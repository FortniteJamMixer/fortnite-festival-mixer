<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Fortnite Jam Mixer ‚Äî Library</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root {
      color-scheme: dark;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      min-height: 100vh;
      background: radial-gradient(circle at top, #111833 0%, #0a0f24 40%, #070b18 100%);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color: #e5f6ff;
    }
    .panel {
      background: rgba(9, 13, 30, 0.85);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 20px 45px rgba(0,0,0,0.35);
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      color: #fff;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      border-radius: 10px;
      font-weight: 700;
      border: 0;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .btn:hover { transform: translateY(-1px); }
    .btn-primary { background: linear-gradient(90deg,#22d3ee,#3b82f6); color:#07132d; }
    .btn-secondary { background: rgba(255,255,255,0.12); color:#e7f9ff; }
    .btn-danger { background: linear-gradient(90deg,#ef4444,#dc2626); color:#fff; }
    .btn-outline { border: 1px solid rgba(255,255,255,0.2); background: transparent; color:#e5f6ff; }
    .muted { color: rgba(223, 246, 255, 0.7); }
    .grid-cards {
      display: grid;
      gap: 14px;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    }
    .card {
      background: rgba(13, 20, 42, 0.9);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      position: relative;
    }
    .card.selected {
      outline: 2px solid rgba(34,211,238,0.7);
      box-shadow: 0 0 22px rgba(34,211,238,0.2);
    }
    .help-modal {
      position: fixed;
      inset: 0;
      background: rgba(2,6,23,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
      backdrop-filter: blur(6px);
    }
    .help-content {
      width: min(820px, 92vw);
      max-height: 86vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      background: rgba(10,15,30,0.98);
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.08);
    }
    .help-body {
      padding: 18px 20px;
      overflow-y: auto;
      line-height: 1.5;
      font-size: 14px;
    }
    .help-body h3 {
      font-size: 16px;
      font-weight: 800;
      margin-top: 16px;
      margin-bottom: 6px;
    }
    .help-body ul { margin-left: 18px; margin-top: 6px; }
    .help-body li { margin-bottom: 4px; }
  </style>
</head>
<body>
  <div class="max-w-6xl mx-auto px-4 py-8">
    <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
      <div class="flex items-center gap-3">
        <div class="text-3xl">üéµ</div>
        <div>
          <h1 class="text-2xl font-extrabold">Fortnite Jam Mixer</h1>
          <p class="muted text-sm">Organize your Festival library and build the perfect setlist.</p>
        </div>
      </div>
      <div class="flex flex-wrap gap-2">
        <button class="btn btn-outline" id="helpBtn">üéß Help</button>
        <button class="btn btn-outline" id="exportBtn">Export JSON</button>
        <label class="btn btn-outline" for="importInput">Import JSON</label>
        <input id="importInput" type="file" accept="application/json" class="hidden"/>
      </div>
    </header>

    <main id="app"></main>
  </div>

  <div class="help-modal" id="helpModal" aria-hidden="true">
    <div class="help-content" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
      <div class="flex items-center justify-between px-5 py-4 border-b border-white/10">
        <div class="flex items-center gap-3">
          <div class="text-2xl">üéß</div>
          <div>
            <div id="helpTitle" class="text-lg font-bold">Help & Features</div>
            <div class="text-xs muted">Learn how to mix, filter, and manage your library.</div>
          </div>
        </div>
        <button class="btn btn-secondary" id="closeHelp">‚úï Close</button>
      </div>
      <div class="help-body">
        <h3>Library Basics</h3>
        <ul>
          <li><strong>Mark Owned</strong> adds a track to your personal collection.</li>
          <li><strong>Setlist</strong> lets you queue the songs you want to play.</li>
          <li><strong>Search & Filters</strong> help you narrow the library quickly.</li>
        </ul>

        <h3>Camelot Compatibility</h3>
        <p class="muted">Select a track to see compatibility scores. Mixable songs share the same Camelot key or a neighbor on the Camelot wheel. BPM closeness also boosts the score.</p>

        <h3>Admin Genre Overrides</h3>
        <p class="muted">If your username is <strong>BattleNeBody</strong>, right-click a genre pill to correct it. Overrides are stored locally.</p>

        <h3>Export & Import</h3>
        <p class="muted">Export downloads a JSON backup of your owned tracks, setlist, and genre overrides. Import merges that data back into your browser.</p>

        <h3>Data Management</h3>
        <p class="muted">All data is stored locally in your browser. Use the button below to delete your saved library, setlist, and settings.</p>
        <button class="btn btn-danger w-full mt-3" id="deleteDataBtn">Delete All My Data</button>
        <p class="text-xs text-red-200 mt-2">‚ö†Ô∏è This will permanently erase owned tracks, setlist entries, and overrides.</p>
      </div>
    </div>
  </div>

  <script>
    const state = {
      currentUser: localStorage.getItem('currentUser') || '',
      songs: [],
      ownedTracks: JSON.parse(localStorage.getItem('ownedTracks') || '[]'),
      setlist: JSON.parse(localStorage.getItem('setlist') || '[]'),
      genreOverrides: JSON.parse(localStorage.getItem('genreOverrides') || '{}'),
      searchTerm: '',
      showOwnedOnly: false,
      showMixableOnly: false,
      selectedSongId: null
    };

    const camelotColorMap = {
      '1A': '#ff6b6b', '1B': '#ff8f8f',
      '2A': '#ff9248', '2B': '#ffb56b',
      '3A': '#ffc857', '3B': '#ffd27f',
      '4A': '#ffe66d', '4B': '#fff1a5',
      '5A': '#9be564', '5B': '#b4f285',
      '6A': '#00c49a', '6B': '#4dd9b6',
      '7A': '#00a8e8', '7B': '#47c7ff',
      '8A': '#4ea8de', '8B': '#7ec8ff',
      '9A': '#8e9aaf', '9B': '#b1b9c8',
      '10A': '#9d4edd', '10B': '#b47bff',
      '11A': '#f15bb5', '11B': '#f78fcb',
      '12A': '#ff4d6d', '12B': '#ff8096'
    };

    const genreKeywords = {
      'Rock': ['rock', 'metal', 'guitar', 'punk'],
      'Pop': ['pop', 'dance', 'radio'],
      'Hip-Hop': ['hip hop', 'rap', 'trap'],
      'Electronic': ['edm', 'electro', 'house', 'techno', 'dubstep'],
      'R&B': ['r&b', 'soul', 'rnb'],
      'Indie': ['indie', 'alternative'],
      'Country': ['country', 'folk'],
      'Disco/Funk': ['funk', 'disco'],
      'Latin': ['latin', 'reggaeton'],
      'Jazz': ['jazz', 'swing'],
      'Reggae': ['reggae']
    };

    const appEl = document.getElementById('app');

    function saveState() {
      localStorage.setItem('ownedTracks', JSON.stringify(state.ownedTracks));
      localStorage.setItem('setlist', JSON.stringify(state.setlist));
      localStorage.setItem('genreOverrides', JSON.stringify(state.genreOverrides));
      localStorage.setItem('currentUser', state.currentUser);
    }

    function detectGenre(artist, title) {
      const text = `${artist} ${title}`.toLowerCase();
      for (const [genre, keys] of Object.entries(genreKeywords)) {
        if (keys.some(key => text.includes(key))) {
          return genre;
        }
      }
      return 'Other';
    }

    function convertToCamelot(key, mode) {
      const normalizedKey = (key || '').toUpperCase();
      const isMinor = (mode || '').toLowerCase().includes('minor');
      const mapping = {
        'C': ['8B', '5A'],
        'C#': ['3B', '12A'],
        'DB': ['3B', '12A'],
        'D': ['10B', '7A'],
        'D#': ['5B', '2A'],
        'EB': ['5B', '2A'],
        'E': ['12B', '9A'],
        'F': ['7B', '4A'],
        'F#': ['2B', '11A'],
        'GB': ['2B', '11A'],
        'G': ['9B', '6A'],
        'G#': ['4B', '1A'],
        'AB': ['4B', '1A'],
        'A': ['11B', '8A'],
        'A#': ['6B', '3A'],
        'BB': ['6B', '3A'],
        'B': ['1B', '10A']
      };
      const base = mapping[normalizedKey];
      if (!base) return '?';
      return isMinor ? base[1] : base[0];
    }

    function camelotColor(camelot) {
      return camelotColorMap[camelot] || '#64748b';
    }

    function bpmDiff(a, b) {
      return Math.abs((a?.bpm || 0) - (b?.bpm || 0));
    }

    function isMixable(base, track) {
      if (!base || !track) return false;
      if (!base.camelot || !track.camelot) return false;
      const baseNum = parseInt(base.camelot, 10);
      const baseMode = base.camelot.slice(-1);
      const trackNum = parseInt(track.camelot, 10);
      const trackMode = track.camelot.slice(-1);
      const sameKey = baseNum === trackNum && baseMode === trackMode;
      const neighbor = (Math.abs(baseNum - trackNum) === 1 || Math.abs(baseNum - trackNum) === 11) && baseMode === trackMode;
      const relative = baseNum === trackNum && baseMode !== trackMode;
      return sameKey || neighbor || relative;
    }

    function compatibilityScore(base, track) {
      if (!base || !track) return 0;
      let score = 50;
      if (isMixable(base, track)) score += 30;
      const diff = bpmDiff(base, track);
      if (diff <= 2) score += 15;
      else if (diff <= 6) score += 8;
      else if (diff <= 10) score += 4;
      return Math.min(100, Math.max(0, score));
    }

    async function loadSongs() {
      const endpoints = [
        'https://api.allorigins.win/raw?url=https://fortnitecontent-website-prod07.ol.epicgames.com/content/api/pages/fortnite-game/spark-tracks',
        'https://corsproxy.io/?https://fortnitecontent-website-prod07.ol.epicgames.com/content/api/pages/fortnite-game/spark-tracks'
      ];
      for (const endpoint of endpoints) {
        try {
          const res = await fetch(endpoint);
          if (!res.ok) continue;
          const data = await res.json();
          const entries = Object.entries(data).filter(([key]) => !key.startsWith('_'));
          state.songs = entries.map(([id, item]) => {
            const track = item?.track || {};
            if (!track?.tt) return null;
            const detected = detectGenre(track.an || '', track.tt || '');
            const finalGenre = state.genreOverrides[id] || detected;
            return {
              id,
              title: track.tt,
              artist: track.an || 'Unknown',
              bpm: Number(track.mt) || 0,
              key: track.mk || '?',
              mode: track.mm || '',
              camelot: convertToCamelot(track.mk || '', track.mm || ''),
              duration: Number(track.dn) || 0,
              albumArt: track.au || '',
              genre: finalGenre
            };
          }).filter(Boolean);
          state.songs.sort((a, b) => a.title.localeCompare(b.title));
          if (state.songs.length) return;
        } catch (error) {
          console.warn('Song fetch failed', error);
        }
      }
      state.songs = [
        { id: 's1', title: 'Bad Guy', artist: 'Billie Eilish', bpm: 135, key: 'C', mode: 'major', camelot: '8B', duration: 180, albumArt: '', genre: 'Pop' },
        { id: 's2', title: 'Need You Tonight', artist: 'INXS', bpm: 115, key: 'C', mode: 'minor', camelot: '8A', duration: 210, albumArt: '', genre: 'Rock' },
        { id: 's3', title: 'Electric Night', artist: 'Daft Sample', bpm: 128, key: 'D', mode: 'major', camelot: '10B', duration: 200, albumArt: '', genre: 'Electronic' },
        { id: 's4', title: 'Slow Burn', artist: 'Indie Star', bpm: 95, key: 'G', mode: 'minor', camelot: '9A', duration: 190, albumArt: '', genre: 'Indie' },
        { id: 's5', title: 'Drop The Bass', artist: 'SkrillSample', bpm: 142, key: 'A', mode: 'minor', camelot: '11A', duration: 160, albumArt: '', genre: 'Electronic' }
      ];
    }

    function renderLanding() {
      appEl.innerHTML = `
        <section class="panel">
          <div class="grid md:grid-cols-[1.1fr_0.9fr] gap-8">
            <div>
              <div class="text-4xl mb-3">üéµ</div>
              <h2 class="text-3xl font-extrabold mb-3">Mix smarter with Camelot keys</h2>
              <p class="muted mb-4">
                The Camelot Wheel maps musical keys into a simple color system. When two tracks share the same Camelot
                code (or neighboring numbers), they blend smoothly. Use the Mixable filter to explore harmonic matches.
              </p>
              <div class="flex flex-wrap gap-2 mb-6">
                <span class="pill" style="background:#22d3ee">Same Key</span>
                <span class="pill" style="background:#3b82f6">Neighbor Key</span>
                <span class="pill" style="background:#f97316">Relative Major/Minor</span>
              </div>
              <div class="panel">
                <h3 class="font-bold mb-2">Quick Start</h3>
                <ul class="muted list-disc ml-5">
                  <li>Log in with a username (stored locally).</li>
                  <li>Select a track to see compatibility scores.</li>
                  <li>Mark owned tracks and build your setlist.</li>
                </ul>
              </div>
            </div>
            <div class="panel">
              <h3 class="text-xl font-bold mb-3">Enter your DJ name</h3>
              <p class="muted mb-4">No account required ‚Äî this is stored only in your browser.</p>
              <input id="usernameInput" type="text" placeholder="Your username" class="w-full p-3 rounded-lg bg-slate-900/70 border border-white/10 text-white mb-3"/>
              <button class="btn btn-primary w-full" id="loginBtn">Start Mixing ‚Üí</button>
              <p class="muted text-xs mt-3">Tip: Use <strong>BattleNeBody</strong> to enable genre overrides.</p>
            </div>
          </div>
        </section>
      `;
      document.getElementById('loginBtn').addEventListener('click', handleLogin);
    }

    function renderApp() {
      const selectedSong = state.songs.find(song => song.id === state.selectedSongId);
      const totalOwned = state.ownedTracks.length;
      const totalSongs = state.songs.length;
      const ownedLabel = totalSongs ? `${totalOwned}/${totalSongs} owned` : '0 owned';

      appEl.innerHTML = `
        <section class="panel mb-6">
          <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
            <div>
              <div class="text-sm muted">Welcome, <strong>${state.currentUser}</strong></div>
              <h2 class="text-2xl font-bold">Song Browser</h2>
              <div class="text-xs muted">${ownedLabel} ‚Ä¢ Select a track to unlock mixable scores.</div>
            </div>
            <div class="flex flex-wrap gap-2">
              <button class="btn btn-secondary" id="logoutBtn">Log out</button>
              <button class="btn btn-secondary" id="clearSelectionBtn">Clear Selection</button>
              <button class="btn btn-secondary" id="toggleSetlistBtn">Setlist (${state.setlist.length})</button>
            </div>
          </div>
          <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-3 mt-4">
            <input id="searchInput" type="text" placeholder="Search by title or artist" value="${state.searchTerm}" class="p-3 rounded-lg bg-slate-900/70 border border-white/10 text-white"/>
            <label class="flex items-center gap-2 text-sm">
              <input id="ownedOnlyToggle" type="checkbox" ${state.showOwnedOnly ? 'checked' : ''}/>
              Show Owned Only ‚úì
            </label>
            <label class="flex items-center gap-2 text-sm">
              <input id="mixableToggle" type="checkbox" ${state.showMixableOnly ? 'checked' : ''}/>
              Show Mixable Only ‚Üí
            </label>
            <div class="text-sm muted">Compatibility uses Camelot + BPM ¬±</div>
          </div>
        </section>

        <section class="panel mb-6" id="setlistPanel" style="display:none;">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-lg font-bold">Setlist</h3>
            <button class="btn btn-secondary" id="closeSetlistBtn">‚úï Close</button>
          </div>
          <div id="setlistList" class="grid gap-2"></div>
        </section>

        <section class="grid-cards" id="songList"></section>
      `;

      document.getElementById('logoutBtn').addEventListener('click', handleLogout);
      document.getElementById('clearSelectionBtn').addEventListener('click', () => {
        state.selectedSongId = null;
        render();
      });
      document.getElementById('toggleSetlistBtn').addEventListener('click', () => {
        const panel = document.getElementById('setlistPanel');
        panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
      });
      document.getElementById('closeSetlistBtn').addEventListener('click', () => {
        document.getElementById('setlistPanel').style.display = 'none';
      });
      document.getElementById('searchInput').addEventListener('input', (event) => {
        state.searchTerm = event.target.value;
        renderSongList();
      });
      document.getElementById('ownedOnlyToggle').addEventListener('change', (event) => {
        state.showOwnedOnly = event.target.checked;
        renderSongList();
      });
      document.getElementById('mixableToggle').addEventListener('change', (event) => {
        state.showMixableOnly = event.target.checked;
        renderSongList();
      });

      renderSetlist();
      renderSongList();
    }

    function renderSetlist() {
      const container = document.getElementById('setlistList');
      if (!container) return;
      if (!state.setlist.length) {
        container.innerHTML = '<p class="muted">No tracks in your setlist yet.</p>';
        return;
      }
      container.innerHTML = state.setlist.map(id => {
        const song = state.songs.find(track => track.id === id);
        if (!song) return '';
        return `
          <div class="flex items-center justify-between bg-slate-900/60 border border-white/10 rounded-lg p-3">
            <div>
              <div class="font-semibold">${song.title}</div>
              <div class="text-xs muted">${song.artist} ‚Ä¢ ${song.bpm} BPM ‚Ä¢ ${song.camelot}</div>
            </div>
            <button class="btn btn-secondary" data-action="remove-set" data-id="${song.id}">‚úï Remove</button>
          </div>
        `;
      }).join('');
      container.querySelectorAll('[data-action="remove-set"]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-id');
          state.setlist = state.setlist.filter(trackId => trackId !== id);
          saveState();
          render();
        });
      });
    }

    function renderSongList() {
      const listEl = document.getElementById('songList');
      if (!listEl) return;
      const selectedSong = state.songs.find(song => song.id === state.selectedSongId);
      const filtered = state.songs.filter(song => {
        const matchesSearch = !state.searchTerm || song.title.toLowerCase().includes(state.searchTerm.toLowerCase()) || song.artist.toLowerCase().includes(state.searchTerm.toLowerCase());
        const matchesOwned = !state.showOwnedOnly || state.ownedTracks.includes(song.id);
        const matchesMixable = !state.showMixableOnly || (selectedSong && isMixable(selectedSong, song));
        return matchesSearch && matchesOwned && matchesMixable;
      });
      listEl.innerHTML = filtered.map(song => {
        const isOwned = state.ownedTracks.includes(song.id);
        const inSetlist = state.setlist.includes(song.id);
        const camelotColorValue = camelotColor(song.camelot);
        const isSelected = state.selectedSongId === song.id;
        const score = selectedSong && song.id !== selectedSong.id ? compatibilityScore(selectedSong, song) : null;
        const scoreLabel = score !== null ? `<div class="text-xs muted">Compatibility: ${score}%</div>` : '';
        return `
          <div class="card ${isSelected ? 'selected' : ''}" data-id="${song.id}">
            <div class="flex items-center justify-between">
              <div class="text-sm font-semibold">${song.title}</div>
              <div class="text-xs muted">${song.bpm} BPM</div>
            </div>
            <div class="text-xs muted">${song.artist}</div>
            <div class="flex flex-wrap gap-2">
              <span class="pill" style="background:${camelotColorValue}">${song.camelot}</span>
              <span class="pill genre-pill" data-id="${song.id}" style="background:${camelotColorValue}; opacity:0.85">${song.genre}</span>
            </div>
            ${scoreLabel}
            <div class="flex flex-wrap gap-2 mt-2">
              <button class="btn btn-secondary" data-action="select" data-id="${song.id}">${isSelected ? 'Selected ‚úì' : 'Select'}</button>
              <button class="btn btn-secondary" data-action="owned" data-id="${song.id}">${isOwned ? 'Owned ‚≠ê' : 'Mark Owned'}</button>
              <button class="btn btn-secondary" data-action="setlist" data-id="${song.id}">${inSetlist ? 'In Setlist' : '+ Set'}</button>
            </div>
          </div>
        `;
      }).join('');

      listEl.querySelectorAll('[data-action="select"]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-id');
          state.selectedSongId = state.selectedSongId === id ? null : id;
          render();
        });
      });
      listEl.querySelectorAll('[data-action="owned"]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-id');
          if (state.ownedTracks.includes(id)) {
            state.ownedTracks = state.ownedTracks.filter(trackId => trackId !== id);
          } else {
            state.ownedTracks.push(id);
          }
          saveState();
          render();
        });
      });
      listEl.querySelectorAll('[data-action="setlist"]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-id');
          if (!state.setlist.includes(id)) {
            state.setlist.push(id);
          }
          saveState();
          render();
        });
      });

      listEl.querySelectorAll('.genre-pill').forEach(pill => {
        pill.addEventListener('contextmenu', (event) => {
          if (state.currentUser !== 'BattleNeBody') return;
          event.preventDefault();
          const id = pill.getAttribute('data-id');
          const newGenre = prompt('Enter new genre:', state.genreOverrides[id] || pill.textContent);
          if (!newGenre) return;
          state.genreOverrides[id] = newGenre.trim();
          saveState();
          render();
        });
      });
    }

    function handleLogin() {
      const input = document.getElementById('usernameInput');
      const value = input?.value.trim();
      if (!value) {
        alert('Please enter a username.');
        return;
      }
      state.currentUser = value;
      saveState();
      render();
    }

    function handleLogout() {
      state.currentUser = '';
      saveState();
      render();
    }

    function render() {
      if (!state.currentUser) {
        renderLanding();
      } else {
        renderApp();
      }
    }

    function openHelp() {
      document.getElementById('helpModal').style.display = 'flex';
    }

    function closeHelp() {
      document.getElementById('helpModal').style.display = 'none';
    }

    function handleDeleteData() {
      const confirmed = confirm('Delete all your data? This cannot be undone.');
      if (!confirmed) return;
      localStorage.removeItem('ownedTracks');
      localStorage.removeItem('setlist');
      localStorage.removeItem('genreOverrides');
      localStorage.removeItem('currentUser');
      location.reload();
    }

    function handleExport() {
      const payload = {
        ownedTracks: state.ownedTracks,
        setlist: state.setlist,
        genreOverrides: state.genreOverrides
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'festival-mixer-data.json';
      link.click();
      URL.revokeObjectURL(url);
    }

    function handleImport(event) {
      const file = event.target.files?.[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const parsed = JSON.parse(reader.result);
          state.ownedTracks = Array.isArray(parsed.ownedTracks) ? parsed.ownedTracks : state.ownedTracks;
          state.setlist = Array.isArray(parsed.setlist) ? parsed.setlist : state.setlist;
          state.genreOverrides = parsed.genreOverrides && typeof parsed.genreOverrides === 'object' ? parsed.genreOverrides : state.genreOverrides;
          saveState();
          render();
        } catch (error) {
          alert('Invalid JSON file.');
        }
      };
      reader.readAsText(file);
    }

    document.getElementById('helpBtn').addEventListener('click', openHelp);
    document.getElementById('closeHelp').addEventListener('click', closeHelp);
    document.getElementById('deleteDataBtn').addEventListener('click', handleDeleteData);
    document.getElementById('exportBtn').addEventListener('click', handleExport);
    document.getElementById('importInput').addEventListener('change', handleImport);

    loadSongs().then(render);
  </script>
</body>
</html>
