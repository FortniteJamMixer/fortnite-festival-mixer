<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Fortnite Jam Mixer ‚Äî Library</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Optional Firebase SDKs (compat). Enable only if you use Firebase. -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <style>
    /* ---------------- Theme & Layout ---------------- */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html,body { height: 100%; }
    body {
      background: linear-gradient(135deg, #0f1020 0%, #14122a 40%, #071130 100%);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color: #e9f7ff;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .content-wrapper { max-width: 1400px; margin: 18px auto; padding: 12px; }
    .panel { background: linear-gradient(180deg, rgba(0,0,0,0.55), rgba(0,0,0,0.45)); border-radius: 12px; border: 1px solid rgba(255,255,255,0.03); padding: 12px; }
    .vinyl-spin { animation: spin 4s linear infinite; }
    .bounce-icon { animation: bounce 2s ease-in-out infinite; }
    @keyframes spin { from { transform: rotate(0) } to { transform: rotate(360deg) } }
    @keyframes bounce { 0%,100% { transform: translateY(0) } 50% { transform: translateY(-8px) } }
    .graffiti-text { text-shadow: 3px 3px 0 #ff6b9d, 6px 6px 0 rgba(255,107,157,0.22); letter-spacing: 1px; }
    .camelot-pill { padding: 6px 10px; border-radius: 10px; font-weight: 700; color: #fff; }
    .small-muted { color: rgba(230,247,255,0.7); font-size: 13px; }

    /* Grid Layout for Song Cards */
    #songList {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    @media (max-width: 1400px) {
      #songList { grid-template-columns: repeat(4, 1fr); }
    }
    @media (max-width: 1000px) {
      #songList { grid-template-columns: repeat(3, 1fr); }
    }
    @media (max-width: 768px) {
      #songList { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 480px) {
      #songList { grid-template-columns: 1fr; }
    }

    /* Help modal */
    #helpModal {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 20000;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.85);
      backdrop-filter: blur(6px);
    }
    .helpBox {
      width: 92%;
      max-width: 760px;
      height: 80vh;
      background: linear-gradient(180deg, rgba(12,10,25,0.96), rgba(20,16,38,0.98));
      border-radius: 14px;
      border: 2px solid rgba(0,217,255,0.14);
      box-shadow: 0 10px 40px rgba(0,0,0,0.6), 0 0 50px rgba(0,217,255,0.06);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .helpHeader {
      padding: 14px 18px;
      border-bottom: 1px solid rgba(0,217,255,0.06);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .helpTitle { font-size:20px; font-weight:800; color:#fff; display:flex; gap:10px; align-items:center; }
    .helpContent {
      padding: 14px 18px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      color: #dff7ff;
      line-height:1.45;
      font-size:14px;
    }
    .helpFooter { padding: 10px 14px; border-top: 1px solid rgba(0,217,255,0.04); text-align:right; }

    /* Custom neon scrollbar for helpContent */
    .helpContent::-webkit-scrollbar { width: 12px; }
    .helpContent::-webkit-scrollbar-track { background: linear-gradient(180deg, rgba(0,0,0,0.12), rgba(0,0,0,0.06)); border-radius:8px; }
    .helpContent::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, rgba(0,217,255,0.9), rgba(255,107,157,0.9));
      border-radius: 8px;
      border: 2px solid rgba(0,0,0,0.2);
      box-shadow: 0 0 12px rgba(0,217,255,0.14);
    }
    .helpCloseBtn {
      background: linear-gradient(90deg,#ff6b9d,#8b5cf6);
      padding: 8px 12px;
      border-radius: 10px;
      color: #fff;
      font-weight:700;
      cursor:pointer;
      border: none;
      box-shadow: 0 6px 24px rgba(139,92,246,0.12);
    }
  </style>
</head>
<body>
  <div class="content-wrapper">
    <div id="app">
      <div class="min-h-screen flex items-center justify-center">
        <div class="text-center">
          <div class="text-6xl mb-4 animate-pulse">üéµ</div>
          <div class="text-2xl font-bold text-white">Loading Festival Mixer...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Help Modal (outside #app so it persists) -->
  <div id="helpModal" aria-hidden="true">
    <div class="helpBox" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
      <div class="helpHeader">
        <div class="helpTitle" id="helpTitle">
          <div style="width:50px;height:50px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:linear-gradient(90deg,#ff6b9d,#8b5cf6);box-shadow:0 8px 24px rgba(139,92,246,0.12);font-size:22px;">üéß</div>
          <div>
            <div style="font-size:18px;font-weight:800">HELP & FEATURES</div>
            <div style="font-size:12px;color:#bdeeff">Track your Fortnite Festival song library</div>
          </div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="helpCloseBtn" onclick="closeHelp()" aria-label="Close help">‚úï Close</button>
        </div>
      </div>

      <div class="helpContent" id="helpContent">
        <h3 style="font-weight:800;margin-bottom:6px;color:#fff;font-size:16px">Welcome ‚Äî Quick Overview</h3>
        <p class="small-muted">Track which songs you own in Fortnite Festival and organize them into setlists.</p>

        <hr style="margin:12px 0;border-color:rgba(0,217,255,0.06)">

        <h4 style="margin-top:8px;font-weight:800;color:#ffb3d1">Library Basics</h4>
        <ul style="margin-left:16px;margin-top:6px">
          <li><strong>Mark Owned</strong> ‚Äî Click <em>Mark Owned</em> on a track to add it to your collection.</li>
          <li><strong>Setlist</strong> ‚Äî Use <em>+ Set</em> to add a track to your setlist. Open the Setlist view to see your picks.</li>
          <li><strong>Search & Filters</strong> ‚Äî Use the search box and <em>Show All / ‚úì Owned Only</em> to filter tracks.</li>
        </ul>

        <h4 style="margin-top:12px;font-weight:800;color:#9fe8ff">Song Information</h4>
        <p class="small-muted">Each track shows its genre, key (Camelot notation), and BPM for reference. Genre tags can be corrected by the admin (BattleNeBody) via right-click.</p>

        <h4 style="margin-top:12px;font-weight:800;color:#b0ffc8">Setlist Management</h4>
        <ul style="margin-left:16px;margin-top:6px">
          <li><strong>Add to setlist</strong> ‚Äî Click <em>+ Set</em>. The Setlist view shows your list.</li>
          <li><strong>Remove from setlist</strong> ‚Äî Use the ‚úï button in Setlist view.</li>
        </ul>

        <h4 style="margin-top:12px;font-weight:800;color:#b6e0ff">Admin & Genre Overrides</h4>
        <p class="small-muted">Admin (user <strong>BattleNeBody</strong>) can correct genre tags by right-clicking the genre pill.</p>

        <h4 style="margin-top:12px;font-weight:800;color:#ff9a9a">Data Management</h4>
        <p class="small-muted" style="margin-bottom:8px">All your data is stored locally in your browser. If you want to delete everything and start fresh, or if you're done using the app:</p>
        <button onclick="deleteAllData()" style="background:linear-gradient(90deg,#ef4444,#dc2626);padding:8px 16px;border-radius:8px;color:#fff;font-weight:700;cursor:pointer;border:none;width:100%;margin-top:6px;">üóëÔ∏è Delete All My Data</button>
        <p class="small-muted" style="margin-top:6px;font-size:11px;color:#ff9a9a;">‚ö†Ô∏è This will permanently erase your owned tracks, setlists, and all settings. This cannot be undone.</p>

        <p class="small-muted" style="margin-top:10px">Open this panel anytime via the ‚ùì Help button. üéß</p>
      </div>

      <div class="helpFooter">
        <button class="helpCloseBtn" onclick="closeHelp()">Close</button>
      </div>
    </div>
  </div>

  <script>
    /**************************************************************************
     * Simplified Library-Only Version
     * - No mixing logic, selection, or sandbox
     * - 4-column grid layout
     * - Load More pagination (12 songs initially)
     * - Genre info display only
     **************************************************************************/

    // -------------------- FIREBASE (optional) ----------------------------
    const firebaseEnabled = false; // set true to enable
    const firebaseConfig = {
      // Paste your firebase config here
    };

    let firebaseApp = null, firebaseAuth = null, firestore = null;
    if (firebaseEnabled && window.firebase && firebaseConfig.apiKey) {
      try {
        firebaseApp = firebase.initializeApp(firebaseConfig);
        firebaseAuth = firebase.auth();
        firestore = firebase.firestore();
        console.log('Firebase initialized');
      } catch (e) {
        console.warn('Firebase init failed', e);
        firebaseApp = null;
      }
    }

    // Backend save/load wrappers (Firestore or localStorage)
    async function saveUserProfileToBackend(profile) {
      if (!profile) return;
      if (firestore && profile.username) {
        try {
          await firestore.collection('users').doc(profile.username).set(profile, { merge: true });
          return true;
        } catch (e) { console.warn('Firestore save failed', e); return false; }
      } else {
        const profiles = JSON.parse(localStorage.getItem('userProfiles') || '{}');
        profiles[profile.username] = profile;
        localStorage.setItem('userProfiles', JSON.stringify(profiles));
        return true;
      }
    }
    async function loadUserProfileFromBackend(username) {
      if (!username) return null;
      if (firestore) {
        try {
          const doc = await firestore.collection('users').doc(username).get();
          return doc.exists ? doc.data() : null;
        } catch (e) { console.warn('Firestore load failed', e); }
      }
      const profiles = JSON.parse(localStorage.getItem('userProfiles') || '{}');
      return profiles[username] || null;
    }

    // ---------------------------- Data ------------------------------
    const camelotColors = {
      '1A':'#FF6B9D','1B':'#FF8FAB','2A':'#FFA07A','2B':'#FFB699','3A':'#FFD700','3B':'#FFE55C',
      '4A':'#98D8C8','4B':'#7FD8BE','5A':'#6BCB77','5B':'#8FD89F','6A':'#4D96FF','6B':'#6FB1FF',
      '7A':'#9D4EDD','7B':'#B877FF','8A':'#E84A5F','8B':'#FF6B81','9A':'#00D9FF','9B':'#4DFFFF',
      '10A':'#FFA400','10B':'#FFBB5C','11A':'#FE6D73','11B':'#FF8C94','12A':'#A8E6CF','12B':'#C1F0DD'
    };
    const keyToCamelot = { 'C':'8B','Am':'8A','A Minor':'8A','C Major':'8B','G':'9B','Em':'9A','E Minor':'9A','G Major':'9B','D':'10B','Bm':'10A','B Minor':'10A','D Major':'10B','A':'11B','F#m':'11A','F# Minor':'11A','A Major':'11B','E':'12B','C#m':'12A','C# Minor':'12A','E Major':'12B','B':'1B','G#m':'1A','G# Minor':'1A','B Major':'1B','F#':'2B','D#m':'2A','D# Minor':'2A','F# Major':'2B','Db':'3B','Bbm':'3A','Bb Minor':'3A','Db Major':'3B','Ab':'4B','Fm':'4A','F Minor':'4A','Ab Major':'4B','Eb':'5B','Cm':'5A','C Minor':'5A','Eb Major':'5B','Bb':'6B','Gm':'6A','G Minor':'6A','Bb Major':'6B','F':'7B','Dm':'7A','D Minor':'7A','F Major':'7B' };

    const genreMap = {
      'Rock': ['foo fighters','nirvana','pearl jam','soundgarden','alice in chains','red hot chili peppers','radiohead','muse','queens of the stone age','rage against the machine'],
      'Classic Rock': ['beatles','rolling stones','led zeppelin','pink floyd','queen','the who','aerosmith'],
      'Alternative': ['green day','blink-182','sum 41','my chemical romance','fall out boy','arctic monkeys','the strokes','the killers'],
      'Punk': ['ramones','sex pistols','the clash'],
      'Metal': ['metallica','megadeth','slayer','anthrax','iron maiden'],
      'Pop': ['taylor swift','ariana grande','billie eilish','dua lipa','lady gaga','katy perry'],
      'Hip-Hop': ['eminem','dr. dre','snoop dogg','2pac','notorious b.i.g','jay-z','nas','kanye west','kendrick lamar','drake'],
      'R&B': ['the weeknd','bruno mars','usher','beyonce','rihanna'],
      'Electronic': ['daft punk','deadmau5','skrillex','diplo','zedd','avicii','calvin harris'],
      'Indie': ['vampire weekend','tame impala','mgmt','arctic monkeys','the strokes'],
      'Country': ['johnny cash','garth brooks','shania twain','tim mcgraw'],
      'Disco/Funk': ['bee gees','donna summer','chic','earth wind & fire','bruno mars'],
      'Blues': ['bb king','muddy waters','howlin wolf'],
      'Jazz': ['miles davis','john coltrane'],
      'Reggae': ['bob marley'],
      'Latin': ['shakira','ricky martin','enrique iglesias'],
      'Soul': ['aretha franklin','otis redding','sam cooke']
    };

    const genreColors = {
      'Rock': '#ef4444',           // Red
      'Classic Rock': '#dc2626',   // Dark Red
      'Alternative': '#f97316',    // Orange
      'Punk': '#ea580c',           // Dark Orange
      'Metal': '#7f1d1d',          // Very Dark Red
      'Pop': '#ec4899',            // Pink
      'Hip-Hop': '#8b5cf6',        // Purple
      'R&B': '#a855f7',            // Light Purple
      'Electronic': '#06b6d4',     // Cyan
      'Indie': '#14b8a6',          // Teal
      'Country': '#eab308',        // Yellow
      'Disco/Funk': '#f59e0b',     // Amber
      'Blues': '#3b82f6',          // Blue
      'Jazz': '#6366f1',           // Indigo
      'Reggae': '#22c55e',         // Green
      'Latin': '#f43f5e',          // Rose
      'Soul': '#9333ea',           // Violet
      'Other': '#6b7280'           // Gray
    };

    // -------------------------- State -----------------------------
    let currentUser = null;
    let songs = [];
    let ownedTracks = JSON.parse(localStorage.getItem('ownedTracks') || '[]');
    let selectedSong = null;
    let setlist = JSON.parse(localStorage.getItem('setlist') || '[]');
    let searchTerm = '';
    let view = 'browser';
    let showOwnedOnly = false;
    let showMixableOnly = false;
    let searchMode = 'camelot'; // 'camelot' or 'key'
    let genreOverrides = JSON.parse(localStorage.getItem('genreOverrides') || '{}');
    let currentPage = 1;
    const songsPerPage = 15;

    // ---------------------- Utils & Mixing Logic -----------------------
    function convertToCamelot(key) {
      if (!key) return '?';
      return keyToCamelot[(key||'').trim()] || '?';
    }
    function getCompatibleKeys(camelot) {
      if (!camelot || camelot === '?') return [];
      const matches = camelot.match(/^(\d+)([AB])$/);
      if (!matches) return [];
      const num = parseInt(matches[1]); const letter = matches[2];
      const compatible = [camelot, `${num}${letter==='A'?'B':'A'}`];
      const nextNum = num === 12 ? 1 : num + 1; const prevNum = num === 1 ? 12 : num - 1;
      compatible.push(`${nextNum}${letter}`); compatible.push(`${prevNum}${letter}`);
      return compatible;
    }
    function isMixable(song1,song2){ if(!song1||!song2) return false; const compatible = getCompatibleKeys(song1.camelot); return compatible.includes(song2.camelot); }

    function scoreKeyMatch(aCamelot,bCamelot){ if(!aCamelot||!bCamelot||aCamelot==='?'||bCamelot==='?') return 0; if(aCamelot===bCamelot) return 40; const ma=aCamelot.match(/^(\d+)([AB])$/), mb=bCamelot.match(/^(\d+)([AB])$/); if(!ma||!mb) return 0; const numA=parseInt(ma[1]), letterA=ma[2], numB=parseInt(mb[1]), letterB=mb[2]; if(numA===numB&&letterA!==letterB) return 30; if(letterA===letterB&&(Math.abs(numA-numB)===1||Math.abs(numA-numB)===11)) return 30; if(Math.abs(numA-numB)===1&&letterA!==letterB) return 20; return 0; }
    function scoreBpmMatch(aBpm,bBpm){ const diff=Math.abs(aBpm-bBpm); if(diff<=1) return 40; if(diff<=3) return 35; if(diff<=6) return 25; if(diff<=10) return 15; return 0; }
    function scoreGenreMatch(aGenre,bGenre){ if(!aGenre||!bGenre) return 0; return aGenre===bGenre?20:0; }
    function mashupCompatibility(a,b){ const key=scoreKeyMatch(a.camelot,b.camelot); const bpm=scoreBpmMatch(a.bpm,b.bpm); const genre=scoreGenreMatch(a.genre,b.genre); const total=key+bpm+genre; return {total,breakdown:{key,bpm,genre}}; }
    function bpmShiftSuggestion(aBpm,bBpm){ const shift=Math.round(bBpm-aBpm); if(shift===0) return 'Perfect BPM match'; return (shift>0?'+':'')+shift+' BPM'; }

    // ----------------------- Genre detection -----------------------
    function detectGenre(artist, title){
      artist=(artist||'').toLowerCase(); title=(title||'').toLowerCase();
      for(const [genre,artists] of Object.entries(genreMap)){
        if(artists.some(a=>artist.includes(a) || (a.length>3 && artist.includes(a.split(' ')[0])))) return genre;
      }
      if(title.includes('rock')||title.includes('metal')) return 'Rock';
      if(title.includes('funk')||title.includes('disco')) return 'Disco/Funk';
      if(title.includes('blues')) return 'Blues';
      if(title.includes('jazz')) return 'Jazz';
      if(title.includes('country')) return 'Country';
      if(title.includes('reggae')) return 'Reggae';
      return 'Other';
    }

    // ----------------------- Storage helpers -----------------------
    async function saveUserProfile(){
      if(!currentUser) return;
      const profile = { username: currentUser.username, djName: currentUser.djName, ownedTracks, setlists: currentUser.setlists||[], genreOverrides };
      localStorage.setItem('ownedTracks', JSON.stringify(ownedTracks));
      localStorage.setItem('genreOverrides', JSON.stringify(genreOverrides));
      const profiles = JSON.parse(localStorage.getItem('userProfiles')||'{}');
      profiles[profile.username] = profile;
      localStorage.setItem('userProfiles', JSON.stringify(profiles));
      await saveUserProfileToBackend(profile);
    }
    async function loadUserProfile(username){
      if(!username) return null;
      if(firestore){
        try{
          const doc = await firestore.collection('users').doc(username).get();
          if(doc.exists) return doc.data();
        }catch(e){ console.warn('Firestore load failed',e); }
      }
      const profiles = JSON.parse(localStorage.getItem('userProfiles')||'{}');
      return profiles[username] || null;
    }

    // --------------------- UI: Landing / Auth ------------------------
    function showLandingPage(){
      document.getElementById('app').innerHTML = `
        <div class="min-h-screen py-12 px-6">
          <div class="max-w-6xl mx-auto">
            <div class="text-center mb-16">
              <div class="flex justify-center mb-6">
                <div class="w-32 h-32 bg-gradient-to-br from-pink-500 via-purple-500 to-cyan-500 rounded-full flex items-center justify-center text-6xl vinyl-spin">üéß</div>
              </div>
              <h1 class="text-5xl md:text-6xl font-bold text-white graffiti-text mb-4">FORTNITE JAM MIXER</h1>
              <p class="text-xl md:text-2xl text-cyan-300 mb-6">Track Your Festival Song Library</p>
              <div class="mt-6">
                <button onclick="hideLanding()" class="px-8 py-4 bg-gradient-to-r from-pink-500 via-purple-500 to-cyan-500 rounded-xl font-bold text-white text-xl md:text-2xl bounce-icon shadow-lg">üéµ START BROWSING</button>
              </div>
            </div>
          </div>
        </div>
      `;
    }
    window.hideLanding = () => { localStorage.setItem('hasSeenLanding','true'); checkAuth(); };

    // -------------------- Login / Profile handlers ---------------------
    function showLoginScreen(){
      document.getElementById('app').innerHTML = `
        <div class="min-h-screen flex items-center justify-center p-6">
          <div class="max-w-md w-full">
            <div class="text-center mb-8">
              <div class="w-24 h-24 bg-gradient-to-br from-pink-500 via-purple-500 to-cyan-500 rounded-full flex items-center justify-center text-5xl mx-auto mb-4 vinyl-spin">üéß</div>
              <h1 class="text-4xl font-bold text-white graffiti-text mb-2">JAM MIXER</h1>
              <p class="text-cyan-300">Your Personal Library</p>
            </div>

            <div class="bg-black/60 backdrop-blur-xl border border-cyan-500/30 rounded-2xl p-8 shadow-2xl">
              <h2 class="text-2xl font-bold text-white mb-6 text-center">Sign In / Create Profile</h2>

              ${firebaseEnabled ? `
                <form onsubmit="handleFirebaseLogin(event)" class="space-y-4">
                  <div><label class="block text-sm text-gray-300 mb-2">Email</label><input id="email" type="email" required placeholder="you@example.com" class="w-full px-4 py-3 bg-black/40 border border-gray-600 rounded-lg text-white" /></div>
                  <div><label class="block text-sm text-gray-300 mb-2">Password</label><input id="password" type="password" required placeholder="password" class="w-full px-4 py-3 bg-black/40 border border-gray-600 rounded-lg text-white" /></div>
                  <div class="flex gap-2"><button type="submit" class="flex-1 px-4 py-3 bg-gradient-to-r from-pink-500 to-purple-500 rounded-lg font-bold text-white">Sign In</button><button type="button" onclick="handleFirebaseRegister()" class="px-4 py-3 bg-green-600 rounded-lg font-bold text-white">Register</button></div>
                </form>
              ` : `
                <form onsubmit="handleLogin(event)" class="space-y-4">
                  <div><label class="block text-sm text-gray-300 mb-2">Username</label><input id="username" type="text" required minlength="3" placeholder="Enter your username" class="w-full px-4 py-3 bg-black/40 border border-gray-600 rounded-lg text-white" /></div>
                  <div><label class="block text-sm text-gray-300 mb-2">DJ Name (optional)</label><input id="djName" type="text" placeholder="e.g., DJ Spinner" class="w-full px-4 py-3 bg-black/40 border border-gray-600 rounded-lg text-white" /></div>
                  <button type="submit" class="w-full px-6 py-3 bg-gradient-to-r from-pink-500 via-purple-500 to-cyan-500 rounded-lg font-bold text-white text-lg">üéµ Enter</button>
                </form>
              `}
            </div>
          </div>
        </div>
      `;
    }

    async function handleFirebaseRegister(){
      if(!firebaseEnabled||!firebaseAuth) return alert('Firebase not enabled/configured');
      const email=document.getElementById('email').value.trim();
      const password=document.getElementById('password').value;
      if(!email||!password) return alert('Enter email & password');
      try{
        const cred = await firebaseAuth.createUserWithEmailAndPassword(email,password);
        const username = email.split('@')[0];
        currentUser = { username, djName: username, ownedTracks: [], setlists: [], genreOverrides:{} };
        await saveUserProfileToBackend(currentUser);
        localStorage.setItem('currentUser', username);
        checkAuth();
        alert('Registered! Welcome.');
      }catch(e){ console.error(e); alert('Registration failed: '+(e.message||e)); }
    }

    async function handleFirebaseLogin(e){
      e.preventDefault();
      if(!firebaseEnabled||!firebaseAuth) return alert('Firebase not enabled/configured');
      const email=document.getElementById('email').value.trim();
      const password=document.getElementById('password').value;
      try{
        const res = await firebaseAuth.signInWithEmailAndPassword(email,password);
        const username = email.split('@')[0];
        const profile = await loadUserProfileFromBackend(username);
        if(profile){ currentUser = profile; ownedTracks = profile.ownedTracks || []; genreOverrides = profile.genreOverrides || {}; }
        else { currentUser = { username, djName: username, ownedTracks: [], setlists: [], genreOverrides: {} }; await saveUserProfileToBackend(currentUser); }
        localStorage.setItem('currentUser', currentUser.username);
        loadSongs();
      }catch(err){ console.error(err); alert('Sign-in failed: '+(err.message||err)); }
    }

    window.handleLogin = async (event) => {
      event.preventDefault();
      const username = document.getElementById('username').value.trim();
      const djName = (document.getElementById('djName').value || username).trim() || username;
      if(username.length<3){ alert('Username must be at least 3 characters'); return; }
      const profile = await loadUserProfile(username);
      if(profile){ currentUser = profile; ownedTracks = profile.ownedTracks || []; genreOverrides = profile.genreOverrides || {}; }
      else { currentUser = { username, djName, ownedTracks: [], setlists: [], genreOverrides: {} }; await saveUserProfileToBackend(currentUser); }
      localStorage.setItem('currentUser', username);
      loadSongs();
    };

    async function logoutUser(){
      saveUserProfile();
      if(firebaseAuth){ try{ await firebaseAuth.signOut(); } catch(e){ console.warn('signout',e); } }
      currentUser = null; ownedTracks = []; setlist = []; genreOverrides = {};
      localStorage.removeItem('currentUser');
      showLoginScreen();
    }

    // -------------------- Songs loading -----------------------
    async function loadSongs(){
      console.log('Loading tracks...');
      // Load owned tracks from localStorage first
      const savedOwned = localStorage.getItem('ownedTracks');
      if(savedOwned) {
        try {
          ownedTracks = JSON.parse(savedOwned);
          console.log('Loaded owned tracks:', ownedTracks.length);
        } catch(e) {
          console.warn('Failed to parse ownedTracks', e);
          ownedTracks = [];
        }
      }
      const endpoints=[ 'https://api.allorigins.win/raw?url=https://fortnitecontent-website-prod07.ol.epicgames.com/content/api/pages/fortnite-game/spark-tracks', 'https://corsproxy.io/?https://fortnitecontent-website-prod07.ol.epicgames.com/content/api/pages/fortnite-game/spark-tracks' ];
      for(let i=0;i<endpoints.length;i++){
        try{
          const res = await fetch(endpoints[i]);
          if(!res.ok) continue;
          const data = await res.json();
          songs = Object.entries(data).filter(([k])=>!k.startsWith('_')).map(([id,item])=>{
            const track = item?.track || {};
            if(!track?.tt) return null;
            const detectedGenre = detectGenre(track.an||'', track.tt);
            const finalGenre = genreOverrides[id] || detectedGenre;
            return { id, title: track.tt, artist: track.an || 'Unknown', bpm: Number(track.mt) || 0, key: track.mk || '?', mode:track.mm||'', camelot:convertToCamelot(track.mk||''), duration: Number(track.dn)||0, albumArt: track.au||'', genre: finalGenre };
          }).filter(s=>s && s.bpm>0);
          songs.sort((a,b)=>a.title.localeCompare(b.title));
          if(songs.length>0){ render(); setupEventListeners(); return; }
        }catch(e){ console.warn('endpoint err',e); }
      }
      console.warn('endpoints failed, using fallback sample');
      songs = [
        { id:'s1', title:'Bad Guy', artist:'Billie Eilish', bpm:135, key:'C', mode:'major', camelot:'8B', duration:180, albumArt:'', genre:'Pop'},
        { id:'s2', title:'Need You Tonight', artist:'INXS', bpm:115, key:'C', mode:'minor', camelot:'8A', duration:210, albumArt:'', genre:'Rock'},
        { id:'s3', title:'Electric Night', artist:'Daft Sample', bpm:128, key:'D', mode:'major', camelot:'10B', duration:200, albumArt:'', genre:'Electronic'},
        { id:'s4', title:'Slow Burn', artist:'Indie Star', bpm:95, key:'G', mode:'minor', camelot:'9A', duration:190, albumArt:'', genre:'Indie'},
        { id:'s5', title:'Drop The Bass', artist:'SkrillSample', bpm:142, key:'A', mode:'minor', camelot:'11A', duration:160, albumArt:'', genre:'Electronic'}
      ];
      render(); setupEventListeners();
    }

    // ---------------------- Render list & setlist -----------------------
    function formatDuration(sec){ const m=Math.floor(sec/60); const s=sec%60; return `${m}:${s.toString().padStart(2,'0')}`; }
    function updateOwnedCount(){ const el=document.getElementById('ownedCount'); if(el){ el.textContent = `You own ${ownedTracks.length}/${songs.length} tracks`; } }

    function renderSongList(){
      const filtered = songs.filter(s=>{
        const matchesSearch = !searchTerm || s.title.toLowerCase().includes(searchTerm.toLowerCase()) || s.artist.toLowerCase().includes(searchTerm.toLowerCase());
        const matchesOwned = !showOwnedOnly || ownedTracks.includes(s.id);
        const matchesMixable = !showMixableOnly || !selectedSong || isMixable(selectedSong, s);
        return matchesSearch && matchesOwned && matchesMixable;
      });

      // Sort by BPM proximity if a song is selected
      if(selectedSong) {
        filtered.sort((a,b)=> Math.abs(a.bpm - selectedSong.bpm) - Math.abs(b.bpm - selectedSong.bpm));
      }
      
      const totalPages = Math.ceil(filtered.length / songsPerPage);
      const startIdx = (currentPage - 1) * songsPerPage;
      const endIdx = startIdx + songsPerPage;
      const songsToDisplay = filtered.slice(startIdx, endIdx);
      
      const songListEl = document.getElementById('songList'); if(!songListEl) return;
      songListEl.innerHTML = songsToDisplay.map(song=>{
        const isOwned = ownedTracks.includes(song.id);
        const hasOverride = genreOverrides[song.id];
        const isSelected = selectedSong && selectedSong.id === song.id;
        const comp = selectedSong && selectedSong.id !== song.id ? mashupCompatibility(selectedSong, song) : null;
        const pct = comp ? Math.round(comp.total) : null;
        const glowClass = pct>=80 ? 'glow-perfect' : pct>=60 ? 'glow-good' : (pct!==null ? 'glow-bad' : '');
        
        return `
          <div class="song-card panel p-4 hover:border-cyan-400 transition-all ${isSelected ? 'border-2 border-purple-500' : ''} ${glowClass}" onclick="selectSong('${song.id}')">
            ${isSelected ? '<div class="absolute top-2 left-2 text-xl">üéØ</div>' : ''}
            ${selectedSong && selectedSong.id !== song.id && isMixable(selectedSong,song) ? '<div class="absolute top-2 right-2 text-xl">üéß</div>' : ''}
            <div class="flex flex-col gap-3 mb-3">
              ${song.albumArt ? `<img src="${song.albumArt}" class="w-full aspect-square rounded-lg object-cover"/>` : `<div class="w-full aspect-square bg-gradient-to-br from-purple-500 to-pink-500 rounded-lg"></div>`}
              <div>
                <div class="font-bold text-lg mb-1 text-white line-clamp-2">${song.title}</div>
                <div class="text-gray-300 mb-2 text-sm line-clamp-1">${song.artist}</div>
                <div class="flex items-center gap-2 text-sm flex-wrap mb-2">
                  <button data-genre-tag="${song.id}" data-song-id-genre="${song.id}" class="px-2 py-1 ${hasOverride ? 'bg-green-500/30 border-green-500/50' : 'bg-orange-500/30 border-orange-500/50'} border rounded text-xs ${currentUser && currentUser.username === 'BattleNeBody' ? 'cursor-pointer' : 'cursor-default opacity-75'}" onclick="event.stopPropagation()">${song.genre}${hasOverride ? ' ‚úì' : ''}</button>
                  <span class="px-2 py-1 rounded-lg font-mono font-bold text-white text-xs" style="background:${camelotColors[song.camelot] || '#666'}">${song.camelot}</span>
                  <span class="font-semibold text-cyan-300 text-xs">${song.bpm} BPM</span>
                  ${selectedSong && selectedSong.id !== song.id && isMixable(selectedSong,song) ? `<span class="px-2 py-1 bg-purple-600/40 border border-purple-400/40 rounded text-xs text-purple-200 font-bold">${bpmShiftSuggestion(selectedSong.bpm, song.bpm)}</span>` : ''}
                </div>
              </div>
            </div>
            <div class="flex gap-2">
              <button onclick="event.stopPropagation(); toggleOwned('${song.id}')" class="flex-1 px-3 py-2 ${isOwned ? 'bg-green-500 hover:bg-green-600' : 'bg-gray-700 hover:bg-gray-600'} rounded-lg text-sm font-medium transition">${isOwned ? '‚úì Owned' : 'Mark Owned'}</button>
              <button class="addSetBtn px-3 py-2 bg-gradient-to-r from-purple-500 to-pink-500 rounded-lg text-sm font-medium transition" data-id="${song.id}" onclick="event.stopPropagation()">+ Set</button>
              ${pct !== null ? `<div class="px-3 py-2 score-badge font-bold">${pct}%</div>` : ''}
            </div>
          </div>
        `;
      }).join('');
      
      // Pagination controls
      const paginationContainer = document.getElementById('paginationContainer');
      if(paginationContainer){
        if(totalPages <= 1){
          paginationContainer.innerHTML = '';
        } else {
          const showingStart = startIdx + 1;
          const showingEnd = Math.min(endIdx, filtered.length);
          paginationContainer.innerHTML = `
            <div class="flex items-center justify-center gap-4">
              <button onclick="prevPage()" ${currentPage === 1 ? 'disabled' : ''} class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg font-medium transition disabled:opacity-30 disabled:cursor-not-allowed">‚Äπ Previous</button>
              <div class="text-sm">
                <span class="text-cyan-300 font-bold">Page ${currentPage} of ${totalPages}</span>
                <span class="text-gray-400 ml-2">(${showingStart}-${showingEnd} of ${filtered.length} songs)</span>
              </div>
              <button onclick="nextPage()" ${currentPage === totalPages ? 'disabled' : ''} class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg font-medium transition disabled:opacity-30 disabled:cursor-not-allowed">Next ‚Ä∫</button>
            </div>
          `;
        }
      }
      
      // attach right-click genre handlers
      document.querySelectorAll('[data-song-id-genre]').forEach(btn=>{
        btn.addEventListener('click',(e)=>{ e.stopPropagation(); const songId = btn.getAttribute('data-song-id-genre'); showGenreMenu(songId, e); });
      });
    }

    window.nextPage = () => {
      currentPage++;
      window.scrollTo({ top: 0, behavior: 'smooth' });
      renderSongList();
    };

    window.prevPage = () => {
      currentPage--;
      window.scrollTo({ top: 0, behavior: 'smooth' });
      renderSongList();
    };

    function renderSetlist(){
      const setlistEl = document.getElementById('setlistContent'); if(!setlistEl) return;
      if(setlist.length===0){
        setlistEl.innerHTML = `<div class="text-center py-12"><div class="text-6xl mb-4">üéµ</div><p class="text-xl mb-4 text-white">Your setlist is empty</p><button onclick="switchView('browser')" class="px-6 py-3 bg-gradient-to-r from-purple-500 to-pink-500 rounded-lg font-bold">Browse Tracks</button></div>`;
      } else {
        setlistEl.innerHTML = `<div class="space-y-4">${setlist.map((song,i)=>`<div class="bg-black/40 backdrop-blur-sm border border-gray-700 rounded-xl p-4 flex items-center gap-4 hover:border-cyan-400 transition"><div class="text-2xl font-bold text-pink-400">${i+1}</div>${song.albumArt?`<img src="${song.albumArt}" class="w-16 h-16 rounded-lg"/>`:''}<div class="flex-1"><div class="font-bold text-lg text-white">${song.title}</div><div class="text-gray-300">${song.artist}</div><div class="text-xs text-orange-300">${song.genre}</div></div><div class="text-xl font-mono font-bold" style="color:${camelotColors[song.camelot]}">${song.camelot}</div><button onclick="removeFromSetlist('${song.id}')" class="p-2 hover:bg-red-500/20 rounded text-red-400 text-xl">‚úï</button></div>`).join('')}</div>`;
      }
    }

    function render(){
      const ownedCount = ownedTracks.length;
      document.getElementById('app').innerHTML = `
        <div class="min-h-screen">
          <div class="bg-black/60 backdrop-blur-xl border-b border-cyan-500/30 sticky top-0 z-50 shadow-lg">
            <div class="max-w-7xl mx-auto px-6 py-4">
              <div class="flex items-center justify-between gap-4 mb-4">
                <div class="flex items-center gap-3">
                  <div class="w-12 h-12 bg-gradient-to-br from-pink-500 via-purple-500 to-cyan-500 rounded-lg flex items-center justify-center text-2xl vinyl-spin">üéµ</div>
                  <div>
                    <h1 class="text-2xl font-bold text-white graffiti-text">JAM MIXER</h1>
                    <p id="ownedCount" class="text-xs text-cyan-300 font-semibold">You own ${ownedCount}/${songs.length} tracks</p>
                  </div>
                </div>
                <div class="flex items-center gap-3">
                  <div class="text-right"><div class="text-sm text-pink-300 font-bold">${currentUser?currentUser.djName:''}</div><div class="text-xs text-gray-400">@${currentUser?currentUser.username:''}${Object.keys(genreOverrides).length>0?` ‚Ä¢ ${Object.keys(genreOverrides).length} corrections`:''}</div></div>
                  <button onclick="openHelp()" class="px-3 py-2 bg-white/6 hover:bg-white/12 border border-cyan-500/20 rounded-lg text-cyan-200 text-sm">‚ùì Help</button>
                  <button onclick="logoutUser()" class="px-3 py-2 bg-red-500/20 hover:bg-red-500/30 border border-red-500/50 rounded-lg text-red-300 text-sm">Logout</button>
                </div>
              </div>

              <div class="flex gap-2">
                <button id="browserBtn" class="px-4 py-2 rounded-lg font-medium transition ${view==='browser'?'bg-gradient-to-r from-purple-500 to-pink-500':'bg-white/10 hover:bg-white/20'}">Browse</button>
                <button id="setlistBtn" class="px-4 py-2 rounded-lg font-medium transition ${view==='setlist'?'bg-gradient-to-r from-purple-500 to-pink-500':'bg-white/10 hover:bg-white/20'}">Setlist (<span id="setlistCount">${setlist.length}</span>)</button>
              </div>
            </div>
          </div>

          <div class="max-w-7xl mx-auto px-6 py-6 pb-20">
            <div id="browserView" style="display:${view==='browser'?'block':'none'}">
              <div class="mb-6 space-y-4">
                <div class="relative">
                  <input type="text" id="searchInput" placeholder="üîç Search songs..." class="w-full px-4 py-3 pr-12 bg-black/40 backdrop-blur-sm border border-cyan-500/30 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500"/>
                  <button id="clearSearchBtn" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white transition text-xl" style="display:none;">‚úï</button>
                </div>
                <div class="flex flex-wrap gap-3">
                  <button id="ownedFilterBtn" class="px-4 py-2 rounded-lg font-medium transition ${showOwnedOnly?'bg-gradient-to-r from-green-500 to-emerald-500':'bg-white/10 hover:bg-white/20'}">${showOwnedOnly? '‚úì Owned Only' : 'Show All'}</button>
                  <button id="mixableFilterBtn" class="px-4 py-2 rounded-lg font-medium transition ${showMixableOnly?'bg-gradient-to-r from-blue-500 to-cyan-500':'bg-white/10 hover:bg-white/20'}">${showMixableOnly? 'üéß Mixable Only' : 'Show Mixable'}</button>
                  ${selectedSong ? `<button onclick="clearSelection()" class="px-4 py-2 bg-purple-500/20 hover:bg-purple-500/30 border border-purple-500/50 rounded-lg text-purple-200 text-sm">‚úï Clear Selection</button>` : ''}
                  <button id="markAllBtn" class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg">Mark All Owned</button>
                  <button id="clearAllBtn" class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg">Clear All</button>
                </div>
              </div>
              <div id="songList"></div>
              <div id="paginationContainer" class="text-center mt-6"></div>
            </div>

            <div id="setlistView" style="display:${view==='setlist'?'block':'none'}">
              <div id="setlistContent"></div>
            </div>
          </div>
        </div>
      `;
      if(view==='browser'){ renderSongList(); } else { renderSetlist(); }
    }

    // ------------------ Genre context menu ------------------------
    function showGenreMenu(songId,event){
      if(!currentUser||currentUser.username!=='BattleNeBody'){ alert('üîí Only the admin (BattleNeBody) can correct genre tags!'); return; }
      const existing = document.getElementById('genreContextMenu'); if(existing) existing.remove();
      const menu=document.createElement('div'); menu.id='genreContextMenu'; menu.className='context-menu';
      const rect = event.target.getBoundingClientRect();
      let left=rect.left, top=rect.bottom+5;
      if(left+220>window.innerWidth) left=rect.right-220;
      if(top+300>window.innerHeight) top=rect.top-305;
      menu.style.cssText = `position:fixed;left:${left}px;top:${top}px;background:rgba(0,0,0,0.95);border-radius:8px;padding:8px;z-index:10000;backdrop-filter:blur(8px);border:1px solid rgba(0,217,255,0.12);color:#e6f7ff;`;
      const genres = Object.keys(genreMap).concat(['Other']);
      menu.innerHTML = `<div style="padding:8px 12px;color:#00d9ff;font-weight:bold;border-bottom:1px solid rgba(0,217,255,0.3);margin-bottom:6px;">Select Genre:</div>`;
      genres.forEach(g=>{
        const btn=document.createElement('button'); btn.textContent=g; btn.style.cssText='display:block;width:100%;padding:8px 12px;background:transparent;border:none;text-align:left;color:#e6f7ff;cursor:pointer;';
        btn.addEventListener('click',async()=>{ await setGenreOverride(songId,g); menu.remove(); });
        menu.appendChild(btn);
      });
      document.body.appendChild(menu);
      setTimeout(()=>{ const closeMenu=(e)=>{ if(!menu.contains(e.target)){ menu.remove(); document.removeEventListener('click', closeMenu); } }; document.addEventListener('click', closeMenu); },100);
    }

    window.setGenreOverride = async (songId,newGenre) => {
      if(!currentUser) return;
      genreOverrides[songId] = newGenre;
      const song = songs.find(s=>s.id===songId); if(song) song.genre = newGenre;
      localStorage.setItem('genreOverrides', JSON.stringify(genreOverrides));
      await saveUserProfile();
      renderSongList();
      const genreTag = document.querySelector(`[data-genre-tag="${songId}"]`);
      if(genreTag){ genreTag.textContent = newGenre + ' ‚úì'; genreTag.classList.add('animate-pulse'); setTimeout(()=>genreTag.classList.remove('animate-pulse'),1000); }
    };

    // ------------------ Event listeners and interactions --------------
    function setupEventListeners(){
      const searchInput = document.getElementById('searchInput');
      const clearSearchBtn = document.getElementById('clearSearchBtn');
      if(searchInput && clearSearchBtn){
        searchInput.oninput = (e)=>{ searchTerm = e.target.value; clearSearchBtn.style.display = searchTerm ? 'block' : 'none'; currentPage = 1; renderSongList(); };
        clearSearchBtn.onclick = ()=>{ searchInput.value=''; searchTerm=''; clearSearchBtn.style.display='none'; currentPage = 1; renderSongList(); };
      }
      document.getElementById('browserBtn')?.addEventListener('click', ()=> switchView('browser'));
      document.getElementById('setlistBtn')?.addEventListener('click', ()=> switchView('setlist'));
      document.getElementById('ownedFilterBtn')?.addEventListener('click', toggleOwnedFilter);
      document.getElementById('mixableFilterBtn')?.addEventListener('click', toggleMixableFilter);
      document.getElementById('markAllBtn')?.addEventListener('click', markAllOwned);
      document.getElementById('clearAllBtn')?.addEventListener('click', clearAllOwned);
      document.querySelectorAll('.addSetBtn').forEach(btn=>{ btn.onclick = (e)=>{ e.preventDefault(); e.stopPropagation(); addToSetlist(btn.dataset.id); }; });
    }

    window.selectSong = (id) => {
      selectedSong = songs.find(s=>s.id===id);
      currentPage = 1; // Reset to page 1 when selecting
      render();
      setupEventListeners();
    };

    window.clearSelection = () => {
      selectedSong = null;
      showMixableOnly = false;
      currentPage = 1;
      render();
      setupEventListeners();
    };

    window.toggleMixableFilter = () => {
      if(!selectedSong){ alert('Select a song first to see mixable tracks!'); return; }
      showMixableOnly = !showMixableOnly;
      currentPage = 1;
      render();
      setupEventListeners();
    };

    window.toggleOwned = (id) => {
      if(ownedTracks.includes(id)) ownedTracks = ownedTracks.filter(t=>t!==id); else ownedTracks.push(id);
      localStorage.setItem('ownedTracks', JSON.stringify(ownedTracks));
      saveUserProfile();
      updateOwnedCount();
      renderSongList();
    };

    window.addToSetlist = (id) => {
      const song = songs.find(s=>s.id===id); if(!song) return;
      if(!setlist.find(s=>s.id===id)){
        setlist.push(song);
        localStorage.setItem('setlist', JSON.stringify(setlist));
        const countEl = document.getElementById('setlistCount'); if(countEl) countEl.textContent = setlist.length;
        if(view==='setlist') renderSetlist(); else { if(countEl){ countEl.classList.add('animate-pulse'); setTimeout(()=>countEl.classList.remove('animate-pulse'),800); } }
      }
    };

    window.removeFromSetlist = (id) => {
      setlist = setlist.filter(s=>s.id!==id);
      localStorage.setItem('setlist', JSON.stringify(setlist));
      renderSetlist();
      const countEl = document.getElementById('setlistCount'); if(countEl) countEl.textContent = setlist.length;
    };

    window.switchView = (newView) => {
      view = newView;
      currentPage = 1; // Reset to page 1 when switching views
      document.getElementById('browserView').style.display = view==='browser' ? 'block' : 'none';
      document.getElementById('setlistView').style.display = view==='setlist' ? 'block' : 'none';
      const browserBtn = document.getElementById('browserBtn'); const setlistBtn = document.getElementById('setlistBtn');
      if(browserBtn) browserBtn.className = `px-4 py-2 rounded-lg font-medium transition ${view==='browser'?'bg-gradient-to-r from-purple-500 to-pink-500':'bg-white/10 hover:bg-white/20'}`;
      if(setlistBtn) setlistBtn.className = `px-4 py-2 rounded-lg font-medium transition ${view==='setlist'?'bg-gradient-to-r from-purple-500 to-pink-500':'bg-white/10 hover:bg-white/20'}`;
      if(view==='browser'){ renderSongList(); setupEventListeners(); } else { renderSetlist(); setupEventListeners(); }
    };

    window.toggleOwnedFilter = () => {
      showOwnedOnly = !showOwnedOnly;
      currentPage = 1; // Reset to page 1 when toggling filter
      render();
      setupEventListeners();
    };

    window.markAllOwned = () => {
      if(!confirm(`‚ö†Ô∏è Mark ALL ${songs.length} songs as owned?\nThis will override your current selection!`)) return;
      ownedTracks = songs.map(s=>s.id);
      localStorage.setItem('ownedTracks', JSON.stringify(ownedTracks));
      saveUserProfile(); renderSongList(); updateOwnedCount(); alert(`‚úÖ Marked all ${songs.length} songs as owned!`);
    };

    window.clearAllOwned = () => {
      if(!confirm(`‚ö†Ô∏è CLEAR ALL owned songs?`)) return;
      const count = ownedTracks.length; ownedTracks = []; localStorage.setItem('ownedTracks', JSON.stringify(ownedTracks)); saveUserProfile(); renderSongList(); updateOwnedCount(); alert(`üóëÔ∏è Cleared ${count} owned songs.`);
    };

    // --------------------- Data Management -----------------------
    window.deleteAllData = () => {
      if(!confirm('‚ö†Ô∏è DELETE ALL DATA?\n\nThis will permanently erase:\n‚Ä¢ All owned tracks\n‚Ä¢ All setlists\n‚Ä¢ All genre corrections\n‚Ä¢ Your profile\n\nThis CANNOT be undone.\n\nAre you absolutely sure?')) return;
      
      // Double confirmation
      if(!confirm('This is your last chance.\n\nClick OK to permanently delete everything, or Cancel to keep your data.')) return;
      
      // Clear everything
      localStorage.removeItem('ownedTracks');
      localStorage.removeItem('setlist');
      localStorage.removeItem('genreOverrides');
      localStorage.removeItem('userProfiles');
      localStorage.removeItem('currentUser');
      localStorage.removeItem('hasSeenLanding');
      
      // Reset state
      currentUser = null;
      ownedTracks = [];
      setlist = [];
      genreOverrides = {};
      
      alert('‚úÖ All data has been deleted.\n\nYou will now be returned to the login screen.');
      
      closeHelp();
      showLoginScreen();
    };

    // --------------------- Help modal functions -----------------------
    function openHelp(){ document.getElementById('helpModal').style.display = 'flex'; document.getElementById('helpModal').focus(); }
    function closeHelp(){ document.getElementById('helpModal').style.display = 'none'; }

    // ----------------------- Init / Auth check ------------------------
    function openHelp(){ document.getElementById('helpModal').style.display = 'flex'; document.getElementById('helpModal').focus(); }
    function closeHelp(){ document.getElementById('helpModal').style.display = 'none'; }

    // ----------------------- Init / Auth check ------------------------
    async function checkAuth(){
      const savedUsername = localStorage.getItem('currentUser');
      if(savedUsername){
        const profile = await loadUserProfile(savedUsername);
        if(profile){ currentUser = profile; ownedTracks = profile.ownedTracks || []; genreOverrides = profile.genreOverrides || {}; loadSongs(); return; }
      }
      showLoginScreen();
    }

    if(!localStorage.getItem('hasSeenLanding')) showLandingPage(); else checkAuth();

    // ---------------- Expose some helpers for debugging ----------------
    window.openHelp = openHelp; window.closeHelp = closeHelp; window.render = render; window.loadSongs = loadSongs; window.renderSongList = renderSongList; window.renderSetlist = renderSetlist;
  </script>
</body>
</html>
