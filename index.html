<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Fortnite Festival Pro Mixer ‚Äî Final</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase config injected from Vercel (serverless /api/firebase-config) -->
  <script src="/api/firebase-config"></script>

  <!-- Optional Firebase SDKs (compat). Enable only if you use Firebase. -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <style>
    /* ---------------- Theme & Layout ---------------- */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html,body { height: 100%; }
    body {
      background: linear-gradient(135deg, #0f1020 0%, #14122a 40%, #071130 100%);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color: #e9f7ff;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .content-wrapper { max-width: 1200px; margin: 18px auto; padding: 12px; }
    .panel { background: linear-gradient(180deg, rgba(0,0,0,0.55), rgba(0,0,0,0.45)); border-radius: 12px; border: 1px solid rgba(255,255,255,0.03); padding: 12px; }
    .vinyl-spin { animation: spin 4s linear infinite; }
    .bounce-icon { animation: bounce 2s ease-in-out infinite; }
    @keyframes spin { from { transform: rotate(0) } to { transform: rotate(360deg) } }
    @keyframes bounce { 0%,100% { transform: translateY(0) } 50% { transform: translateY(-8px) } }
    .graffiti-text { text-shadow: 3px 3px 0 #ff6b9d, 6px 6px 0 rgba(255,107,157,0.22); letter-spacing: 1px; }
    .camelot-pill { padding: 6px 10px; border-radius: 10px; font-weight: 700; color: #fff; }
    .score-badge { font-weight: 800; letter-spacing: .6px; padding: 6px 10px; border-radius: 8px; display:inline-block; }
    .small-muted { color: rgba(230,247,255,0.7); font-size: 13px; }
    .energy-bar { height: 12px; border-radius: 8px; background: rgba(255,255,255,0.06); overflow: hidden; }
    .sandbox-drop { min-height: 110px; border-radius: 12px; padding: 10px; border: 2px dashed rgba(255,255,255,0.04); }
    .context-menu { position: fixed; background: rgba(0,0,0,0.95); border-radius: 8px; padding: 8px; z-index:10000; backdrop-filter: blur(8px); border: 1px solid rgba(0,217,255,0.12); color: #e6f7ff; }
    .glow-perfect { box-shadow: 0 0 18px rgba(57,255,20,0.85), 0 0 48px rgba(57,255,20,0.12); }
    .glow-good { box-shadow: 0 0 12px rgba(255,230,65,0.9), 0 0 36px rgba(255,230,65,0.08); }
    .glow-bad { box-shadow: 0 0 12px rgba(255,63,63,0.9), 0 0 36px rgba(255,63,63,0.08); }

    /* Help modal */
    #helpModal {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 20000;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.85);
      backdrop-filter: blur(6px);
    }
    .helpBox {
      width: 92%;
      max-width: 760px;
      height: 80vh;
      background: linear-gradient(180deg, rgba(12,10,25,0.96), rgba(20,16,38,0.98));
      border-radius: 14px;
      border: 2px solid rgba(0,217,255,0.14);
      box-shadow: 0 10px 40px rgba(0,0,0,0.6), 0 0 50px rgba(0,217,255,0.06);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .helpHeader {
      padding: 14px 18px;
      border-bottom: 1px solid rgba(0,217,255,0.06);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .helpTitle { font-size:20px; font-weight:800; color:#fff; display:flex; gap:10px; align-items:center; }
    .helpContent {
      padding: 14px 18px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      color: #dff7ff;
      line-height:1.45;
      font-size:14px;
    }
    .helpFooter { padding: 10px 14px; border-top: 1px solid rgba(0,217,255,0.04); text-align:right; }

    /* Custom neon scrollbar for helpContent */
    .helpContent::-webkit-scrollbar { width: 12px; }
    .helpContent::-webkit-scrollbar-track { background: linear-gradient(180deg, rgba(0,0,0,0.12), rgba(0,0,0,0.06)); border-radius:8px; }
    .helpContent::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, rgba(0,217,255,0.9), rgba(255,107,157,0.9));
      border-radius: 8px;
      border: 2px solid rgba(0,0,0,0.2);
      box-shadow: 0 0 12px rgba(0,217,255,0.14);
    }
    .helpCloseBtn {
      background: linear-gradient(90deg,#ff6b9d,#8b5cf6);
      padding: 8px 12px;
      border-radius: 10px;
      color: #fff;
      font-weight:700;
      cursor:pointer;
      border: none;
      box-shadow: 0 6px 24px rgba(139,92,246,0.12);
    }

    /* responsive tweaks */
    @media (max-width: 980px) {
      .two-col { flex-direction: column; }
      .rightCol { width: 100% !important; min-width: auto; }
    }
  </style>
</head>
<body>
  <div class="content-wrapper">
    <div id="app">
      <div class="min-h-screen flex items-center justify-center">
        <div class="text-center">
          <div class="text-6xl mb-4 animate-pulse">üéµ</div>
          <div class="text-2xl font-bold text-white">Loading Festival Mixer...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Help Modal (outside #app so it persists) -->
  <div id="helpModal" aria-hidden="true">
    <div class="helpBox" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
      <div class="helpHeader">
        <div class="helpTitle" id="helpTitle">
          <div style="width:50px;height:50px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:linear-gradient(90deg,#ff6b9d,#8b5cf6);box-shadow:0 8px 24px rgba(139,92,246,0.12);font-size:22px;">üéß</div>
          <div>
            <div style="font-size:18px;font-weight:800">HELP & FEATURES</div>
            <div style="font-size:12px;color:#bdeeff">Everything the landing page explains ‚Äî available anytime</div>
          </div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="helpCloseBtn" onclick="closeHelp()" aria-label="Close help">‚úï Close</button>
        </div>
      </div>

      <div class="helpContent" id="helpContent">
        <h3 style="font-weight:800;margin-bottom:6px;color:#fff;font-size:16px">Welcome ‚Äî Quick Overview</h3>
        <p class="small-muted">This panel holds the same guidance as the landing page, plus details about new mashup tools. Open it anytime by clicking the ‚ùì Help button in the header.</p>

        <hr style="margin:12px 0;border-color:rgba(0,217,255,0.06)">

        <h4 style="margin-top:8px;font-weight:800;color:#ffb3d1">Mixer Basics</h4>
        <ul style="margin-left:16px;margin-top:6px">
          <li><strong>Mark Owned</strong> ‚Äî Click <em>Mark Owned</em> on a track to mark it in your collection.</li>
          <li><strong>Setlist</strong> ‚Äî Use <em>+ Set</em> to add a track to your setlist. Open the Setlist view to see and reorder your picks.</li>
          <li><strong>Search & Filters</strong> ‚Äî Use the search box, <em>Show Mixable</em> and <em>Show All / ‚úì Owned Only</em> to filter tracks.</li>
          <li><strong>Band Members</strong> ‚Äî Add bandmates to view and combine collections. You cannot edit other members' libraries.</li>
        </ul>

        <h4 style="margin-top:12px;font-weight:800;color:#9fe8ff">Camelot Key & BPM</h4>
        <p class="small-muted">We use the Camelot Wheel for harmonic mixing. Each track shows its Camelot code (e.g., <span style="font-weight:700">8B</span>) and a colored pill. Compatible keys and ¬±1/¬±11 steps blend well.</p>
        <p class="small-muted">BPM is shown on each card. The tool can recommend a BPM shift like <em>+3 BPM = Perfect Match</em>.</p>

        <h4 style="margin-top:12px;font-weight:800;color:#ffd7a6">What is Mixable?</h4>
        <p class="small-muted">Toggling <strong>Show Mixable</strong> filters to tracks compatible with your selected track by key and (optionally) BPM range. Selecting a track does <em>not</em> force the filter ‚Äî you toggle it on/off.</p>

        <h4 style="margin-top:12px;font-weight:800;color:#b0ffc8">Setlist & Sandbox</h4>
        <ul style="margin-left:16px;margin-top:6px">
          <li><strong>Add to setlist</strong> ‚Äî Click <em>+ Set</em>. The Setlist view shows your list. Removing works with the ‚úï button.</li>
          <li><strong>Sandbox</strong> ‚Äî Drag tracks into the sandbox to visualize BPM differences, compatible keys, and energy flow (limit 4 tracks).</li>
        </ul>

        <h4 style="margin-top:12px;font-weight:800;color:#ffd3e0">New Mashup Tools</h4>
        <ul style="margin-left:16px;margin-top:6px">
          <li><strong>Mash-up Compatibility Score</strong> ‚Äî Shows a combined compatibility score (0‚Äì100%) using key (0‚Äì40), BPM (0‚Äì40), and genre (0‚Äì20).</li>
          <li><strong>Auto BPM Suggestion</strong> ‚Äî Displays <em>+N BPM = Perfect Match</em> calculated as otherBpm - selectedBpm.</li>
          <li><strong>Two-Track Preview Panel</strong> ‚Äî Compare two tracks: keys, BPM, energy, tips, and a suggested mash-up recipe.</li>
          <li><strong>Auto-Suggest Transitions</strong> ‚Äî Based on key/BPM/genre, suggestions like <em>Filter sweep + reverb tail ‚Üí chorus</em>.</li>
          <li><strong>Mash-up Recipe Generator</strong> ‚Äî Recommends starting BPM, key-change advice, bars to mix, and techniques.</li>
          <li><strong>AI Mash-up Naming</strong> ‚Äî Fun name suggestions for your mashups.</li>
          <li><strong>Energy Level Graph</strong> ‚Äî Visualize energy (1‚Äì5) across your set or sandbox.</li>
        </ul>

        <h4 style="margin-top:12px;font-weight:800;color:#c5f1ff">Official Festival Jam Mixer Guide</h4>
        <ol style="margin-left:18px;margin-top:6px;line-height:1.6">
          <li><strong>Pick your anchor track</strong> ‚Äî Click a card to lock it in. The list instantly prioritizes the closest matches.</li>
          <li><strong>Choose a priority mode</strong> ‚Äî Use the three Smart Match buttons: BPM, Camelot, or Genre. These act as tiebreakers while keeping the best compatibility score on top.</li>
          <li><strong>Toggle Mixable</strong> ‚Äî Want strict key/BPM filtering? Hit ‚Äúüéß Mixable Only.‚Äù</li>
          <li><strong>Refine</strong> ‚Äî Search, Owned/All, and Genre tags stack with Smart Match to dial in your set.</li>
          <li><strong>Sandbox it</strong> ‚Äî Drag top picks into the Sandbox to visualize energy and compatibility before performing.</li>
        </ol>

        <div style="margin-top:10px;padding:10px;border-radius:10px;background:rgba(0,217,255,0.06);border:1px solid rgba(0,217,255,0.12)">
          <div style="font-weight:800;color:#9fe8ff;margin-bottom:6px">Smart Matching Explained</div>
          <p class="small-muted">Every track gets a compatibility score (key > BPM > genre). Switching modes <em>never</em> breaks that order; it only decides the tie-break. Expect the closest harmonic matches first, then tempo closeness, then genre cohesion.</p>
        </div>

        <h4 style="margin-top:12px;font-weight:800;color:#ffe3b8">Troubleshooting & Tips</h4>
        <ul style="margin-left:16px;margin-top:6px">
          <li><strong>Help won‚Äôt close?</strong> Click outside the panel or press Esc.</li>
          <li><strong>Offline mode</strong> ‚Äî Works with localStorage + export/import. Firebase adds sync; it never removes offline play.</li>
          <li><strong>Reset a view</strong> ‚Äî Clear search, toggle filters off, or hit ‚ÄúShow Mixable‚Äù again.</li>
          <li><strong>Bandmates</strong> ‚Äî You can browse band collections but can‚Äôt edit their owned list.</li>
        </ul>

        <h4 style="margin-top:12px;font-weight:800;color:#b6e0ff">Admin & Genre Overrides</h4>
        <p class="small-muted">Admin (user <strong>BattleNeBody</strong>) can correct genre tags by clicking the genre pill. This opens the genre menu for corrections.</p>

        <h4 style="margin-top:12px;font-weight:800;color:#ffe29a">Export / Import & Firebase</h4>
        <p class="small-muted">By default the app uses localStorage and JSON export/import. If you enable Firebase (email sign-in + Firestore), profiles are saved to Firestore and exports can backup to the Firestore <em>backups</em> collection. Cloud email sending requires server-side functions/extensions (instructions included in the code).</p>

        <hr style="margin:12px 0;border-color:rgba(0,217,255,0.06)">

        <h4 style="margin-top:12px;font-weight:800;color:#ffd0ff">Tips & Pro Tricks</h4>
        <ul style="margin-left:16px;margin-top:6px">
          <li>Mix on phrase boundaries (8/16 bars).</li>
          <li>Use FX (filter/reverb) to hide key clashes on cross-genre mixes.</li>
          <li>When BPM differs by >6, consider tempo ramp or resampling for smoothness.</li>
          <li>Use the sandbox to pre-visualize your energy curve and reorder for build-ups.</li>
        </ul>

        <p class="small-muted" style="margin-top:10px">That's it ‚Äî open this panel anytime via the ‚ùì Help button. Stay in theme and keep the groove alive. üéß</p>
      </div>

      <div class="helpFooter">
        <button class="helpCloseBtn" onclick="closeHelp()">Close</button>
      </div>
    </div>
  </div>

  <script>
    /**************************************************************************
     * Final merged app
     * - All fixes applied (setlist rendering, show-all toggle, mixable toggle, band member)
     * - Optional Firebase (see firebaseEnabled & firebaseConfig)
     * - Help modal integrated (manual open via header button)
     **************************************************************************/

    // -------------------- FIREBASE (auto-detect) ----------------------------
// We auto-enable Firebase if /api/firebase-config injected window.firebaseConfig (Vercel env vars).
// This prevents the "no signup option" problem when firebaseEnabled was left false.
const firebaseConfig = (window.firebaseConfig && window.firebaseConfig.apiKey) ? window.firebaseConfig : null;
const firebaseEnabled = !!firebaseConfig;

let firebaseApp = null, firebaseAuth = null, firestore = null;
let firebaseAuthUnsub = null;
let authSettledUser = null;
let authProcessing = false;
if (firebaseEnabled && window.firebase && firebaseConfig && firebaseConfig.apiKey) {
  try {
    firebaseApp = firebase.initializeApp(firebaseConfig);
    firebaseAuth = firebase.auth();
    firestore = firebase.firestore();
    console.log('Firebase initialized');
  } catch (e) {
    console.warn('Firebase init failed', e);
    firebaseApp = null;
    firebaseAuth = null;
    firestore = null;
  }
}


    // Backend save/load wrappers (Firestore or localStorage)
    async function saveUserProfileToBackend(profile) {
      if (!profile) return;
      const firebaseUser = firebaseAuth?.currentUser;
      const profileKey = profile.uid || firebaseUser?.uid || profile.username;
      if (firestore && firebaseUser && profileKey) {
        try {
          await firestore.collection('users').doc(profileKey).set({ ...profile, uid: profileKey }, { merge: true });
          return true;
        } catch (e) { console.warn('Firestore save failed', e); return false; }
      } else {
        const profiles = JSON.parse(localStorage.getItem('userProfiles') || '{}');
        if (profile.username) profiles[profile.username] = profile;
        if (profileKey) profiles[profileKey] = profile;
        localStorage.setItem('userProfiles', JSON.stringify(profiles));
        return true;
      }
    }
    async function loadUserProfileFromBackend(identifier) {
      if (!identifier && !firebaseAuth?.currentUser) return null;
      const firebaseUser = firebaseAuth?.currentUser;
      const lookupKey = identifier || firebaseUser?.uid;
      if (firestore && lookupKey) {
        try {
          const doc = await firestore.collection('users').doc(lookupKey).get();
          if (doc.exists) return doc.data();
          if (firebaseUser?.email) {
            const emailKey = firebaseUser.email.split('@')[0];
            if (emailKey && emailKey !== lookupKey) {
              const legacyDoc = await firestore.collection('users').doc(emailKey).get();
              if (legacyDoc.exists) return legacyDoc.data();
            }
          }
        } catch (e) { console.warn('Firestore load failed', e); }
      }
      const profiles = JSON.parse(localStorage.getItem('userProfiles') || '{}');
      if (lookupKey && profiles[lookupKey]) return profiles[lookupKey];
      if (firebaseUser?.uid && profiles[firebaseUser.uid]) return profiles[firebaseUser.uid];
      if (firebaseUser?.email) {
        const fallbackName = firebaseUser.email.split('@')[0];
        if (profiles[fallbackName]) return profiles[fallbackName];
      }
      return identifier ? profiles[identifier] || null : null;
    }

    // ---------------------------- Data ------------------------------
    const camelotColors = {
      '1A':'#FF6B9D','1B':'#FF8FAB','2A':'#FFA07A','2B':'#FFB699','3A':'#FFD700','3B':'#FFE55C',
      '4A':'#98D8C8','4B':'#7FD8BE','5A':'#6BCB77','5B':'#8FD89F','6A':'#4D96FF','6B':'#6FB1FF',
      '7A':'#9D4EDD','7B':'#B877FF','8A':'#E84A5F','8B':'#FF6B81','9A':'#00D9FF','9B':'#4DFFFF',
      '10A':'#FFA400','10B':'#FFBB5C','11A':'#FE6D73','11B':'#FF8C94','12A':'#A8E6CF','12B':'#C1F0DD'
    };
    const camelotOverrides = {
      ids: {
        // Example override for known mismatched metadata
        'dont_fear_the_reaper': '8A'
      },
      names: {
        'don‚Äôt fear the reaper|blue √∂yster cult': '8A',
        "don't fear the reaper|blue oyster cult": '8A'
      }
    };
    const keyToCamelot = { 'C':'8B','Am':'8A','A Minor':'8A','C Major':'8B','G':'9B','Em':'9A','E Minor':'9A','G Major':'9B','D':'10B','Bm':'10A','B Minor':'10A','D Major':'10B','A':'11B','F#m':'11A','F# Minor':'11A','A Major':'11B','E':'12B','C#m':'12A','C# Minor':'12A','E Major':'12B','B':'1B','G#m':'1A','G# Minor':'1A','B Major':'1B','F#':'2B','D#m':'2A','D# Minor':'2A','F# Major':'2B','Db':'3B','Bbm':'3A','Bb Minor':'3A','Db Major':'3B','Ab':'4B','Fm':'4A','F Minor':'4A','Ab Major':'4B','Eb':'5B','Cm':'5A','C Minor':'5A','Eb Major':'5B','Bb':'6B','Gm':'6A','G Minor':'6A','Bb Major':'6B','F':'7B','Dm':'7A','D Minor':'7A','F Major':'7B' };

    const genreMap = {
      'Rock': ['foo fighters','nirvana','pearl jam','soundgarden','alice in chains','red hot chili peppers','radiohead','muse','queens of the stone age','rage against the machine'],
      'Classic Rock': ['beatles','rolling stones','led zeppelin','pink floyd','queen','the who','aerosmith'],
      'Alternative': ['green day','blink-182','sum 41','my chemical romance','fall out boy','arctic monkeys','the strokes','the killers'],
      'Punk': ['ramones','sex pistols','the clash'],
      'Metal': ['metallica','megadeth','slayer','anthrax','iron maiden'],
      'Pop': ['taylor swift','ariana grande','billie eilish','dua lipa','lady gaga','katy perry'],
      'Hip-Hop': ['eminem','dr. dre','snoop dogg','2pac','notorious b.i.g','jay-z','nas','kanye west','kendrick lamar','drake'],
      'R&B': ['the weeknd','bruno mars','usher','beyonce','rihanna'],
      'Electronic': ['daft punk','deadmau5','skrillex','diplo','zedd','avicii','calvin harris'],
      'Indie': ['vampire weekend','tame impala','mgmt','arctic monkeys','the strokes'],
      'Country': ['johnny cash','garth brooks','shania twain','tim mcgraw'],
      'Disco/Funk': ['bee gees','donna summer','chic','earth wind & fire','bruno mars'],
      'Blues': ['bb king','muddy waters','howlin wolf'],
      'Jazz': ['miles davis','john coltrane'],
      'Reggae': ['bob marley'],
      'Latin': ['shakira','ricky martin','enrique iglesias'],
      'Soul': ['aretha franklin','otis redding','sam cooke']
    };

    // -------------------------- State -----------------------------
    let currentUser = null;
    let songs = [];
    let ownedTracks = JSON.parse(localStorage.getItem('ownedTracks') || '[]');
    let selectedSong = null;
    let sortMode = 'bpm';
    let previewSong = null;
    let setlist = JSON.parse(localStorage.getItem('setlist') || '[]');
    let searchTerm = '';
    let view = 'browser';
    let showOwnedOnly = false;
    let showMixableOnly = false;
    let selectedGenre = 'All';
    let bandMembers = [];
    let viewingMember = null;
    let genreOverrides = JSON.parse(localStorage.getItem('genreOverrides') || '{}');
    let sandboxTracks = [];
    let sandboxIds = JSON.parse(localStorage.getItem('sandboxTrackIds') || '[]');
    const usernamePattern = /^[A-Za-z0-9_]{3,20}$/;

    // ---------------------- Utils & Scoring -----------------------
    function normalizeMode(mode,keyStr){
      const m=(mode||'').toLowerCase();
      if(m.includes('min')) return 'minor';
      if(m.includes('maj')) return 'major';
      const k=(keyStr||'').toLowerCase();
      if(/m$/.test(k) || k.includes('minor')) return 'minor';
      if(k.includes('major')) return 'major';
      return '';
    }
    function normalizeKeyName(raw){
      if(!raw) return '';
      let cleaned = (raw||'').replace(/major|minor/ig,'').replace(/maj|min/ig,'').trim();
      cleaned = cleaned.replace(/m$/i,'');
      cleaned = cleaned.replace(/[^a-g#b]/ig,'');
      if(!cleaned) return '';
      const first = cleaned[0].toUpperCase();
      const rest = cleaned.slice(1).replace(/b/,'b').replace(/#/,'#');
      return (first + rest);
    }
    function convertToCamelot(key, mode) {
      if (!key && !mode) return '?';
      const modeNormalized = normalizeMode(mode,key);
      const base = normalizeKeyName(key);
      const variants = [];
      const modeWord = modeNormalized === 'minor' ? 'Minor' : 'Major';
      if(base){
        if(modeNormalized){ variants.push(`${base} ${modeWord}`); variants.push(`${base}${modeNormalized==='minor'?'m':''}`); }
        variants.push(base);
      }
      for(const v of variants){ if(keyToCamelot[v]) return keyToCamelot[v]; }
      return '?';
    }
    function deriveCamelotForTrack(track){
      const override = camelotOverrides.ids[track.id] || camelotOverrides.names[`${(track.tt||track.title||'').toLowerCase()}|${(track.an||track.artist||'').toLowerCase()}`];
      const baseKey = normalizeKeyName(track.mk || track.key || '');
      const mode = normalizeMode(track.mm || track.mode || '', track.mk || track.key || '');
      const fallbackMode = mode || (((track.key||'') + (track.mk||'')).toLowerCase().includes('m') ? 'minor' : 'major');
      const camelot = override || convertToCamelot(baseKey || track.mk || track.key || '', fallbackMode);
      const keyLabel = baseKey ? `${baseKey} ${fallbackMode}` : '?';
      return { camelot, keyLabel, mode: fallbackMode };
    }
    function getCompatibleKeys(camelot) {
      if (!camelot || camelot === '?') return [];
      const matches = camelot.match(/^(\d+)([AB])$/);
      if (!matches) return [];
      const num = parseInt(matches[1]); const letter = matches[2];
      const compatible = [camelot, `${num}${letter==='A'?'B':'A'}`];
      const nextNum = num === 12 ? 1 : num + 1; const prevNum = num === 1 ? 12 : num - 1;
      compatible.push(`${nextNum}${letter}`); compatible.push(`${prevNum}${letter}`);
      return compatible;
    }
    function isMixable(song1,song2){ if(!song1||!song2) return false; const compatible = getCompatibleKeys(song1.camelot); return compatible.includes(song2.camelot); }

    function scoreKeyMatch(aCamelot,bCamelot){ if(!aCamelot||!bCamelot||aCamelot==='?'||bCamelot==='?') return 0; if(aCamelot===bCamelot) return 50; const ma=aCamelot.match(/^(\d+)([AB])$/), mb=bCamelot.match(/^(\d+)([AB])$/); if(!ma||!mb) return 0; const numA=parseInt(ma[1]), letterA=ma[2], numB=parseInt(mb[1]), letterB=mb[2]; const ringDiff=Math.min(Math.abs(numA-numB),12-Math.abs(numA-numB)); if(numA===numB&&letterA!==letterB) return 42; if(letterA===letterB&&ringDiff===1) return 38; if(letterA!==letterB&&ringDiff===1) return 30; if(letterA===letterB&&ringDiff===2) return 26; return 14 - Math.min(ringDiff,6); }
    function scoreBpmMatch(aBpm,bBpm){ const diff=Math.abs(aBpm-bBpm); if(diff<=1) return 35; if(diff<=3) return 32; if(diff<=6) return 26; if(diff<=10) return 16; if(diff<=15) return 10; return 0; }
    function scoreGenreMatch(aGenre,bGenre){ if(!aGenre||!bGenre) return 0; return aGenre===bGenre?15:5; }
    function camelotDistance(aCamelot,bCamelot){ if(!aCamelot||!bCamelot||aCamelot==='?'||bCamelot==='?') return 99; const ma=aCamelot.match(/^(\d+)([AB])$/), mb=bCamelot.match(/^(\d+)([AB])$/); if(!ma||!mb) return 99; const numA=parseInt(ma[1]), letterA=ma[2], numB=parseInt(mb[1]), letterB=mb[2]; const numDiff=Math.min(Math.abs(numA-numB),12-Math.abs(numA-numB)); const letterDiff = letterA===letterB ? 0 : 0.5; return numDiff + letterDiff; }
    function mashupCompatibility(a,b){ const key=scoreKeyMatch(a.camelot,b.camelot); const bpm=scoreBpmMatch(a.bpm,b.bpm); const genre=scoreGenreMatch(a.genre,b.genre); const total=key+bpm+genre; return {total,breakdown:{key,bpm,genre}}; }
    function bpmShiftSuggestion(aBpm,bBpm){ const shift=Math.round(bBpm-aBpm); if(shift===0) return 'No change'; return (shift>0?'+':'')+shift+' BPM = Perfect Match'; }
    function computeEnergy(track){ if(!track||!track.bpm) return 3; let e=1; const bpm=track.bpm; if(bpm<90) e=1; else if(bpm<110) e=2; else if(bpm<125) e=3; else if(bpm<140) e=4; else e=5; if(track.genre==='Electronic'||track.genre==='Rock') e=Math.min(5,e+1); return e; }

    // ----------------------- Genre detection -----------------------
    function detectGenre(artist, title){
      artist=(artist||'').toLowerCase(); title=(title||'').toLowerCase();
      for(const [genre,artists] of Object.entries(genreMap)){
        if(artists.some(a=>artist.includes(a) || (a.length>3 && artist.includes(a.split(' ')[0])))) return genre;
      }
      if(title.includes('rock')||title.includes('metal')) return 'Rock';
      if(title.includes('funk')||title.includes('disco')) return 'Disco/Funk';
      if(title.includes('blues')) return 'Blues';
      if(title.includes('jazz')) return 'Jazz';
      if(title.includes('country')) return 'Country';
      if(title.includes('reggae')) return 'Reggae';
      return 'Other';
    }

    // ----------------------- Storage helpers -----------------------
    async function saveUserProfile(){
      if(!currentUser) return;
      const mergedProfile = {
        ...currentUser,
        uid: firebaseAuth?.currentUser?.uid || currentUser.uid,
        username: currentUser.username,
        djName: currentUser.djName,
        ownedTracks,
        setlists: currentUser.setlists || setlist || [],
        setlist: setlist || [],
        bandMembers,
        genreOverrides
      };
      currentUser = mergedProfile;
      localStorage.setItem('ownedTracks', JSON.stringify(ownedTracks));
      localStorage.setItem('genreOverrides', JSON.stringify(genreOverrides));
      localStorage.setItem('setlist', JSON.stringify(setlist));
      const profiles = JSON.parse(localStorage.getItem('userProfiles')||'{}');
      if (mergedProfile.username) profiles[mergedProfile.username] = { ...(profiles[mergedProfile.username]||{}), ...mergedProfile };
      if (mergedProfile.uid) profiles[mergedProfile.uid] = { ...(profiles[mergedProfile.uid]||{}), ...mergedProfile };
      localStorage.setItem('userProfiles', JSON.stringify(profiles));
      await saveUserProfileToBackend(mergedProfile);
    }
    async function loadUserProfile(username){
      if(!username && !firebaseAuth?.currentUser) return null;
      const firebaseUser = firebaseAuth?.currentUser;
      if(firestore && (firebaseUser || username)){
        try{
          const doc = await firestore.collection('users').doc(firebaseUser?.uid || username).get();
          if(doc.exists) return doc.data();
        }catch(e){ console.warn('Firestore load failed',e); }
      }
      const profiles = JSON.parse(localStorage.getItem('userProfiles')||'{}');
      if(firebaseUser?.uid && profiles[firebaseUser.uid]) return profiles[firebaseUser.uid];
      return profiles[username] || null;
    }

    // --------------------- UI: Landing / Auth ------------------------
    function showLandingPage(){
      document.getElementById('app').innerHTML = `
        <div class="min-h-screen py-12 px-6">
          <div class="max-w-6xl mx-auto">
            <div class="text-center mb-16">
              <div class="flex justify-center mb-6">
                <div class="w-32 h-32 bg-gradient-to-br from-pink-500 via-purple-500 to-cyan-500 rounded-full flex items-center justify-center text-6xl vinyl-spin">üéß</div>
              </div>
              <h1 class="text-5xl md:text-6xl font-bold text-white graffiti-text mb-4">FORTNITE FESTIVAL PRO MIXER</h1>
              <p class="text-xl md:text-2xl text-cyan-300 mb-6">Create Epic Mashups & DJ Like a Pro on the Jam Stage!</p>
              <div class="mt-6">
                <button onclick="hideLanding()" class="px-8 py-4 bg-gradient-to-r from-pink-500 via-purple-500 to-cyan-500 rounded-xl font-bold text-white text-xl md:text-2xl bounce-icon shadow-lg">üéµ START MIXING NOW</button>
              </div>
            </div>
            <div class="bg-black/60 backdrop-blur-xl border border-pink-500/30 rounded-2xl p-6 md:p-8 mb-12">
              <div class="flex flex-col lg:flex-row items-center gap-8">
                <div class="flex-shrink-0">
                  <div class="w-28 h-28 camelot-wheel rounded-full" style="background: conic-gradient(from 0deg,#FF6B9D 0deg 30deg,#FFA07A 30deg 60deg,#FFD700 60deg 90deg,#98D8C8 90deg 120deg,#6BCB77 120deg 150deg,#4D96FF 150deg 180deg,#9D4EDD 180deg 210deg,#E84A5F 210deg 240deg,#00D9FF 240deg 270deg,#FFA400 270deg 300deg,#FE6D73 300deg 330deg,#A8E6CF 330deg 360deg); width:140px;height:140px;border-radius:50%;box-shadow:0 0 40px rgba(0,217,255,0.2)"></div>
                  <p class="text-center text-xs text-cyan-300 mt-4">The Camelot Wheel in Action</p>
                </div>
                <div class="flex-1">
                  <h2 class="text-2xl md:text-3xl font-bold text-white mb-4 graffiti-text">üéõÔ∏è The Secret: The Camelot Wheel</h2>
                  <p class="text-gray-300 mb-4 text-base md:text-lg">Professional DJs use the Camelot Wheel to create seamless mashups. It's a color-coded system that shows which songs are harmonically compatible.</p>
                  <div class="space-y-3 text-gray-300 text-sm md:text-base">
                    <div class="flex items-start gap-3"><span class="text-2xl">‚úÖ</span><div><strong class="text-cyan-300">Same Number = Perfect Match!</strong><br/><span class="text-sm">Example: 8B ‚Üí 8B</span></div></div>
                    <div class="flex items-start gap-3"><span class="text-2xl">‚úÖ</span><div><strong class="text-cyan-300">A/B Switch = Energy Shift</strong><br/><span class="text-sm">Example: 8B ‚Üí 8A</span></div></div>
                    <div class="flex items-start gap-3"><span class="text-2xl">‚úÖ</span><div><strong class="text-cyan-300">¬±1 Number = Smooth Blend</strong><br/><span class="text-sm">Example: 8B ‚Üí 9B or 7B</span></div></div>
                  </div>
                </div>
              </div>
            </div>

            <div class="text-center">
              <button onclick="hideLanding()" class="px-8 md:px-12 py-4 md:py-5 bg-gradient-to-r from-pink-500 via-purple-500 to-cyan-500 rounded-xl font-bold text-white text-2xl md:text-3xl shadow-2xl">üéµ LET'S MIX!</button>
            </div>
          </div>
        </div>
      `;
    }
    window.hideLanding = () => { localStorage.setItem('hasSeenLanding','true'); checkAuth(); };

    // -------------------- Login / Profile handlers ---------------------
    function showLoginScreen(){
      // default auth mode
      setTimeout(()=>{ try{ if(window.setAuthMode) window.setAuthMode('signin'); }catch(e){} }, 50);

      document.getElementById('app').innerHTML = `
        <div class="min-h-screen flex items-center justify-center p-6">
          <div class="max-w-md w-full">
            <div class="text-center mb-8">
              <div class="w-24 h-24 bg-gradient-to-br from-pink-500 via-purple-500 to-cyan-500 rounded-full flex items-center justify-center text-5xl mx-auto mb-4 vinyl-spin">üéß</div>
              <h1 class="text-4xl font-bold text-white graffiti-text mb-2">FESTIVAL PRO MIXER</h1>
              <p class="text-cyan-300">Your Personal DJ Profile</p>
            </div>

            <div class="bg-black/60 backdrop-blur-xl border border-cyan-500/30 rounded-2xl p-8 shadow-2xl">
              <h2 class="text-2xl font-bold text-white mb-6 text-center">Sign In / Create Profile</h2>

              ${firebaseEnabled ? `
                <div class="mb-5">
                  <div class="flex gap-2 bg-black/30 p-1 rounded-xl border border-cyan-500/20">
                    <button type="button" id="tabSignIn" onclick="setAuthMode('signin')" class="flex-1 px-3 py-2 rounded-lg font-bold text-white bg-white/10">Already a member</button>
                    <button type="button" id="tabSignUp" onclick="setAuthMode('signup')" class="flex-1 px-3 py-2 rounded-lg font-bold text-white opacity-80">Sign up</button>
                  </div>
                  <p class="text-xs text-gray-300 mt-3 text-center">
                    Cloud sync works after you create an account once. If you just want to use your old saved data, hit <strong>Continue Offline</strong>.
                  </p>
                </div>

                <form onsubmit="handleFirebaseAuth(event)" class="space-y-4" autocomplete="on">
                  <input type="hidden" id="authMode" value="signin" />

                  <div>
                    <label class="block text-sm text-gray-300 mb-2">Email</label>
                    <input id="email" type="email" required placeholder="you@example.com"
                      class="w-full px-4 py-3 bg-black/40 border border-gray-600 rounded-lg text-white" />
                  </div>

                  <div>
                    <label class="block text-sm text-gray-300 mb-2">Password</label>
                    <input id="password" type="password" required minlength="6" placeholder="password"
                      class="w-full px-4 py-3 bg-black/40 border border-gray-600 rounded-lg text-white" />
                  </div>

                  <div id="confirmWrap" style="display:none">
                    <label class="block text-sm text-gray-300 mb-2">Confirm Password</label>
                    <input id="passwordConfirm" type="password" placeholder="confirm password"
                      class="w-full px-4 py-3 bg-black/40 border border-gray-600 rounded-lg text-white" />
                    <p class="text-xs text-gray-400 mt-2">Tip: use at least 6 characters.</p>
                  </div>

                  <div class="flex gap-2">
                    <button type="submit" id="authSubmit"
                      class="flex-1 px-4 py-3 bg-gradient-to-r from-pink-500 to-purple-500 rounded-lg font-bold text-white">
                      Sign In
                    </button>
                    <button type="button" onclick="continueOffline()"
                      class="px-4 py-3 bg-black/50 border border-gray-600 rounded-lg font-bold text-white">
                      Continue Offline
                    </button>
                  </div>

                  <p class="text-xs text-gray-400 text-center">Offline mode is device-only and not tied to any account.</p>

                  <div class="text-center">
                    <button type="button" onclick="forgotPassword()" class="text-xs text-cyan-300 hover:underline">Forgot password?</button>
                  </div>
                </form>
              ` : `
                <form onsubmit="handleLogin(event)" class="space-y-4">
                  <div><label class="block text-sm text-gray-300 mb-2">Username</label><input id="username" type="text" required minlength="3" placeholder="Enter your username" class="w-full px-4 py-3 bg-black/40 border border-gray-600 rounded-lg text-white" /></div>
                  <div><label class="block text-sm text-gray-300 mb-2">DJ Name (optional)</label><input id="djName" type="text" placeholder="e.g., DJ Spinner" class="w-full px-4 py-3 bg-black/40 border border-gray-600 rounded-lg text-white" /></div>
                  <button type="submit" class="w-full px-6 py-3 bg-gradient-to-r from-pink-500 via-purple-500 to-cyan-500 rounded-lg font-bold text-white text-lg">üéµ Enter the Mix</button>
                </form>
              `}
              <div class="mt-6 pt-6 border-t border-gray-700">
                <p class="text-xs text-gray-400 text-center mb-3">üí° Tip: Right-click any song's genre tag to correct it (admin only).</p>
                <p class="text-xs text-gray-400 text-center">‚ö†Ô∏è Epic Games doesn't share inventory; mark songs you own manually.</p>
              </div>
            </div>
          </div>
        </div>
      `;
    }

      // -------------------- Firebase Auth UI helpers ---------------------
    window.setAuthMode = (mode) => {
      const m = (mode === 'signup') ? 'signup' : 'signin';
      const authMode = document.getElementById('authMode');
      if (!authMode) return;
      authMode.value = m;

      const tabIn = document.getElementById('tabSignIn');
      const tabUp = document.getElementById('tabSignUp');
      const confirmWrap = document.getElementById('confirmWrap');
      const submit = document.getElementById('authSubmit');
      const confirmInput = document.getElementById('passwordConfirm');

      if (m === 'signup') {
        if (tabUp) { tabUp.classList.add('bg-white/10'); tabUp.classList.remove('opacity-80'); }
        if (tabIn) { tabIn.classList.remove('bg-white/10'); tabIn.classList.add('opacity-80'); }
        if (confirmWrap) confirmWrap.style.display = 'block';
        if (submit) submit.textContent = 'Create Account';
        if (confirmInput) { confirmInput.required = true; confirmInput.setAttribute('minlength','6'); confirmInput.value = ''; }
      } else {
        if (tabIn) { tabIn.classList.add('bg-white/10'); tabIn.classList.remove('opacity-80'); }
        if (tabUp) { tabUp.classList.remove('bg-white/10'); tabUp.classList.add('opacity-80'); }
        if (confirmWrap) confirmWrap.style.display = 'none';
        if (submit) submit.textContent = 'Sign In';
        if (confirmInput) { confirmInput.required = false; confirmInput.value = ''; }
      }
    };

    function getLocalDeviceId(){
      let localId = localStorage.getItem('localDeviceUserId');
      if(!localId){
        localId = 'local_' + Math.random().toString(36).slice(2,10);
        localStorage.setItem('localDeviceUserId', localId);
      }
      return localId;
    }

    window.continueOffline = () => {
      const username = getLocalDeviceId();
      currentUser = { username, djName: username, ownedTracks: ownedTracks || [], setlists: [], bandMembers: bandMembers || [], genreOverrides: genreOverrides || {} };
      localStorage.setItem('currentUser', currentUser.username);
      loadSongs();
    };

    window.forgotPassword = async () => {
      if (!firebaseAuth) return alert('Firebase not ready yet.');
      const email = (document.getElementById('email')?.value || '').trim();
      if (!email) return alert('Type your email first, then click "Forgot password?"');
      try {
        await firebaseAuth.sendPasswordResetEmail(email);
        alert('Password reset email sent (check inbox/spam).');
      } catch (e) {
        alert('Could not send reset email: ' + (e.message || e));
      }
    };

    function hasMeaningfulData(profile){
      if(!profile) return false;
      return (profile.ownedTracks && profile.ownedTracks.length) ||
        (profile.setlist && profile.setlist.length) ||
        (profile.setlists && profile.setlists.length) ||
        (profile.genreOverrides && Object.keys(profile.genreOverrides).length) ||
        (profile.bandMembers && profile.bandMembers.length);
    }

    async function promptLocalImport(firebaseUsername){
      const localOwned = JSON.parse(localStorage.getItem('ownedTracks') || '[]');
      const localSet = JSON.parse(localStorage.getItem('setlist') || '[]');
      const localGenre = JSON.parse(localStorage.getItem('genreOverrides') || '{}');
      const profiles = JSON.parse(localStorage.getItem('userProfiles') || '{}');

      const candidateProfiles = Object.entries(profiles)
        .filter(([name, data]) => name && name !== firebaseUsername && hasMeaningfulData(data));
      const deviceDataAvailable = (localOwned && localOwned.length) || (localSet && localSet.length) || (localGenre && Object.keys(localGenre).length);
      if(!candidateProfiles.length && !deviceDataAvailable) return null;

      return await new Promise((resolve)=>{
        const modal = document.createElement('div');
        modal.id = 'importModal';
        modal.style.cssText = 'position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.85);z-index:30000;backdrop-filter:blur(6px);padding:12px;';
        const optionsHtml = candidateProfiles.length ?
          `<label class="block text-sm text-gray-200 mb-2">Import from saved profile</label>
            <select id="importProfileSelect" class="w-full px-3 py-2 rounded-lg bg-black/60 border border-cyan-500/30 text-white mb-3">
              ${candidateProfiles.map(([name])=>`<option value="${name}">${name}</option>`).join('')}
            </select>` : '';
        modal.innerHTML = `
          <div class="w-full max-w-md bg-gradient-to-b from-black/85 to-black/90 border border-cyan-500/30 rounded-2xl p-6 text-white shadow-2xl">
            <h3 class="text-xl font-bold mb-2">Import your local data?</h3>
            <p class="text-sm text-gray-200 mb-4">We found local data on this device. Import into this account?</p>
            ${optionsHtml || ''}
            ${deviceDataAvailable ? '<p class="text-xs text-gray-300 mb-4">Tip: If you used this app offline, choose Import to keep your owned songs and setlists.</p>' : ''}
            <div class="flex gap-2 justify-end">
              <button id="importSkip" class="px-4 py-2 rounded-lg bg-gray-700 text-white">Skip</button>
              <button id="importConfirm" class="px-4 py-2 rounded-lg bg-gradient-to-r from-pink-500 to-cyan-500 text-white font-bold">Import</button>
            </div>
          </div>`;
        document.body.appendChild(modal);
        const cleanup = ()=>{ modal.remove(); };
        modal.querySelector('#importSkip').onclick = ()=>{ cleanup(); resolve(null); };
        modal.querySelector('#importConfirm').onclick = ()=>{
          const choice = modal.querySelector('#importProfileSelect')?.value || null;
          cleanup();
          if(choice && profiles[choice]) return resolve(profiles[choice]);
          if(deviceDataAvailable){
            return resolve({
              ownedTracks: localOwned,
              setlist: localSet,
              setlists: localSet,
              genreOverrides: localGenre
            });
          }
          resolve(null);
        };
      });
    }

    async function resolveAuthSuccess(firebaseUser) {
      if (!firebaseUser?.uid) return;
      if (authSettledUser === firebaseUser.uid) return;
      authSettledUser = firebaseUser.uid;
      if (authProcessing) return;
      authProcessing = true;
      try {
        const defaultUsername = firebaseUser.displayName || (firebaseUser.email ? firebaseUser.email.split('@')[0] : `user_${firebaseUser.uid.slice(0,6)}`);
        const existingProfile = await loadUserProfileFromBackend(firebaseUser.uid);
        const shouldOfferImport = !hasMeaningfulData(existingProfile);
        let importedProfile = null;
        if (shouldOfferImport) {
          importedProfile = await promptLocalImport(defaultUsername);
        }

        const profile = existingProfile || {};
        currentUser = {
          ...profile,
          uid: firebaseUser.uid,
          username: profile.username || defaultUsername,
          djName: profile.djName || defaultUsername,
          ownedTracks: importedProfile?.ownedTracks || profile.ownedTracks || ownedTracks || [],
          setlists: importedProfile?.setlists || profile.setlists || setlist || [],
          setlist: importedProfile?.setlist || profile.setlist || profile.setlists || setlist || [],
          bandMembers: importedProfile?.bandMembers || profile.bandMembers || bandMembers || [],
          genreOverrides: importedProfile?.genreOverrides || profile.genreOverrides || genreOverrides || {}
        };
        ownedTracks = currentUser.ownedTracks || [];
        setlist = currentUser.setlist || currentUser.setlists || [];
        bandMembers = currentUser.bandMembers || [];
        genreOverrides = currentUser.genreOverrides || {};
        localStorage.setItem('currentUser', firebaseUser.uid);
        await saveUserProfile();
        loadSongs();
      } finally {
        authProcessing = false;
      }
    }

    function setupFirebaseAuthListener() {
      if (!firebaseAuth || firebaseAuthUnsub) return;
      firebaseAuthUnsub = firebaseAuth.onAuthStateChanged(async (user) => {
        if (user) {
          await resolveAuthSuccess(user);
        }
      });
    }

    async function handleFirebaseAuth(e){
      e.preventDefault();
      if(!firebaseEnabled || !firebaseAuth) return alert('Firebase is not enabled/configured yet.');
      const mode = document.getElementById('authMode')?.value || 'signin';
      const email = (document.getElementById('email')?.value || '').trim();
      const password = (document.getElementById('password')?.value || '').trim();
      const passwordConfirm = document.getElementById('passwordConfirm')?.value || '';

      if(!email || !password) return alert('Enter email & password.');
      if(password.length < 6 && mode === 'signup') return alert('Password must be at least 6 characters.');

      try{
        if(mode === 'signup'){
          if(password !== passwordConfirm) return alert('Passwords do not match.');
          await firebaseAuth.createUserWithEmailAndPassword(email,password);
        } else {
          await firebaseAuth.signInWithEmailAndPassword(email,password);
        }

        setupFirebaseAuthListener();
        await resolveAuthSuccess(firebaseAuth.currentUser);

      } catch(err){
        console.error(err);
        const code = err?.code || '';
        if(code === 'auth/invalid-login-credentials' || code === 'auth/user-not-found' || code === 'auth/wrong-password'){
          alert('Sign-in failed: Email/password not found.\n\nIf this is your first time using email login, click "Sign up" and create the account first.');
        } else if(code === 'auth/email-already-in-use'){
          alert('That email already has an account. Click "Already a member" and sign in.');
        } else {
          alert('Auth failed: ' + (err.message || err));
        }
      }
    }
    window.handleFirebaseAuth = handleFirebaseAuth;

window.handleLogin = async (event) => {
      event.preventDefault();
      const username = document.getElementById('username').value.trim();
      const djName = (document.getElementById('djName').value || username).trim() || username;
      if(username.length<3){ alert('Username must be at least 3 characters'); return; }
      const profile = await loadUserProfile(username);
      if(profile){ currentUser = profile; ownedTracks = profile.ownedTracks || []; bandMembers = profile.bandMembers || []; genreOverrides = profile.genreOverrides || {}; }
      else { currentUser = { username, djName, ownedTracks: [], setlists: [], bandMembers: [], genreOverrides: {} }; await saveUserProfileToBackend(currentUser); }
      localStorage.setItem('currentUser', username);
      loadSongs();
    };

    async function logoutUser(){
      saveUserProfile();
      if(firebaseAuth){ try{ await firebaseAuth.signOut(); } catch(e){ console.warn('signout',e); } }
      authSettledUser = null; authProcessing = false;
      currentUser = null; ownedTracks = []; setlist = []; bandMembers = []; viewingMember = null; genreOverrides = {};
      localStorage.removeItem('currentUser');
      showLoginScreen();
    }

    // -------------------- Songs loading -----------------------
    async function loadSongs(){
      console.log('Loading tracks...');
      const endpoints=[ 'https://api.allorigins.win/raw?url=https://fortnitecontent-website-prod07.ol.epicgames.com/content/api/pages/fortnite-game/spark-tracks', 'https://corsproxy.io/?https://fortnitecontent-website-prod07.ol.epicgames.com/content/api/pages/fortnite-game/spark-tracks' ];
      for(let i=0;i<endpoints.length;i++){
        try{
          const res = await fetch(endpoints[i]);
          if(!res.ok) continue;
          const data = await res.json();
          songs = Object.entries(data).filter(([k])=>!k.startsWith('_')).map(([id,item])=>{
            const track = item?.track || {};
            if(!track?.tt) return null;
            const detectedGenre = detectGenre(track.an||'', track.tt);
            const finalGenre = genreOverrides[id] || detectedGenre;
            const camelotData = deriveCamelotForTrack({ ...track, id });
            return { id, title: track.tt, artist: track.an || 'Unknown', bpm: Number(track.mt) || 0, key: camelotData.keyLabel || (track.mk || '?'), mode: camelotData.mode || (track.mm||''), camelot: camelotData.camelot, duration: Number(track.dn)||0, albumArt: track.au||'', genre: finalGenre };
          }).filter(s=>s && s.bpm>0);
          songs.sort((a,b)=>a.title.localeCompare(b.title));
          if(songs.length>0){ render(); setupEventListeners(); return; }
        }catch(e){ console.warn('endpoint err',e); }
      }
      console.warn('endpoints failed, using fallback sample');
      songs = [
        { id:'s1', title:'Bad Guy', artist:'Billie Eilish', bpm:135, key:'C major', mode:'major', camelot:'8B', duration:180, albumArt:'', genre:'Pop'},
        { id:'s2', title:'Need You Tonight', artist:'INXS', bpm:115, key:'C minor', mode:'minor', camelot:'8A', duration:210, albumArt:'', genre:'Rock'},
        { id:'s3', title:'Electric Night', artist:'Daft Sample', bpm:128, key:'D major', mode:'major', camelot:'10B', duration:200, albumArt:'', genre:'Electronic'},
        { id:'s4', title:'Slow Burn', artist:'Indie Star', bpm:95, key:'G minor', mode:'minor', camelot:'9A', duration:190, albumArt:'', genre:'Indie'},
        { id:'s5', title:'Drop The Bass', artist:'SkrillSample', bpm:142, key:'A minor', mode:'minor', camelot:'11A', duration:160, albumArt:'', genre:'Electronic'}
      ];
      render(); setupEventListeners();
    }

    // ---------------------- Render list & setlist -----------------------
    function formatDuration(sec){ const m=Math.floor(sec/60); const s=sec%60; return `${m}:${s.toString().padStart(2,'0')}`; }
    function updateOwnedCount(){ const el=document.getElementById('ownedCount'); if(el){ const displayTracks = viewingMember ? viewingMember.ownedTracks : ownedTracks; el.textContent = `${viewingMember ? viewingMember.djName : 'You'} own ${displayTracks.length}/${songs.length} tracks`; } }

    function renderSongList(){
      const displayTracks = viewingMember ? viewingMember.ownedTracks : ownedTracks;
      const filtered = songs.filter(s=>{
        if(selectedSong && s.id === selectedSong.id) return false;
        const matchesSearch = !searchTerm || s.title.toLowerCase().includes(searchTerm.toLowerCase()) || s.artist.toLowerCase().includes(searchTerm.toLowerCase());
        const matchesOwned = !showOwnedOnly || displayTracks.includes(s.id);
        const matchesMixable = !showMixableOnly || !selectedSong || isMixable(selectedSong, s);
        const matchesGenre = selectedGenre === 'All' || s.genre === selectedGenre;
        return matchesSearch && matchesOwned && matchesMixable && matchesGenre;
      });

      const scored = filtered.map(song=>{
        const comp = selectedSong ? mashupCompatibility(selectedSong, song) : null;
        const bpmDiff = selectedSong ? Math.abs(song.bpm - selectedSong.bpm) : null;
        const camelotGap = selectedSong ? camelotDistance(selectedSong.camelot, song.camelot) : null;
        const genreTie = selectedSong ? (song.genre === selectedSong.genre ? 0 : 1) : null;
        return { song, comp, bpmDiff, camelotGap, genreTie };
      });

      if(selectedSong){
        scored.sort((a,b)=>{
          const scoreDiff = (b.comp?.total || 0) - (a.comp?.total || 0);
          if(scoreDiff !== 0) return scoreDiff;
          if(sortMode === 'bpm') return (a.bpmDiff ?? 999) - (b.bpmDiff ?? 999);
          if(sortMode === 'camelot') return (a.camelotGap ?? 999) - (b.camelotGap ?? 999);
          if(sortMode === 'genre') {
            if((a.genreTie ?? 2) !== (b.genreTie ?? 2)) return (a.genreTie ?? 2) - (b.genreTie ?? 2);
          }
          return a.song.title.localeCompare(b.song.title);
        });
      } else {
        scored.sort((a,b)=> a.song.title.localeCompare(b.song.title));
      }

      const songListEl = document.getElementById('songList'); if(!songListEl) return;
      songListEl.innerHTML = scored.map(entry=>{
        const song = entry.song;
        const isOwned = displayTracks.includes(song.id);
        const comp = entry.comp;
        const pct = comp ? Math.min(100, Math.max(0, Math.round(comp.total))) : null;
        const hasOverride = genreOverrides[song.id];
        const glowClass = pct>=80 ? 'glow-perfect' : pct>=60 ? 'glow-good' : (pct!==null ? 'glow-bad' : '');
        if(showMixableOnly && selectedSong){
          const bpmOk = Math.abs(song.bpm - selectedSong.bpm) <= 4;
          const keyOk = getCompatibleKeys(selectedSong.camelot).includes(song.camelot);
          if(!bpmOk || !keyOk) return '';
        }
        return `
          <div class="song-card panel p-4 relative hover:border-cyan-400 transition-all" data-song-id="${song.id}" draggable="true">
            <div class="star-icon absolute top-2 right-2 text-xl" style="display:${isOwned?'block':'none'}">‚≠ê</div>
            ${selectedSong && isMixable(selectedSong,song) ? `<div class="absolute top-2 left-2 text-xl">üéß</div>` : ''}
            <div class="flex gap-4 mb-3">
              ${song.albumArt ? `<img src="${song.albumArt}" class="w-20 h-20 rounded-lg cursor-pointer hover:scale-110 transition-transform" onclick="selectSong('${song.id}')"/>` : `<div class="w-20 h-20 bg-gradient-to-br from-purple-500 to-pink-500 rounded-lg"></div>`}
              <div class="flex-1 cursor-pointer" onclick="selectSong('${song.id}')">
                <div class="font-bold text-lg mb-1 text-white">${song.title}</div>
                <div class="text-gray-300 mb-2 text-sm">${song.artist}</div>
                <div class="flex items-center gap-2 text-sm flex-wrap">
                  <button data-genre-tag="${song.id}" data-song-id-genre="${song.id}" class="px-2 py-1 ${hasOverride ? 'bg-green-500/30 border-green-500/50' : 'bg-orange-500/30 border-orange-500/50'} border rounded text-xs ${currentUser && currentUser.username === 'BattleNeBody' ? 'cursor-pointer' : 'cursor-default opacity-75'}">${song.genre}${hasOverride ? ' ‚úì' : ''}</button>
                  <span class="px-3 py-1 rounded-lg font-mono font-bold text-white" style="background:${camelotColors[song.camelot] || '#666'}">${song.camelot}</span>
                  <span class="px-2 py-1 bg-gray-700 rounded text-xs">${song.key}</span>
                  <span class="font-semibold text-cyan-300">${song.bpm} BPM</span>
                  ${selectedSong && isMixable(selectedSong,song) ? `<span class="px-2 py-1 bg-purple-600/40 border border-purple-400/40 rounded text-xs text-purple-200 font-bold">¬±${Math.abs(song.bpm - selectedSong.bpm)} BPM</span>` : ''}
                  <span class="text-gray-400">${formatDuration(song.duration)}</span>
                </div>
              </div>
            </div>
            <div class="flex gap-2">
              <button onclick="toggleOwned('${song.id}')" class="flex-1 px-3 py-2 ${isOwned ? 'bg-green-500 hover:bg-green-600' : 'bg-gray-700 hover:bg-gray-600'} rounded-lg text-sm font-medium transition" ${viewingMember ? 'disabled style="opacity:0.5;cursor:not-allowed;"' : ''}>${isOwned ? '‚úì Owned' : 'Mark Owned'}</button>
              <button class="addSetBtn px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 rounded-lg text-sm font-medium transition" data-id="${song.id}">+ Set</button>
              ${selectedSong ? `<div class="${pct!==null?glowClass:''} ml-2 px-3 py-2 score-badge">${pct!==null?pct+'%':'‚Äî'}</div>` : ''}
            </div>
          </div>
        `;
      }).join('');
      // attach right-click genre handlers
      document.querySelectorAll('[data-song-id-genre]').forEach(btn=>{
        btn.addEventListener('click',(e)=>{ e.stopPropagation(); const songId = btn.getAttribute('data-song-id-genre'); showGenreMenu(songId, e); });
      });
    }

    function renderSetlist(){
      const setlistEl = document.getElementById('setlistContent'); if(!setlistEl) return;
      if(setlist.length===0){
        setlistEl.innerHTML = `<div class="text-center py-12"><div class="text-6xl mb-4">üéµ</div><p class="text-xl mb-4 text-white">Your setlist is empty</p><button onclick="switchView('browser')" class="px-6 py-3 bg-gradient-to-r from-purple-500 to-pink-500 rounded-lg font-bold">Browse Tracks</button></div>`;
      } else {
        setlistEl.innerHTML = `<div class="space-y-4">${setlist.map((song,i)=>`<div class="bg-black/40 backdrop-blur-sm border border-gray-700 rounded-xl p-4 flex items-center gap-4 hover:border-cyan-400 transition"><div class="text-2xl font-bold text-pink-400">${i+1}</div>${song.albumArt?`<img src="${song.albumArt}" class="w-16 h-16 rounded-lg"/>`:''}<div class="flex-1"><div class="font-bold text-lg text-white">${song.title}</div><div class="text-gray-300">${song.artist}</div><div class="text-xs text-orange-300">${song.genre}</div></div><div class="text-xl font-mono font-bold" style="color:${camelotColors[song.camelot]}">${song.camelot}</div><button onclick="removeFromSetlist('${song.id}')" class="p-2 hover:bg-red-500/20 rounded text-red-400 text-xl">‚úï</button></div>`).join('')}</div>`;
      }
    }

    function renderProfile(){
      const profileEl = document.getElementById('profileView'); if(!profileEl) return;
      const email = (firebaseAuth && firebaseAuth.currentUser && firebaseAuth.currentUser.email) ? firebaseAuth.currentUser.email : 'Offline mode (local storage)';
      const usernameVal = currentUser?.username || '';
      const djVal = currentUser?.djName || usernameVal;
      profileEl.innerHTML = `
        <div class="panel max-w-3xl mx-auto space-y-4">
          <div class="text-2xl font-bold text-white">Profile</div>
          <p class="text-sm text-gray-300">Update your DJ identity without leaving the mixer. Username changes migrate your data safely.</p>
          <div class="grid gap-4">
            <div>
              <label class="text-sm text-gray-300">Email</label>
              <div class="px-4 py-3 bg-black/40 border border-gray-700 rounded-lg text-white">${email}</div>
            </div>
            <div>
              <label class="text-sm text-gray-300">Username</label>
              <input id="profileUsername" value="${usernameVal}" class="w-full px-4 py-3 bg-black/40 border border-cyan-500/30 rounded-lg text-white" />
              <p class="text-xs text-gray-400 mt-1">3‚Äì20 characters, letters/numbers/underscore only. No logout needed.</p>
            </div>
            <div>
              <label class="text-sm text-gray-300">DJ Name</label>
              <input id="profileDjName" value="${djVal}" class="w-full px-4 py-3 bg-black/40 border border-purple-500/30 rounded-lg text-white" />
              <p class="text-xs text-gray-400 mt-1">Shown in headers and band views.</p>
            </div>
          </div>
          <div class="flex gap-3 flex-wrap">
            <button onclick="saveProfileSettings()" class="px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 rounded-lg font-bold">Save Profile</button>
            <button onclick="switchView('browser')" class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg">Back to Mixer</button>
          </div>
          <div id="profileStatus" class="text-sm text-cyan-200"></div>
        </div>`;
    }

    function updateBandReferencesLocal(oldUsername,newUsername,newDj){
      const profiles = JSON.parse(localStorage.getItem('userProfiles')||'{}');
      Object.keys(profiles).forEach(key=>{
        const memberList = profiles[key].bandMembers || [];
        const updated = memberList.map(m=> m.username===oldUsername ? { ...m, username:newUsername, djName:newDj } : m);
        profiles[key].bandMembers = updated;
      });
      localStorage.setItem('userProfiles', JSON.stringify(profiles));
      bandMembers = (bandMembers||[]).map(m=> m.username===oldUsername ? { ...m, username:newUsername, djName:newDj } : m);
      currentUser.bandMembers = bandMembers;
    }

    async function migrateUsername(oldUsername,newUsername,newDjName){
      const status = document.getElementById('profileStatus');
      const merged = { ...currentUser, username:newUsername, djName:newDjName, ownedTracks, setlist, setlists:setlist, bandMembers, genreOverrides };
      if(firestore){
        try{
          const oldRef = firestore.collection('users').doc(oldUsername);
          const newRef = firestore.collection('users').doc(newUsername);
          const snap = await oldRef.get();
          const payload = snap.exists ? { ...snap.data(), username:newUsername, djName:newDjName } : merged;
          await newRef.set(payload, { merge:true });
          try{
            const snapshot = await firestore.collection('users').get();
            const batch = firestore.batch();
            let needsCommit = false;
            snapshot.forEach(doc=>{
              const data = doc.data()||{};
              const members = data.bandMembers || [];
              const updated = members.map(m=> m.username===oldUsername ? { ...m, username:newUsername, djName:newDjName } : m);
              const changed = JSON.stringify(updated)!==JSON.stringify(members);
              if(changed){ batch.set(doc.ref,{ bandMembers: updated },{merge:true}); needsCommit=true; }
            });
            if(needsCommit) await batch.commit();
          }catch(err){ console.warn('band member update failed', err); }
          await oldRef.delete().catch(()=>{});
        }catch(e){ if(status) status.textContent = 'Error migrating in Firestore: ' + (e.message||e); throw e; }
      }

      const profiles = JSON.parse(localStorage.getItem('userProfiles')||'{}');
      if(profiles[oldUsername]){
        profiles[newUsername] = { ...profiles[oldUsername], ...merged, username:newUsername, djName:newDjName };
        delete profiles[oldUsername];
      } else {
        profiles[newUsername] = merged;
      }
      localStorage.setItem('userProfiles', JSON.stringify(profiles));
      updateBandReferencesLocal(oldUsername,newUsername,newDjName);
      currentUser = merged;
      localStorage.setItem('currentUser', newUsername);
      await saveUserProfileToBackend(currentUser);
    }

    async function saveProfileSettings(){
      if(!currentUser) return;
      const status = document.getElementById('profileStatus');
      const newUsername = (document.getElementById('profileUsername')?.value || '').trim();
      const newDjName = (document.getElementById('profileDjName')?.value || '').trim() || newUsername;
      const usernameChanged = newUsername !== currentUser.username;
      const djChanged = newDjName !== currentUser.djName;
      if(!usernamePattern.test(newUsername)){
        if(status) status.textContent = 'Username must be 3-20 chars, letters/numbers/underscore only';
        return;
      }
      try{
        if(usernameChanged){
          if(status) status.textContent = 'Migrating profile...';
          await migrateUsername(currentUser.username,newUsername,newDjName);
        } else {
          currentUser.djName = newDjName;
          if(djChanged) updateBandReferencesLocal(currentUser.username,currentUser.username,newDjName);
          await saveUserProfile();
        }
        const msg = usernameChanged ? 'Username updated successfully' : (djChanged ? 'DJ name updated successfully' : 'Profile saved');
        render(); setupEventListeners();
        const statusEl = document.getElementById('profileStatus');
        if(statusEl) statusEl.textContent = msg;
      }catch(e){ const statusEl = document.getElementById('profileStatus'); if(statusEl) statusEl.textContent = 'Error saving profile: ' + (e.message||e); }
    }

    function render(){
      const displayTracks = viewingMember ? viewingMember.ownedTracks : ownedTracks;
      const ownedCount = displayTracks.length;
      document.getElementById('app').innerHTML = `
        <div class="min-h-screen">
          <div class="bg-black/60 backdrop-blur-xl border-b border-cyan-500/30 sticky top-0 z-50 shadow-lg">
            <div class="max-w-7xl mx-auto px-6 py-4">
              <div class="flex items-center justify-between gap-4 mb-4">
                <div class="flex items-center gap-3">
                  <div class="w-12 h-12 bg-gradient-to-br from-pink-500 via-purple-500 to-cyan-500 rounded-lg flex items-center justify-center text-2xl vinyl-spin">üéµ</div>
                  <div>
                    <h1 class="text-2xl font-bold text-white graffiti-text">FESTIVAL PRO MIXER</h1>
                    <p id="ownedCount" class="text-xs text-cyan-300 font-semibold">${viewingMember?viewingMember.djName:'You'} own ${ownedCount}/${songs.length} tracks</p>
                  </div>
                </div>
                <div class="flex items-center gap-3">
                  ${viewingMember?`<button onclick="backToMyProfile()" class="px-3 py-2 bg-purple-500 hover:bg-purple-600 rounded-lg text-sm">‚Üê Back</button>`:`
                    <div class="text-right"><div class="text-sm text-pink-300 font-bold">${currentUser?currentUser.djName:''}</div><div class="text-xs text-gray-400">@${currentUser?currentUser.username:''}${Object.keys(genreOverrides).length>0?` ‚Ä¢ ${Object.keys(genreOverrides).length} corrections`:''}</div></div>
                    <button onclick="openProfileView()" class="px-3 py-2 bg-purple-500/20 hover:bg-purple-500/30 border border-purple-500/50 rounded-lg text-purple-200 text-sm">Profile</button>
                    <button onclick="exportCollection()" class="px-3 py-2 bg-blue-500/20 hover:bg-blue-500/30 border border-blue-500/50 rounded-lg text-blue-300 text-sm">Export</button>
                    <button onclick="importCollection()" class="px-3 py-2 bg-green-500/20 hover:bg-green-500/30 border border-green-500/50 rounded-lg text-green-300 text-sm">Import</button>
                    <button onclick="openHelp()" class="px-3 py-2 bg-white/6 hover:bg-white/12 border border-cyan-500/20 rounded-lg text-cyan-200 text-sm">‚ùì Help</button>
                    <button onclick="logoutUser()" class="px-3 py-2 bg-red-500/20 hover:bg-red-500/30 border border-red-500/50 rounded-lg text-red-300 text-sm">Logout</button>
                  `}
                </div>
              </div>

              ${!viewingMember && bandMembers.length>0 ? `<div class="mb-4"><div class="text-sm text-purple-300 mb-2 font-bold">üé∏ Band Members:</div><div class="flex gap-2 flex-wrap">${bandMembers.map(member=>`<button onclick="viewBandMember('${member.username}')" class="px-3 py-2 bg-purple-500/20 hover:bg-purple-500/30 border border-purple-500/50 rounded-lg text-purple-200 text-sm">${member.djName}</button>`).join('')}<button onclick="addBandMember()" class="px-3 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-sm">+ Add Member</button></div></div>` : !viewingMember?`<div class="mb-4"><button onclick="addBandMember()" class="px-4 py-2 bg-purple-500/20 hover:bg-purple-500/30 border border-purple-500/50 rounded-lg text-purple-200 text-sm">üé∏ + Add Band Member</button></div>` : ''}

              <div class="flex gap-2">
                <button id="browserBtn" class="px-4 py-2 rounded-lg font-medium transition ${view==='browser'?'bg-gradient-to-r from-purple-500 to-pink-500':'bg-white/10 hover:bg-white/20'}">Browse</button>
                <button id="setlistBtn" class="px-4 py-2 rounded-lg font-medium transition ${view==='setlist'?'bg-gradient-to-r from-purple-500 to-pink-500':'bg-white/10 hover:bg-white/20'}">Setlist (<span id="setlistCount">${setlist.length}</span>)</button>
                <button id="profileBtn" class="px-4 py-2 rounded-lg font-medium transition ${view==='profile'?'bg-gradient-to-r from-indigo-500 to-blue-500':'bg-white/10 hover:bg-white/20'}">Profile</button>
              </div>
            </div>
          </div>

          <div class="max-w-7xl mx-auto px-6 py-6 pb-20">
            <div id="browserView" style="display:${view==='browser'?'block':'none'}">
              <div class="mb-6 space-y-4">
                <div class="relative">
                  <input type="text" id="searchInput" placeholder="üîç Quick search (optional)..." class="w-full px-4 py-3 pr-12 bg-black/40 backdrop-blur-sm border border-cyan-500/30 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500"/>
                  <button id="clearSearchBtn" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white transition text-xl" style="display:none;">‚úï</button>
                </div>
                <div class="flex flex-wrap gap-3">
                  <button id="mixableFilterBtn" class="px-4 py-2 rounded-lg font-medium transition ${showMixableOnly?'bg-gradient-to-r from-blue-500 to-cyan-500':'bg-white/10 hover:bg-white/20'}">${showMixableOnly? 'üéß Mixable Only' : 'Show Mixable'}</button>
                  <button id="ownedFilterBtn" class="px-4 py-2 rounded-lg font-medium transition ${showOwnedOnly?'bg-gradient-to-r from-green-500 to-emerald-500':'bg-white/10 hover:bg-white/20'}">${showOwnedOnly? '‚úì Owned Only' : 'Show All'}</button>
                  ${!viewingMember?`<button id="markAllBtn" class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg">Mark All Owned</button><button id="clearAllBtn" class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg">Clear All</button>`:''}
                </div>
                <div class="flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between bg-black/30 border border-cyan-500/10 rounded-xl p-3">
                  <div>
                    <div class="text-sm text-cyan-200 font-semibold">Smart Match Priority</div>
                    <div class="text-xs text-gray-400">Best matches stay on top. Choose what to emphasize as a tiebreaker.</div>
                    ${selectedSong?`<div class="text-xs text-pink-200 mt-1">Selected: <span class="font-semibold">${selectedSong.title}</span> ‚Ä¢ ${selectedSong.camelot} ‚Ä¢ ${selectedSong.bpm} BPM</div>`:''}
                  </div>
                  <div class="flex flex-wrap gap-2">
                    <button onclick="setSortMode('bpm')" class="px-3 py-2 rounded-lg text-sm font-semibold border ${sortMode==='bpm'?'border-cyan-400 bg-cyan-500/20 text-cyan-100':'border-white/10 bg-white/5 text-gray-200'}">Priority: Tempo (BPM)</button>
                    <button onclick="setSortMode('camelot')" class="px-3 py-2 rounded-lg text-sm font-semibold border ${sortMode==='camelot'?'border-pink-400 bg-pink-500/20 text-pink-100':'border-white/10 bg-white/5 text-gray-200'}">Camelot</button>
                    <button onclick="setSortMode('genre')" class="px-3 py-2 rounded-lg text-sm font-semibold border ${sortMode==='genre'?'border-emerald-400 bg-emerald-500/20 text-emerald-100':'border-white/10 bg-white/5 text-gray-200'}">Genre</button>
                  </div>
                </div>
                <div class="grid lg:grid-cols-3 gap-4">
                  <div class="panel lg:col-span-2">
                    <div class="flex items-center justify-between mb-2">
                      <div class="font-bold text-white">Sandbox (drag tracks here)</div>
                      <div class="text-xs text-gray-300">Limit 4 ‚Ä¢ persists locally</div>
                    </div>
                    <div id="sandbox" class="sandbox-drop bg-black/40"></div>
                    <div id="sandboxInfo" class="small-muted mt-2"></div>
                  </div>
                  <div class="panel">
                    <div class="font-bold text-white mb-2">Energy Graph</div>
                    <div id="energyGraph"></div>
                  </div>
                </div>
              </div>
              <div id="songList"></div>
            </div>

            <div id="setlistView" style="display:${view==='setlist'?'block':'none'}">
              <div id="setlistContent"></div>
            </div>
            <div id="profileView" style="display:${view==='profile'?'block':'none'}"></div>
          </div>
        </div>
      `;
      if(view==='browser'){ renderSongList(); sandboxInit(); renderSandbox(); } else if(view==='setlist'){ renderSetlist(); } else { renderProfile(); }
    }

    // ------------------ Genre context menu ------------------------
    function showGenreMenu(songId,event){
      if(!currentUser||currentUser.username!=='BattleNeBody'){ alert('üîí Only the admin (BattleNeBody) can correct genre tags!'); return; }
      const existing = document.getElementById('genreContextMenu'); if(existing) existing.remove();
      const menu=document.createElement('div'); menu.id='genreContextMenu'; menu.className='context-menu';
      const rect = event.target.getBoundingClientRect();
      let left=rect.left, top=rect.bottom+5;
      if(left+220>window.innerWidth) left=rect.right-220;
      if(top+300>window.innerHeight) top=rect.top-305;
      menu.style.left = left+'px'; menu.style.top = top+'px';
      const genres = Object.keys(genreMap).concat(['Other']);
      menu.innerHTML = `<div style="padding:8px 12px;color:#00d9ff;font-weight:bold;border-bottom:1px solid rgba(0,217,255,0.3);margin-bottom:6px;">Select Genre:</div>`;
      genres.forEach(g=>{
        const btn=document.createElement('button'); btn.textContent=g; btn.style.display='block'; btn.style.width='100%'; btn.style.padding='8px 12px'; btn.style.background='transparent'; btn.style.border='none'; btn.style.textAlign='left'; btn.style.color='#e6f7ff'; btn.style.cursor='pointer';
        btn.addEventListener('click',async()=>{ await setGenreOverride(songId,g); menu.remove(); });
        menu.appendChild(btn);
      });
      document.body.appendChild(menu);
      setTimeout(()=>{ const closeMenu=(e)=>{ if(!menu.contains(e.target)){ menu.remove(); document.removeEventListener('click', closeMenu); } }; document.addEventListener('click', closeMenu); },100);
    }

    window.setGenreOverride = async (songId,newGenre) => {
      if(!currentUser) return;
      genreOverrides[songId] = newGenre;
      const song = songs.find(s=>s.id===songId); if(song) song.genre = newGenre;
      localStorage.setItem('genreOverrides', JSON.stringify(genreOverrides));
      await saveUserProfile();
      renderSongList();
      const genreTag = document.querySelector(`[data-genre-tag="${songId}"]`);
      if(genreTag){ genreTag.textContent = newGenre + ' ‚úì'; genreTag.classList.add('animate-pulse'); setTimeout(()=>genreTag.classList.remove('animate-pulse'),1000); }
    };

    // ------------------ Event listeners and interactions --------------
    function setupEventListeners(){
      const searchInput = document.getElementById('searchInput');
      const clearSearchBtn = document.getElementById('clearSearchBtn');
      if(searchInput && clearSearchBtn){
        searchInput.oninput = (e)=>{ searchTerm = e.target.value; clearSearchBtn.style.display = searchTerm ? 'block' : 'none'; renderSongList(); };
        clearSearchBtn.onclick = ()=>{ searchInput.value=''; searchTerm=''; clearSearchBtn.style.display='none'; renderSongList(); };
      }
      document.getElementById('browserBtn')?.addEventListener('click', ()=> switchView('browser'));
      document.getElementById('setlistBtn')?.addEventListener('click', ()=> switchView('setlist'));
      document.getElementById('profileBtn')?.addEventListener('click', ()=> switchView('profile'));
      document.getElementById('mixableFilterBtn')?.addEventListener('click', toggleMixableFilter);
      document.getElementById('ownedFilterBtn')?.addEventListener('click', toggleOwnedFilter);
      if(!viewingMember){ document.getElementById('markAllBtn')?.addEventListener('click', markAllOwned); document.getElementById('clearAllBtn')?.addEventListener('click', clearAllOwned); }
      document.querySelectorAll('.addSetBtn').forEach(btn=>{ btn.onclick = (e)=>{ e.preventDefault(); addToSetlist(btn.dataset.id); }; });
    }

    window.setSortMode = (mode) => {
      sortMode = mode;
      renderSongList();
    };

    window.selectSong = (id) => {
      selectedSong = songs.find(s=>s.id===id);
      const btn = document.getElementById('mixableFilterBtn');
      if(btn){ btn.className = `px-4 py-2 rounded-lg font-medium transition ${showMixableOnly ? 'bg-gradient-to-r from-blue-500 to-cyan-500' : 'bg-white/10 hover:bg-white/20'}`; btn.textContent = showMixableOnly ? 'üéß Mixable Only' : 'Show Mixable'; }
      renderSongList();
    };

    window.clearSelection = () => {
      selectedSong = null;
      const btn = document.getElementById('mixableFilterBtn');
      if(btn){ btn.className = 'px-4 py-2 rounded-lg font-medium transition bg-white/10 hover:bg-white/20'; btn.textContent = 'Show Mixable'; }
      showMixableOnly = false;
      renderSongList();
    };

    window.openProfileView = () => {
      view = 'profile';
      render();
      setupEventListeners();
      renderProfile();
    };

    window.toggleOwned = (id) => {
      if(viewingMember){ alert("You can't edit other people's collections!"); return; }
      if(ownedTracks.includes(id)) ownedTracks = ownedTracks.filter(t=>t!==id); else ownedTracks.push(id);
      localStorage.setItem('ownedTracks', JSON.stringify(ownedTracks));
      saveUserProfile();
      updateOwnedCount();
      renderSongList();
    };

    window.addToSetlist = (id) => {
      const song = songs.find(s=>s.id===id); if(!song) return;
      if(!setlist.find(s=>s.id===id)){
        setlist.push(song);
        localStorage.setItem('setlist', JSON.stringify(setlist));
        const countEl = document.getElementById('setlistCount'); if(countEl) countEl.textContent = setlist.length;
        if(view==='setlist') renderSetlist(); else { if(countEl){ countEl.classList.add('animate-pulse'); setTimeout(()=>countEl.classList.remove('animate-pulse'),800); } }
      }
    };

    window.removeFromSetlist = (id) => {
      setlist = setlist.filter(s=>s.id!==id);
      localStorage.setItem('setlist', JSON.stringify(setlist));
      renderSetlist();
      const countEl = document.getElementById('setlistCount'); if(countEl) countEl.textContent = setlist.length;
    };

    window.switchView = (newView) => {
      view = newView;
      const browserView = document.getElementById('browserView');
      const setlistView = document.getElementById('setlistView');
      const profileView = document.getElementById('profileView');
      if(browserView) browserView.style.display = view==='browser' ? 'block' : 'none';
      if(setlistView) setlistView.style.display = view==='setlist' ? 'block' : 'none';
      if(profileView) profileView.style.display = view==='profile' ? 'block' : 'none';
      const browserBtn = document.getElementById('browserBtn'); const setlistBtn = document.getElementById('setlistBtn'); const profileBtn = document.getElementById('profileBtn');
      if(browserBtn) browserBtn.className = `px-4 py-2 rounded-lg font-medium transition ${view==='browser'?'bg-gradient-to-r from-purple-500 to-pink-500':'bg-white/10 hover:bg-white/20'}`;
      if(setlistBtn) setlistBtn.className = `px-4 py-2 rounded-lg font-medium transition ${view==='setlist'?'bg-gradient-to-r from-purple-500 to-pink-500':'bg-white/10 hover:bg-white/20'}`;
      if(profileBtn) profileBtn.className = `px-4 py-2 rounded-lg font-medium transition ${view==='profile'?'bg-gradient-to-r from-indigo-500 to-blue-500':'bg-white/10 hover:bg-white/20'}`;
      if(view==='browser'){ renderSongList(); setupEventListeners(); sandboxInit(); renderSandbox(); }
      else if(view==='setlist'){ renderSetlist(); setupEventListeners(); }
      else { renderProfile(); setupEventListeners(); }
    };

    window.toggleMixableFilter = () => {
      if(!selectedSong){ alert('Select a song first to see mixable tracks!'); return; }
      showMixableOnly = !showMixableOnly;
      const btn = document.getElementById('mixableFilterBtn');
      if(btn){ btn.className = `px-4 py-2 rounded-lg font-medium transition ${showMixableOnly ? 'bg-gradient-to-r from-blue-500 to-cyan-500' : 'bg-white/10 hover:bg-white/20'}`; btn.textContent = showMixableOnly ? 'üéß Mixable Only' : 'Show Mixable'; }
      renderSongList();
    };

    window.toggleOwnedFilter = () => {
      showOwnedOnly = !showOwnedOnly;
      const btn = document.getElementById('ownedFilterBtn');
      if(btn){ btn.className = `px-4 py-2 rounded-lg font-medium transition ${showOwnedOnly ? 'bg-gradient-to-r from-green-500 to-emerald-500' : 'bg-white/10 hover:bg-white/20'}`; btn.textContent = showOwnedOnly ? '‚úì Owned Only' : 'Show All'; }
      renderSongList();
    };

    window.markAllOwned = () => {
      if(viewingMember) return;
      if(!confirm(`‚ö†Ô∏è Mark ALL ${songs.length} songs as owned?\nThis will override your current selection!`)) return;
      ownedTracks = songs.map(s=>s.id);
      localStorage.setItem('ownedTracks', JSON.stringify(ownedTracks));
      saveUserProfile(); renderSongList(); updateOwnedCount(); alert(`‚úÖ Marked all ${songs.length} songs as owned!`);
    };

    window.clearAllOwned = () => {
      if(viewingMember) return;
      if(!confirm(`‚ö†Ô∏è CLEAR ALL owned songs?`)) return;
      const count = ownedTracks.length; ownedTracks = []; localStorage.setItem('ownedTracks', JSON.stringify(ownedTracks)); saveUserProfile(); renderSongList(); updateOwnedCount(); alert(`üóëÔ∏è Cleared ${count} owned songs.`);
    };

    async function addBandMember(){
      const username = prompt('Enter bandmate username:'); if(!username) return;
      const memberProfile = await loadUserProfile(username); if(!memberProfile){ alert(`‚ùå User "${username}" not found!`); return; }
      if(bandMembers.find(m=>m.username===username)){ alert('This person is already in your band!'); return; }
      bandMembers.push({ username: memberProfile.username, djName: memberProfile.djName }); await saveUserProfile(); alert(`‚úÖ Added ${memberProfile.djName} (@${username}) to your band!`); render(); setupEventListeners();
    }

    async function viewBandMember(username){
      const memberProfile = await loadUserProfile(username); if(!memberProfile) return alert('Could not load member profile');
      viewingMember = memberProfile; render(); setupEventListeners();
    }
    function backToMyProfile(){ viewingMember=null; render(); setupEventListeners(); }

    // --------------------- Preview & two-track (simple) ---------------
    function onPreviewClick(id){
      const b = songs.find(s => s.id === id); if(!selectedSong){ selectedSong = b; renderSongList(); alert('Main track selected. Click Preview on another track to compare.'); return; }
      previewSong = b; displayTwoTrackPreview(selectedSong, previewSong);
    }
    function displayTwoTrackPreview(A,B){
      const comp = mashupCompatibility(A,B); const pct = Math.round(comp.total);
      alert(`${A.title} ‚Üí ${B.title}\nCompatibility: ${pct}%\nBPM diff: ${Math.abs(A.bpm-B.bpm)}\n${bpmShiftSuggestion(A.bpm,B.bpm)}`);
    }

    // -------------------- Sandbox functions --------------------------
    function sandboxInit(){ const el=document.getElementById('sandbox'); if(!el) return; if(!el.dataset.bound){ el.dataset.bound='1'; el.addEventListener('dragover', (e)=>e.preventDefault()); el.addEventListener('drop', (e)=>{ e.preventDefault(); const id=e.dataTransfer.getData('text/plain'); const track = songs.find(s=>s.id===id); if(!track) return; if(sandboxTracks.find(t=>t.id===id)) return; if(sandboxTracks.length>=4){ alert('Sandbox limit: 4 tracks'); return; } sandboxTracks.push(track); renderSandbox(); }); } if(!sandboxTracks.length && sandboxIds.length){ sandboxTracks = sandboxIds.map(id=> songs.find(s=>s.id===id)).filter(Boolean).slice(0,4); } renderSandbox(); }
    function persistSandbox(){ sandboxIds = sandboxTracks.map(t=>t.id); localStorage.setItem('sandboxTrackIds', JSON.stringify(sandboxIds)); }
    function renderSandbox(){ const el=document.getElementById('sandbox'); if(!el) return; el.innerHTML = sandboxTracks.map((t,i)=>`<div class="flex items-center gap-3 panel p-2 mb-2"><div class="w-10 h-10 rounded" style="background:${camelotColors[t.camelot]||'#666'};display:flex;align-items:center;justify-content:center">${t.camelot}</div><div style="flex:1"><div class="font-semibold">${t.title}</div><div class="small-muted text-xs">${t.artist} ‚Ä¢ ${t.genre} ‚Ä¢ ${t.bpm} BPM ‚Ä¢ ${t.key}</div></div><div class="small-muted">${computeEnergy(t)}</div><button class="ml-2 px-2 py-1 bg-red-600/40" onclick="removeSandbox('${t.id}')">‚úï</button></div>`).join('') || `<div class="small-muted p-2">Drop tracks here</div>`; persistSandbox(); const info=document.getElementById('sandboxInfo'); if(sandboxTracks.length===0){ if(info) info.textContent=''; renderEnergyGraph([]); return; } const bpms=sandboxTracks.map(s=>s.bpm); const keys=sandboxTracks.map(s=>s.camelot); const bpmRange=`${Math.min(...bpms)}‚Äì${Math.max(...bpms)}`; const bpmDiffs=bpms.length>1?Math.max(...bpms)-Math.min(...bpms):0; const genreBlend=getGenreBlendScore(sandboxTracks); if(info) info.innerHTML=`BPM range: ${bpmRange} (Œî ${bpmDiffs}) ‚Ä¢ Key set: ${[...new Set(keys)].join(', ')} ‚Ä¢ Genre-blend: ${Math.round(genreBlend*100)}%`; renderEnergyGraph(sandboxTracks); }
    function removeSandbox(id){ sandboxTracks=sandboxTracks.filter(s=>s.id!==id); renderSandbox(); }
    function getGenreBlendScore(list){ if(!list.length) return 0; const counts={}; list.forEach(s=>counts[s.genre]=(counts[s.genre]||0)+1); const max=Math.max(...Object.values(counts)); return max/list.length; }

    function renderEnergyGraph(list){ const container=document.getElementById('energyGraph'); if(!container) return; if(!list||list.length===0){ container.innerHTML='<div class="small-muted">No tracks selected</div>'; return; } container.innerHTML = list.map((t,i)=>{ const e=computeEnergy(t); const pct=(e/5)*100; const color = e>=4 ? 'linear-gradient(90deg,#f97316,#ef4444)' : e>=3 ? 'linear-gradient(90deg,#f59e0b,#f97316)' : 'linear-gradient(90deg,#34d399,#10b981)'; return `<div class="flex items-center gap-3"><div style="width:40px" class="small-muted">${i+1}</div><div style="flex:1"><div class="small-muted text-xs">${t.title} ‚Äî <span style="color:${camelotColors[t.camelot]||'#fff'}">${t.camelot}</span></div><div class="energy-bar mt-1"><div class="energy-fill" style="width:${pct}%;background:${color}"></div></div></div><div style="width:36px" class="text-center font-bold">${e}</div></div>`; }).join('<div style="height:8px"></div>'); }

    // ---------------- Export / Import -------------------------
    async function exportCollection(){
      if(!currentUser) return alert('Login first');
      const data = { username: currentUser.username, djName: currentUser.djName, ownedTracks, genreOverrides, exportDate: new Date().toISOString() };
      if(firestore){
        try{ await firestore.collection('backups').doc(`${currentUser.username}_${Date.now()}`).set(data); alert('Collection backed up to Firestore (backups collection).'); return; } catch(e){ console.warn('Firestore backup failed', e); }
      }
      const blob = new Blob([JSON.stringify(data,null,2)], { type:'application/json' }); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download = `festival-mixer-${currentUser.username}.json`; a.click(); URL.revokeObjectURL(url);
    }
    async function importCollection(){
      if(!currentUser) return alert('Login first');
      const input=document.createElement('input'); input.type='file'; input.accept='.json';
      input.onchange = (e)=>{ const file=e.target.files[0]; const reader=new FileReader(); reader.onload = async (ev)=>{ try{ const data = JSON.parse(ev.target.result); if(!data.ownedTracks) throw new Error('Invalid file'); if(!confirm(`Import ${data.ownedTracks.length} songs from ${data.djName || data.username || 'file'}?`)) return; ownedTracks = data.ownedTracks; if(data.genreOverrides) genreOverrides = {...genreOverrides,...data.genreOverrides}; localStorage.setItem('ownedTracks', JSON.stringify(ownedTracks)); localStorage.setItem('genreOverrides', JSON.stringify(genreOverrides)); await saveUserProfile(); songs.forEach(song=>{ if(genreOverrides[song.id]) song.genre = genreOverrides[song.id]; }); renderSongList(); setupEventListeners(); alert('Collection imported successfully!'); }catch(err){ alert('Invalid file format'); } }; reader.readAsText(file); };
      input.click();
    }

    // --------------------- Help modal functions -----------------------
    function openHelp(){
      const modal = document.getElementById('helpModal');
      if(!modal) return;
      modal.style.display = 'flex';
      modal.setAttribute('aria-hidden','false');
      modal.focus();
    }
    function closeHelp(){
      const modal = document.getElementById('helpModal');
      if(!modal) return;
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden','true');
    }

    const helpModal = document.getElementById('helpModal');
    if(helpModal){
      helpModal.addEventListener('click',(e)=>{ if(e.target === helpModal) closeHelp(); });
    }
    document.addEventListener('keydown',(e)=>{ if(e.key === 'Escape') closeHelp(); });

    // ----------------------- Init / Auth check ------------------------
    async function checkAuth(){
      if (firebaseEnabled && firebaseAuth) {
        setupFirebaseAuthListener();
        const fbUser = firebaseAuth.currentUser;
        if (fbUser) {
          await resolveAuthSuccess(fbUser);
          return;
        }
        const savedUsername = localStorage.getItem('currentUser');
        const localId = localStorage.getItem('localDeviceUserId');
        if(savedUsername && savedUsername === localId){
          const profile = await loadUserProfile(savedUsername);
          if(profile){ currentUser = profile; ownedTracks = profile.ownedTracks || []; bandMembers = profile.bandMembers || []; genreOverrides = profile.genreOverrides || {}; loadSongs(); return; }
        }
        showLoginScreen();
        return;
      }
      const savedUsername = localStorage.getItem('currentUser');
      if(savedUsername){
        const profile = await loadUserProfile(savedUsername);
        if(profile){ currentUser = profile; ownedTracks = profile.ownedTracks || []; bandMembers = profile.bandMembers || []; genreOverrides = profile.genreOverrides || {}; loadSongs(); return; }
      }
      showLoginScreen();
    }

    if(!localStorage.getItem('hasSeenLanding')) showLandingPage(); else checkAuth();

    // ------------------ Drag/drop support ---------------------------
    document.addEventListener('dragstart', (e)=>{ const card = e.target.closest('.song-card'); if(card) e.dataTransfer.setData('text/plain', card.getAttribute('data-song-id')); });
    document.addEventListener('click', (e)=>{ const preview = e.target.closest('.previewBtn'); if(preview){ e.preventDefault(); onPreviewClick(preview.dataset.id); } const addSet = e.target.closest('.addSetBtn'); if(addSet){ e.preventDefault(); addToSetlist(addSet.dataset.id); } });

    // ---------------- Expose some helpers for debugging ----------------
    window.openHelp = openHelp; window.closeHelp = closeHelp; window.render = render; window.loadSongs = loadSongs; window.renderSongList = renderSongList; window.renderSetlist = renderSetlist;
  </script>
</body>
</html>
