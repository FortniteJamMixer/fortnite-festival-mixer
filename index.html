<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Fortnite Festival Pro Mixer ‚Äî Upgraded</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Optional Firebase SDKs (compat) - only required if you enable Firebase.
       If you plan to use Firebase, add your firebaseConfig in the script below.
       Otherwise you can ignore these and the app will use localStorage. -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <style>
    /* --- OG DJ / Breakdance theme preserved & polished --- */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html,body { height: 100%; }
    body {
      background: linear-gradient(135deg, #0f1020 0%, #14122a 40%, #071130 100%);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color: #e9f7ff;
      -webkit-font-smoothing: antialiased;
    }
    .content-wrapper { max-width: 1200px; margin: 18px auto; padding: 12px; }
    .vinyl-spin { animation: spin 4s linear infinite; }
    .bounce-icon { animation: bounce 2s ease-in-out infinite; }
    @keyframes spin { from { transform: rotate(0) } to { transform: rotate(360deg) } }
    @keyframes bounce { 0%,100% { transform: translateY(0) } 50% { transform: translateY(-8px) } }

    .graffiti-text { text-shadow: 3px 3px 0 #ff6b9d, 6px 6px 0 rgba(255,107,157,0.22); letter-spacing: 1px; }
    .panel { background: linear-gradient(180deg, rgba(0,0,0,0.55), rgba(0,0,0,0.45)); border-radius: 12px; border: 1px solid rgba(255,255,255,0.03); padding: 12px; }
    .camelot-pill { padding: 6px 10px; border-radius: 10px; font-weight: 700; color: #fff; }
    .score-badge { font-weight: 800; letter-spacing: .6px; padding: 6px 10px; border-radius: 8px; display:inline-block; }
    .small-muted { color: rgba(230,247,255,0.7); font-size: 13px; }
    .energy-bar { height: 12px; border-radius: 8px; background: rgba(255,255,255,0.06); overflow: hidden; }
    .sandbox-drop { min-height: 110px; border-radius: 12px; padding: 10px; border: 2px dashed rgba(255,255,255,0.04); }
    .context-menu { position: fixed; background: rgba(0,0,0,0.95); border-radius: 8px; padding: 8px; z-index:10000; backdrop-filter: blur(8px); border: 1px solid rgba(0,217,255,0.12); color: #e6f7ff; }
    .glow-perfect { box-shadow: 0 0 18px rgba(57,255,20,0.85), 0 0 48px rgba(57,255,20,0.12); }
    .glow-good { box-shadow: 0 0 12px rgba(255,230,65,0.9), 0 0 36px rgba(255,230,65,0.08); }
    .glow-bad { box-shadow: 0 0 12px rgba(255,63,63,0.9), 0 0 36px rgba(255,63,63,0.08); }

    /* responsive tweaks */
    @media (max-width: 980px) {
      .two-col { flex-direction: column; }
      .rightCol { width: 100% !important; min-width: auto; }
    }

    /* small utility */
    .hidden { display:none!important; }
  </style>
</head>
<body>
  <div class="content-wrapper">
    <div id="app">
      <!-- initial content will be rendered by JS -->
      <div class="min-h-screen flex items-center justify-center">
        <div class="text-center">
          <div class="text-6xl mb-4 animate-pulse">üéµ</div>
          <div class="text-2xl font-bold text-white">Loading Festival Mixer...</div>
        </div>
      </div>
    </div>
  </div>

  <script>
  /*****************************************************************************
   * Festival Pro Mixer ‚Äî Version B (Fixed)
   * - Fixes: setlist rendering, showAll toggle, mixable toggle, add band member
   * - Optional Firebase: email auth + Firestore user profiles (see firebaseEnabled)
   * - Save this file as festival-mixer-updated.html
   *****************************************************************************/

  // -------------------- FIREBASE (optional) ----------------------------
  // To enable Firebase:
  // 1) Set firebaseEnabled = true
  // 2) Replace firebaseConfig with your project's config object
  // 3) In Firebase console enable Email/Password auth and create a Firestore DB
  // 4) Optionally add Cloud Functions or Extensions for welcome emails
  const firebaseEnabled = false; // <<-- set to true after adding config
  const firebaseConfig = {
    // paste your firebase config here, e.g:
    // apiKey: "...",
    // authDomain: "your-app.firebaseapp.com",
    // projectId: "your-app",
    // storageBucket: "your-app.appspot.com",
    // messagingSenderId: "...",
    // appId: "..."
  };

  let firebaseApp = null, firebaseAuth = null, firestore = null;
  if (firebaseEnabled && window.firebase && firebaseConfig.apiKey) {
    try {
      firebaseApp = firebase.initializeApp(firebaseConfig);
      firebaseAuth = firebase.auth();
      firestore = firebase.firestore();
      console.log('Firebase initialized');
    } catch (e) {
      console.warn('Firebase init failed', e);
      firebaseApp = null;
    }
  }

  // Helper wrappers that use Firestore when available, otherwise localStorage
  async function saveUserProfileToBackend(profile) {
    if (!profile) return;
    if (firestore && profile.username) {
      try {
        await firestore.collection('users').doc(profile.username).set(profile, { merge: true });
        return true;
      } catch (e) {
        console.warn('Firestore save failed', e);
        return false;
      }
    } else {
      const profiles = JSON.parse(localStorage.getItem('userProfiles') || '{}');
      profiles[profile.username] = profile;
      localStorage.setItem('userProfiles', JSON.stringify(profiles));
      return true;
    }
  }
  async function loadUserProfileFromBackend(username) {
    if (!username) return null;
    if (firestore) {
      try {
        const doc = await firestore.collection('users').doc(username).get();
        return doc.exists ? doc.data() : null;
      } catch (e) {
        console.warn('Firestore load failed', e);
        return null;
      }
    } else {
      const profiles = JSON.parse(localStorage.getItem('userProfiles') || '{}');
      return profiles[username] || null;
    }
  }

  // ----------------------------- Data maps ------------------------------
  const camelotColors = {
    '1A':'#FF6B9D','1B':'#FF8FAB','2A':'#FFA07A','2B':'#FFB699','3A':'#FFD700','3B':'#FFE55C',
    '4A':'#98D8C8','4B':'#7FD8BE','5A':'#6BCB77','5B':'#8FD89F','6A':'#4D96FF','6B':'#6FB1FF',
    '7A':'#9D4EDD','7B':'#B877FF','8A':'#E84A5F','8B':'#FF6B81','9A':'#00D9FF','9B':'#4DFFFF',
    '10A':'#FFA400','10B':'#FFBB5C','11A':'#FE6D73','11B':'#FF8C94','12A':'#A8E6CF','12B':'#C1F0DD'
  };

  const keyToCamelot = {
    'C':'8B','Am':'8A','A Minor':'8A','C Major':'8B',
    'G':'9B','Em':'9A','E Minor':'9A','G Major':'9B',
    'D':'10B','Bm':'10A','B Minor':'10A','D Major':'10B',
    'A':'11B','F#m':'11A','F# Minor':'11A','A Major':'11B',
    'E':'12B','C#m':'12A','C# Minor':'12A','E Major':'12B',
    'B':'1B','G#m':'1A','G# Minor':'1A','B Major':'1B',
    'F#':'2B','D#m':'2A','D# Minor':'2A','F# Major':'2B',
    'Db':'3B','Bbm':'3A','Bb Minor':'3A','Db Major':'3B',
    'Ab':'4B','Fm':'4A','F Minor':'4A','Ab Major':'4B',
    'Eb':'5B','Cm':'5A','C Minor':'5A','Eb Major':'5B',
    'Bb':'6B','Gm':'6A','G Minor':'6A','Bb Major':'6B',
    'F':'7B','Dm':'7A','D Minor':'7A','F Major':'7B'
  };

  const genreMap = {
    'Rock': ['foo fighters','nirvana','pearl jam','soundgarden','alice in chains','red hot chili peppers','radiohead','muse','queens of the stone age','rage against the machine','audioslave','incubus','weezer','smashing pumpkins'],
    'Classic Rock': ['beatles','rolling stones','led zeppelin','pink floyd','queen','the who','aerosmith','van halen','journey','boston','styx','foreigner'],
    'Alternative': ['green day','blink-182','sum 41','simple plan','good charlotte','my chemical romance','fall out boy','panic! at the disco','twenty one pilots','arctic monkeys','the strokes','the killers'],
    'Punk': ['ramones','sex pistols','the clash','dead kennedys','black flag'],
    'Metal': ['metallica','megadeth','slayer','anthrax','iron maiden','judas priest','pantera','korn','linkin park','tool'],
    'Pop': ['taylor swift','ariana grande','billie eilish','olivia rodrigo','dua lipa','lady gaga','katy perry','miley cyrus','selena gomez','justin bieber','ed sheeran','shawn mendes'],
    'Hip-Hop': ['eminem','dr. dre','snoop dogg','2pac','notorious b.i.g','jay-z','nas','kanye west','kendrick lamar','j. cole','drake','nicki minaj'],
    'R&B': ['the weeknd','bruno mars','usher','john legend','beyonce','rihanna','alicia keys'],
    'Electronic': ['daft punk','deadmau5','skrillex','diplo','marshmello','zedd','avicii','calvin harris','david guetta','tiesto','avicii'],
    'Indie': ['vampire weekend','tame impala','mgmt','arctic monkeys','the strokes','interpol','phoenix','foster the people'],
    'Country': ['johnny cash','garth brooks','kacey mccre', 'shania twain','tim mcgraw'],
    'Disco/Funk': ['bee gees','donna summer','chic','earth wind & fire','bruno mars'],
    'Blues': ['bb king','muddy waters','howlin wolf'],
    'Jazz': ['miles davis','john coltrane','dizzy gillespie'],
    'Reggae': ['bob marley','peter tosh','toots and the maytals'],
    'Latin': ['shakira','ricky martin','enrique iglesias','luis fonsi'],
    'Soul': ['aretha franklin','otis redding','sam cooke','marvin gaye']
  };

  // ----------------------------- State ------------------------------
  let currentUser = null;
  let songs = [];
  let ownedTracks = JSON.parse(localStorage.getItem('ownedTracks')||'[]');
  let selectedSong = null;
  let previewSong = null;
  let setlist = JSON.parse(localStorage.getItem('setlist')||'[]');
  let searchTerm = '';
  let view = 'browser';
  let showOwnedOnly = false;
  let showMixableOnly = false;
  let selectedGenre = 'All';
  let bandMembers = [];
  let viewingMember = null;
  let genreOverrides = JSON.parse(localStorage.getItem('genreOverrides')||'{}');
  let mashupMode = false; // reserved if you want a top-level "Mash-up Mode" toggle

  // ------------------------- Persistence ----------------------------
  async function saveUserProfile() {
    if (!currentUser) return;
    const profile = {
      username: currentUser.username,
      djName: currentUser.djName,
      ownedTracks,
      setlists: currentUser.setlists || [],
      bandMembers,
      genreOverrides
    };
    localStorage.setItem('ownedTracks', JSON.stringify(ownedTracks));
    localStorage.setItem('genreOverrides', JSON.stringify(genreOverrides));
    localStorage.setItem('userProfiles', JSON.stringify({
      ...(JSON.parse(localStorage.getItem('userProfiles')||'{}')),
      [profile.username]: profile
    }));
    // try backend save (if firestore enabled)
    await saveUserProfileToBackend(profile);
  }

  async function loadUserProfile(username) {
    if (!username) return null;
    // try backend first
    if (firestore) {
      try {
        const doc = await firestore.collection('users').doc(username).get();
        if (doc.exists) return doc.data();
      } catch (e) {
        console.warn('Firestore load failed, falling back to local', e);
      }
    }
    const profiles = JSON.parse(localStorage.getItem('userProfiles')||'{}');
    return profiles[username] || null;
  }

  // ----------------------- Landing & Auth UI ------------------------
  function showLandingPage() {
    document.getElementById('app').innerHTML = `
      <div class="min-h-screen py-12 px-6">
        <div class="max-w-6xl mx-auto">
          <div class="text-center mb-16">
            <div class="flex justify-center mb-6">
              <div class="w-32 h-32 bg-gradient-to-br from-pink-500 via-purple-500 to-cyan-500 rounded-full flex items-center justify-center text-6xl vinyl-spin">üéß</div>
            </div>
            <h1 class="text-5xl md:text-6xl font-bold text-white graffiti-text mb-4">FORTNITE FESTIVAL PRO MIXER</h1>
            <p class="text-xl md:text-2xl text-cyan-300 mb-6">Create Epic Mashups & DJ Like a Pro on the Jam Stage!</p>
            <p class="text-lg md:text-xl text-gray-300 max-w-3xl mx-auto mb-8">Anyone can DJ in Fortnite Festival! Use the Jam Stage to mix tracks live in front of thousands. We'll show you exactly which songs blend perfectly together using professional DJ techniques.</p>
            <button onclick="hideLanding()" class="px-8 py-4 bg-gradient-to-r from-pink-500 via-purple-500 to-cyan-500 rounded-xl font-bold text-white text-xl md:text-2xl bounce-icon shadow-lg">üéµ START MIXING NOW</button>
          </div>
          <div class="text-center">
            <h2 class="text-3xl md:text-4xl font-bold text-white mb-4 graffiti-text">READY TO BECOME A FORTNITE DJ?</h2>
            <p class="text-lg md:text-xl text-gray-300 mb-8">Join thousands of players creating epic mashups on the Jam Stage</p>
            <button onclick="hideLanding()" class="px-8 md:px-12 py-4 md:py-5 bg-gradient-to-r from-pink-500 via-purple-500 to-cyan-500 rounded-xl font-bold text-white text-2xl md:text-3xl shadow-2xl">üéµ LET'S MIX!</button>
          </div>
        </div>
      </div>
    `;
  }

  window.hideLanding = () => {
    localStorage.setItem('hasSeenLanding', 'true');
    checkAuth();
  };

  // -------------------------- Login / Profiles -------------------------
  function showLoginScreen() {
    // If firebase is enabled we'll show email & password inputs; otherwise simple username/djName
    document.getElementById('app').innerHTML = `
      <div class="min-h-screen flex items-center justify-center p-6">
        <div class="max-w-md w-full">
          <div class="text-center mb-8">
            <div class="w-24 h-24 bg-gradient-to-br from-pink-500 via-purple-500 to-cyan-500 rounded-full flex items-center justify-center text-5xl mx-auto mb-4 vinyl-spin">üéß</div>
            <h1 class="text-4xl font-bold text-white graffiti-text mb-2">FESTIVAL PRO MIXER</h1>
            <p class="text-cyan-300">Your Personal DJ Profile</p>
          </div>

          <div class="bg-black/60 backdrop-blur-xl border border-cyan-500/30 rounded-2xl p-8 shadow-2xl">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Sign In / Create Profile</h2>

            ${firebaseEnabled ? `
              <form onsubmit="handleFirebaseLogin(event)" class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-300 mb-2">Email</label>
                  <input id="email" type="email" required placeholder="you@example.com" class="w-full px-4 py-3 bg-black/40 border border-gray-600 rounded-lg text-white" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-300 mb-2">Password</label>
                  <input id="password" type="password" required placeholder="password" class="w-full px-4 py-3 bg-black/40 border border-gray-600 rounded-lg text-white" />
                </div>
                <div class="flex gap-2">
                  <button type="submit" class="flex-1 px-4 py-3 bg-gradient-to-r from-pink-500 to-purple-500 rounded-lg font-bold text-white">Sign In</button>
                  <button type="button" onclick="handleFirebaseRegister()" class="px-4 py-3 bg-green-600 rounded-lg font-bold text-white">Register</button>
                </div>
              </form>
            ` : `
              <form onsubmit="handleLogin(event)" class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-300 mb-2">Username</label>
                  <input id="username" type="text" required minlength="3" placeholder="Enter your username" class="w-full px-4 py-3 bg-black/40 border border-gray-600 rounded-lg text-white" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-300 mb-2">DJ Name (optional)</label>
                  <input id="djName" type="text" placeholder="e.g., DJ Spinner" class="w-full px-4 py-3 bg-black/40 border border-gray-600 rounded-lg text-white" />
                </div>

                <button type="submit" class="w-full px-6 py-3 bg-gradient-to-r from-pink-500 via-purple-500 to-cyan-500 rounded-lg font-bold text-white text-lg">üéµ Enter the Mix</button>
              </form>
            `}

            <div class="mt-6 pt-6 border-t border-gray-700">
              <p class="text-xs text-gray-400 text-center mb-3">üí° Tip: Right-click any song's genre tag to correct it (admin only).</p>
              <p class="text-xs text-gray-400 text-center">‚ö†Ô∏è Epic Games doesn't share inventory; mark songs you own manually.</p>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  // Email/password handlers for Firebase (if enabled)
  async function handleFirebaseRegister() {
    if (!firebaseEnabled || !firebaseAuth) return alert('Firebase not enabled/configured');
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    if (!email || !password) return alert('Enter email & password');
    try {
      const cred = await firebaseAuth.createUserWithEmailAndPassword(email, password);
      const username = email.split('@')[0];
      currentUser = { username, djName: username, ownedTracks: [], setlists: [], bandMembers: [], genreOverrides: {} };
      await saveUserProfileToBackend(currentUser);
      localStorage.setItem('currentUser', username);
      checkAuth();
      alert('Registered! Welcome ‚Äî please check your email for verification (if enabled).');
      // Optionally trigger a welcome email via server/cloud function
    } catch (e) {
      console.error(e);
      alert('Registration failed: ' + (e.message || e));
    }
  }

  async function handleFirebaseLogin(e) {
    e.preventDefault();
    if (!firebaseEnabled || !firebaseAuth) return alert('Firebase not enabled/configured');
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    try {
      const res = await firebaseAuth.signInWithEmailAndPassword(email, password);
      const username = email.split('@')[0];
      const profile = await loadUserProfileFromBackend(username);
      if (profile) {
        currentUser = profile;
        ownedTracks = profile.ownedTracks || [];
        bandMembers = profile.bandMembers || [];
        genreOverrides = profile.genreOverrides || {};
      } else {
        currentUser = { username, djName: username, ownedTracks: [], setlists: [], bandMembers: [], genreOverrides: {} };
        await saveUserProfileToBackend(currentUser);
      }
      localStorage.setItem('currentUser', currentUser.username);
      loadSongs();
    } catch (err) {
      console.error(err);
      alert('Sign-in failed: ' + (err.message || err));
    }
  }

  window.handleLogin = async (event) => {
    event.preventDefault();
    const username = document.getElementById('username').value.trim();
    const djName = document.getElementById('djName').value.trim() || username;
    if (username.length < 3) { alert('Username must be at least 3 characters'); return; }
    const profile = await loadUserProfile(username);
    if (profile) {
      currentUser = profile;
      ownedTracks = profile.ownedTracks || [];
      bandMembers = profile.bandMembers || [];
      genreOverrides = profile.genreOverrides || {};
    } else {
      currentUser = { username, djName, ownedTracks: [], setlists: [], bandMembers: [], genreOverrides: {} };
      await saveUserProfileToBackend(currentUser);
    }
    localStorage.setItem('currentUser', username);
    loadSongs();
  };

  async function logoutUser() {
    saveUserProfile();
    if (firebaseAuth) {
      try { await firebaseAuth.signOut(); } catch (e){ console.warn('signout', e); }
    }
    currentUser = null;
    ownedTracks = [];
    setlist = [];
    bandMembers = [];
    viewingMember = null;
    genreOverrides = {};
    localStorage.removeItem('currentUser');
    showLoginScreen();
  }

  async function addBandMember() {
    const username = prompt('Enter bandmate username:');
    if (!username) return;
    const memberProfile = await loadUserProfile(username);
    if (!memberProfile) {
      alert(`‚ùå User "${username}" not found!`);
      return;
    }
    if (bandMembers.find(m => m.username === username)) {
      alert('This person is already in your band!');
      return;
    }
    bandMembers.push({ username: memberProfile.username, djName: memberProfile.djName });
    await saveUserProfile();
    alert(`‚úÖ Added ${memberProfile.djName} (@${username}) to your band!`);
    render();
    setupEventListeners();
  }

  async function viewBandMember(username) {
    const memberProfile = await loadUserProfile(username);
    if (!memberProfile) return alert('Could not load member profile');
    viewingMember = memberProfile;
    render();
    setupEventListeners();
  }
  function backToMyProfile() { viewingMember = null; render(); setupEventListeners(); }

  // ----------------------- Genre detection & overrides --------------------
  function detectGenre(artist, title) {
    artist = (artist || '').toLowerCase();
    title = (title || '').toLowerCase();
    for (const [genre, artists] of Object.entries(genreMap)) {
      if (artists.some(a => artist.includes(a) || (a.length > 3 && artist.includes(a.split(' ')[0])))) {
        return genre;
      }
    }
    if (title.includes('rock') || title.includes('metal')) return 'Rock';
    if (title.includes('funk') || title.includes('disco')) return 'Disco/Funk';
    if (title.includes('blues')) return 'Blues';
    if (title.includes('jazz')) return 'Jazz';
    if (title.includes('country')) return 'Country';
    if (title.includes('reggae')) return 'Reggae';
    return 'Other';
  }

  window.setGenreOverride = async (songId, newGenre) => {
    if (!currentUser) return;
    genreOverrides[songId] = newGenre;
    const song = songs.find(s => s.id === songId);
    if (song) song.genre = newGenre;
    localStorage.setItem('genreOverrides', JSON.stringify(genreOverrides));
    await saveUserProfile();
    renderSongList();
    const genreTag = document.querySelector(`[data-genre-tag="${songId}"]`);
    if (genreTag) {
      genreTag.textContent = newGenre + ' ‚úì';
      genreTag.classList.add('animate-pulse');
      setTimeout(() => genreTag.classList.remove('animate-pulse'), 1000);
    }
  };

  // --------------------------- Load Songs -------------------------------
  function convertToCamelot(key, mode) {
    if (!key) return '?';
    const cleaned = key.trim();
    return keyToCamelot[cleaned] || '?';
  }

  function getCompatibleKeys(camelot) {
    if (!camelot || camelot === '?') return [];
    const matches = camelot.match(/^(\d+)([AB])$/);
    if (!matches) return [];
    const num = parseInt(matches[1]);
    const letter = matches[2];
    const compatible = [camelot, `${num}${letter === 'A' ? 'B' : 'A'}`];
    const nextNum = num === 12 ? 1 : num + 1;
    compatible.push(`${nextNum}${letter}`);
    const prevNum = num === 1 ? 12 : num - 1;
    compatible.push(`${prevNum}${letter}`);
    return compatible;
  }

  function isMixable(song1, song2) {
    if (!song1 || !song2) return false;
    const compatible = getCompatibleKeys(song1.camelot);
    return compatible.includes(song2.camelot);
  }

  async function loadSongs() {
    console.log('üéµ Loading Fortnite Festival tracks...');
    const endpoints = [
      'https://api.allorigins.win/raw?url=https://fortnitecontent-website-prod07.ol.epicgames.com/content/api/pages/fortnite-game/spark-tracks',
      'https://corsproxy.io/?https://fortnitecontent-website-prod07.ol.epicgames.com/content/api/pages/fortnite-game/spark-tracks'
    ];
    for (let i = 0; i < endpoints.length; i++) {
      try {
        console.log(`Trying endpoint ${i+1}...`);
        const res = await fetch(endpoints[i]);
        console.log('Status', res.status);
        if (!res.ok) continue;
        const data = await res.json();
        songs = Object.entries(data)
          .filter(([key]) => !key.startsWith('_'))
          .map(([id, item]) => {
            const track = item?.track || {};
            if (!track?.tt) return null;
            const detectedGenre = detectGenre(track.an || '', track.tt);
            const finalGenre = genreOverrides[id] || detectedGenre;
            return {
              id,
              title: track.tt,
              artist: track.an || 'Unknown',
              bpm: Number(track.mt) || 0,
              key: track.mk || '?',
              mode: track.mm || '',
              camelot: convertToCamelot(track.mk || '', track.mm || ''),
              duration: Number(track.dn) || 0,
              albumArt: track.au || '',
              genre: finalGenre
            };
          })
          .filter(s => s && s.bpm > 0);
        songs.sort((a,b)=>a.title.localeCompare(b.title));
        if (songs.length > 0) {
          console.log(`Loaded ${songs.length} tracks`);
          render();
          setupEventListeners();
          return;
        }
      } catch (err) {
        console.warn('Endpoint error', err);
      }
    }
    // fallback sample
    console.warn('All endpoints failed ‚Äî using fallback sample');
    songs = [
      { id:'s1', title:'Bad Guy', artist:'Billie Eilish', bpm:135, key:'C', mode:'major', camelot:'8B', duration:180, albumArt:'', genre:'Pop'},
      { id:'s2', title:'Need You Tonight', artist:'INXS', bpm:115, key:'C', mode:'minor', camelot:'8A', duration:210, albumArt:'', genre:'Rock'},
      { id:'s3', title:'Electric Night', artist:'Daft Sample', bpm:128, key:'D', mode:'major', camelot:'10B', duration:200, albumArt:'', genre:'Electronic'},
      { id:'s4', title:'Slow Burn', artist:'Indie Star', bpm:95, key:'G', mode:'minor', camelot:'9A', duration:190, albumArt:'', genre:'Indie'},
      { id:'s5', title:'Drop The Bass', artist:'SkrillSample', bpm:142, key:'A', mode:'minor', camelot:'11A', duration:160, albumArt:'', genre:'Electronic'}
    ];
    render();
    setupEventListeners();
  }

  // ------------------- Compatibility & Scoring --------------------------
  function scoreKeyMatch(aCamelot, bCamelot) {
    if (!aCamelot || !bCamelot || aCamelot === '?' || bCamelot === '?') return 0;
    if (aCamelot === bCamelot) return 40;
    const ma = aCamelot.match(/^(\d+)([AB])$/), mb = bCamelot.match(/^(\d+)([AB])$/);
    if (!ma || !mb) return 0;
    const numA = parseInt(ma[1]), letterA = ma[2], numB = parseInt(mb[1]), letterB = mb[2];
    if (numA === numB && letterA !== letterB) return 30;
    if (letterA === letterB && (Math.abs(numA-numB) === 1 || Math.abs(numA-numB) === 11)) return 30;
    if (Math.abs(numA-numB) === 1 && letterA !== letterB) return 20;
    return 0;
  }
  function scoreBpmMatch(aBpm, bBpm) {
    const diff = Math.abs(aBpm - bBpm);
    if (diff <= 1) return 40;
    if (diff <= 3) return 35;
    if (diff <= 6) return 25;
    if (diff <= 10) return 15;
    return 0;
  }
  function scoreGenreMatch(aGenre, bGenre) {
    if (!aGenre || !bGenre) return 0;
    return aGenre === bGenre ? 20 : 0;
  }
  function mashupCompatibility(a, b) {
    const key = scoreKeyMatch(a.camelot, b.camelot);
    const bpm = scoreBpmMatch(a.bpm, b.bpm);
    const genre = scoreGenreMatch(a.genre, b.genre);
    const total = key + bpm + genre; // max 100
    return { total, breakdown: { key, bpm, genre } };
  }
  function bpmShiftSuggestion(aBpm, bBpm) {
    const shift = Math.round(bBpm - aBpm);
    if (shift === 0) return 'No change';
    return (shift > 0 ? '+' : '') + shift + ' BPM = Perfect Match';
  }
  function computeEnergy(track) {
    if (!track || !track.bpm) return 3;
    let e = 1;
    const bpm = track.bpm;
    if (bpm < 90) e = 1;
    else if (bpm < 110) e = 2;
    else if (bpm < 125) e = 3;
    else if (bpm < 140) e = 4;
    else e = 5;
    if (track.genre === 'Electronic' || track.genre === 'Rock') e = Math.min(5, e+1);
    return e;
  }

  // ------------------ Transition & Recipe ------------------------------
  function suggestTransitions(a, b) {
    const tips = [];
    const diff = b.bpm - a.bpm;
    const keyScore = scoreKeyMatch(a.camelot, b.camelot);
    if (Math.abs(diff) > 6) tips.push('Consider a slow tempo ramp (warp) before mixing; large BPM change.');
    if (Math.abs(diff) <= 3) tips.push('Minimal warp ‚Äî you can beatmatch without heavy time-stretching.');
    if (diff > 0) tips.push('Try speeding track A gradually (+pitch) into B.');
    if (diff < 0) tips.push('Try a short pitch-down / echo into the slower track.');
    if (keyScore >= 40) tips.push('Perfect harmonic match ‚Äî consider a clean beatmix.');
    else if (keyScore >= 30) tips.push('Good harmonic relation ‚Äî try a filter + reverb tail into chorus.');
    else tips.push('Potential key clash ‚Äî use filter sweep + reverb tail or consider key transposition.');
    if (a.genre !== b.genre) tips.push('Cross-genre blend: keep drums and add FX to glue textures.');
    tips.push('Try mixing at phrase boundary (16 bars) or on the chorus drop.');
    const examples = ['Spinback from chorus into beat drop', 'Filter sweep + reverb tail ‚Üí chorus entry', 'Keep drums playing for first 4 bars'];
    tips.push('Examples: ' + examples.slice(0,2).join(' ‚Ä¢ '));
    return tips;
  }

  function generateRecipe(a, b) {
    const bpm = Math.round((a.bpm + b.bpm)/2);
    const keyChange = (a.camelot === b.camelot) ? 'No key change' : `Consider ${a.camelot} ‚Üí ${b.camelot} (transpose)`;
    const bars = 'Mix at 16 bars into verse (8 bars if energetic)';
    const techniques = [];
    if (a.genre === b.genre) techniques.push('Simple beatmix, minimal FX');
    else techniques.push('Filter glue + reverb tails to blend textures');
    if (Math.abs(a.bpm - b.bpm) > 6) techniques.push('Tempo ramp or resampling for smoother transition');
    const name = aiNameGenerator(a,b);
    return { bpm, keyChange, bars, techniques, name };
  }

  function aiNameGenerator(a,b) {
    const toksA = (a.title || a.artist).split(' ').slice(0,2).map(t => t.replace(/[^a-zA-Z0-9]/g,''));
    const toksB = (b.title || b.artist).split(' ').slice(0,2).map(t => t.replace(/[^a-zA-Z0-9]/g,''));
    const combos = [
      `${toksA[0] || a.artist} ${toksB[0] || b.artist}`,
      `${toksB[0] || b.artist} vs ${toksA[0] || a.artist}`,
      `${toksA.join(' ')} ${toksB.join(' ')} Remix`,
      `${toksA[0] || 'Mix'} of ${toksB[0] || 'Tracks'}`
    ];
    return combos[Math.floor(Math.random() * combos.length)];
  }

  // ------------------------ Rendering ----------------------------------
  function getGenres() {
    const genres = new Set(songs.map(s => s.genre));
    return ['All', ...Array.from(genres).sort()];
  }

  function formatDuration(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins}:${secs.toString().padStart(2,'0')}`;
  }

  function updateOwnedCount() {
    const countEl = document.getElementById('ownedCount');
    if (countEl) {
      const displayTracks = viewingMember ? viewingMember.ownedTracks : ownedTracks;
      countEl.textContent = `${viewingMember ? viewingMember.djName : 'You'} own ${displayTracks.length}/${songs.length} tracks`;
    }
  }

  function renderSongList() {
    const displayTracks = viewingMember ? viewingMember.ownedTracks : ownedTracks;
    const filtered = songs.filter(s => {
      const matchesSearch = !searchTerm || s.title.toLowerCase().includes(searchTerm.toLowerCase()) || s.artist.toLowerCase().includes(searchTerm.toLowerCase());
      const matchesOwned = !showOwnedOnly || displayTracks.includes(s.id);
      const matchesMixable = !showMixableOnly || !selectedSong || isMixable(selectedSong, s);
      const matchesGenre = selectedGenre === 'All' || s.genre === selectedGenre;
      return matchesSearch && matchesOwned && matchesMixable && matchesGenre;
    });

    // autoprioritize by BPM proximity if a selection exists
    if (selectedSong) {
      filtered.sort((a,b)=> Math.abs(a.bpm - selectedSong.bpm) - Math.abs(b.bpm - selectedSong.bpm));
    }

    const songListEl = document.getElementById('songList');
    if (!songListEl) return;

    songListEl.innerHTML = filtered.map(song => {
      const isOwned = displayTracks.includes(song.id);
      const comp = selectedSong ? mashupCompatibility(selectedSong, song) : null;
      const pct = comp ? Math.round(comp.total) : null;
      const bpmDiff = selectedSong ? Math.abs(song.bpm - selectedSong.bpm) : null;
      const hasOverride = genreOverrides[song.id];
      // glow class
      const glowClass = pct >= 80 ? 'glow-perfect' : pct >= 60 ? 'glow-good' : (pct !== null ? 'glow-bad' : '');

      // mash-up mode filter (extra enforced guard)
      if (showMixableOnly && selectedSong) {
        const bpmOk = Math.abs(song.bpm - selectedSong.bpm) <= 4;
        const keyOk = getCompatibleKeys(selectedSong.camelot).includes(song.camelot);
        if (!bpmOk || !keyOk) return '';
      }

      return `
        <div class="song-card panel p-4 relative hover:border-cyan-400 transition-all" data-song-id="${song.id}">
          <div class="star-icon absolute top-2 right-2 text-xl" style="display: ${isOwned ? 'block' : 'none'}">‚≠ê</div>
          ${selectedSong && isMixable(selectedSong, song) ? `<div class="absolute top-2 left-2 text-xl">üéß</div>` : ''}
          <div class="flex gap-4 mb-3">
            ${song.albumArt ? `<img src="${song.albumArt}" class="w-20 h-20 rounded-lg cursor-pointer hover:scale-110 transition-transform" onclick="selectSong('${song.id}')"/>` : `<div class="w-20 h-20 bg-gradient-to-br from-purple-500 to-pink-500 rounded-lg"></div>`}
            <div class="flex-1 cursor-pointer" onclick="selectSong('${song.id}')">
              <div class="font-bold text-lg mb-1 text-white">${song.title}</div>
              <div class="text-gray-300 mb-2 text-sm">${song.artist}</div>
              <div class="flex items-center gap-2 text-sm flex-wrap">
                <button data-genre-tag="${song.id}" data-song-id-genre="${song.id}" class="px-2 py-1 ${hasOverride ? 'bg-green-500/30 border-green-500/50' : 'bg-orange-500/30 border-orange-500/50'} border rounded text-xs ${currentUser && currentUser.username === 'BattleNeBody' ? 'cursor-pointer' : 'cursor-default opacity-75'} transition" title="${currentUser && currentUser.username === 'BattleNeBody' ? 'Click to change genre (Admin only)' : 'Genre'}">${song.genre}${hasOverride ? ' ‚úì' : ''}</button>
                <span class="px-3 py-1 rounded-lg font-mono font-bold text-white" style="background: ${camelotColors[song.camelot] || '#666'}">${song.camelot}</span>
                <span class="px-2 py-1 bg-gray-700 rounded text-xs">${song.key} ${song.mode}</span>
                <span class="font-semibold text-cyan-300">${song.bpm} BPM</span>
                ${selectedSong && isMixable(selectedSong, song) ? `<span class="px-2 py-1 bg-purple-600/40 border border-purple-400/40 rounded text-xs text-purple-200 font-bold">¬±${Math.abs(song.bpm - selectedSong.bpm)} BPM</span>` : ''}
                <span class="text-gray-400">${formatDuration(song.duration)}</span>
              </div>
            </div>
          </div>
          <div class="flex gap-2">
            <button onclick="toggleOwned('${song.id}')" class="flex-1 px-3 py-2 ${isOwned ? 'bg-green-500 hover:bg-green-600' : 'bg-gray-700 hover:bg-gray-600'} rounded-lg text-sm font-medium transition" ${viewingMember ? 'disabled style="opacity:0.5;cursor:not-allowed;"' : ''}>${isOwned ? '‚úì Owned' : 'Mark Owned'}</button>
            <button class="addSetBtn px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 rounded-lg text-sm font-medium transition" data-id="${song.id}">+ Set</button>
            ${selectedSong ? `<div class="${pct !== null ? glowClass : ''} ml-2 px-3 py-2 score-badge">${pct !== null ? pct + '%' : '‚Äî'}</div>` : ''}
          </div>
        </div>
      `;
    }).join('');

    // attach right-click genre handlers (delegated)
    document.querySelectorAll('[data-song-id-genre]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const songId = btn.getAttribute('data-song-id-genre');
        showGenreMenu(songId, e);
      });
    });
  }

  // ----------------------- Render Full App -----------------------------
  function renderSetlist() {
    const setlistEl = document.getElementById('setlistContent');
    if (!setlistEl) return;
    if (setlist.length === 0) {
      setlistEl.innerHTML = `
        <div class="text-center py-12">
          <div class="text-6xl mb-4">üéµ</div>
          <p class="text-xl mb-4 text-white">Your setlist is empty</p>
          <button onclick="switchView('browser')" class="px-6 py-3 bg-gradient-to-r from-purple-500 to-pink-500 rounded-lg font-bold">Browse Tracks</button>
        </div>
      `;
    } else {
      setlistEl.innerHTML = `
        <div class="space-y-4">
          ${setlist.map((song,i)=>`
            <div class="bg-black/40 backdrop-blur-sm border border-gray-700 rounded-xl p-4 flex items-center gap-4 hover:border-cyan-400 transition">
              <div class="text-2xl font-bold text-pink-400">${i+1}</div>
              ${song.albumArt ? `<img src="${song.albumArt}" class="w-16 h-16 rounded-lg"/>` : ''}
              <div class="flex-1">
                <div class="font-bold text-lg text-white">${song.title}</div>
                <div class="text-gray-300">${song.artist}</div>
                <div class="text-xs text-orange-300">${song.genre}</div>
              </div>
              <div class="text-xl font-mono font-bold" style="color:${camelotColors[song.camelot]}">${song.camelot}</div>
              <button onclick="removeFromSetlist('${song.id}')" class="p-2 hover:bg-red-500/20 rounded text-red-400 text-xl">‚úï</button>
            </div>
          `).join('')}
        </div>
      `;
    }
  }

  function render() {
    const displayTracks = viewingMember ? viewingMember.ownedTracks : ownedTracks;
    const ownedCount = displayTracks.length;

    document.getElementById('app').innerHTML = `
      <div class="min-h-screen">
        <div class="bg-black/60 backdrop-blur-xl border-b border-cyan-500/30 sticky top-0 z-50 shadow-lg">
          <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between gap-4 mb-4">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-gradient-to-br from-pink-500 via-purple-500 to-cyan-500 rounded-lg flex items-center justify-center text-2xl vinyl-spin">üéµ</div>
                <div>
                  <h1 class="text-2xl font-bold text-white graffiti-text">FESTIVAL PRO MIXER</h1>
                  <p id="ownedCount" class="text-xs text-cyan-300 font-semibold">${viewingMember ? viewingMember.djName : 'You'} own ${ownedCount}/${songs.length} tracks</p>
                </div>
              </div>
              <div class="flex items-center gap-3">
                ${viewingMember ? `
                  <button onclick="backToMyProfile()" class="px-3 py-2 bg-purple-500 hover:bg-purple-600 rounded-lg text-sm">‚Üê Back</button>
                ` : `
                  <div class="text-right">
                    <div class="text-sm text-pink-300 font-bold">${currentUser ? currentUser.djName : ''}</div>
                    <div class="text-xs text-gray-400">@${currentUser ? currentUser.username : ''}${Object.keys(genreOverrides).length > 0 ? ` ‚Ä¢ ${Object.keys(genreOverrides).length} corrections` : ''}</div>
                  </div>
                  <button onclick="exportCollection()" class="px-3 py-2 bg-blue-500/20 hover:bg-blue-500/30 border border-blue-500/50 rounded-lg text-blue-300 text-sm">Export</button>
                  <button onclick="importCollection()" class="px-3 py-2 bg-green-500/20 hover:bg-green-500/30 border border-green-500/50 rounded-lg text-green-300 text-sm">Import</button>
                  <button onclick="logoutUser()" class="px-3 py-2 bg-red-500/20 hover:bg-red-500/30 border border-red-500/50 rounded-lg text-red-300 text-sm">Logout</button>
                `}
              </div>
            </div>

            ${!viewingMember && bandMembers.length > 0 ? `
              <div class="mb-4">
                <div class="text-sm text-purple-300 mb-2 font-bold">üé∏ Band Members:</div>
                <div class="flex gap-2 flex-wrap">
                  ${bandMembers.map(member => `<button onclick="viewBandMember('${member.username}')" class="px-3 py-2 bg-purple-500/20 hover:bg-purple-500/30 border border-purple-500/50 rounded-lg text-purple-200 text-sm">${member.djName}</button>`).join('')}
                  <button onclick="addBandMember()" class="px-3 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-sm">+ Add Member</button>
                </div>
              </div>
            ` : !viewingMember ? `
              <div class="mb-4"><button onclick="addBandMember()" class="px-4 py-2 bg-purple-500/20 hover:bg-purple-500/30 border border-purple-500/50 rounded-lg text-purple-200 text-sm">üé∏ + Add Band Member</button></div>
            ` : ''}

            <div class="flex gap-2">
              <button id="browserBtn" class="px-4 py-2 rounded-lg font-medium transition ${view === 'browser' ? 'bg-gradient-to-r from-purple-500 to-pink-500' : 'bg-white/10 hover:bg-white/20'}">Browse</button>
              <button id="setlistBtn" class="px-4 py-2 rounded-lg font-medium transition ${view === 'setlist' ? 'bg-gradient-to-r from-purple-500 to-pink-500' : 'bg-white/10 hover:bg-white/20'}">Setlist (<span id="setlistCount">${setlist.length}</span>)</button>
            </div>
          </div>
        </div>

        <div class="max-w-7xl mx-auto px-6 py-6 pb-20">
          <div id="browserView" style="display: ${view === 'browser' ? 'block' : 'none'}">
            <div class="mb-6 space-y-4">
              <div class="relative">
                <input type="text" id="searchInput" placeholder="üîç Quick search (optional)..." class="w-full px-4 py-3 pr-12 bg-black/40 backdrop-blur-sm border border-cyan-500/30 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500"/>
                <button id="clearSearchBtn" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white transition text-xl" style="display:none;">‚úï</button>
              </div>
              <div class="flex flex-wrap gap-3">
                <button id="mixableFilterBtn" class="px-4 py-2 rounded-lg font-medium transition ${showMixableOnly ? 'bg-gradient-to-r from-blue-500 to-cyan-500' : 'bg-white/10 hover:bg-white/20'}">${showMixableOnly ? 'üéß Mixable Only' : 'Show Mixable'}</button>
                <button id="ownedFilterBtn" class="px-4 py-2 rounded-lg font-medium transition ${showOwnedOnly ? 'bg-gradient-to-r from-green-500 to-emerald-500' : 'bg-white/10 hover:bg-white/20'}">${showOwnedOnly ? '‚úì Owned Only' : 'Show All'}</button>
                ${!viewingMember ? `<button id="markAllBtn" class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg transition">Mark All Owned</button><button id="clearAllBtn" class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg transition">Clear All</button>` : ''}
              </div>
            </div>
            <div id="songList"></div>
          </div>

          <div id="setlistView" style="display: ${view === 'setlist' ? 'block' : 'none'}">
            <div id="setlistContent"></div>
          </div>
        </div>
      </div>
    `;

    // after DOM set, run list rendering and event hookup
    if (view === 'browser') {
      renderSongList();
    } else {
      renderSetlist();
    }
  }

  // ---------------------- Context menu for genre override ----------------
  function showGenreMenu(songId, event) {
    if (!currentUser || currentUser.username !== 'BattleNeBody') {
      alert('üîí Only the admin (BattleNeBody) can correct genre tags!');
      return;
    }
    const existing = document.getElementById('genreContextMenu');
    if (existing) existing.remove();
    const menu = document.createElement('div');
    menu.id = 'genreContextMenu';
    menu.className = 'context-menu';
    const rect = event.target.getBoundingClientRect();
    let left = rect.left;
    let top = rect.bottom + 5;
    if (left + 220 > window.innerWidth) left = rect.right - 220;
    if (top + 300 > window.innerHeight) top = rect.top - 305;
    menu.style.left = left + 'px';
    menu.style.top = top + 'px';
    const genres = Object.keys(genreMap).concat(['Other']);
    menu.innerHTML = `<div style="padding:8px 12px;color:#00d9ff;font-weight:bold;border-bottom:1px solid rgba(0,217,255,0.3);margin-bottom:6px;">Select Genre:</div>`;
    genres.forEach(g => {
      const btn = document.createElement('button');
      btn.textContent = g;
      btn.style.display = 'block';
      btn.style.width = '100%';
      btn.style.padding = '8px 12px';
      btn.style.background = 'transparent';
      btn.style.border = 'none';
      btn.style.textAlign = 'left';
      btn.style.color = '#e6f7ff';
      btn.style.cursor = 'pointer';
      btn.addEventListener('click', async () => { await setGenreOverride(songId, g); menu.remove(); });
      menu.appendChild(btn);
    });
    document.body.appendChild(menu);
    setTimeout(()=> {
      const closeMenu = (e)=>{ if (!menu.contains(e.target)) { menu.remove(); document.removeEventListener('click', closeMenu); } };
      document.addEventListener('click', closeMenu);
    }, 100);
  }

  // --------------------- Setup Event Listeners --------------------------
  function setupEventListeners() {
    const searchInput = document.getElementById('searchInput');
    const clearSearchBtn = document.getElementById('clearSearchBtn');

    if (searchInput && clearSearchBtn) {
      // remove any previous listeners to avoid duplicates (defensive)
      searchInput.oninput = (e) => {
        searchTerm = e.target.value;
        clearSearchBtn.style.display = searchTerm ? 'block' : 'none';
        renderSongList();
      };
      clearSearchBtn.onclick = () => {
        searchInput.value = '';
        searchTerm = '';
        clearSearchBtn.style.display = 'none';
        renderSongList();
      };
    }
    document.getElementById('browserBtn')?.addEventListener('click', () => switchView('browser'));
    document.getElementById('setlistBtn')?.addEventListener('click', () => switchView('setlist'));
    document.getElementById('mixableFilterBtn')?.addEventListener('click', toggleMixableFilter);
    document.getElementById('ownedFilterBtn')?.addEventListener('click', toggleOwnedFilter);
    if (!viewingMember) {
      document.getElementById('markAllBtn')?.addEventListener('click', markAllOwned);
      document.getElementById('clearAllBtn')?.addEventListener('click', clearAllOwned);
    }

    // delegate +Set click (some buttons rendered dynamically)
    document.querySelectorAll('.addSetBtn').forEach(btn => {
      btn.onclick = (e) => { e.preventDefault(); addToSetlist(btn.dataset.id); };
    });
  }

  // -------------------- Selection / Preview / Setlist -------------------
  window.selectSong = (id) => {
    selectedSong = songs.find(s => s.id === id);
    // don't force showMixableOnly ‚Äî let the user toggle
    // But if they previously had the mixable filter on, keep it.
    // Update the Mixable button state visually:
    const btn = document.getElementById('mixableFilterBtn');
    if (btn) {
      btn.className = `px-4 py-2 rounded-lg font-medium transition ${showMixableOnly ? 'bg-gradient-to-r from-blue-500 to-cyan-500' : 'bg-white/10 hover:bg-white/20'}`;
      btn.textContent = showMixableOnly ? 'üéß Mixable Only' : 'Show Mixable';
    }
    renderSongList();
  };

  window.clearSelection = () => {
    selectedSong = null;
    // keep showMixableOnly as-is (user preference); if they want to clear mixable, toggle
    const btn = document.getElementById('mixableFilterBtn');
    if (btn) { btn.className = 'px-4 py-2 rounded-lg font-medium transition bg-white/10 hover:bg-white/20'; btn.textContent = 'Show Mixable'; }
    showMixableOnly = false;
    renderSongList();
  };

  window.toggleOwned = (id) => {
    if (viewingMember) { alert("You can't edit other people's collections!"); return; }
    if (ownedTracks.includes(id)) ownedTracks = ownedTracks.filter(t => t !== id); else ownedTracks.push(id);
    localStorage.setItem('ownedTracks', JSON.stringify(ownedTracks));
    saveUserProfile();
    updateOwnedCount();
    renderSongList();
  };

  window.addToSetlist = (id) => {
    const song = songs.find(s => s.id === id);
    if (!song) return;
    if (!setlist.find(s => s.id === id)) {
      setlist.push(song);
      // persist locally
      localStorage.setItem('setlist', JSON.stringify(setlist));
      const countEl = document.getElementById('setlistCount');
      if (countEl) countEl.textContent = setlist.length;
      // render setlist area only ‚Äî avoid calling render() which recreates the entire DOM and can hide the setlist view
      if (view === 'setlist') {
        renderSetlist();
      } else {
        // minor UX: flash setlist count in header
        if (countEl) {
          countEl.classList.add('animate-pulse');
          setTimeout(()=>countEl.classList.remove('animate-pulse'), 800);
        }
      }
    }
  };
  window.removeFromSetlist = (id) => {
    setlist = setlist.filter(s => s.id !== id);
    localStorage.setItem('setlist', JSON.stringify(setlist));
    renderSetlist();
    const countEl = document.getElementById('setlistCount');
    if (countEl) countEl.textContent = setlist.length;
  };

  window.switchView = (newView) => {
    view = newView;
    document.getElementById('browserView').style.display = view === 'browser' ? 'block' : 'none';
    document.getElementById('setlistView').style.display = view === 'setlist' ? 'block' : 'none';
    const browserBtn = document.getElementById('browserBtn');
    const setlistBtn = document.getElementById('setlistBtn');
    if (browserBtn) browserBtn.className = `px-4 py-2 rounded-lg font-medium transition ${view === 'browser' ? 'bg-gradient-to-r from-purple-500 to-pink-500' : 'bg-white/10 hover:bg-white/20'}`;
    if (setlistBtn) setlistBtn.className = `px-4 py-2 rounded-lg font-medium transition ${view === 'setlist' ? 'bg-gradient-to-r from-purple-500 to-pink-500' : 'bg-white/10 hover:bg-white/20'}`;
    if (view === 'browser') { renderSongList(); setupEventListeners(); } else { renderSetlist(); setupEventListeners(); }
  };

  window.toggleMixableFilter = () => {
    if (!selectedSong) { alert('Select a song first to see mixable tracks!'); return; }
    showMixableOnly = !showMixableOnly;
    const btn = document.getElementById('mixableFilterBtn');
    if (btn) { btn.className = `px-4 py-2 rounded-lg font-medium transition ${showMixableOnly ? 'bg-gradient-to-r from-blue-500 to-cyan-500' : 'bg-white/10 hover:bg-white/20'}`; btn.textContent = showMixableOnly ? 'üéß Mixable Only' : 'Show Mixable'; }
    renderSongList();
  };

  window.toggleOwnedFilter = () => {
    showOwnedOnly = !showOwnedOnly;
    const btn = document.getElementById('ownedFilterBtn');
    if (btn) { btn.className = `px-4 py-2 rounded-lg font-medium transition ${showOwnedOnly ? 'bg-gradient-to-r from-green-500 to-emerald-500' : 'bg-white/10 hover:bg-white/20'}`; btn.textContent = showOwnedOnly ? '‚úì Owned Only' : 'Show All'; }
    renderSongList();
  };

  window.markAllOwned = () => {
    if (viewingMember) return;
    if (!confirm(`‚ö†Ô∏è Mark ALL ${songs.length} songs as owned?\nThis will override your current selection!`)) return;
    ownedTracks = songs.map(s => s.id);
    localStorage.setItem('ownedTracks', JSON.stringify(ownedTracks));
    saveUserProfile();
    renderSongList(); updateOwnedCount(); alert(`‚úÖ Marked all ${songs.length} songs as owned!`);
  };

  window.clearAllOwned = () => {
    if (viewingMember) return;
    if (!confirm(`‚ö†Ô∏è CLEAR ALL owned songs? This cannot be undone!`)) return;
    const count = ownedTracks.length;
    ownedTracks = [];
    localStorage.setItem('ownedTracks', JSON.stringify(ownedTracks));
    saveUserProfile();
    renderSongList(); updateOwnedCount(); alert(`üóëÔ∏è Cleared ${count} owned songs.`);
  };

  // ------------------------- Preview / Two-track ------------------------
  function onPreviewClick(id) {
    const b = songs.find(s => s.id === id);
    if (!selectedSong) { selectedSong = b; renderSongList(); alert('Main track selected. Click Preview on another track to compare.'); return; }
    previewSong = b;
    displayTwoTrackPreview(selectedSong, previewSong);
  }

  function displayTwoTrackPreview(A, B) {
    // If your layout has a preview panel add one; for now we alert & console -- but we included display functions earlier in version B
    const comp = mashupCompatibility(A,B);
    const pct = Math.round(comp.total);
    alert(`${A.title} ‚Üí ${B.title}\nCompatibility: ${pct}%\nBPM diff: ${Math.abs(A.bpm-B.bpm)}\n${bpmShiftSuggestion(A.bpm,B.bpm)}`);
    console.log('Preview comp:', comp);
  }

  // -------------------------- Sandbox ----------------------------------
  let sandboxTracks = [];
  function sandboxInit() {
    const el = document.getElementById('sandbox');
    if (!el) return;
    el.innerHTML = `<div class="small-muted p-2">Drop tracks here</div>`;
    el.addEventListener('dragover', (e) => e.preventDefault());
    el.addEventListener('drop', (e) => {
      e.preventDefault();
      const id = e.dataTransfer.getData('text/plain');
      const track = songs.find(s => s.id === id);
      if (!track) return;
      if (sandboxTracks.find(t => t.id === id)) return;
      if (sandboxTracks.length >= 4) { alert('Sandbox limit: 4 tracks'); return; }
      sandboxTracks.push(track); renderSandbox();
    });
  }

  function renderSandbox() {
    const el = document.getElementById('sandbox');
    if (!el) return;
    el.innerHTML = sandboxTracks.map((t,i) => `
      <div class="flex items-center gap-3 panel p-2 mb-2">
        <div class="w-10 h-10 rounded" style="background:${camelotColors[t.camelot]||'#666'};display:flex;align-items:center;justify-content:center">${t.camelot}</div>
        <div style="flex:1">
          <div class="font-semibold">${t.title}</div>
          <div class="small-muted text-xs">${t.artist} ‚Ä¢ ${t.genre} ‚Ä¢ ${t.bpm} BPM</div>
        </div>
        <div class="small-muted">${computeEnergy(t)}</div>
        <button class="ml-2 px-2 py-1 bg-red-600/40" onclick="removeSandbox('${t.id}')">‚úï</button>
      </div>
    `).join('') || `<div class="small-muted p-2">Drop tracks here</div>`;
    const info = document.getElementById('sandboxInfo');
    if (sandboxTracks.length === 0) { if (info) info.textContent = ''; renderEnergyGraph([]); return; }
    const bpms = sandboxTracks.map(s=>s.bpm);
    const keys = sandboxTracks.map(s=>s.camelot);
    const bpmDiffs = bpms.length > 1 ? Math.abs(bpms[0]-bpms[bpms.length-1]) : 0;
    const genreBlend = getGenreBlendScore(sandboxTracks);
    if (info) info.innerHTML = `BPM range: ${Math.min(...bpms)}‚Äì${Math.max(...bpms)} (Œî ${bpmDiffs}) ‚Ä¢ Key set: ${[...new Set(keys)].join(', ')} ‚Ä¢ Genre-blend: ${Math.round(genreBlend*100)}%`;
    renderEnergyGraph(sandboxTracks);
  }
  function removeSandbox(id) { sandboxTracks = sandboxTracks.filter(s => s.id !== id); renderSandbox(); }
  function getGenreBlendScore(list) { if (!list.length) return 0; const counts = {}; list.forEach(s=>counts[s.genre] = (counts[s.genre]||0)+1); const max = Math.max(...Object.values(counts)); return max / list.length; }
  function suggestSandboxOrder(list) { return [...list].sort((a,b)=>a.bpm - b.bpm); }

  // ------------------------ Energy Graph -------------------------------
  function renderEnergyGraph(list) {
    const container = document.getElementById('energyGraph');
    if (!container) return;
    if (!list || list.length === 0) { container.innerHTML = '<div class="small-muted">No tracks selected</div>'; return; }
    container.innerHTML = list.map((t,i) => {
      const e = computeEnergy(t);
      const pct = (e/5) * 100;
      const color = e>=4 ? 'linear-gradient(90deg,#f97316,#ef4444)' : e>=3 ? 'linear-gradient(90deg,#f59e0b,#f97316)' : 'linear-gradient(90deg,#34d399,#10b981)';
      return `<div class="flex items-center gap-3"><div style="width:40px" class="small-muted">${i+1}</div><div style="flex:1"><div class="small-muted text-xs">${t.title} ‚Äî <span style="color:${camelotColors[t.camelot]||'#fff'}">${t.camelot}</span></div><div class="energy-bar mt-1"><div class="energy-fill" style="width:${pct}%;background:${color}"></div></div></div><div style="width:36px" class="text-center font-bold">${e}</div></div>`;
    }).join('<div style="height:8px"></div>');
  }

  // --------------------- Export / Import / Genre override --------------
  async function exportCollection() {
    if (!currentUser) return alert('Login first');
    const data = { username: currentUser.username, djName: currentUser.djName, ownedTracks, genreOverrides, exportDate: new Date().toISOString() };
    if (firestore) {
      // prefer saving to Firestore instead of JSON export
      try {
        await firestore.collection('backups').doc(`${currentUser.username}_${Date.now()}`).set(data);
        alert('Collection backed up to Firestore (backups collection).');
        return;
      } catch (e) { console.warn('Firestore backup failed', e); }
    }
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `festival-mixer-${currentUser.username}.json`; a.click(); URL.revokeObjectURL(url);
  }

  async function importCollection() {
    if (!currentUser) return alert('Login first');
    const input = document.createElement('input'); input.type = 'file'; input.accept = '.json';
    input.onchange = (e) => {
      const file = e.target.files[0]; const reader = new FileReader();
      reader.onload = async (ev) => {
        try {
          const data = JSON.parse(ev.target.result);
          if (!data.ownedTracks) throw new Error('Invalid file');
          if (!confirm(`Import ${data.ownedTracks.length} songs from ${data.djName || data.username || 'file'}?`)) return;
          ownedTracks = data.ownedTracks;
          if (data.genreOverrides) genreOverrides = {...genreOverrides, ...data.genreOverrides};
          localStorage.setItem('ownedTracks', JSON.stringify(ownedTracks));
          localStorage.setItem('genreOverrides', JSON.stringify(genreOverrides));
          await saveUserProfile();
          songs.forEach(song => { if (genreOverrides[song.id]) song.genre = genreOverrides[song.id]; });
          renderSongList(); setupEventListeners(); alert('Collection imported successfully!');
        } catch (err) {
          alert('Invalid file format');
        }
      };
      reader.readAsText(file);
    };
    input.click();
  }

  // ---------------------- Helpers & Init --------------------------------
  function showError(message) {
    document.getElementById('app').innerHTML = `
      <div class="min-h-screen flex items-center justify-center p-6">
        <div class="text-center max-w-2xl">
          <div class="text-6xl mb-4">‚ö†Ô∏è</div>
          <div class="text-2xl font-bold mb-4 text-white">Unable to Load Tracks</div>
          <div class="text-gray-300 mb-6 bg-black/30 p-4 rounded-lg"><p class="mb-2">${message}</p></div>
          <button onclick="location.reload()" class="px-6 py-3 bg-gradient-to-r from-pink-500 to-purple-500 rounded-lg font-bold">üîÑ Retry Loading</button>
        </div>
      </div>
    `;
  }

  // ------------------------- Initial boot --------------------------------
  async function checkAuth() {
    const savedUsername = localStorage.getItem('currentUser');
    if (savedUsername) {
      const profile = await loadUserProfile(savedUsername);
      if (profile) {
        currentUser = profile;
        ownedTracks = profile.ownedTracks || [];
        bandMembers = profile.bandMembers || [];
        genreOverrides = profile.genreOverrides || {};
        loadSongs();
      } else {
        showLoginScreen();
      }
    } else {
      showLoginScreen();
    }
  }

  if (!localStorage.getItem('hasSeenLanding')) {
    showLandingPage();
  } else {
    checkAuth();
  }

  // ------------------- Exposed debug helpers --------------------------
  window.renderSongList = renderSongList;
  window.render = render;
  window.loadSongs = loadSongs;
  window.renderSetlist = renderSetlist;
  window.addToSetlist = addToSetlist;
  window.onPreviewClick = onPreviewClick;

  // attach dragstart for song cards to enable sandbox drag/drop
  document.addEventListener('dragstart', (e) => {
    const card = e.target.closest('.song-card'); if (card) e.dataTransfer.setData('text/plain', card.getAttribute('data-song-id'));
  });

  // attach delegated clicks for dynamic preview/add buttons
  document.addEventListener('click', (e) => {
    const preview = e.target.closest('.previewBtn');
    if (preview) { e.preventDefault(); onPreviewClick(preview.dataset.id); }
    const addSet = e.target.closest('.addSetBtn');
    if (addSet) { e.preventDefault(); addToSetlist(addSet.dataset.id); }
  });

  </script>
</body>
</html>
