    <!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fortnite Festival Jam Mixer ‚Äî Firebase Enabled</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase Compat SDKs (v9 compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics-compat.js"></script>

  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{background:linear-gradient(135deg,#0f1020 0%,#14122a 40%,#071130 100%);color:#e9f7ff;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial}
    .panel{background:linear-gradient(180deg,rgba(0,0,0,.55),rgba(0,0,0,.45));border-radius:12px;border:1px solid rgba(255,255,255,0.03);padding:12px}
    .vinyl-spin{animation:spin 4s linear infinite}
    @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
    .small-muted{color:rgba(230,247,255,.75);font-size:13px}
    .energy-bar{height:12px;border-radius:8px;background:rgba(255,255,255,0.06);overflow:hidden}
    .camelot-pill{padding:6px 10px;border-radius:10px;font-weight:700;color:#fff;display:inline-block}
    .song-card{transition: box-shadow .12s, transform .12s}
    .song-card:hover{transform:translateY(-4px)}
    .context-menu{position:fixed;background:rgba(0,0,0,.95);border-radius:8px;padding:8px;z-index:10000;backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,0.03)}
    .btn { padding:8px 12px;border-radius:8px;background:rgba(255,255,255,0.04);color:#e6f7ff;border:1px solid rgba(255,255,255,0.03);cursor:pointer }
    .glow-perfect{box-shadow:0 0 18px rgba(57,255,20,0.85), 0 0 48px rgba(57,255,20,0.12)}
    .glow-good{box-shadow:0 0 12px rgba(255,230,65,0.9), 0 0 36px rgba(255,230,65,0.08)}
    .glow-bad{box-shadow:0 0 12px rgba(255,63,63,0.9), 0 0 36px rgba(255,63,63,0.08)}
    #helpModal{display:none;position:fixed;inset:0;z-index:20000;align-items:center;justify-content:center;background:rgba(0,0,0,0.85);backdrop-filter:blur(6px)}
    .helpBox{width:92%;max-width:760px;height:80vh;background:linear-gradient(180deg,rgba(12,10,25,0.96),rgba(20,16,38,0.98));border-radius:14px;border:2px solid rgba(0,217,255,0.14);overflow:hidden;display:flex;flex-direction:column}
    .helpContent{padding:14px 18px;overflow-y:auto;color:#dff7ff;line-height:1.45;font-size:14px}
  </style>
</head>
<body>
  <div id="app" class="p-6 max-w-7xl mx-auto"></div>

  <!-- Help Modal -->
  <div id="helpModal" tabindex="-1">
    <div class="helpBox panel">
      <div class="helpContent">
        <h2 style="font-weight:800;font-size:20px;margin-bottom:8px">Help & Features</h2>
        <p class="small-muted">This build includes Camelot-tier toggles, priority toggle, band member fix, and Firebase integration (Auth + Firestore). Use header buttons to export/import, open help, sign in, or add members.</p>
        <hr style="margin:12px 0;border-color:rgba(0,217,255,0.06)">
        <h3 style="margin-top:8px">Camelot Tier</h3>
        <p class="small-muted">Toggle between Tier 1 (same number), Tiers 1‚Äì2 (nearby keys), and All Tiers (1‚Äì3). Mixable filter respects this.</p>
        <h3 style="margin-top:8px">Priority</h3>
        <p class="small-muted">Switch between tempo closeness and Camelot-tier sorting priority.</p>
        <h3 style="margin-top:8px">Band Members</h3>
        <p class="small-muted">Band members are stored as full profiles (username, djName, ownedTracks) so viewing a member won't break UI.</p>
        <div style="margin-top:12px;text-align:right"><button class="btn" onclick="closeHelp()">Close</button></div>
      </div>
    </div>
  </div>

  <script>
  /**************************************************************************
   * Final index.html - Firebase compat wired (using your provided config)
   * - Uses Firebase compat SDKs so existing app logic works unchanged
   * - Firestore used for profile storage if available; falls back to localStorage
   **************************************************************************/

  // -------------------- Firebase config (from you) --------------------
  const firebaseConfig = {
    apiKey: "AIzaSyAeVHy4RPVwEAfQaEisW82eqCPwBRkG3WQ",
    authDomain: "festival-jam-mixer.firebaseapp.com",
    projectId: "festival-jam-mixer",
    storageBucket: "festival-jam-mixer.firebasestorage.app",
    messagingSenderId: "255348637744",
    appId: "1:255348637744:web:cbd3151011372f0e8fadf5",
    measurementId: "G-G0ZHBW07C3"
  };

  // Initialize compat Firebase
  let firebaseApp = null, firebaseAuth = null, firestore = null;
  try {
    firebaseApp = firebase.initializeApp(firebaseConfig);
    firebaseAuth = firebase.auth();
    firestore = firebase.firestore();
    if (firebase.analytics) try { firebase.analytics(); } catch(e){ /* ignore analytics init errors */ }
    console.log('Firebase (compat) initialized.');
  } catch (e) {
    console.warn('Firebase init failed (falling back to localStorage):', e);
    firebaseApp = null; firebaseAuth = null; firestore = null;
  }

  // -------------------- Data & maps --------------------
  const camelotColors = {
    '1A':'#FF6B9D','1B':'#FF8FAB','2A':'#FFA07A','2B':'#FFB699','3A':'#FFD700','3B':'#FFE55C',
    '4A':'#98D8C8','4B':'#7FD8BE','5A':'#6BCB77','5B':'#8FD89F','6A':'#4D96FF','6B':'#6FB1FF',
    '7A':'#9D4EDD','7B':'#B877FF','8A':'#E84A5F','8B':'#FF6B81','9A':'#00D9FF','9B':'#4DFFFF',
    '10A':'#FFA400','10B':'#FFBB5C','11A':'#FE6D73','11B':'#FF8C94','12A':'#A8E6CF','12B':'#C1F0DD'
  };

  const keyToCamelot = {
    'C':'8B','Am':'8A','A Minor':'8A','C Major':'8B','G':'9B','Em':'9A','E Minor':'9A','G Major':'9B',
    'D':'10B','Bm':'10A','B Minor':'10A','D Major':'10B','A':'11B','F#m':'11A','F# Minor':'11A','A Major':'11B',
    'E':'12B','C#m':'12A','C# Minor':'12A','E Major':'12B','B':'1B','G#m':'1A','G# Minor':'1A','B Major':'1B',
    'F#':'2B','D#m':'2A','D# Minor':'2A','F# Major':'2B','Db':'3B','Bbm':'3A','Bb Minor':'3A','Db Major':'3B',
    'Ab':'4B','Fm':'4A','F Minor':'4A','Ab Major':'4B','Eb':'5B','Cm':'5A','C Minor':'5A','Eb Major':'5B',
    'Bb':'6B','Gm':'6A','G Minor':'6A','Bb Major':'6B','F':'7B','Dm':'7A','D Minor':'7A','F Major':'7B'
  };

  function convertToCamelot(key){ if(!key) return '?'; return keyToCamelot[(key||'').trim()] || '?'; }

  // -------------------- State --------------------
  let currentUser = null;
  let songs = [];
  let ownedTracks = JSON.parse(localStorage.getItem('ownedTracks') || '[]');
  let setlist = JSON.parse(localStorage.getItem('setlist') || '[]');
  let bandMembers = JSON.parse(localStorage.getItem('bandMembers') || '[]');
  let genreOverrides = JSON.parse(localStorage.getItem('genreOverrides') || '{}');
  let sandboxTracks = [];
  let selectedSong = null;
  let previewSong = null;
  let viewingMember = null;
  let showOwnedOnly = false;
  let showMixableOnly = false;
  let searchTerm = '';
  let view = 'browser';

  // New states
  let camelotTier = 3; // 1,2,3
  let priorityMode = 'tempo'; // 'tempo' | 'camelot'

  // -------------------- Utilities & scoring --------------------
  function formatDuration(sec){ const m = Math.floor(sec/60); const s = sec%60; return `${m}:${s.toString().padStart(2,'0')}`; }

  function getCompatibleKeys(camelot){
    if(!camelot||camelot==='?') return [];
    const ma = camelot.match(/^(\d+)([AB])$/);
    if(!ma) return [];
    const num = parseInt(ma[1]); const letter = ma[2];
    const res = [camelot, `${num}${letter==='A'?'B':'A'}`];
    const next = num===12?1:num+1; const prev = num===1?12:num-1;
    res.push(`${next}${letter}`); res.push(`${prev}${letter}`);
    return res;
  }

  function isMixable(a,b){
    if(!a||!b) return false;
    const keys = getCompatibleKeys(a.camelot);
    return keys.includes(b.camelot);
  }

  function getCamelotTier(a,b){
    if(!a||!b||a==='?'||b==='?') return 99;
    const ma = a.match(/^(\d+)([AB])$/), mb = b.match(/^(\d+)([AB])$/);
    if(!ma||!mb) return 99;
    const na = parseInt(ma[1]), la = ma[2];
    const nb = parseInt(mb[1]), lb = mb[2];
    if(na === nb) return 1;
    const next = na === 12 ? 1 : na + 1;
    const prev = na === 1 ? 12 : na - 1;
    if(la === lb && (nb === next || nb === prev)) return 2;
    return 3;
  }

  function scoreKeyMatch(aCamelot,bCamelot){
    if(!aCamelot||!bCamelot||aCamelot==='?'||bCamelot==='?') return 0;
    if(aCamelot===bCamelot) return 40;
    const ma=aCamelot.match(/^(\d+)([AB])$/), mb=bCamelot.match(/^(\d+)([AB])$/);
    if(!ma||!mb) return 0;
    const numA=parseInt(ma[1]), letterA=ma[2], numB=parseInt(mb[1]), letterB=mb[2];
    if(numA===numB&&letterA!==letterB) return 30;
    if(letterA===letterB&&(Math.abs(numA-numB)===1||Math.abs(numA-numB)===11)) return 30;
    if(Math.abs(numA-numB)===1&&letterA!==letterB) return 20;
    return 0;
  }
  function scoreBpmMatch(aBpm,bBpm){ const diff=Math.abs(aBpm-bBpm); if(diff<=1) return 40; if(diff<=3) return 35; if(diff<=6) return 25; if(diff<=10) return 15; return 0; }
  function scoreGenreMatch(a,b){ if(!a||!b) return 0; return a===b?20:0; }
  function mashupCompatibility(a,b){ const key=scoreKeyMatch(a.camelot,b.camelot); const bpm=scoreBpmMatch(a.bpm,b.bpm); const genre=scoreGenreMatch(a.genre,b.genre); return { total: key+bpm+genre, breakdown:{key,bpm,genre} }; }
  function bpmShiftSuggestion(a,b){ const shift = Math.round(b-a); if(shift===0) return 'No change'; return (shift>0?'+':'')+shift+' BPM = Perfect Match'; }
  function computeEnergy(track){ if(!track||!track.bpm) return 3; let e=1; const bpm=track.bpm; if(bpm<90) e=1; else if(bpm<110) e=2; else if(bpm<125) e=3; else if(bpm<140) e=4; else e=5; if(track.genre==='Electronic' || track.genre==='Rock') e = Math.min(5,e+1); return e; }

  // -------------------- Persistence --------------------
  async function saveUserProfileToBackend(profile){
    if(!profile) return false;
    if(firestore && profile.username){
      try{
        await firestore.collection('users').doc(profile.username).set(profile, { merge: true });
        return true;
      }catch(e){ console.warn('Firestore save failed', e); }
    }
    // fallback to local
    const profiles = JSON.parse(localStorage.getItem('userProfiles')||'{}');
    profiles[profile.username] = profile;
    localStorage.setItem('userProfiles', JSON.stringify(profiles));
    return true;
  }

  async function saveUserProfile(){
    const profile = currentUser ? {
      username: currentUser.username,
      djName: currentUser.djName || currentUser.username,
      ownedTracks,
      setlist,
      bandMembers,
      genreOverrides
    } : null;
    if(!profile) return;
    // local write
    const profiles = JSON.parse(localStorage.getItem('userProfiles')||'{}');
    profiles[profile.username] = profile;
    localStorage.setItem('userProfiles', JSON.stringify(profiles));
    localStorage.setItem('ownedTracks', JSON.stringify(ownedTracks));
    localStorage.setItem('bandMembers', JSON.stringify(bandMembers));
    localStorage.setItem('genreOverrides', JSON.stringify(genreOverrides));
    // backend write
    await saveUserProfileToBackend(profile);
  }

  async function loadUserProfile(username){
    if(!username) return null;
    if(firestore){
      try{
        const doc = await firestore.collection('users').doc(username).get();
        if(doc.exists) return doc.data();
      }catch(e){ console.warn('Firestore load failed', e); }
    }
    const profiles = JSON.parse(localStorage.getItem('userProfiles') || '{}');
    return profiles[username] || null;
  }

  // -------------------- Load songs (API + fallback) --------------------
  async function loadSongs(){
    const endpoints = [
      'https://api.allorigins.win/raw?url=https://fortnitecontent-website-prod07.ol.epicgames.com/content/api/pages/fortnite-game/spark-tracks',
      'https://corsproxy.io/?https://fortnitecontent-website-prod07.ol.epicgames.com/content/api/pages/fortnite-game/spark-tracks'
    ];
    for(let ep of endpoints){
      try{
        const res = await fetch(ep);
        if(!res.ok) continue;
        const data = await res.json();
        songs = Object.entries(data).filter(([k])=>!k.startsWith('_')).map(([id,item])=>{
          const t = item.track || {};
          if(!t.tt) return null;
          const detectedGenre = detectGenre(t.an||'', t.tt);
          const finalGenre = genreOverrides[id] || detectedGenre;
          return {
            id,
            title: t.tt,
            artist: t.an || 'Unknown',
            bpm: Number(t.mt) || 0,
            key: t.mk || '?',
            mode: t.mm || '',
            camelot: convertToCamelot(t.mk||''),
            duration: Number(t.dn) || 0,
            albumArt: t.au || '',
            genre: finalGenre
          };
        }).filter(s=>s && s.bpm>0);
        if(songs.length>0){ songs.sort((a,b)=>a.title.localeCompare(b.title)); render(); setupEventListeners(); return; }
      }catch(e){ console.warn('endpoint error', e); }
    }
    // fallback sample
    songs = [
      { id:'s1', title:'Bad Guy', artist:'Billie Eilish', bpm:135, key:'C', mode:'major', camelot:'8B', duration:180, albumArt:'', genre:'Pop'},
      { id:'s2', title:'Need You Tonight', artist:'INXS', bpm:115, key:'C', mode:'minor', camelot:'8A', duration:210, albumArt:'', genre:'Rock'},
      { id:'s3', title:'Electric Night', artist:'Daft Sample', bpm:128, key:'D', mode:'major', camelot:'10B', duration:200, albumArt:'', genre:'Electronic'},
      { id:'s4', title:'Slow Burn', artist:'Indie Star', bpm:95, key:'G', mode:'minor', camelot:'9A', duration:190, albumArt:'', genre:'Indie'},
      { id:'s5', title:'Drop The Bass', artist:'SkrillSample', bpm:142, key:'A', mode:'minor', camelot:'11A', duration:160, albumArt:'', genre:'Electronic'}
    ];
    render(); setupEventListeners();
  }

  // -------------------- Genre detection --------------------
  const genreMap = {
    'Rock': ['foo fighters','nirvana','pearl jam','soundgarden','alice in chains','red hot chili peppers','radiohead','muse'],
    'Pop': ['taylor swift','ariana grande','billie eilish','dua lipa','lady gaga'],
    'Electronic': ['daft punk','deadmau5','skrillex','diplo','zedd','avicii']
  };
  function detectGenre(artist,title){
    artist=(artist||'').toLowerCase(); title=(title||'').toLowerCase();
    for(const [g,arr] of Object.entries(genreMap)){
      if(arr.some(a=>artist.includes(a) || title.includes(a))) return g;
    }
    if(title.includes('rock')) return 'Rock';
    if(title.includes('electr')) return 'Electronic';
    return 'Other';
  }

  // -------------------- Render --------------------
  function render(){
    document.getElementById('app').innerHTML = buildMainUI();
    renderSongList();
    renderSetlist();
    renderBandPanel();
    sandboxInit();
  }

  function buildMainUI(){
    const userDisplay = currentUser ? (currentUser.djName || currentUser.username) : 'Guest';
    return `
      <div class="panel mb-6">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="display:flex;gap:12px;align-items:center">
            <div class="vinyl-spin" style="width:56px;height:56px;background:linear-gradient(90deg,#ff6b9d,#8b5cf6);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:30px">üéß</div>
            <div>
              <div style="font-weight:800;font-size:18px">FORTNITE FESTIVAL JAM MIXER</div>
              <div class="small-muted">Signed in as <strong>${userDisplay}</strong></div>
            </div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <button onclick="openHelp()" class="btn">‚ùì Help</button>
            <button onclick="exportCollection()" class="btn">Export</button>
            <button onclick="importCollection()" class="btn">Import</button>
            <button onclick="logoutUser()" class="btn">Logout</button>
          </div>
        </div>
      </div>

      <div style="display:flex;gap:16px;align-items:flex-start">
        <div style="width:340px">
          <div class="panel mb-4">
            <div style="margin-bottom:12px;font-weight:800">Controls</div>
            <div style="display:flex;flex-direction:column;gap:8px">
              <input id="searchInput" placeholder="üîç Search..." class="w-full px-3 py-2 bg-black/40 border border-cyan-500/20 rounded" />
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button id="mixableFilterBtn" class="btn">${showMixableOnly? 'üéß Mixable Only':'Show Mixable'}</button>
                <button id="ownedFilterBtn" class="btn">${showOwnedOnly? '‚úì Owned Only':'Show All'}</button>
                <button id="clearSelectionBtn" class="btn">Clear Selection</button>
                <button id="markAllBtn" class="btn">Mark All Owned</button>
              </div>

              <div style="display:flex;gap:8px;margin-top:8px">
                <button id="camelotTierBtn" class="btn">Camelot: All Tiers</button>
                <button id="priorityBtn" class="btn">Priority: Tempo</button>
              </div>

              <div style="margin-top:12px">
                <div style="font-weight:700;margin-bottom:6px">Band Members</div>
                <div id="bandContainer"></div>
                <div style="margin-top:8px">
                  <button id="addBandBtn" class="btn">+ Add Band Member</button>
                </div>
              </div>
            </div>
          </div>

          <div class="panel mb-4">
            <div style="font-weight:800;margin-bottom:8px">Sandbox</div>
            <div id="sandbox" class="sandbox-drop" style="min-height:110px;padding:8px"></div>
            <div id="sandboxInfo" class="small-muted" style="margin-top:8px"></div>
            <div id="energyGraph" style="margin-top:8px"></div>
          </div>
        </div>

        <div style="flex:1">
          <div class="panel mb-4">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
              <div style="font-weight:800">Song Browser</div>
              <div class="small-muted">Selected: <span id="selectedInfo">None</span></div>
            </div>
            <div id="songList" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:12px"></div>
          </div>

          <div class="panel">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div style="font-weight:800">Setlist (<span id="setlistCount">${setlist.length}</span>)</div>
              <div>
                <button onclick="switchView('setlist')" class="btn">Open Setlist</button>
                <button onclick="switchView('browser')" class="btn">Browser</button>
              </div>
            </div>
            <div id="setlistContent"></div>
          </div>
        </div>
      </div>
    `;
  }

  // -------------------- Render helpers --------------------
  function renderBandPanel(){
    const container = document.getElementById('bandContainer');
    if(!container) return;
    if(bandMembers.length===0){ container.innerHTML = '<div class="small-muted">No band members yet.</div>'; return; }
    container.innerHTML = bandMembers.map(m=>{
      return `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
                <div style="display:flex;gap:8px;align-items:center">
                  <div style="width:36px;height:36px;border-radius:8px;background:${camelotColors['8B']};display:flex;align-items:center;justify-content:center">${m.djName?m.djName[0]:'?'}</div>
                  <div style="font-weight:700">${m.djName || m.username}</div>
                  <div class="small-muted" style="margin-left:8px">@${m.username}</div>
                </div>
                <div style="display:flex;gap:6px">
                  <button class="btn" onclick="viewBandMember('${m.username}')">View</button>
                </div>
              </div>`;
    }).join('');
  }

  function renderSongList(){
    const listEl = document.getElementById('songList');
    if(!listEl) return;
    const selected = selectedSong;
    const displayTracks = viewingMember ? viewingMember.ownedTracks || [] : ownedTracks || [];
    let filtered = songs.slice();

    // Search
    const q = (document.getElementById('searchInput')?.value || '').trim().toLowerCase();
    if(q) filtered = filtered.filter(s => s.title.toLowerCase().includes(q) || s.artist.toLowerCase().includes(q) || (s.genre||'').toLowerCase().includes(q));

    // Owned-only filter
    if(showOwnedOnly){
      filtered = filtered.filter(s => displayTracks.includes(s.id));
    }

    // Map owned flag for UI
    filtered = filtered.map(s => Object.assign({}, s, { _isOwned: displayTracks.includes(s.id) }));

    // Mixable-only filter (respects camelotTier & BPM tolerance)
    if(showMixableOnly && selected){
      filtered = filtered.filter(s=>{
        const keyTier = getCamelotTier(selected.camelot, s.camelot);
        const bpmOk = Math.abs(s.bpm - selected.bpm) <= 4;
        return keyTier <= camelotTier && bpmOk;
      });
    }

    // Sorting
    if(selected){
      filtered.sort((a,b)=>{
        if(priorityMode === 'tempo'){
          return Math.abs(a.bpm - selected.bpm) - Math.abs(b.bpm - selected.bpm);
        } else {
          const ta = getCamelotTier(selected.camelot, a.camelot);
          const tb = getCamelotTier(selected.camelot, b.camelot);
          return ta - tb;
        }
      });
    } else {
      filtered.sort((a,b)=>a.title.localeCompare(b.title));
    }

    // Build HTML
    listEl.innerHTML = filtered.map(song => {
      const isOwned = song._isOwned;
      const selectedMarker = selected && selected.id===song.id ? 'Selected' : 'Select';
      const bpmBadge = selected && selected.id!==song.id && Math.abs(song.bpm - (selected?.bpm||0)) <= 10 ? `<span class="small-muted" style="margin-left:8px">¬±${Math.abs(song.bpm - (selected?.bpm||0))} BPM</span>` : '';
      const keyColor = camelotColors[song.camelot] || '#666';
      const mixableMarker = selected && getCamelotTier(selected.camelot, song.camelot) <= camelotTier && Math.abs(song.bpm - (selected?.bpm||0)) <= 4 ? 'üéß' : '';
      return `
        <div class="song-card panel" data-song-id="${song.id}" draggable="true">
          <div style="display:flex;gap:12px">
            <div style="width:64px;height:64px;border-radius:8px;background:${keyColor};display:flex;align-items:center;justify-content:center">${song.camelot}</div>
            <div style="flex:1">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div>
                  <div style="font-weight:800">${song.title}</div>
                  <div class="small-muted">${song.artist}</div>
                </div>
                <div style="text-align:right">
                  <div class="small-muted">${song.bpm} BPM</div>
                  <div style="margin-top:6px">${mixableMarker}</div>
                </div>
              </div>
              <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
                <button class="btn" onclick="selectSong('${song.id}')">${selected && selected.id===song.id ? 'Selected' : 'Select'}</button>
                <button class="btn" onclick="addToSetlist('${song.id}')">+ Set</button>
                <button class="btn" onclick="toggleOwned('${song.id}')" ${viewingMember ? 'disabled style="opacity:.5;cursor:not-allowed;"' : ''}>${isOwned? '‚úì Owned':'Mark Owned'}</button>
                <button class="btn previewBtn" data-id="${song.id}" onclick="onPreviewClick('${song.id}')">Preview</button>
                ${bpmBadge}
              </div>
            </div>
          </div>
        </div>
      `;
    }).join('');
    document.getElementById('selectedInfo').textContent = selected ? `${selected.title} ‚Ä¢ ${selected.artist}` : 'None';
  }

  function renderSetlist(){
    const el = document.getElementById('setlistContent');
    if(!el) return;
    if(setlist.length===0){ el.innerHTML = '<div class="small-muted">Setlist is empty</div>'; document.getElementById('setlistCount').textContent = 0; return; }
    el.innerHTML = setlist.map((s,i)=>`<div class="panel" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><div><strong>${i+1}. ${s.title}</strong><div class="small-muted">${s.artist} ‚Ä¢ ${s.bpm} BPM ‚Ä¢ ${s.camelot}</div></div><div><button class="btn" onclick="removeFromSetlist('${s.id}')">‚úï</button></div></div>`).join('');
    document.getElementById('setlistCount').textContent = setlist.length;
  }

  // -------------------- Interactions --------------------
  function selectSong(id){
    const s = songs.find(x=>x.id===id); if(!s) return;
    if(selectedSong && selectedSong.id === id){ selectedSong = null; } else selectedSong = s;
    renderSongList();
  }

  function onPreviewClick(id){
    const s = songs.find(x=>x.id===id); if(!s) return;
    if(!selectedSong){ selectedSong = s; renderSongList(); alert('Main track selected. Click Preview on another track to compare.'); return; }
    previewSong = s;
    const comp = mashupCompatibility(selectedSong, previewSong);
    alert(`${selectedSong.title} ‚Üí ${previewSong.title}\nCompatibility: ${Math.round(comp.total)}%\nBPM diff: ${Math.abs(selectedSong.bpm - previewSong.bpm)}\n${bpmShiftSuggestion(selectedSong.bpm, previewSong.bpm)}`);
  }

  window.toggleMixableFilter = () => {
    if(!selectedSong){ alert('Select a song first to see mixable tracks!'); return; }
    showMixableOnly = !showMixableOnly;
    renderSongList();
    document.getElementById('mixableFilterBtn').textContent = showMixableOnly ? 'üéß Mixable Only':'Show Mixable';
  };

  window.toggleOwnedFilter = () => {
    showOwnedOnly = !showOwnedOnly;
    document.getElementById('ownedFilterBtn').textContent = showOwnedOnly ? '‚úì Owned Only':'Show All';
    renderSongList();
  };

  window.clearSelection = () => {
    selectedSong = null; previewSong = null; showMixableOnly = false;
    document.getElementById('mixableFilterBtn').textContent = 'Show Mixable';
    renderSongList();
  };

  window.toggleOwned = (id) => {
    if(viewingMember){ alert("You can't edit other people's collections!"); return; }
    if(ownedTracks.includes(id)) ownedTracks = ownedTracks.filter(x=>x!==id); else ownedTracks.push(id);
    localStorage.setItem('ownedTracks', JSON.stringify(ownedTracks));
    saveUserProfile();
    renderSongList();
  };

  window.addToSetlist = (id) => {
    const s = songs.find(x=>x.id===id); if(!s) return;
    if(!setlist.find(x=>x.id===id)){
      setlist.push(s); localStorage.setItem('setlist', JSON.stringify(setlist)); renderSetlist();
      document.getElementById('setlistCount').classList.add('animate-pulse');
      setTimeout(()=>document.getElementById('setlistCount').classList.remove('animate-pulse'),800);
    }
  };

  window.removeFromSetlist = (id) => {
    setlist = setlist.filter(x=>x.id!==id); localStorage.setItem('setlist', JSON.stringify(setlist)); renderSetlist();
  };

  window.switchView = (v) => {
    if(v==='setlist') window.scrollTo({top:document.getElementById('setlistContent').offsetTop-30,behavior:'smooth'});
    if(v==='browser') window.scrollTo({top:0,behavior:'smooth'});
  };

  // -------------------- Band members --------------------
  async function addBandMember(){
    const username = prompt('Enter bandmate username (exact):');
    if(!username) return;
    const profile = await loadUserProfile(username) || { username, djName: username, ownedTracks: [], genreOverrides: {} };
    if(bandMembers.find(m=>m.username===username)){ alert('This person is already in your band!'); return; }
    const memberProfile = { username: profile.username, djName: profile.djName || profile.username, ownedTracks: profile.ownedTracks || [], genreOverrides: profile.genreOverrides || {} };
    bandMembers.push(memberProfile);
    localStorage.setItem('bandMembers', JSON.stringify(bandMembers));
    saveUserProfile();
    renderBandPanel();
    alert(`Added ${memberProfile.djName} (@${memberProfile.username}) to your band.`);
  }

  async function viewBandMember(username){
    const profile = await loadUserProfile(username) || { username, djName: username, ownedTracks: [], genreOverrides: {} };
    profile.ownedTracks = profile.ownedTracks || [];
    profile.genreOverrides = profile.genreOverrides || {};
    viewingMember = profile;
    showOwnedOnly = true;
    render();
    document.getElementById('ownedFilterBtn').textContent = '‚úì Owned Only';
  }

  function backToMyProfile(){
    viewingMember = null;
    showOwnedOnly = false;
    render();
    document.getElementById('ownedFilterBtn').textContent = 'Show All';
  }

  // -------------------- Sandbox --------------------
  function sandboxInit(){
    const el = document.getElementById('sandbox'); if(!el) return;
    el.innerHTML = '<div class="small-muted">Drop tracks here</div>';
    el.addEventListener('dragover', (e)=>e.preventDefault());
    el.addEventListener('drop', (e)=>{
      e.preventDefault();
      const id = e.dataTransfer.getData('text/plain');
      const track = songs.find(s=>s.id===id); if(!track) return;
      if(sandboxTracks.find(s=>s.id===id)) return;
      if(sandboxTracks.length>=4){ alert('Sandbox limit: 4 tracks'); return; }
      sandboxTracks.push(track); renderSandbox();
    });
  }
  function renderSandbox(){
    const el = document.getElementById('sandbox'); if(!el) return;
    if(sandboxTracks.length===0){ el.innerHTML = '<div class="small-muted p-2">Drop tracks here</div>'; document.getElementById('sandboxInfo').textContent = ''; renderEnergyGraph([]); return; }
    el.innerHTML = sandboxTracks.map((t,i)=>`<div style="display:flex;align-items:center;gap:10px" class="panel"><div style="width:36px;height:36px;border-radius:6px;background:${camelotColors[t.camelot]||'#666'};display:flex;align-items:center;justify-content:center">${t.camelot}</div><div style="flex:1"><div style="font-weight:700">${t.title}</div><div class="small-muted">${t.artist} ‚Ä¢ ${t.genre} ‚Ä¢ ${t.bpm} BPM</div></div><div class="small-muted">${computeEnergy(t)}</div><div><button class="btn" onclick="removeSandbox('${t.id}')">‚úï</button></div></div>`).join('');
    const bpms = sandboxTracks.map(s=>s.bpm); const keys = sandboxTracks.map(s=>s.camelot);
    const bpmRange = bpms.length>0 ? `${Math.min(...bpms)}‚Äì${Math.max(...bpms)}` : 'n/a';
    document.getElementById('sandboxInfo').textContent = `BPM range: ${bpmRange} ‚Ä¢ Keys: ${[...new Set(keys)].join(', ')} ‚Ä¢ Tracks: ${sandboxTracks.length}`;
    renderEnergyGraph(sandboxTracks);
  }
  function removeSandbox(id){ sandboxTracks = sandboxTracks.filter(s=>s.id!==id); renderSandbox(); }
  function renderEnergyGraph(list){
    const container = document.getElementById('energyGraph'); if(!container) return;
    if(!list||list.length===0){ container.innerHTML = '<div class="small-muted">No tracks selected</div>'; return; }
    container.innerHTML = list.map((t,i)=>{
      const e = computeEnergy(t); const pct = (e/5)*100;
      const color = e>=4 ? 'linear-gradient(90deg,#f97316,#ef4444)' : e>=3 ? 'linear-gradient(90deg,#f59e0b,#f97316)' : 'linear-gradient(90deg,#34d399,#10b981)';
      return `<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px"><div style="width:28px" class="small-muted">${i+1}</div><div style="flex:1"><div class="small-muted text-xs">${t.title} ‚Äî <span style="color:${camelotColors[t.camelot]||'#fff'}">${t.camelot}</span></div><div class="energy-bar mt-1"><div style="width:${pct}%;height:12px;border-radius:8px;background:${color}"></div></div></div><div style="width:36px;text-align:center;font-weight:700">${e}</div></div>`;
    }).join('');
  }

  // -------------------- Export / Import --------------------
  async function exportCollection(){
    const data = { username: currentUser ? currentUser.username : 'guest', djName: currentUser ? currentUser.djName : '', ownedTracks, genreOverrides, exportDate: new Date().toISOString() };
    if(firestore && currentUser && confirm('Also back up to Firestore? (Cancel to only download)')){
      try{ await firestore.collection('backups').doc(`${currentUser.username}_${Date.now()}`).set(data); alert('Backed up to Firestore (backups collection).'); }catch(e){ console.warn('backup failed',e); }
    }
    const blob = new Blob([JSON.stringify(data,null,2)], { type:'application/json' }); const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `festival-mixer-${data.username || 'guest'}.json`; a.click(); URL.revokeObjectURL(url);
  }
  async function importCollection(){
    const input = document.createElement('input'); input.type='file'; input.accept='.json';
    input.onchange = async (e)=>{
      const file = e.target.files[0]; if(!file) return;
      const text = await file.text();
      try{
        const data = JSON.parse(text);
        if(!data.ownedTracks) throw new Error('Invalid import');
        if(!confirm(`Import ${data.ownedTracks.length} tracks from ${data.djName||data.username||'file'}?`)) return;
        ownedTracks = data.ownedTracks; genreOverrides = data.genreOverrides || {};
        localStorage.setItem('ownedTracks', JSON.stringify(ownedTracks));
        localStorage.setItem('genreOverrides', JSON.stringify(genreOverrides));
        saveUserProfile();
        songs.forEach(song=>{ if(genreOverrides[song.id]) song.genre = genreOverrides[song.id]; });
        renderSongList();
        alert('Imported!');
      }catch(err){ alert('Invalid file format'); }
    };
    input.click();
  }

  // -------------------- Auth --------------------
  window.handleLogin = async (e)=>{
    e && e.preventDefault && e.preventDefault();
    if(firebaseAuth){
      const email = prompt('Enter email (for Firebase login/register):');
      if(!email) return;
      const password = prompt('Enter password:');
      if(!password) return;
      try {
        const res = await firebaseAuth.signInWithEmailAndPassword(email, password);
        const username = email.split('@')[0];
        // load profile from backend
        const profile = await loadUserProfile(username);
        if(profile){
          currentUser = profile;
          ownedTracks = profile.ownedTracks || [];
          bandMembers = profile.bandMembers || [];
          genreOverrides = profile.genreOverrides || {};
        } else {
          currentUser = { username, djName: username };
          await saveUserProfile();
        }
        localStorage.setItem('currentUser', username);
        render();
        alert('Signed in.');
      } catch(err){
        if(err.code === 'auth/user-not-found' && confirm('No account found ‚Äî create one?')){
          try{
            const cred = await firebaseAuth.createUserWithEmailAndPassword(email, password);
            const username = email.split('@')[0];
            currentUser = { username, djName: username, ownedTracks: [], setlists: [], bandMembers: [], genreOverrides: {} };
            await saveUserProfileToBackend(currentUser);
            localStorage.setItem('currentUser', username);
            render();
            alert('Account created & signed in.');
          }catch(e){ alert('Register failed: '+(e.message||e)); }
        } else {
          alert('Sign in failed: '+(err.message||err));
        }
      }
      return;
    }
    // fallback simple local login
    const username = prompt('Enter username to sign in (local mode)');
    if(!username) return;
    currentUser = { username, djName: username };
    const profile = await loadUserProfile(username);
    if(profile){
      currentUser = profile;
      ownedTracks = profile.ownedTracks || [];
      bandMembers = profile.bandMembers || [];
      genreOverrides = profile.genreOverrides || {};
    } else {
      await saveUserProfile();
    }
    localStorage.setItem('currentUser', username);
    render();
  };

  async function logoutUser(){
    saveUserProfile();
    if(firebaseAuth && firebaseAuth.currentUser){
      try{ await firebaseAuth.signOut(); }catch(e){ console.warn('signout error',e); }
    }
    currentUser = null; ownedTracks = []; setlist = []; bandMembers = []; viewingMember = null; genreOverrides = {};
    localStorage.removeItem('currentUser');
    render();
    alert('Logged out (local mode).');
  }

  // -------------------- Helpers / event wiring --------------------
  function setupEventListeners(){
    document.getElementById('mixableFilterBtn')?.addEventListener('click', ()=>window.toggleMixableFilter());
    document.getElementById('ownedFilterBtn')?.addEventListener('click', ()=>window.toggleOwnedFilter());
    document.getElementById('clearSelectionBtn')?.addEventListener('click', ()=>window.clearSelection());
    document.getElementById('markAllBtn')?.addEventListener('click', ()=>{ if(!confirm('Mark ALL loaded songs as owned?')) return; ownedTracks = songs.map(s=>s.id); localStorage.setItem('ownedTracks', JSON.stringify(ownedTracks)); saveUserProfile(); renderSongList(); });
    document.getElementById('addBandBtn')?.addEventListener('click', ()=>addBandMember());
    document.getElementById('searchInput')?.addEventListener('input', (e)=>{ renderSongList(); });

    // Camelot Tier button
    document.getElementById('camelotTierBtn')?.addEventListener('click', ()=>{
      camelotTier++; if(camelotTier>3) camelotTier=1;
      const labels = {1:'Camelot: Tier 1 Only',2:'Camelot: Tiers 1‚Äì2',3:'Camelot: All Tiers'};
      document.getElementById('camelotTierBtn').textContent = labels[camelotTier];
      renderSongList();
    });

    // Priority toggle
    document.getElementById('priorityBtn')?.addEventListener('click', ()=>{
      priorityMode = priorityMode === 'tempo' ? 'camelot' : 'tempo';
      document.getElementById('priorityBtn').textContent = priorityMode === 'tempo' ? 'Priority: Tempo' : 'Priority: Camelot';
      renderSongList();
    });

    // dragstart binding for sandbox
    document.querySelectorAll('.song-card').forEach(card=>{
      card.addEventListener('dragstart', (e)=> e.dataTransfer.setData('text/plain', card.getAttribute('data-song-id')) );
    });

    // preview buttons binding
    document.querySelectorAll('.previewBtn').forEach(btn=>{
      btn.addEventListener('click', (e)=>{ e.preventDefault(); onPreviewClick(btn.dataset.id); });
    });

    // genre context right-click (admin override)
    document.querySelectorAll('[data-genre-tag]').forEach(btn=>{
      btn.addEventListener('contextmenu', (e)=>{ e.preventDefault(); const songId = btn.getAttribute('data-genre-tag'); showGenreMenu(songId, e); });
      btn.addEventListener('click', (e)=>{ e.stopPropagation(); const songId = btn.getAttribute('data-genre-tag'); if(currentUser && currentUser.username==='BattleNeBody') showGenreMenu(songId, e); });
    });
  }

  // -------------------- Genre override menu --------------------
  function showGenreMenu(songId,event){
    if(!currentUser||currentUser.username!=='BattleNeBody'){ alert('üîí Only the admin (BattleNeBody) can correct genre tags!'); return; }
    const existing = document.getElementById('genreContextMenu'); if(existing) existing.remove();
    const menu=document.createElement('div'); menu.id='genreContextMenu'; menu.className='context-menu';
    const rect = event.target.getBoundingClientRect();
    let left=rect.left, top=rect.bottom+5;
    if(left+220>window.innerWidth) left=rect.right-220;
    if(top+300>window.innerHeight) top=rect.top-305;
    menu.style.left = left+'px'; menu.style.top = top+'px';
    const genres = Object.keys(genreMap).concat(['Other']);
    menu.innerHTML = `<div style="display:flex;flex-direction:column;gap:8px;padding:6px">${genres.map(g=>`<button class="btn" data-genre="${g}">${g}</button>`).join('')}</div>`;
    document.body.appendChild(menu);
    menu.querySelectorAll('button').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const g = b.dataset.genre;
        genreOverrides[songId] = g;
        localStorage.setItem('genreOverrides', JSON.stringify(genreOverrides));
        // apply to songs array
        songs.forEach(s=>{ if(s.id===songId) s.genre = g; });
        await saveUserProfile();
        renderSongList();
        menu.remove();
      });
    });
    document.addEventListener('click', ()=>{ menu.remove(); }, { once: true });
  }

  // -------------------- Init / boot --------------------
  function openHelp(){ document.getElementById('helpModal').style.display = 'flex'; document.getElementById('helpModal').focus(); }
  function closeHelp(){ document.getElementById('helpModal').style.display = 'none'; }

  (async function init(){
    ownedTracks = JSON.parse(localStorage.getItem('ownedTracks') || '[]');
    bandMembers = JSON.parse(localStorage.getItem('bandMembers') || '[]');
    genreOverrides = JSON.parse(localStorage.getItem('genreOverrides') || '{}');
    setlist = JSON.parse(localStorage.getItem('setlist') || '[]');
    const savedUser = localStorage.getItem('currentUser');
    if(savedUser){ const profile = await loadUserProfile(savedUser); if(profile) currentUser = profile; else currentUser = { username:savedUser, djName: savedUser }; }
    render();
    sandboxInit();
    await loadSongs();
    setTimeout(()=>{ setupEventListeners(); },120);
  })();

  </script>
</body>
</html>
