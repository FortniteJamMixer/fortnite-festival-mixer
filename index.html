<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fortnite Festival Pro Mixer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
  </style>
</head>
<body>
  <div id="app">
    <div class="min-h-screen bg-gradient-to-br from-purple-900 via-indigo-900 to-gray-900 text-white flex items-center justify-center">
      <div class="text-center">
        <div class="text-6xl mb-4 animate-pulse">üéµ</div>
        <div class="text-2xl font-bold">Loading Fortnite Tracks...</div>
        <div class="text-purple-300 text-sm mt-2">Bypassing CORS restrictions...</div>
      </div>
    </div>
  </div>
  
  <script>
    const camelotColors = {
      '1A': '#FF6B9D', '1B': '#FF8FAB', '2A': '#FFA07A', '2B': '#FFB699',
      '3A': '#FFD700', '3B': '#FFE55C', '4A': '#98D8C8', '4B': '#7FD8BE',
      '5A': '#6BCB77', '5B': '#8FD89F', '6A': '#4D96FF', '6B': '#6FB1FF',
      '7A': '#9D4EDD', '7B': '#B877FF', '8A': '#E84A5F', '8B': '#FF6B81',
      '9A': '#00D9FF', '9B': '#4DFFFF', '10A': '#FFA400', '10B': '#FFBB5C',
      '11A': '#FE6D73', '11B': '#FF8C94', '12A': '#A8E6CF', '12B': '#C1F0DD'
    };

    const keyToCamelot = {
      'C': '8B', 'Am': '8A', 'A Minor': '8A', 'C Major': '8B',
      'G': '9B', 'Em': '9A', 'E Minor': '9A', 'G Major': '9B',
      'D': '10B', 'Bm': '10A', 'B Minor': '10A', 'D Major': '10B',
      'A': '11B', 'F#m': '11A', 'F# Minor': '11A', 'A Major': '11B',
      'E': '12B', 'C#m': '12A', 'C# Minor': '12A', 'E Major': '12B',
      'B': '1B', 'G#m': '1A', 'G# Minor': '1A', 'B Major': '1B',
      'F#': '2B', 'D#m': '2A', 'D# Minor': '2A', 'F# Major': '2B',
      'Db': '3B', 'Bbm': '3A', 'Bb Minor': '3A', 'Db Major': '3B',
      'Ab': '4B', 'Fm': '4A', 'F Minor': '4A', 'Ab Major': '4B',
      'Eb': '5B', 'Cm': '5A', 'C Minor': '5A', 'Eb Major': '5B',
      'Bb': '6B', 'Gm': '6A', 'G Minor': '6A', 'Bb Major': '6B',
      'F': '7B', 'Dm': '7A', 'D Minor': '7A', 'F Major': '7B'
    };

    let songs = [];
    let ownedTracks = JSON.parse(localStorage.getItem('ownedTracks') || '[]');
    let selectedSong = null;
    let setlist = [];
    let searchTerm = '';
    let view = 'browser';
    let showOwnedOnly = false;

    function convertToCamelot(key, mode) {
      if (!key) return '?';
      const fullKey = `${key} ${mode}`;
      return keyToCamelot[fullKey] || keyToCamelot[key] || '?';
    }

    async function loadSongs() {
      console.log('üéµ Loading Fortnite Festival tracks...');
      
      const endpoints = [
        'https://api.allorigins.win/raw?url=https://fortnitecontent-website-prod07.ol.epicgames.com/content/api/pages/fortnite-game/spark-tracks',
        'https://corsproxy.io/?https://fortnitecontent-website-prod07.ol.epicgames.com/content/api/pages/fortnite-game/spark-tracks',
      ];
      
      for (let i = 0; i < endpoints.length; i++) {
        try {
          console.log(`üì° Trying endpoint ${i + 1}/${endpoints.length}...`);
          
          const response = await fetch(endpoints[i]);
          
          console.log(`üìä Response status: ${response.status}`);
          
          if (!response.ok) {
            console.warn(`‚ö†Ô∏è Endpoint ${i + 1} failed with status ${response.status}`);
            continue;
          }
          
          const data = await response.json();
          console.log('üì¶ Received data, processing...');
          
          songs = Object.entries(data)
            .filter(([key]) => !key.startsWith('_'))
            .map(([id, item]) => {
              const track = item?.track;
              if (!track?.tt) return null;
              
              return {
                id,
                title: track.tt,
                artist: track.an || 'Unknown',
                bpm: track.mt || 0,
                key: track.mk || '?',
                mode: track.mm || '',
                camelot: convertToCamelot(track.mk, track.mm),
                duration: track.dn || 0,
                albumArt: track.au || ''
              };
            })
            .filter(song => song && song.bpm > 0);
          
          if (songs.length > 0) {
            console.log(`‚úÖ Successfully loaded ${songs.length} tracks!`);
            render();
            setupEventListeners();
            return;
          }
          
        } catch (error) {
          console.error(`‚ùå Endpoint ${i + 1} error:`, error);
        }
      }
      
      console.error('‚ùå All endpoints failed');
      showError('Unable to load tracks. The API may be temporarily unavailable. Try refreshing in a few minutes.');
    }

    function showError(message) {
      document.getElementById('app').innerHTML = `
        <div class="min-h-screen bg-gradient-to-br from-purple-900 via-indigo-900 to-gray-900 text-white flex items-center justify-center p-6">
          <div class="text-center max-w-2xl">
            <div class="text-6xl mb-4">‚ö†Ô∏è</div>
            <div class="text-2xl font-bold mb-4">Unable to Load Tracks</div>
            <div class="text-gray-300 mb-6 bg-black/30 p-4 rounded-lg">
              <p class="mb-2">${message}</p>
              <p class="text-sm text-purple-300 mt-4">The Fortnite API has CORS restrictions. We're using a proxy to bypass this.</p>
            </div>
            <button onclick="location.reload()" class="px-6 py-3 bg-purple-500 hover:bg-purple-600 rounded-lg">
              üîÑ Retry Loading
            </button>
          </div>
        </div>
      `;
    }

    function saveOwned() {
      localStorage.setItem('ownedTracks', JSON.stringify(ownedTracks));
    }

    function toggleOwned(id) {
      if (ownedTracks.includes(id)) {
        ownedTracks = ownedTracks.filter(t => t !== id);
      } else {
        ownedTracks.push(id);
      }
      saveOwned();
      renderSongList();
      updateOwnedCount();
    }

    function formatDuration(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function updateOwnedCount() {
      const countEl = document.getElementById('ownedCount');
      if (countEl) {
        countEl.textContent = `You own ${ownedTracks.length}/${songs.length} tracks`;
      }
    }

    function renderSongList() {
      const filteredSongs = songs.filter(s => 
        (s.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
        s.artist.toLowerCase().includes(searchTerm.toLowerCase())) &&
        (!showOwnedOnly || ownedTracks.includes(s.id))
      );

      const songListEl = document.getElementById('songList');
      if (!songListEl) return;

      songListEl.innerHTML = `
        ${selectedSong ? `
          <div class="mb-6 bg-purple-500/20 border border-purple-500/30 rounded-xl p-4">
            <div class="flex items-center gap-4 flex-wrap">
              ${selectedSong.albumArt ? `<img src="${selectedSong.albumArt}" class="w-16 h-16 rounded-lg"/>` : ''}
              <div class="flex-1">
                <div class="text-sm text-purple-300">Now Mixing From:</div>
                <div class="font-bold text-lg">${selectedSong.title}</div>
                <div class="text-purple-200 text-sm">${selectedSong.artist}</div>
              </div>
              <div class="text-right">
                <div class="text-2xl font-mono font-bold" style="color: ${camelotColors[selectedSong.camelot] || '#666'}">${selectedSong.camelot}</div>
                <div class="text-xs text-purple-200">${selectedSong.key} ${selectedSong.mode}</div>
              </div>
              <button onclick="clearSelection()" class="p-2 hover:bg-white/10 rounded">‚úï</button>
            </div>
          </div>
        ` : ''}

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          ${filteredSongs.slice(0, 100).map(song => {
            const isOwned = ownedTracks.includes(song.id);
            return `
              <div class="bg-gray-800/60 border ${selectedSong?.id === song.id ? 'border-purple-400' : 'border-gray-700'} rounded-xl p-4 relative">
                ${isOwned ? '<div class="absolute top-2 right-2 text-xl">‚≠ê</div>' : ''}
                <div class="flex gap-4 mb-3">
                  ${song.albumArt ? `<img src="${song.albumArt}" class="w-20 h-20 rounded-lg cursor-pointer" onclick="selectSong('${song.id}')"/>` : `<div class="w-20 h-20 bg-purple-500 rounded-lg"></div>`}
                  <div class="flex-1 cursor-pointer" onclick="selectSong('${song.id}')">
                    <div class="font-bold text-lg mb-1">${song.title}</div>
                    <div class="text-gray-300 mb-2 text-sm">${song.artist}</div>
                    <div class="flex items-center gap-2 text-sm flex-wrap">
                      <span class="px-3 py-1 rounded-lg font-mono font-bold text-white" style="background: ${camelotColors[song.camelot] || '#666'}">${song.camelot}</span>
                      <span class="px-2 py-1 bg-gray-700 rounded text-xs">${song.key} ${song.mode}</span>
                      <span class="font-semibold">${song.bpm} BPM</span>
                      <span class="text-gray-400">${formatDuration(song.duration)}</span>
                    </div>
                  </div>
                </div>
                <div class="flex gap-2">
                  <button onclick="toggleOwned('${song.id}')" class="flex-1 px-3 py-2 ${isOwned ? 'bg-green-500' : 'bg-gray-700'} rounded-lg text-sm font-medium">
                    ${isOwned ? '‚úì Owned' : 'Mark Owned'}
                  </button>
                  <button onclick="addToSetlist('${song.id}')" class="px-4 py-2 bg-purple-500 rounded-lg text-sm font-medium">
                    + Set
                  </button>
                </div>
              </div>
            `;
          }).join('')}
        </div>
        ${filteredSongs.length > 100 ? `<div class="text-center mt-6 text-purple-300">Showing 100 of ${filteredSongs.length} tracks</div>` : ''}
      `;
    }

    function renderSetlist() {
      const setlistEl = document.getElementById('setlistContent');
      if (!setlistEl) return;

      if (setlist.length === 0) {
        setlistEl.innerHTML = `
          <div class="text-center py-12">
            <div class="text-6xl mb-4">üéµ</div>
            <p class="text-xl mb-4">Your setlist is empty</p>
            <button onclick="switchView('browser')" class="px-6 py-3 bg-purple-500 rounded-lg">Browse Tracks</button>
          </div>
        `;
      } else {
        setlistEl.innerHTML = `
          <div class="space-y-4">
            ${setlist.map((song, i) => `
              <div class="bg-gray-800/60 border border-gray-700 rounded-xl p-4 flex items-center gap-4">
                <div class="text-2xl font-bold text-purple-400">${i + 1}</div>
                ${song.albumArt ? `<img src="${song.albumArt}" class="w-16 h-16 rounded-lg"/>` : ''}
                <div class="flex-1">
                  <div class="font-bold text-lg">${song.title}</div>
                  <div class="text-gray-300">${song.artist}</div>
                </div>
                <div class="text-xl font-mono font-bold" style="color: ${camelotColors[song.camelot]}">${song.camelot}</div>
                <button onclick="removeFromSetlist('${song.id}')" class="p-2 hover:bg-red-500/20 rounded text-red-400">‚úï</button>
              </div>
            `).join('')}
          </div>
        `;
      }
    }

    function render() {
      const ownedCount = ownedTracks.length;

      document.getElementById('app').innerHTML = `
        <div class="min-h-screen bg-gradient-to-br from-purple-900 via-indigo-900 to-gray-900 text-white">
          <div class="bg-black/40 backdrop-blur-xl border-b border-white/10 sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between flex-wrap gap-4">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-500 rounded-lg flex items-center justify-center text-2xl">
                  üéµ
                </div>
                <div>
                  <h1 class="text-2xl font-bold">Festival Pro Mixer</h1>
                  <p id="ownedCount" class="text-xs text-purple-300">You own ${ownedCount}/${songs.length} tracks</p>
                </div>
              </div>
              <div class="flex gap-2">
                <button id="browserBtn" class="px-4 py-2 rounded-lg font-medium transition ${view === 'browser' ? 'bg-purple-500' : 'bg-white/10'}">
                  Browse
                </button>
                <button id="setlistBtn" class="px-4 py-2 rounded-lg font-medium transition ${view === 'setlist' ? 'bg-purple-500' : 'bg-white/10'}">
                  Setlist (<span id="setlistCount">${setlist.length}</span>)
                </button>
              </div>
            </div>
          </div>

          <div class="max-w-7xl mx-auto px-6 py-6">
            <div id="browserView" style="display: ${view === 'browser' ? 'block' : 'none'}">
              <div class="mb-6 space-y-4">
                <input
                  type="text"
                  id="searchInput"
                  placeholder="Search tracks or artists..."
                  class="w-full px-4 py-3 bg-gray-800/80 border border-gray-700 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500"
                />
                <div class="flex flex-wrap gap-3">
                  <button id="ownedFilterBtn" class="px-4 py-2 rounded-lg font-medium transition ${showOwnedOnly ? 'bg-green-500' : 'bg-white/10'}">
                    ${showOwnedOnly ? '‚úì Owned Only' : 'Show All'}
                  </button>
                  <button id="markAllBtn" class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg">
                    Mark All Owned
                  </button>
                  <button id="clearAllBtn" class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg">
                    Clear All
                  </button>
                </div>
              </div>
              <div id="songList"></div>
            </div>

            <div id="setlistView" style="display: ${view === 'setlist' ? 'block' : 'none'}">
              <div id="setlistContent"></div>
            </div>
          </div>
        </div>
      `;

      if (view === 'browser') {
        renderSongList();
      } else {
        renderSetlist();
      }
    }

    function setupEventListeners() {
      // Search input
      const searchInput = document.getElementById('searchInput');
      if (searchInput) {
        searchInput.addEventListener('input', (e) => {
          searchTerm = e.target.value;
          renderSongList();
        });
      }

      // View buttons
      document.getElementById('browserBtn')?.addEventListener('click', () => switchView('browser'));
      document.getElementById('setlistBtn')?.addEventListener('click', () => switchView('setlist'));

      // Filter buttons
      document.getElementById('ownedFilterBtn')?.addEventListener('click', toggleOwnedFilter);
      document.getElementById('markAllBtn')?.addEventListener('click', markAllOwned);
      document.getElementById('clearAllBtn')?.addEventListener('click', clearAllOwned);
    }

    window.selectSong = (id) => { 
      selectedSong = songs.find(s => s.id === id); 
      renderSongList();
    };
    
    window.clearSelection = () => { 
      selectedSong = null; 
      renderSongList();
    };
    
    window.toggleOwned = toggleOwned;
    
    window.markAllOwned = () => { 
      ownedTracks = songs.map(s => s.id); 
      saveOwned(); 
      renderSongList();
      updateOwnedCount();
    };
    
    window.clearAllOwned = () => { 
      ownedTracks = []; 
      saveOwned(); 
      renderSongList();
      updateOwnedCount();
    };
    
    window.toggleOwnedFilter = () => { 
      showOwnedOnly = !showOwnedOnly;
      const btn = document.getElementById('ownedFilterBtn');
      if (btn) {
        btn.className = `px-4 py-2 rounded-lg font-medium transition ${showOwnedOnly ? 'bg-green-500' : 'bg-white/10'}`;
        btn.textContent = showOwnedOnly ? '‚úì Owned Only' : 'Show All';
      }
      renderSongList();
    };
    
    window.addToSetlist = (id) => { 
      const song = songs.find(s => s.id === id); 
      if (!setlist.find(s => s.id === id)) { 
        setlist.push(song);
        const countEl = document.getElementById('setlistCount');
        if (countEl) countEl.textContent = setlist.length;
      }
    };
    
    window.removeFromSetlist = (id) => { 
      setlist = setlist.filter(s => s.id !== id); 
      renderSetlist();
      const countEl = document.getElementById('setlistCount');
      if (countEl) countEl.textContent = setlist.length;
    };
    
    window.switchView = (newView) => { 
      view = newView;
      document.getElementById('browserView').style.display = view === 'browser' ? 'block' : 'none';
      document.getElementById('setlistView').style.display = view === 'setlist' ? 'block' : 'none';
      
      // Update button styles
      const browserBtn = document.getElementById('browserBtn');
      const setlistBtn = document.getElementById('setlistBtn');
      if (browserBtn) browserBtn.className = `px-4 py-2 rounded-lg font-medium transition ${view === 'browser' ? 'bg-purple-500' : 'bg-white/10'}`;
      if (setlistBtn) setlistBtn.className = `px-4 py-2 rounded-lg font-medium transition ${view === 'setlist' ? 'bg-purple-500' : 'bg-white/10'}`;
      
      if (view === 'browser') {
        renderSongList();
        setupEventListeners();
      } else {
        renderSetlist();
      }
    };

    loadSongs();
  </script>
</body>
</html>
