<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="theme-color" content="#0f1020" />
  <title>Fortnite Jam Mixer ‚Äì Cross-Browser Edition</title>
  <meta name="description" content="Fortnite Jam Mixer helps you build harmonious Fortnite Festival mashups with Camelot, BPM, and setlist tools." />
  <link rel="manifest" href="/manifest.webmanifest" />
  <script>document.documentElement.classList.add('tw-offline');</script>
  <link rel="stylesheet" href="/offline.css" />
  <script src="https://cdn.tailwindcss.com" onload="document.documentElement.classList.remove('tw-offline');" onerror="console.warn('Tailwind CDN unavailable; using offline fallback.');"></script>

  <!-- Firebase config injected from Vercel (serverless /api/firebase-config) -->
  <script src="/api/firebase-config"></script>

  <!-- Optional Firebase SDKs (compat). Enable only if you use Firebase. -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <style>
    /* ---------------- Theme & Layout ---------------- */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html,body { height: 100%; }
    body {
      background: linear-gradient(135deg, #0f1020 0%, #14122a 40%, #071130 100%);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color: #e9f7ff;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .content-wrapper { max-width: 1200px; margin: 18px auto; padding: 12px; }
    .panel { background: linear-gradient(180deg, rgba(0,0,0,0.55), rgba(0,0,0,0.45)); border-radius: 12px; border: 1px solid rgba(255,255,255,0.03); padding: 12px; }
    .vinyl-spin { animation: spin 4s linear infinite; }
    .bounce-icon { animation: bounce 2s ease-in-out infinite; }
    @keyframes spin { from { transform: rotate(0) } to { transform: rotate(360deg) } }
    @keyframes bounce { 0%,100% { transform: translateY(0) } 50% { transform: translateY(-8px) } }
    .graffiti-text { text-shadow: 3px 3px 0 #ff6b9d, 6px 6px 0 rgba(255,107,157,0.22); letter-spacing: 1px; }
    .camelot-pill { padding: 6px 10px; border-radius: 10px; font-weight: 700; color: #fff; }
    .score-badge { font-weight: 800; letter-spacing: .6px; padding: 6px 10px; border-radius: 8px; display:inline-block; }
    .small-muted { color: rgba(230,247,255,0.7); font-size: 13px; }
    .sandbox-drop { min-height: 110px; border-radius: 12px; padding: 10px; border: 2px dashed rgba(255,255,255,0.04); }
    .context-menu { position: fixed; background: rgba(0,0,0,0.95); border-radius: 8px; padding: 8px; z-index:10000; backdrop-filter: blur(8px); border: 1px solid rgba(0,217,255,0.12); color: #e6f7ff; }
    .glow-perfect { box-shadow: 0 0 18px rgba(57,255,20,0.85), 0 0 48px rgba(57,255,20,0.12); }
    .glow-good { box-shadow: 0 0 12px rgba(255,230,65,0.9), 0 0 36px rgba(255,230,65,0.08); }
    .glow-bad { box-shadow: 0 0 12px rgba(255,63,63,0.9), 0 0 36px rgba(255,63,63,0.08); }
    .selected-panel { border: 2px solid rgba(0,217,255,0.6); box-shadow: 0 0 18px rgba(0,217,255,0.18), 0 0 32px rgba(255,107,157,0.18); background: linear-gradient(90deg, rgba(0,217,255,0.1), rgba(255,107,157,0.12)); }
    .selected-badge { background: linear-gradient(90deg,#06b6d4,#ec4899); color:#fff; font-weight:800; padding:6px 10px; border-radius:999px; font-size:11px; letter-spacing:0.5px; box-shadow: 0 0 12px rgba(6,182,212,0.4); }
    .selected-card { border: 2px solid rgba(0,217,255,0.8); box-shadow: 0 0 26px rgba(0,217,255,0.45), 0 0 12px rgba(236,72,153,0.25); }
    #adminToolsBtn { pointer-events: auto; cursor: pointer; }
    .admin-tools-menu { z-index: 6000; pointer-events: auto; position: absolute; }
    .song-grid { grid-template-columns: 1fr; }
    @media (min-width: 768px) {
      .song-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    /* Help modal */
    #helpModal {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 20000;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.85);
      backdrop-filter: blur(6px);
    }
    .helpBox {
      width: 92%;
      max-width: 760px;
      height: 80vh;
      background: linear-gradient(180deg, rgba(12,10,25,0.96), rgba(20,16,38,0.98));
      border-radius: 14px;
      border: 2px solid rgba(0,217,255,0.14);
      box-shadow: 0 10px 40px rgba(0,0,0,0.6), 0 0 50px rgba(0,217,255,0.06);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    .helpHeader {
      padding: 14px 18px;
      border-bottom: 1px solid rgba(0,217,255,0.06);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .helpTitle { font-size:20px; font-weight:800; color:#fff; display:flex; gap:10px; align-items:center; }
    .helpTabs { display:flex; gap:8px; align-items:center; }
    .helpTabBtn { padding:8px 10px; border-radius:10px; border:1px solid rgba(0,217,255,0.18); background:rgba(255,255,255,0.06); color:#dff7ff; font-weight:800; cursor:pointer; }
    .helpTabBtn.active { background: linear-gradient(90deg,#ff6b9d,#8b5cf6); border-color: rgba(255,255,255,0.14); box-shadow:0 0 18px rgba(139,92,246,0.18); color:#fff; }
    .helpContent {
      padding: 14px 18px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      color: #dff7ff;
      line-height:1.45;
      font-size:14px;
    }
    .helpSection { margin-bottom: 18px; }
    .helpSection h3 { font-size: 16px; margin-bottom: 6px; font-weight: 800; color: #fff; }
    .helpSection h4 { font-size: 14px; margin-bottom: 6px; font-weight: 800; color: #9fe8ff; }
    .helpSection p, .helpSection ul, .helpSection ol { margin-bottom: 8px; }
    .helpSection ul { margin-left: 16px; }
    .helpSection ol { margin-left: 18px; }
    .helpDivider { margin: 14px 0; border-color: rgba(0,217,255,0.08); }
    .anchorGrid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 8px; margin-bottom: 12px; }
    .anchorLink { display: block; padding: 10px 12px; border-radius: 10px; background: rgba(0,217,255,0.06); border: 1px solid rgba(0,217,255,0.12); color: #e6f7ff; text-decoration: none; font-weight: 700; }
    .anchorLink:hover { border-color: rgba(255,107,157,0.35); box-shadow: 0 0 12px rgba(255,107,157,0.18); }
    .callout { padding: 12px; border-radius: 10px; border: 1px solid rgba(0,217,255,0.14); background: rgba(0,217,255,0.05); margin-bottom: 10px; }
    .calloutTitle { font-weight: 800; margin-bottom: 6px; display: flex; align-items: center; gap: 6px; color: #9fe8ff; text-transform: uppercase; letter-spacing: 0.3px; font-size: 12px; }
    .tag { display: inline-flex; align-items: center; gap: 6px; padding: 4px 8px; border-radius: 999px; background: rgba(0,217,255,0.12); color: #bdeeff; font-weight: 700; font-size: 12px; }
    .camelot-wheel { width: 100%; max-width: 520px; margin: 10px auto; display: flex; justify-content: center; }
    .camelot-wheel svg { width: 100%; height: auto; }
    .camelot-caption { text-align: center; color: #e6f7ff; font-size: 13px; margin-top: 6px; }
    .pill { display: inline-block; padding: 4px 10px; border-radius: 999px; font-weight: 800; font-size: 12px; }
    .helpFooter { padding: 10px 14px; border-top: 1px solid rgba(0,217,255,0.04); text-align:right; }

    /* Custom neon scrollbar for helpContent */
    .helpContent::-webkit-scrollbar { width: 12px; }
    .helpContent::-webkit-scrollbar-track { background: linear-gradient(180deg, rgba(0,0,0,0.12), rgba(0,0,0,0.06)); border-radius:8px; }
    .helpContent::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, rgba(0,217,255,0.9), rgba(255,107,157,0.9));
      border-radius: 8px;
      border: 2px solid rgba(0,0,0,0.2);
      box-shadow: 0 0 12px rgba(0,217,255,0.14);
    }
    .helpCloseBtn {
      background: linear-gradient(90deg,#ff6b9d,#8b5cf6);
      padding: 8px 12px;
      border-radius: 10px;
      color: #fff;
      font-weight:700;
      cursor:pointer;
      border: none;
      box-shadow: 0 6px 24px rgba(139,92,246,0.12);
    }

    /* responsive tweaks */
    @media (max-width: 980px) {
      .two-col { flex-direction: column; }
      .rightCol { width: 100% !important; min-width: auto; }
    }
  </style>
</head>
<body>
  <div class="content-wrapper">
    <div id="app">
      <div class="min-h-screen flex items-center justify-center">
        <div class="text-center">
          <div class="text-6xl mb-4 animate-pulse">üéµ</div>
          <div class="text-2xl font-bold text-white" data-brand="loading">Loading Fortnite Jam Mixer...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Help Modal (outside #app so it persists) -->
  <div id="helpModal" aria-hidden="true">
      <div class="helpBox" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
      <div class="helpHeader">
        <div class="helpTitle" id="helpTitle">
          <div style="width:50px;height:50px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:linear-gradient(90deg,#ff6b9d,#8b5cf6);box-shadow:0 8px 24px rgba(139,92,246,0.12);font-size:22px;">üéß</div>
          <div>
            <div style="font-size:18px;font-weight:800">HELP & FEATURES</div>
            <div style="font-size:12px;color:#bdeeff">Everything the landing page explains ‚Äî available anytime</div>
          </div>
        </div>
        <div class="helpTabs" role="tablist" aria-label="Help tabs">
          <button id="helpTabBasic" class="helpTabBtn active" data-tab="basic" role="tab" aria-selected="true" aria-controls="helpBasic">Basic</button>
          <button id="helpTabAdvanced" class="helpTabBtn" data-tab="advanced" role="tab" aria-selected="false" aria-controls="helpAdvanced" tabindex="-1">Advanced</button>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="helpCloseBtn" onclick="closeHelp()" aria-label="Close help">‚úï Close</button>
        </div>
      </div>

      <div class="helpContent" id="helpContent">
        <div id="helpBasic" data-help-pane="basic">
          <div class="helpSection" id="welcome">
            <h3 data-brand="help-title">Fortnite Jam Mixer Help</h3>
            <p class="small-muted" data-brand="help-intro">A complete, beginner-to-pro guide for every tool in Fortnite Jam Mixer. Open this help anytime with the ‚ùì button in the header.</p>
            <div class="anchorGrid">
              <a class="anchorLink" href="#quickstart">Quick Start</a>
              <a class="anchorLink" href="#browse">Browse, Search & Filter</a>
              <a class="anchorLink" href="#select">Select a Track & Mixable Only</a>
              <a class="anchorLink" href="#priority">Priority Modes & Strength</a>
              <a class="anchorLink" href="#setlist">Setlist & Set view</a>
              <a class="anchorLink" href="#camelot">Camelot Wheel & Harmonic Mixing</a>
              <a class="anchorLink" href="#internalCamelot" data-brand="help-anchor-camelot">How Fortnite Jam Mixer uses Camelot</a>
              <a class="anchorLink" href="#export">Export & Import Basics</a>
            </div>
          </div>

          <div class="helpSection" id="quickstart">
            <h3>Quick Start</h3>
            <ol style="line-height:1.6">
              <li><strong>Browse or search</strong> the song cards. Hovering shows genre, BPM, Camelot key, and ownership.</li>
              <li><strong>Select a track</strong> (click any card). It becomes the anchor; matching songs bubble to the top.</li>
              <li><strong>Choose a Priority Mode</strong> (Tempo, Camelot, or Genre) and adjust <strong>Priority Strength</strong> (Low/Medium/High) to steer the tie-breakers.</li>
              <li><strong>Toggle Mixable Only</strong> when you want strict harmonic/tempo filtering instead of broad suggestions.</li>
              <li><strong>Add to Set</strong> to start a setlist.</li>
            </ol>
            <div class="callout">
              <div class="calloutTitle">üí° Beginner Tip</div>
              <p class="small-muted">Start with Camelot Priority + Mixable Only. You‚Äôll see the safest harmonic picks immediately.</p>
            </div>
          </div>

          <div class="helpSection" id="browse">
            <h3>Browse, Search & Filter</h3>
            <ul>
              <li><strong>Browse songs</strong> in the main grid. Use the <span class="pill" style="background:rgba(255,107,157,0.18);border:1px solid rgba(255,107,157,0.4);color:#fff;">Genre</span> and <span class="pill" style="background:rgba(0,217,255,0.15);border:1px solid rgba(0,217,255,0.4);color:#fff;">Camelot key</span> pills for quick scanning.</li>
              <li><strong>Search</strong> by title or artist in the header bar.</li>
              <li><strong>Filter</strong> with <em>Show All / ‚úì Owned Only</em> to narrow to your library.</li>
              <li><strong>Show Mixable</strong> can stack with search/owned filters to narrow to harmonically compatible songs.</li>
            </ul>
            <div class="callout">
              <div class="calloutTitle">üéöÔ∏è Pro Tip</div>
              <p class="small-muted">Use search to find a vibe (e.g., ‚Äúsynthwave‚Äù), then toggle Mixable Only to keep only the compatible cuts.</p>
            </div>
          </div>

          <div class="helpSection" id="select">
            <h3>Selecting a Track & Mixable Only</h3>
            <ul>
              <li><strong>Select a track</strong> by clicking its card. A <span class="selected-badge">Selected</span> badge appears and compatibility scores recalc around it.</li>
              <li><strong>Mixable Only</strong> (üéß) filters the grid to keys that match the anchor (Camelot match or ¬±1 number same letter) and sensible BPM ranges. Turn it off to explore looser options.</li>
              <li><strong>Compatibility pills</strong> show why a song is ranked (key match, BPM delta, genre cohesion).</li>
            </ul>
            <div class="callout">
              <div class="calloutTitle">üîç Why it matters</div>
              <p class="small-muted">Mixable Only is perfect before a live transition; turn it off when crate-digging for creative curveballs.</p>
            </div>
          </div>

          <div class="helpSection" id="priority">
            <h3>Priority Modes & Strength</h3>
            <p data-brand="priority-desc">Fortnite Jam Mixer always calculates a blended compatibility score (Key ‚Üí BPM ‚Üí Genre). Priority modes only decide how ties are broken, not the overall score.</p>
            <ul>
              <li><span class="tag">Tempo Priority</span> Pushes closer BPM tracks up when scores are similar.</li>
              <li><span class="tag">Camelot Priority</span> Prefers the strongest harmonic matches first.</li>
              <li><span class="tag">Genre Priority</span> Boosts songs that share the current track‚Äôs genre family.</li>
            </ul>
            <p><strong>Priority Strength</strong> (Low / Medium / High) controls how aggressively the chosen mode nudges the order. High = strong tie-break, Low = gentle shuffle.</p>
            <div class="callout">
              <div class="calloutTitle">üß≠ Cue-building idea</div>
              <p class="small-muted">Use Camelot Priority + High to plan tight harmonic sections, then switch to Tempo Priority when you want to accelerate energy.</p>
            </div>
          </div>

          <div class="helpSection" id="setlist">
            <h3>Owned Tracks, Setlist & Set view</h3>
            <ul>
              <li><strong>Mark Owned</strong> on any card to tag it as part of your library. The <em>Owned Only</em> filter shows just these tracks.</li>
              <li><strong>+ Set</strong> adds the song to your setlist. Open <strong>Set view</strong> to see, reorder, and remove selections with the ‚úï button.</li>
              <li><strong>Setlist sorting</strong> mirrors your order; reorder inside Set view to shape your show.</li>
              <li><strong>Profiles & sync</strong> save automatically. With Firebase enabled, your owned list and setlist sync to your account; otherwise they‚Äôre stored locally.</li>
            </ul>
            <div class="callout">
              <div class="calloutTitle">üéØ Beginner Tip</div>
              <p class="small-muted">Curate your first 5 songs with Owned Only + Camelot Priority. Add them to Set to start shaping a show.</p>
            </div>
          </div>

          <div class="helpSection" id="camelot">
            <h3>Camelot Wheel: Colors, Numbers & Keys</h3>
            <p>The Camelot system labels keys with a number (1‚Äì12) and letter (A = minor, B = major). Colors below follow the industry-standard Mixed In Key palette so you can recognize keys at a glance.</p>
            <div class="camelot-wheel" aria-label="Camelot wheel diagram">
              <svg id="camelotWheelSvg" viewBox="0 0 600 600" role="img" aria-labelledby="camelotTitle camelotDesc" preserveAspectRatio="xMidYMid meet">
                <title id="camelotTitle">Camelot Wheel</title>
                <desc id="camelotDesc">Two-ring Camelot wheel with outer B (major) and inner A (minor) wedges labeled with Camelot codes and musical keys.</desc>
              </svg>
            </div>
            <script>
              (() => {
                const svg = document.getElementById('camelotWheelSvg');
                if (!svg) return;

              const NS = 'http://www.w3.org/2000/svg';
              const cx = 300, cy = 300, segments = 12, slice = 360 / segments;

              const major = [
                { code: '1B', key: 'B Major' },
                { code: '2B', key: 'F‚ôØ Major' },
                { code: '3B', key: 'D‚ô≠ Major' },
                { code: '4B', key: 'A‚ô≠ Major' },
                { code: '5B', key: 'E‚ô≠ Major' },
                { code: '6B', key: 'B‚ô≠ Major' },
                { code: '7B', key: 'F Major' },
                { code: '8B', key: 'C Major' },
                { code: '9B', key: 'G Major' },
                { code: '10B', key: 'D Major' },
                { code: '11B', key: 'A Major' },
                { code: '12B', key: 'E Major' }
              ];

              const minor = [
                { code: '1A', key: 'A‚ô≠ Minor' },
                { code: '2A', key: 'E‚ô≠ Minor' },
                { code: '3A', key: 'B‚ô≠ Minor' },
                { code: '4A', key: 'F Minor' },
                { code: '5A', key: 'C Minor' },
                { code: '6A', key: 'G Minor' },
                { code: '7A', key: 'D Minor' },
                { code: '8A', key: 'A Minor' },
                { code: '9A', key: 'E Minor' },
                { code: '10A', key: 'B Minor' },
                { code: '11A', key: 'F‚ôØ Minor' },
                { code: '12A', key: 'C‚ôØ Minor' }
              ];

              const majorColors = ['#15c49f','#11c1c9','#2aa8ff','#4d6dff','#a45cf8','#e556b3','#f06473','#f7843f','#f7c54f','#c9e34a','#7ae05c','#3ac88c'];
              const minorColors = ['#0f9b73','#0fa8c8','#1d98ff','#435bff','#9b4cf4','#d44fc4','#e24d67','#f07a36','#f0b33a','#b9d937','#63d149','#2bb577'];

              const polar = (r, angle) => {
                const rad = (angle - 90) * Math.PI / 180;
                return { x: cx + r * Math.cos(rad), y: cy + r * Math.sin(rad) };
              };

              const describeWedge = (outerR, innerR, startAngle, endAngle) => {
                const outerStart = polar(outerR, startAngle);
                const outerEnd = polar(outerR, endAngle);
                const innerEnd = polar(innerR, endAngle);
                const innerStart = polar(innerR, startAngle);
                const largeArc = (endAngle - startAngle) > 180 ? 1 : 0;
                return [
                  'M', outerStart.x, outerStart.y,
                  'A', outerR, outerR, 0, largeArc, 1, outerEnd.x, outerEnd.y,
                  'L', innerEnd.x, innerEnd.y,
                  'A', innerR, innerR, 0, largeArc, 0, innerStart.x, innerStart.y,
                  'Z'
                ].join(' ');
              };

              const addRing = (data, colors, outerRadius, innerRadius, textSize) => {
                const wedgeGroup = document.createElementNS(NS, 'g');
                const textGroup = document.createElementNS(NS, 'g');
                data.forEach((entry, i) => {
                  const start = -90 + i * slice;
                  const end = start + slice;
                  const mid = start + slice / 2;

                  const wedge = document.createElementNS(NS, 'path');
                  wedge.setAttribute('d', describeWedge(outerRadius, innerRadius, start, end));
                  wedge.setAttribute('fill', colors[i % colors.length]);
                  wedge.setAttribute('stroke', 'rgba(0,0,0,0.08)');
                  wedge.setAttribute('stroke-width', '1');
                  wedgeGroup.appendChild(wedge);

                  const textRadius = innerRadius + (outerRadius - innerRadius) * 0.52;
                  const pos = polar(textRadius, mid);
                  const rotation = (mid > 90 && mid < 270) ? mid + 180 : mid;

                  const label = document.createElementNS(NS, 'text');
                  label.setAttribute('x', pos.x);
                  label.setAttribute('y', pos.y);
                  label.setAttribute('fill', '#f7fbff');
                  label.setAttribute('font-family', '"Segoe UI", sans-serif');
                  label.setAttribute('text-anchor', 'middle');
                  label.setAttribute('dominant-baseline', 'middle');
                  label.setAttribute('transform', `rotate(${rotation} ${pos.x} ${pos.y})`);

                  const code = document.createElementNS(NS, 'tspan');
                  code.setAttribute('x', pos.x);
                  code.setAttribute('dy', '0');
                  code.setAttribute('font-size', textSize);
                  code.setAttribute('font-weight', '800');
                  code.textContent = entry.code;

                  const key = document.createElementNS(NS, 'tspan');
                  key.setAttribute('x', pos.x);
                  key.setAttribute('dy', '16');
                  key.setAttribute('font-size', textSize - 4);
                  key.setAttribute('font-weight', '600');
                  key.textContent = entry.key;

                  label.appendChild(code);
                  label.appendChild(key);
                  textGroup.appendChild(label);
                });
                svg.appendChild(wedgeGroup);
                svg.appendChild(textGroup);
              };

              addRing(major, majorColors, 280, 200, 18);
              addRing(minor, minorColors, 188, 118, 17);

              const center = document.createElementNS(NS, 'circle');
              center.setAttribute('cx', cx);
              center.setAttribute('cy', cy);
              center.setAttribute('r', 90);
              center.setAttribute('fill', 'rgba(9,14,30,0.9)');
              center.setAttribute('stroke', 'rgba(255,255,255,0.07)');
              center.setAttribute('stroke-width', '2');
              svg.appendChild(center);

              const hubLabel = document.createElementNS(NS, 'text');
              hubLabel.setAttribute('x', cx);
              hubLabel.setAttribute('y', cy);
              hubLabel.setAttribute('fill', '#e6f7ff');
              hubLabel.setAttribute('text-anchor', 'middle');
              hubLabel.setAttribute('font-family', '"Segoe UI", sans-serif');
              hubLabel.setAttribute('font-size', '16');
              hubLabel.setAttribute('font-weight', '700');
              hubLabel.textContent = 'Camelot Wheel';
              svg.appendChild(hubLabel);
            })();
          </script>
          <div class="camelot-caption">Colors: green ‚Üí teal ‚Üí blue ‚Üí purple ‚Üí magenta ‚Üí red ‚Üí orange ‚Üí yellow ‚Üí lime (industry-standard Camelot palette). A = minor (inner ring), B = major (outer ring).</div>
          <h4 style="color:#ffd7a6">Harmonic Mixing Rules</h4>
          <ul>
            <li><strong>Perfect match:</strong> same number + same letter (e.g., 8A ‚Üí 8A).</li>
            <li><strong>Energy switch:</strong> same number, different letter (e.g., 8A ‚Üí 8B) for a happy/somber contrast with stable harmony.</li>
            <li><strong>Smooth move:</strong> +1 or -1 number, same letter (e.g., 8A ‚Üí 9A or 7A) for gradual energy lifts or drops.</li>
            <li><strong>Avoid far jumps:</strong> skipping several numbers or flipping both number and letter usually clashes unless you use heavy FX.</li>
          </ul>
          <div class="callout">
            <div class="calloutTitle">üéõÔ∏è DJ Tip</div>
            <p class="small-muted">Ride the wheel clockwise for rising energy. Hop between inner/outer rings on the same number when you want a brighter (major) or moodier (minor) take.</p>
          </div>
        </div>

        <div class="helpSection" id="internalCamelot">
          <h3 data-brand="camelot-heading">How Fortnite Jam Mixer Uses Camelot</h3>
          <ul>
            <li><strong>Accurate keys:</strong> Tracks display Camelot values aligned to real song keys. Example: ‚ÄúDon‚Äôt Fear the Reaper‚Äù is <strong>8A</strong> because the song is in A minor; earlier incorrect tags were fixed in the dataset.</li>
            <li><strong>Color pills</strong> on each card mirror the Camelot wheel colors so you can glance-match without reading numbers.</li>
            <li><strong>Unknown keys</strong> show a <strong>?</strong>. They stay visible for discovery, but Mixable Only will skip them because harmonic certainty is missing.</li>
            <li><strong>Compatibility scoring</strong> prioritizes exact Camelot matches, then ¬±1 number same letter, then broader tempo/genre factors.</li>
          </ul>
          <div class="callout">
            <div class="calloutTitle">‚ÑπÔ∏è Note</div>
            <p class="small-muted">If you ever spot a wrong key, corrected tags will update the Mixable filter and color pill instantly.</p>
          </div>
        </div>
        <div class="helpSection" id="export">
          <h3>Export & Import Basics</h3>
          <ul>
            <li><strong>Auto-save first:</strong> Profiles, owned flags, and setlists save automatically to Firebase when signed in, or to local storage when offline.</li>
            <li><strong>Seamless restore:</strong> Signing in on another device restores your saved data without manual downloads.</li>
            <li><strong>No manual JSON:</strong> Manual import/export is intentionally disabled to avoid corrupted profiles. Use sign-in or local persistence instead.</li>
          </ul>
          <div class="callout">
            <div class="calloutTitle">üìÅ Backup note</div>
            <p class="small-muted">Clearing browser storage resets your offline data. Sign in to keep a cloud copy before wiping a device.</p>
          </div>
        </div>
        </div>

        <div id="helpAdvanced" data-help-pane="advanced" style="display:none">
          <div class="helpSection" id="scoreBreakdown">
            <h3>Score Breakdown</h3>
            <ul>
              <li><strong>Camelot first:</strong> Exact Camelot matches score highest, followed by ¬±1 number in the same letter.</li>
              <li><strong>BPM fit:</strong> Smaller BPM gaps raise the score; bigger gaps lower it unless you adjust tempo.</li>
              <li><strong>Genre cohesion:</strong> Matching genres boost tie-breaks when harmonic scores are similar.</li>
              <li><strong>Priority strength:</strong> The tie-break slider leans rankings toward your chosen focus without changing the underlying blended score.</li>
            </ul>
          </div>

          <div class="helpSection" id="bpmShift">
            <h3>BPM Shift Meaning</h3>
            <ul>
              <li><strong>Preview popups</strong> show the BPM delta between two tracks and suggest whether a half-time/double-time shift might be needed.</li>
              <li><strong>Safe zone:</strong> ¬±4‚Äì6 BPM is usually mix-ready; beyond that, expect to ride pitch/tempo controls.</li>
              <li><strong>Energy planning:</strong> Faster follow-ups raise intensity, while -BPM transitions mellow the room.</li>
            </ul>
          </div>

          <div class="helpSection" id="sandbox">
            <h3>Sandbox Energy & Limits</h3>
            <ul>
              <li><strong>Drag any card</strong> into the Sandbox area (max 4 tracks). The readout shows BPM range, key set, and genre-blend percentage for quick energy checks.</li>
              <li><strong>Reorder</strong> inside the Sandbox to visualize transition flow; delete with ‚úï when iterating ideas.</li>
              <li><strong>Energy arcs:</strong> Line up +1 Camelot steps or gentle BPM climbs to rehearse a rising-energy mini-set before committing it to the main grid.</li>
            </ul>
            <div class="callout">
              <div class="calloutTitle">üß™ Pro Tip</div>
              <p class="small-muted">Sandbox limits hard-stop at four tracks. Use that cap to force concise, high-impact sequences.</p>
            </div>
          </div>

          <div class="helpSection" id="bandMembersHelp">
            <h3>Band Members (View-only)</h3>
            <ul>
              <li>Band member slots stay visible for profiles but are read-only while the feature is paused.</li>
              <li>You can still browse saved collaborators inside profiles; invites/edits are disabled until the feature returns.</li>
            </ul>
          </div>

          <div class="helpSection" id="genreOverridesHelp">
            <h3>Admin Genre Overrides</h3>
            <ul>
              <li>Admin-only tools let you correct a track‚Äôs genre when dataset tags are wrong.</li>
              <li>Overrides sync with your profile storage (cloud when signed in, local when offline) and update mix suggestions immediately.</li>
              <li>Use overrides sparingly‚Äîstick to clear mislabels so setlists and community data stay consistent.</li>
            </ul>
          </div>

          <div class="helpSection" id="limitations">
            <h3>Limitations & Troubleshooting</h3>
            <ul>
              <li><strong>Help controls:</strong> Click outside the panel or press Esc to close. Reopening keeps your tab state and scroll per-pane.</li>
              <li><strong>Reset filters:</strong> Clear search, toggle Mixable Only off/on, or switch Priority Strength back to Medium for balanced results.</li>
              <li><strong>Offline mode:</strong> Without Firebase, everything stays on this device. Clearing storage wipes local data.</li>
            </ul>
          </div>

          <div class="helpSection" id="tips">
            <h3>Performance Tips</h3>
            <ul>
              <li>Enter transitions on phrase boundaries (8 or 16 bars) for cleaner swaps.</li>
              <li>When BPM differs by more than 6, try a tempo ramp or half-time FX to bridge the gap.</li>
              <li>Filter sweeps and reverb tails can hide brief key shifts if you intentionally break Camelot rules.</li>
              <li>Use the Sandbox to rehearse a 3‚Äì4 song story: start on a perfect match, climb +1, then flip to the major on the same number for a finale.</li>
            </ul>
          </div>
        </div>
      </div>

      <div class="helpFooter">
        <button class="helpCloseBtn" onclick="closeHelp()">Close</button>
      </div>
    </div>
  </div>

  <script>
    /**************************************************************************
     * Final merged app
     * - All fixes applied (setlist rendering, show-all toggle, mixable toggle, band member)
     * - Optional Firebase (see firebaseEnabled & firebaseConfig)
     * - Help modal integrated (manual open via header button)
     **************************************************************************/

const BRAND = Object.freeze({
  APP_NAME: 'Fortnite Jam Mixer',
  SHORT_NAME: 'Jam Mixer',
  EXPORT_PREFIX: 'fortnite-jam-mixer',
  BROWSER_TITLE: 'Fortnite Jam Mixer ‚Äì Cross-Browser Edition'
});
document.title = BRAND.BROWSER_TITLE;

    // -------------------- FIREBASE (auto-detect) ----------------------------
// We auto-enable Firebase if /api/firebase-config injected window.firebaseConfig (Vercel env vars).
// This prevents the "no signup option" problem when firebaseEnabled was left false.
const DEBUG_LOG_MAX = 50;
function logEvent(type, payload = {}) {
  const entry = {
    type,
    ts: Date.now(),
    payload
  };
  if (typeof location !== 'undefined' && location.hostname === 'localhost') {
    console.log('[telemetry]', entry);
  }
  try {
    const existing = JSON.parse(localStorage.getItem('debugLogs') || '[]');
    existing.push(entry);
    while (existing.length > DEBUG_LOG_MAX) existing.shift();
    localStorage.setItem('debugLogs', JSON.stringify(existing));
  } catch (e) {
    console.warn('Failed to persist debug log', e);
  }
}

const firebaseConfig = window.firebaseConfig || {};
const firebaseConfigValid = !!(firebaseConfig.apiKey && firebaseConfig.authDomain && firebaseConfig.projectId);
const firebaseEnabled = firebaseConfig.firebaseEnabled === true && firebaseConfigValid && !!window.firebase?.auth;

function applyBrandingCopy(){
  const loading = document.querySelector('[data-brand="loading"]');
  if(loading) loading.textContent = `Loading ${BRAND.APP_NAME}...`;
  const helpTitle = document.querySelector('[data-brand="help-title"]');
  if(helpTitle) helpTitle.textContent = `${BRAND.APP_NAME} Help`;
  const helpIntro = document.querySelector('[data-brand="help-intro"]');
  if(helpIntro) helpIntro.textContent = `A complete, beginner-to-pro guide for every tool in ${BRAND.APP_NAME}. Open this help anytime with the ‚ùì button in the header.`;
  const camelotAnchor = document.querySelector('[data-brand="help-anchor-camelot"]');
  if(camelotAnchor) camelotAnchor.textContent = `How ${BRAND.APP_NAME} uses Camelot`;
  const priorityDesc = document.querySelector('[data-brand="priority-desc"]');
  if(priorityDesc) priorityDesc.textContent = `${BRAND.APP_NAME} always calculates a blended compatibility score (Key ‚Üí BPM ‚Üí Genre). Priority modes only decide how ties are broken, not the overall score.`;
  const camelotHeading = document.querySelector('[data-brand="camelot-heading"]');
  if(camelotHeading) camelotHeading.textContent = `How ${BRAND.APP_NAME} Uses Camelot`;
}

applyBrandingCopy();

window.addEventListener('error', (event) => {
  logEvent('error', {
    message: event?.message || 'Unknown error',
    stack: event?.error?.stack || null,
    view,
    firebaseEnabled,
    online: navigator.onLine
  });
});
window.addEventListener('unhandledrejection', (event) => {
  logEvent('unhandledrejection', {
    message: event?.reason?.message || event?.reason || 'Unknown rejection',
    stack: event?.reason?.stack || null,
    view,
    firebaseEnabled,
    online: navigator.onLine
  });
});

function buildExportFilename(username = 'profile'){
  const safeName = (username || 'profile').trim() || 'profile';
  return `${BRAND.EXPORT_PREFIX}-${safeName}.json`;
}

let firebaseApp = null, firebaseAuth = null, firestore = null;
let firebaseAuthUnsub = null;
let authSettledUser = null;
let authProcessing = false;
let authInFlight = false;
if (firebaseEnabled) {
  try {
    firebaseApp = firebase.initializeApp(firebaseConfig);
    firebaseAuth = firebase.auth();
    firestore = firebase.firestore();
    firebaseAuth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch((err)=>{
      console.warn('Firebase persistence failed', err);
      logEvent('auth_persistence_fail', { message: err?.message, code: err?.code });
    });
    console.log('Firebase initialized');
    logEvent('firebase_init', { projectId: firebaseConfig.projectId });
  } catch (e) {
    console.warn('Firebase init failed', e);
    logEvent('firebase_init_fail', { message: e?.message, code: e?.code });
    firebaseApp = null;
    firebaseAuth = null;
    firestore = null;
  }
} else {
  logEvent('firebase_disabled', { reason: 'missing config or sdk', firebaseConfigValid });
}


    // Backend save/load wrappers (Firestore or localStorage)
    function normalizeProfileShape(profile, fallbackId){
      if(!profile) return null;
      const ownedFromMap = Object.keys(profile.ownedMap || {});
      const ownedArray = Array.isArray(profile.ownedTracks) ? profile.ownedTracks : ownedFromMap;
      const username = profile.username || fallbackId || profile.uid || '';
      const djName = profile.djName || username;
      const email = profile.email || profile.mail || '';
      const oauth = profile.oauth || {};
      return { ...profile, username, djName, email, ownedTracks: ownedArray, oauth };
    }
    function buildOwnedMap(ids){
      const map = {};
      (ids||[]).forEach(id=>{ map[id] = true; });
      return map;
    }
    async function saveUserProfileToBackend(profile) {
      if (!profile) return;
      const firebaseUser = firebaseAuth?.currentUser;
      const profileKey = profile.uid || firebaseUser?.uid || profile.username;
      const ownedIds = profile.ownedTracks || [];
      const serverTimestamp = firebase?.firestore?.FieldValue?.serverTimestamp;
      const payload = {
        ...profile,
        uid: profileKey,
        username: profile.username || profileKey,
        djName: profile.djName || profile.username || profileKey,
        email: profile.email || firebaseUser?.email || '',
        ownedTracks: ownedIds,
        ownedMap: buildOwnedMap(ownedIds),
        updatedAt: serverTimestamp ? serverTimestamp() : new Date().toISOString()
      };
      if (firestore && firebaseUser && profileKey) {
        try {
          await firestore.collection('users').doc(profileKey).set(payload, { merge: true });
          return true;
        } catch (e) { console.warn('Firestore save failed', e); return false; }
      } else {
        const profiles = JSON.parse(localStorage.getItem('userProfiles') || '{}');
        if (payload.username) profiles[payload.username] = payload;
        if (profileKey) profiles[profileKey] = payload;
        localStorage.setItem('userProfiles', JSON.stringify(profiles));
        return true;
      }
    }
    async function loadUserProfileFromBackend(identifier) {
      if (!identifier && !firebaseAuth?.currentUser) return null;
      const firebaseUser = firebaseAuth?.currentUser;
      const lookupKey = identifier || firebaseUser?.uid;
      if (firestore && lookupKey) {
        try {
          const doc = await firestore.collection('users').doc(lookupKey).get();
          if (doc.exists) return normalizeProfileShape(doc.data(), lookupKey);
          if (firebaseUser?.email) {
            const emailKey = firebaseUser.email.split('@')[0];
            if (emailKey && emailKey !== lookupKey) {
              const legacyDoc = await firestore.collection('users').doc(emailKey).get();
              if (legacyDoc.exists) return normalizeProfileShape(legacyDoc.data(), emailKey);
            }
          }
        } catch (e) { console.warn('Firestore load failed', e); }
      }
      const profiles = JSON.parse(localStorage.getItem('userProfiles') || '{}');
      if (lookupKey && profiles[lookupKey]) return normalizeProfileShape(profiles[lookupKey], lookupKey);
      if (firebaseUser?.uid && profiles[firebaseUser.uid]) return normalizeProfileShape(profiles[firebaseUser.uid], firebaseUser.uid);
      if (firebaseUser?.email) {
        const fallbackName = firebaseUser.email.split('@')[0];
        if (profiles[fallbackName]) return normalizeProfileShape(profiles[fallbackName], fallbackName);
      }
      return identifier ? normalizeProfileShape(profiles[identifier], identifier) || null : null;
    }

    // ---------------------------- Data ------------------------------
    const camelotColors = {
      '1A':'#FF6B9D','1B':'#FF8FAB','2A':'#FFA07A','2B':'#FFB699','3A':'#FFD700','3B':'#FFE55C',
      '4A':'#98D8C8','4B':'#7FD8BE','5A':'#6BCB77','5B':'#8FD89F','6A':'#4D96FF','6B':'#6FB1FF',
      '7A':'#9D4EDD','7B':'#B877FF','8A':'#E84A5F','8B':'#FF6B81','9A':'#00D9FF','9B':'#4DFFFF',
      '10A':'#FFA400','10B':'#FFBB5C','11A':'#FE6D73','11B':'#FF8C94','12A':'#A8E6CF','12B':'#C1F0DD'
    };
    const knownCorrections = [
      { id: 'dont_fear_the_reaper', expectedCamelot: '8A' },
    ];
    const keyToCamelot = { 'C':'8B','Am':'8A','A Minor':'8A','C Major':'8B','G':'9B','Em':'9A','E Minor':'9A','G Major':'9B','D':'10B','Bm':'10A','B Minor':'10A','D Major':'10B','A':'11B','F#m':'11A','F# Minor':'11A','A Major':'11B','E':'12B','C#m':'12A','C# Minor':'12A','E Major':'12B','B':'1B','G#m':'1A','G# Minor':'1A','B Major':'1B','F#':'2B','D#m':'2A','D# Minor':'2A','F# Major':'2B','Db':'3B','Bbm':'3A','Bb Minor':'3A','Db Major':'3B','Ab':'4B','Fm':'4A','F Minor':'4A','Ab Major':'4B','Eb':'5B','Cm':'5A','C Minor':'5A','Eb Major':'5B','Bb':'6B','Gm':'6A','G Minor':'6A','Bb Major':'6B','F':'7B','Dm':'7A','D Minor':'7A','F Major':'7B' };

    const genreMap = {
      'Rock': ['foo fighters','nirvana','pearl jam','soundgarden','alice in chains','red hot chili peppers','radiohead','muse','queens of the stone age','rage against the machine'],
      'Classic Rock': ['beatles','rolling stones','led zeppelin','pink floyd','queen','the who','aerosmith'],
      'Alternative': ['green day','blink-182','sum 41','my chemical romance','fall out boy','arctic monkeys','the strokes','the killers'],
      'Punk': ['ramones','sex pistols','the clash'],
      'Metal': ['metallica','megadeth','slayer','anthrax','iron maiden'],
      'Pop': ['taylor swift','ariana grande','billie eilish','dua lipa','lady gaga','katy perry'],
      'Hip-Hop': ['eminem','dr. dre','snoop dogg','2pac','notorious b.i.g','jay-z','nas','kanye west','kendrick lamar','drake'],
      'R&B': ['the weeknd','bruno mars','usher','beyonce','rihanna'],
      'Electronic': ['daft punk','deadmau5','skrillex','diplo','zedd','avicii','calvin harris'],
      'Indie': ['vampire weekend','tame impala','mgmt','arctic monkeys','the strokes'],
      'Country': ['johnny cash','garth brooks','shania twain','tim mcgraw'],
      'Disco/Funk': ['bee gees','donna summer','chic','earth wind & fire','bruno mars'],
      'Blues': ['bb king','muddy waters','howlin wolf'],
      'Jazz': ['miles davis','john coltrane'],
      'Reggae': ['bob marley'],
      'Latin': ['shakira','ricky martin','enrique iglesias'],
      'Soul': ['aretha franklin','otis redding','sam cooke']
    };

    // -------------------------- State -----------------------------
    let currentUser = null;
    let songsLoaded = false;
    let userKey = null;
    let localDeviceId = localStorage.getItem('localDeviceId') || null;
    let songs = [];
    let draftProfile = null;
    let ownedTracks = [];
    let selectedSong = null;
    let sortMode = 'bpm';
    let previewSong = null;
    let setlist = [];
    let searchTerm = '';
    let view = 'browser';
    let showOwnedOnly = false;
    let showMixableOnly = false;
    let selectedGenre = 'All';
    let bandMembers = [];
    let viewingProfile = null;
    let profileOwnedSearch = '';
    let friendSearchTerm = '';
    let friendLookupError = '';
    let friendLookupResults = [];
    let genreOverrides = {};
    let sandboxTracks = [];
    let sandboxIds = [];
    let helpTab = 'basic';
    let helpScroll = { basic: 0, advanced: 0 };
    const PAGE_SIZE_OPTIONS = [12,24,48];
    const PAGE_SIZE_KEY = 'jamMixer.pageSize';
    const CURRENT_PAGE_KEY = 'jamMixer.currentPage';
    const DEFAULT_PAGE_SIZE = 24;
    let currentPage = 1;
    let pageSize = DEFAULT_PAGE_SIZE;
    let priorityStrength = 'medium';
    let keyMatchMode = (localStorage.getItem('jamMixer.keyMatchMode') || 'camelot') === 'semitone' ? 'semitone' : 'camelot';
    let maxSemitoneRange = Math.min(6, Math.max(1, parseInt(localStorage.getItem('jamMixer.maxSemitoneRange') || '6', 10) || 6));
    let includeOppositeMode = localStorage.getItem('jamMixer.includeOppositeMode');
    includeOppositeMode = includeOppositeMode === null ? true : includeOppositeMode === 'true';
    function applyPreferencesFromProfile(profile){
      const prefs = profile?.preferences || {};
      if(prefs.keyMatchMode){ keyMatchMode = prefs.keyMatchMode === 'semitone' ? 'semitone' : 'camelot'; }
      if(Number.isFinite(prefs.maxSemitoneRange)){ maxSemitoneRange = Math.min(6, Math.max(1, Number(prefs.maxSemitoneRange))); }
      if(typeof prefs.includeOppositeMode === 'boolean'){ includeOppositeMode = prefs.includeOppositeMode; }
      if(['low','medium','high'].includes(prefs.priorityStrength)){ priorityStrength = prefs.priorityStrength; }
      const wasPersisting = isPersistingProfile;
      isPersistingProfile = true;
      persistKeyMatchSettings();
      isPersistingProfile = wasPersisting;
    }
    function syncPreferencesIntoProfile(){
      if(!currentUser) return;
      const prefs = { keyMatchMode, maxSemitoneRange, includeOppositeMode, priorityStrength };
      currentUser.preferences = prefs;
      if(draftProfile) draftProfile.preferences = prefs;
    }
    let preferenceSaveTimeout = null;
    let isPersistingProfile = false;
    function schedulePreferencePersist(){
      if(!currentUser) return;
      clearTimeout(preferenceSaveTimeout);
      preferenceSaveTimeout = setTimeout(()=>{
        if(!currentUser) return;
        persistCurrentUserProfile().catch(err=>console.warn('[profile] preference persistence failed', err));
      }, 300);
    }
    let camelotOverridesStore = { ids: {}, names: {} };
    let bpmOverridesStore = { ids: {}, names: {} };
    let auditSearch = '';
    let auditFilters = { flaggedOnly:false, overriddenOnly:false, invalidCamelot:false, modeMismatch:false, bpmOutlier:false };
    let regressionWarnings = [];
    let adminMenuOpen = false;
    let adminMenuListenersBound = false;
    let isOffline = !navigator.onLine;
    let trackSource = 'network';
    const communityStats = { totalDjs: '‚Ä¶' };
    const communityStatMeta = { totalDjs: { updatedAt: null, stale: false } };
    const communityStatGraceTimers = {};
    const COMMUNITY_STAT_GRACE_MS = 3000;
    const COMMUNITY_TOTAL_DJS_CACHE_KEY = 'ffmCommunityTotalDjs';
    const COMMUNITY_TOTAL_DJS_REFRESH_MS = 5 * 60 * 1000;
    const COMMUNITY_TOTAL_DJS_STALE_RETRY_MS = 15 * 1000;
    let communityRefreshInterval = null;
    const TRACK_DB = { name: 'ffm-track-cache', store: 'tracks' };
    const SAMPLE_TRACKS = [
      { id:'s1', title:'Bad Guy', artist:'Billie Eilish', bpm:135, rawBpm:135, key:'C major', rawKey:'C', rawMode:'major', mode:'major', camelot:'8B', derivedCamelot:'8B', duration:180, albumArt:'', genre:'Pop'},
      { id:'s2', title:'Need You Tonight', artist:'INXS', bpm:115, rawBpm:115, key:'C minor', rawKey:'C', rawMode:'minor', mode:'minor', camelot:'8A', derivedCamelot:'8A', duration:210, albumArt:'', genre:'Rock'},
      { id:'s3', title:'Electric Night', artist:'Daft Sample', bpm:128, rawBpm:128, key:'D major', rawKey:'D', rawMode:'major', mode:'major', camelot:'10B', derivedCamelot:'10B', duration:200, albumArt:'', genre:'Electronic'},
      { id:'s4', title:'Slow Burn', artist:'Indie Star', bpm:95, rawBpm:95, key:'G minor', rawKey:'G', rawMode:'minor', mode:'minor', camelot:'9A', derivedCamelot:'9A', duration:190, albumArt:'', genre:'Indie'},
      { id:'s5', title:'Drop The Bass', artist:'SkrillSample', bpm:142, rawBpm:142, key:'A minor', rawKey:'A', rawMode:'minor', mode:'minor', camelot:'11A', derivedCamelot:'11A', duration:160, albumArt:'', genre:'Electronic'}
    ].map(t=>({ ...t, flags: computeTrackFlags ? computeTrackFlags(t) : {} }));
    const usernamePattern = /^[A-Za-z0-9_]{3,20}$/;
    const profileParam = new URLSearchParams(window.location.search).get('profile');
    const pendingOAuthToast = sessionStorage.getItem('oauthSuccess');
    if(pendingOAuthToast){ sessionStorage.removeItem('oauthSuccess'); setTimeout(()=>alert(pendingOAuthToast), 500); }

    // ---------------------- Admin & identity helpers -----------------------
    function ensureLocalDeviceId(){
      if(!localDeviceId){
        localDeviceId = 'device_' + Math.random().toString(36).slice(2,10);
        localStorage.setItem('localDeviceId', localDeviceId);
      }
      return localDeviceId;
    }
    function computeUserKey(){
      const firebaseUser = firebaseAuth?.currentUser;
      if(firebaseUser?.uid) return firebaseUser.uid;
      if(currentUser?.uid) return currentUser.uid;
      if(currentUser?.username) return currentUser.username;
      return ensureLocalDeviceId();
    }
    function getNamespacedKey(base){
      const key = computeUserKey();
      userKey = key;
      return `${base}_${key}`;
    }
    function migrateLegacyStorage(){
      const bases = ['ownedTracks','setlist','genreOverrides','sandboxTrackIds'];
      bases.forEach(base=>{
        const legacy = localStorage.getItem(base);
        const namespacedKey = getNamespacedKey(base);
        const existing = localStorage.getItem(namespacedKey);
        if(legacy && !existing){
          localStorage.setItem(namespacedKey, legacy);
        }
      });
    }
    function loadNamespacedState(){
      migrateLegacyStorage();
      ownedTracks = JSON.parse(localStorage.getItem(getNamespacedKey('ownedTracks')) || '[]');
      setlist = JSON.parse(localStorage.getItem(getNamespacedKey('setlist')) || '[]');
      genreOverrides = JSON.parse(localStorage.getItem(getNamespacedKey('genreOverrides')) || '{}');
      sandboxIds = JSON.parse(localStorage.getItem(getNamespacedKey('sandboxTrackIds')) || '[]');
    }
    function persistNamespacedState(){
      localStorage.setItem(getNamespacedKey('ownedTracks'), JSON.stringify(ownedTracks));
      localStorage.setItem(getNamespacedKey('setlist'), JSON.stringify(setlist));
      localStorage.setItem(getNamespacedKey('genreOverrides'), JSON.stringify(genreOverrides));
      localStorage.setItem(getNamespacedKey('sandboxTrackIds'), JSON.stringify(sandboxIds));
    }
    function loadPaginationPreferences(){
      const storedSize = parseInt(localStorage.getItem(PAGE_SIZE_KEY) || '', 10);
      if(PAGE_SIZE_OPTIONS.includes(storedSize)) pageSize = storedSize;
      const storedPage = parseInt(sessionStorage.getItem(CURRENT_PAGE_KEY) || '', 10);
      if(Number.isFinite(storedPage) && storedPage > 0) currentPage = storedPage;
    }
    function persistPaginationState(){
      localStorage.setItem(PAGE_SIZE_KEY, String(pageSize));
      sessionStorage.setItem(CURRENT_PAGE_KEY, String(currentPage));
    }
    loadPaginationPreferences();
    function cloneProfile(profile){
      if(!profile) return null;
      try { return structuredClone(profile); } catch(_) { return JSON.parse(JSON.stringify(profile)); }
    }
    function refreshDraftProfileFromCurrentUser(){
      if(viewingProfile) return;
      draftProfile = currentUser ? cloneProfile(currentUser) : null;
    }
    const ADMIN_USERNAME = 'BattleNeBody';
    function isAdmin(){
      const username = currentUser?.username || firebaseAuth?.currentUser?.displayName || '';
      return username === ADMIN_USERNAME;
    }

    function handleAdminMenuOutsideClick(e){
      if(!adminMenuOpen) return;
      const menu = document.getElementById('adminToolsMenu');
      const btn = document.getElementById('adminToolsBtn');
      const clickInMenu = menu?.contains(e.target);
      const clickOnBtn = btn?.contains(e.target);
      if(menu && !clickInMenu && !clickOnBtn){
        toggleAdminTools(false);
      }
    }

    function handleAdminMenuKeydown(e){
      if(e.key === 'Escape'){
        closeHelp();
        if(adminMenuOpen) toggleAdminTools(false);
      }
    }

    function ensureAdminMenuListeners(){
      if(adminMenuListenersBound) return;
      document.addEventListener('click', handleAdminMenuOutsideClick);
      document.addEventListener('keydown', handleAdminMenuKeydown);
      adminMenuListenersBound = true;
    }

    const toggleAdminTools = (force)=>{
      if(!isAdmin()) return;
      ensureAdminMenuListeners();
      const previous = adminMenuOpen;
      if(force === true) adminMenuOpen = true; else if(force === false) adminMenuOpen = false; else adminMenuOpen = !adminMenuOpen;
      if(adminMenuOpen !== previous){ console.debug('[admin] Admin menu state changed', { previous, next: adminMenuOpen }); }
      render();
      setupEventListeners();
    };

    function openAuditFromMenu(){
      if(!isAdmin()) return alert('Admin only');
      toggleAdminTools(false);
      switchView('audit');
    }

    // ---------------------- Community metrics -------------------
    function startCommunityStatGrace(key){
      clearTimeout(communityStatGraceTimers[key]);
      communityStatGraceTimers[key] = setTimeout(()=>{
        if(communityStats[key] === null || communityStats[key] === '‚Ä¶'){
          communityStats[key] = '‚Äî';
          syncCommunityStatsUI();
        }
      }, COMMUNITY_STAT_GRACE_MS);
    }

    function formatStatValue(value){
      if(value === null || value === undefined) return '‚Äî';
      if(value === '‚Äî' || value === '‚Ä¶') return value;
      if(typeof value === 'string') return value;
      if(typeof value === 'number' && !Number.isNaN(value)) return value.toLocaleString();
      return '‚Ä¶';
    }

    function formatCommunityMeta(key){
      if(key === 'totalDjs'){
        const { updatedAt, stale } = communityStatMeta.totalDjs || {};
        const date = updatedAt ? new Date(updatedAt) : null;
        const timeLabel = date ? date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }) : '‚Äî';
        const staleLabel = stale ? ' (refreshing...)' : '';
        return `As of: ${timeLabel}${staleLabel}`;
      }
      return '';
    }

    function syncCommunityStatsUI(){
      const mapping = {
        totalDjs: communityStats.totalDjs,
      };
      Object.entries(mapping).forEach(([key,val])=>{
        const el = document.querySelector(`[data-community-stat="${key}"]`);
        if(el) el.textContent = formatStatValue(val);
        const metaEl = document.querySelector(`[data-community-stat-meta="${key}"]`);
        if(metaEl) metaEl.textContent = formatCommunityMeta(key);
      });
    }

    function setCommunityStat(key, value, meta={}){
      communityStats[key] = value;
      communityStatMeta[key] = { ...(communityStatMeta[key]||{}), ...meta };
      if(value !== null && value !== '‚Ä¶'){
        clearTimeout(communityStatGraceTimers[key]);
      } else {
        startCommunityStatGrace(key);
      }
      syncCommunityStatsUI();
    }

    async function loadTotalDjs(force=false){
      const cachedTotal = Number(localStorage.getItem(COMMUNITY_TOTAL_DJS_CACHE_KEY) || '');
      if(Number.isFinite(cachedTotal) && communityStats.totalDjs === '‚Ä¶'){
        setCommunityStat('totalDjs', cachedTotal, { updatedAt: communityStatMeta.totalDjs?.updatedAt, stale:false });
      }
      if(!force && communityStats.totalDjs !== '‚Ä¶' && communityStats.totalDjs !== '‚Äî') return;
      try{
        const resp = await fetch('/api/total-djs');
        if(!resp.ok) throw new Error('Total DJs request failed');
        const data = await resp.json();
        const rawTotal = data.totalDjs;
        const total = typeof rawTotal === 'number' ? rawTotal : Number.NaN;
        const updatedAt = data.updatedAt ? new Date(data.updatedAt) : null;
        const stale = Boolean(data.stale);
        const validTotal = Number.isFinite(total);
        if(validTotal){
          localStorage.setItem(COMMUNITY_TOTAL_DJS_CACHE_KEY, String(total));
        }
        const fallbackValue = validTotal ? total : (Number.isFinite(cachedTotal) ? cachedTotal : null);
        setCommunityStat(
          'totalDjs',
          fallbackValue ?? '‚Äî',
          { updatedAt: updatedAt ? updatedAt.toISOString() : (communityStatMeta.totalDjs?.updatedAt || null), stale }
        );
        if(stale){
          setTimeout(()=>loadTotalDjs(true), COMMUNITY_TOTAL_DJS_STALE_RETRY_MS);
        }
      } catch(err){
        console.error('Total DJs fetch failed', err);
        const fallbackValue = Number.isFinite(cachedTotal) ? cachedTotal : '‚Äî';
        setCommunityStat('totalDjs', fallbackValue, { stale:false });
      }
    }

    function initCommunityMetrics(){
      startCommunityStatGrace('totalDjs');
      loadTotalDjs();
      clearInterval(communityRefreshInterval);
      communityRefreshInterval = setInterval(()=>loadTotalDjs(true), COMMUNITY_TOTAL_DJS_REFRESH_MS);
    }

    // ---------------------- Offline helpers -----------------------
    function handleNetworkStatusChange(){
      isOffline = !navigator.onLine;
      const badges = document.querySelectorAll('[data-network-badge]');
      badges.forEach(el=>{
        el.textContent = isOffline ? 'Offline' : 'Online';
        el.className = isOffline
          ? 'inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold bg-red-600/30 border border-red-400/60 text-red-100'
          : 'inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold bg-emerald-600/30 border border-emerald-400/60 text-emerald-100';
      });
    }

    function openTrackDb(){
      return new Promise((resolve,reject)=>{
        if(!('indexedDB' in window)) return resolve(null);
        const req = indexedDB.open(TRACK_DB.name,1);
        req.onupgradeneeded = ()=>{ req.result.createObjectStore(TRACK_DB.store, { keyPath:'id' }); };
        req.onsuccess = ()=>resolve(req.result);
        req.onerror = ()=>resolve(null);
      });
    }

    async function cacheTracks(list){
      const db = await openTrackDb();
      if(!db) return;
      return new Promise(resolve=>{
        const tx = db.transaction(TRACK_DB.store,'readwrite');
        const store = tx.objectStore(TRACK_DB.store);
        list.forEach(t=>store.put(t));
        tx.oncomplete = ()=>resolve();
        tx.onerror = ()=>resolve();
      });
    }

    async function readCachedTracks(){
      const db = await openTrackDb();
      if(!db) return [];
      return new Promise(resolve=>{
        const tx = db.transaction(TRACK_DB.store,'readonly');
        const store = tx.objectStore(TRACK_DB.store);
        const req = store.getAll();
        req.onsuccess = ()=>resolve(req.result || []);
        req.onerror = ()=>resolve([]);
      });
    }

    // ---------------------- Utils & Scoring -----------------------
    function normalizeMode(mode,keyStr){
      const m=(mode||'').toLowerCase();
      if(m.includes('min')) return 'minor';
      if(m.includes('maj')) return 'major';
      const k=(keyStr||'').toLowerCase();
      if(/m$/.test(k) || k.includes('minor')) return 'minor';
      if(k.includes('major')) return 'major';
      return '';
    }
    function normalizeKeyName(raw){
      if(!raw) return '';
      let cleaned = (raw||'').replace(/major|minor/ig,'').replace(/maj|min/ig,'').trim();
      cleaned = cleaned.replace(/m$/i,'');
      cleaned = cleaned.replace(/[^a-g#b]/ig,'');
      if(!cleaned) return '';
      const first = cleaned[0].toUpperCase();
      const rest = cleaned.slice(1).replace(/b/,'b').replace(/#/,'#');
      return (first + rest);
    }
    const pitchClassMap = { C:0,'C#':1,Db:1,D:2,'D#':3,Eb:3,E:4,F:5,'F#':6,Gb:6,G:7,'G#':8,Ab:8,A:9,'A#':10,Bb:10,B:11 };
    function parseKey(keyStr, modeStr){
      const raw = (keyStr||'').trim();
      let mode = normalizeMode(modeStr||'', keyStr||'') || null;
      let root = null;
      let pitchClass = null;
      let label = raw || '';
      const explicitMatch = raw.match(/^([A-Ga-g][#b]?)(?:\s*(major|minor))?$/i);
      const shorthandMinor = raw.match(/^([A-Ga-g][#b]?)m$/i);
      if(shorthandMinor){
        root = normalizeKeyName(shorthandMinor[1]);
        mode = mode || 'minor';
      } else if(explicitMatch){
        root = normalizeKeyName(explicitMatch[1]);
        if(explicitMatch[2]) mode = explicitMatch[2].toLowerCase();
      } else if(raw){
        const simpleRoot = raw.match(/^([A-Ga-g][#b]?)/);
        if(simpleRoot){ root = normalizeKeyName(simpleRoot[1]); }
        if(/minor/i.test(raw)) mode = mode || 'minor';
        if(/major/i.test(raw)) mode = mode || 'major';
      }
      if(root && Object.prototype.hasOwnProperty.call(pitchClassMap, root)){
        pitchClass = pitchClassMap[root];
      }
      if(root){
        const modeLabel = mode ? (mode === 'minor' ? 'Minor' : 'Major') : '';
        label = modeLabel ? `${root} ${modeLabel}` : root;
      } else {
        label = label || '?';
      }
      return { root, pitchClass, mode, label };
    }
    function convertToCamelot(key, mode) {
      if (!key && !mode) return '?';
      const modeNormalized = normalizeMode(mode,key);
      const base = normalizeKeyName(key);
      const variants = [];
      const modeWord = modeNormalized === 'minor' ? 'Minor' : 'Major';
      if(base){
        if(modeNormalized){ variants.push(`${base} ${modeWord}`); variants.push(`${base}${modeNormalized==='minor'?'m':''}`); }
        variants.push(base);
      }
      for(const v of variants){ if(keyToCamelot[v]) return keyToCamelot[v]; }
      return '?';
    }
    function deriveCamelotForTrack(track){
      const baseKey = normalizeKeyName(track.mk || track.key || '');
      const mode = normalizeMode(track.mm || track.mode || '', track.mk || track.key || '');
      const fallbackMode = mode || (((track.key||'') + (track.mk||'')).toLowerCase().includes('m') ? 'minor' : 'major');
      const camelot = convertToCamelot(baseKey || track.mk || track.key || '', fallbackMode);
      const keyLabel = baseKey ? `${baseKey} ${fallbackMode}` : '?';
      return { camelot, keyLabel, mode: fallbackMode };
    }
    function semitoneDistance(aPc,bPc){ if(aPc===null||aPc===undefined||bPc===null||bPc===undefined) return null; const d=Math.abs(aPc-bPc)%12; return Math.min(d,12-d); }
    function signedSemitoneDelta(aPc,bPc){ if(aPc===null||aPc===undefined||bPc===null||bPc===undefined) return null; let diff=(bPc-aPc)%12; if(diff>6) diff-=12; if(diff<-6) diff+=12; return diff; }
    function scoreSemitoneKeyMatch(a,b,maxRange, allowOpposite=true){
      if(!a || !b || a.pitchClass===null || b.pitchClass===null) return { eligibleSameMode:false, eligibleOppMode:false, dist:null, scoreSameMode:0, scoreOppMode:0 };
      const dist = semitoneDistance(a.pitchClass,b.pitchClass);
      if(dist===null) return { eligibleSameMode:false, eligibleOppMode:false, dist:null, scoreSameMode:0, scoreOppMode:0 };
      const sameMode = a.mode && b.mode && a.mode === b.mode;
      const eligibleSameMode = !!(sameMode && dist <= maxRange);
      const eligibleOppMode = !!(!sameMode && allowOpposite && dist <= maxRange);
      const scoreSameMode = eligibleSameMode ? Math.max(0, 40 - (dist*4)) : 0;
      const scoreOppMode = eligibleOppMode ? Math.max(4, 10 - dist) : 0;
      return { eligibleSameMode, eligibleOppMode, dist, scoreSameMode, scoreOppMode };
    }
    function getCompatibleKeys(camelot) {
      if (!camelot || camelot === '?') return [];
      const matches = camelot.match(/^(\d+)([AB])$/);
      if (!matches) return [];
      const num = parseInt(matches[1]); const letter = matches[2];
      const compatible = [camelot, `${num}${letter==='A'?'B':'A'}`];
      const nextNum = num === 12 ? 1 : num + 1; const prevNum = num === 1 ? 12 : num - 1;
      compatible.push(`${nextNum}${letter}`); compatible.push(`${prevNum}${letter}`);
      return compatible;
    }
    function ensureKeyInfo(track){ if(!track) return { root:null, pitchClass:null, mode:null, label:'?' }; if(!track.keyInfo){ track.keyInfo = parseKey(track.rawKey || track.key || '', track.rawMode || track.mode || ''); } return track.keyInfo; }
    function isMixable(song1,song2){
      if(!song1||!song2) return false;
      if(keyMatchMode === 'semitone'){
        const aInfo = ensureKeyInfo(song1);
        const bInfo = ensureKeyInfo(song2);
        const match = scoreSemitoneKeyMatch(aInfo,bInfo,maxSemitoneRange, includeOppositeMode);
        return match.eligibleSameMode || match.eligibleOppMode;
      }
      const compatible = getCompatibleKeys(song1.camelot);
      return compatible.includes(song2.camelot);
    }
    function isMixableWithBpm(song1,song2){ if(!song1||!song2) return false; const bpmOk = Math.abs(song1.bpm - song2.bpm) <= 4; return bpmOk && isMixable(song1,song2); }

    function scoreKeyMatch(aCamelot,bCamelot){ if(!aCamelot||!bCamelot||aCamelot==='?'||bCamelot==='?') return 0; if(aCamelot===bCamelot) return 50; const ma=aCamelot.match(/^(\d+)([AB])$/), mb=bCamelot.match(/^(\d+)([AB])$/); if(!ma||!mb) return 0; const numA=parseInt(ma[1]), letterA=ma[2], numB=parseInt(mb[1]), letterB=mb[2]; const ringDiff=Math.min(Math.abs(numA-numB),12-Math.abs(numA-numB)); if(numA===numB&&letterA!==letterB) return 42; if(letterA===letterB&&ringDiff===1) return 38; if(letterA!==letterB&&ringDiff===1) return 30; if(letterA===letterB&&ringDiff===2) return 26; return 14 - Math.min(ringDiff,6); }
    function scoreBpmMatch(aBpm,bBpm){ const diff=Math.abs(aBpm-bBpm); if(diff<=1) return 35; if(diff<=3) return 32; if(diff<=6) return 26; if(diff<=10) return 16; if(diff<=15) return 10; return 0; }
    function scoreGenreMatch(aGenre,bGenre){ if(!aGenre||!bGenre) return 0; return aGenre===bGenre?15:5; }
    function camelotDistance(aCamelot,bCamelot){ if(!aCamelot||!bCamelot||aCamelot==='?'||bCamelot==='?') return 99; const ma=aCamelot.match(/^(\d+)([AB])$/), mb=bCamelot.match(/^(\d+)([AB])$/); if(!ma||!mb) return 99; const numA=parseInt(ma[1]), letterA=ma[2], numB=parseInt(mb[1]), letterB=mb[2]; const numDiff=Math.min(Math.abs(numA-numB),12-Math.abs(numA-numB)); const letterDiff = letterA===letterB ? 0 : 0.5; return numDiff + letterDiff; }
    function mashupCompatibility(a,b){
      let keyScore = 0;
      if(keyMatchMode === 'semitone'){
        const aInfo = ensureKeyInfo(a);
        const bInfo = ensureKeyInfo(b);
        const match = scoreSemitoneKeyMatch(aInfo,bInfo,maxSemitoneRange, includeOppositeMode);
        keyScore = match.eligibleSameMode ? match.scoreSameMode : (match.eligibleOppMode ? match.scoreOppMode : 0);
      } else {
        keyScore = scoreKeyMatch(a.camelot,b.camelot);
      }
      const bpm=scoreBpmMatch(a.bpm,b.bpm); const genre=scoreGenreMatch(a.genre,b.genre); const total=keyScore+bpm+genre; return {total,breakdown:{key:keyScore,bpm,genre}};
    }
    function getPriorityBoost(strength){ if(strength==='low') return 60; if(strength==='high') return 200; return 120; }
    function priorityRank(anchor, candidate, mode){
      const comp = mashupCompatibility(anchor, candidate);
      const bpmDiff = Math.abs(candidate.bpm - anchor.bpm);
      const semitoneMatch = keyMatchMode==='semitone' ? (()=>{ const aInfo=ensureKeyInfo(anchor); const bInfo=ensureKeyInfo(candidate); const base=scoreSemitoneKeyMatch(aInfo,bInfo,maxSemitoneRange, includeOppositeMode); return { ...base, signedDelta: signedSemitoneDelta(aInfo.pitchClass,bInfo.pitchClass) }; })() : null;
      const keyDist = keyMatchMode==='semitone' ? (semitoneMatch ? semitoneMatch.dist : null) : camelotDistance(anchor.camelot, candidate.camelot);
      const sameGenre = candidate.genre === anchor.genre;

      const bpmScore = Math.max(0, 1 - (bpmDiff / 10));
      const keyScore = keyMatchMode==='semitone'
        ? Math.max(0, 1 - ((keyDist ?? 6) / 6))
        : Math.max(0, 1 - (keyDist / 6));
      const genreScore = sameGenre ? 1 : 0;

      const boost = getPriorityBoost(priorityStrength);
      let rank = comp.total * 10;

      if(mode === 'bpm') rank += bpmScore * boost;
      if(mode === 'camelot') rank += keyScore * boost;
      if(mode === 'genre') rank += genreScore * boost;

      if(bpmDiff > 12) rank -= 40;
      if(keyDist !== null && keyDist !== undefined && keyDist > 4) rank -= 40;

      return { rank, comp, bpmDiff, keyDist, sameGenre, semitoneMatch };
    }
    function bpmShiftSuggestion(aBpm,bBpm){ const shift=Math.round(bBpm-aBpm); if(shift===0) return 'No change'; return (shift>0?'+':'')+shift+' BPM = Perfect Match'; }
    function normalizeTitleArtist(title,artist){
      return `${(title||'').toLowerCase()}|${(artist||'').toLowerCase()}`;
    }
    function applyCamelotOverride(track, derivedCamelot){
      const key = normalizeTitleArtist(track.title || track.tt, track.artist || track.an);
      const fromId = camelotOverridesStore.ids[track.id];
      const fromName = camelotOverridesStore.names[key];
      const finalCamelot = fromId || fromName || derivedCamelot;
      return { camelot: finalCamelot, overridden: !!(fromId || fromName) };
    }
    function applyBpmOverride(track, rawBpm){
      const key = normalizeTitleArtist(track.title || track.tt, track.artist || track.an);
      const fromId = bpmOverridesStore.ids[track.id];
      const fromName = bpmOverridesStore.names[key];
      const finalBpm = fromId ? Number(fromId) : (fromName ? Number(fromName) : rawBpm);
      return { bpm: isNaN(finalBpm) ? rawBpm : finalBpm, overridden: !!(fromId || fromName) };
    }
    function computeTrackFlags(track){
      const flags = [];
      if(!track.camelot || !/^\d{1,2}[AB]$/.test(track.camelot)) flags.push('INVALID_CAMELOT');
      const modeLower = (track.mode||'').toLowerCase();
      if(track.camelot && /^\d{1,2}[AB]$/.test(track.camelot)){
        const letter = track.camelot.slice(-1);
        if(modeLower==='major' && letter==='A') flags.push('MODE_MISMATCH');
        if(modeLower==='minor' && letter==='B') flags.push('MODE_MISMATCH');
      }
      if(!track.rawKey && !track.rawMode) flags.push('WEAK_PARSE');
      if(!track.bpm || isNaN(track.bpm)) flags.push('BPM_MISSING');
      if(track.bpm && (track.bpm < 60 || track.bpm > 220)) flags.push('BPM_OUTLIER');
      if(track.camelotOverridden) flags.push('OVERRIDDEN_CAMELOT');
      if(track.bpmOverridden) flags.push('OVERRIDDEN_BPM');
      return flags;
    }
    function refreshSongOverrides(track){
      const camelotData = deriveCamelotForTrack({ mk: track.rawKey, mm: track.rawMode, key: track.key, title: track.title, artist: track.artist });
      const camelotApplied = applyCamelotOverride(track, camelotData.camelot);
      const bpmApplied = applyBpmOverride(track, track.rawBpm || track.bpm);
      track.keyInfo = parseKey(track.rawKey || track.key || '', track.rawMode || track.mode || '');
      track.key = track.keyInfo.label || camelotData.keyLabel || track.key;
      track.camelot = camelotApplied.camelot;
      track.camelotOverridden = camelotApplied.overridden;
      track.bpm = bpmApplied.bpm;
      track.bpmOverridden = bpmApplied.overridden;
      track.derivedCamelot = camelotData.camelot;
      track.flags = computeTrackFlags(track);
    }
    function hydrateKeyInfo(track){
      if(!track) return;
      track.keyInfo = parseKey(track.rawKey || track.key || '', track.rawMode || track.mode || '');
      if(track.keyInfo.label) track.key = track.keyInfo.label;
    }
    // ----------------------- Genre detection -----------------------
    function detectGenre(artist, title){
      artist=(artist||'').toLowerCase(); title=(title||'').toLowerCase();
      for(const [genre,artists] of Object.entries(genreMap)){
        if(artists.some(a=>artist.includes(a) || (a.length>3 && artist.includes(a.split(' ')[0])))) return genre;
      }
      if(title.includes('rock')||title.includes('metal')) return 'Rock';
      if(title.includes('funk')||title.includes('disco')) return 'Disco/Funk';
      if(title.includes('blues')) return 'Blues';
      if(title.includes('jazz')) return 'Jazz';
      if(title.includes('country')) return 'Country';
      if(title.includes('reggae')) return 'Reggae';
      return 'Other';
    }

    // ----------------------- Storage helpers -----------------------
    function loadOverridesFromStorage(){
      try{
        camelotOverridesStore = JSON.parse(localStorage.getItem('camelotOverrides_v2') || '{"ids":{},"names":{}}');
      }catch(e){ camelotOverridesStore = { ids:{}, names:{} }; }
      try{
        bpmOverridesStore = JSON.parse(localStorage.getItem('bpmOverrides_v1') || '{"ids":{},"names":{}}');
      }catch(e){ bpmOverridesStore = { ids:{}, names:{} }; }
    }
    async function persistOverrides(){
      localStorage.setItem('camelotOverrides_v2', JSON.stringify(camelotOverridesStore));
      localStorage.setItem('bpmOverrides_v1', JSON.stringify(bpmOverridesStore));
      if(isAdmin() && firestore && firebaseAuth?.currentUser){
        try{
          await firestore.collection('users').doc(firebaseAuth.currentUser.uid).set({
            camelotOverrides: camelotOverridesStore,
            bpmOverrides: bpmOverridesStore
          },{merge:true});
        }catch(err){ console.warn('persist override firestore', err); }
      }
    }
    async function loadUserOverridesFromBackend(){
      if(isAdmin() && firestore && firebaseAuth?.currentUser){
        try{
          const doc = await firestore.collection('users').doc(firebaseAuth.currentUser.uid).get();
          if(doc.exists){
            const data = doc.data()||{};
            if(data.camelotOverrides) camelotOverridesStore = data.camelotOverrides;
            if(data.bpmOverrides) bpmOverridesStore = data.bpmOverrides;
          }
        }catch(err){ console.warn('load override firestore', err); }
      }
    }
    function normalizeOwnedList(ids){
      const arr = Array.isArray(ids) ? ids.filter(Boolean) : [];
      return Array.from(new Set(arr)).sort();
    }
    async function persistCurrentUserProfile(){
      console.debug('[profile] save clicked', { draftProfile, currentUser });
      if(viewingProfile) throw new Error('Cannot save while viewing another profile');
      if(!currentUser?.username) throw new Error('No current user to persist');
      isPersistingProfile = true;
      try{
        syncPreferencesIntoProfile();
        const mergedProfile = {
          ...currentUser,
          uid: firebaseAuth?.currentUser?.uid || currentUser.uid,
          username: currentUser.username,
          djName: (currentUser.djName || currentUser.username || '').trim() || currentUser.username,
          ownedTracks,
          setlists: currentUser.setlists || setlist || [],
          setlist: setlist || [],
          bandMembers,
          genreOverrides,
          oauth: currentUser.oauth || {},
          preferences: {
            keyMatchMode,
            maxSemitoneRange,
            includeOppositeMode,
            priorityStrength
          }
        };
        console.debug('[profile] currentUser before persist', currentUser);
        currentUser = mergedProfile;
        console.debug('[profile] currentUser after merge', currentUser);
        refreshDraftProfileFromCurrentUser();
        persistNamespacedState();
        persistKeyMatchSettings();
        localStorage.setItem('currentUser', currentUser.username);
        const profiles = JSON.parse(localStorage.getItem('userProfiles')||'{}');
        if (currentUser.username) profiles[currentUser.username] = { ...(profiles[currentUser.username]||{}), ...mergedProfile };
        if (currentUser.uid) profiles[currentUser.uid] = { ...(profiles[currentUser.uid]||{}), ...mergedProfile };
        localStorage.setItem('userProfiles', JSON.stringify(profiles));
        console.debug('[profile] local save ok');
        const backendOk = await saveUserProfileToBackend(mergedProfile);
        console[backendOk ? 'debug' : 'warn'](backendOk ? '[profile] backend save ok' : '[profile] backend save failed');
        const verifyProfile = await loadUserProfile(currentUser.username);
        const ownedMatch = JSON.stringify(normalizeOwnedList(verifyProfile?.ownedTracks)) === JSON.stringify(normalizeOwnedList(mergedProfile.ownedTracks));
        const prefMatch = JSON.stringify(verifyProfile?.preferences || {}) === JSON.stringify(mergedProfile.preferences || {});
        const genreMatch = JSON.stringify(verifyProfile?.genreOverrides || {}) === JSON.stringify(mergedProfile.genreOverrides || {});
        const djMatch = (verifyProfile?.djName || '').trim() === (mergedProfile.djName || '').trim();
        const verified = !!verifyProfile && ownedMatch && djMatch && prefMatch && genreMatch;
        if(!verified){
          console.error('[profile] save verification failed', { mergedProfile, verifyProfile });
          throw new Error('Save verification failed');
        }
        currentUser = verifyProfile;
        applyPreferencesFromProfile(currentUser);
        refreshDraftProfileFromCurrentUser();
        console.debug('[profile] save verified', { verifyProfile });
        return { backendOk, verifyProfile };
      } finally {
        isPersistingProfile = false;
      }
    }
    async function loadUserProfile(username){
      if(!username && !firebaseAuth?.currentUser) return null;
      const firebaseUser = firebaseAuth?.currentUser;
      if(firestore && (firebaseUser || username)){
        try{
          const doc = await firestore.collection('users').doc(firebaseUser?.uid || username).get();
          if(doc.exists) return normalizeProfileShape(doc.data(), firebaseUser?.uid || username);
        }catch(e){ console.warn('Firestore load failed',e); }
      }
      const profiles = JSON.parse(localStorage.getItem('userProfiles')||'{}');
      if(firebaseUser?.uid && profiles[firebaseUser.uid]) return normalizeProfileShape(profiles[firebaseUser.uid], firebaseUser.uid);
      return normalizeProfileShape(profiles[username], username) || null;
    }

    async function loadProfileForViewing(username){
      if(!username) return null;
      const profile = await loadUserProfileFromBackend(username) || await loadUserProfile(username);
      viewingProfile = profile || null;
      return viewingProfile;
    }

    async function fetchProfilesByField(field, value){
      if(!firestore || !value) return [];
      try{
        const snap = await firestore.collection('users').where(field,'==',value).get();
        return snap.docs.map(doc=> normalizeProfileShape({ ...doc.data(), uid: doc.id }, doc.id));
      }catch(err){ console.warn('profile lookup failed', err); return []; }
    }

    function openFriendProfile(profile){
      if(!profile) return;
      viewingProfile = normalizeProfileShape(profile, profile.uid || profile.username || '');
      profileOwnedSearch = '';
      setProfileQueryParam(viewingProfile?.username || viewingProfile?.uid || '');
      friendLookupResults = [];
      friendLookupError = '';
      view = 'profile';
      render();
      setupEventListeners();
      updateOwnedCount();
    }

    window.selectFriendProfile = (username)=>{
      const pick = friendLookupResults.find(p=>p.username === username || p.uid === username);
      if(!pick){ friendLookupError = 'Profile not available anymore.'; renderProfile(); setupEventListeners(); return; }
      openFriendProfile(pick);
    };

    async function viewFriendProfile(){
      const input = (document.getElementById('friendSearchInput')?.value || '').trim();
      friendSearchTerm = input;
      friendLookupError = '';
      friendLookupResults = [];
      if(!firebaseAuth?.currentUser){
        friendLookupError = 'Sign in required to view other profiles.';
        renderProfile(); setupEventListeners(); return;
      }
      if(!input){ friendLookupError = 'Enter a DJ name or username to view.'; renderProfile(); setupEventListeners(); return; }
      const tryMatches = async (field)=> await fetchProfilesByField(field, input);
      try{
        const usernameHits = await tryMatches('username');
        if(usernameHits.length === 1) return openFriendProfile(usernameHits[0]);
        if(usernameHits.length > 1){ friendLookupResults = usernameHits; renderProfile(); setupEventListeners(); return; }

        const djHits = await tryMatches('djName');
        if(djHits.length === 1) return openFriendProfile(djHits[0]);
        if(djHits.length > 1){ friendLookupResults = djHits; renderProfile(); setupEventListeners(); return; }

        if(input.includes('@')){
          const emailHits = await tryMatches('email');
          if(emailHits.length === 1) return openFriendProfile(emailHits[0]);
          if(emailHits.length > 1){ friendLookupResults = emailHits; renderProfile(); setupEventListeners(); return; }
        }
        friendLookupError = `No profile found for ‚Äò${input}‚Äô`;
      }catch(err){
        friendLookupError = 'Lookup failed. Please try again.';
      }
      renderProfile();
      setupEventListeners();
    }

    function setProfileQueryParam(value){
      const params = new URLSearchParams(window.location.search);
      if(value) params.set('profile', value); else params.delete('profile');
      const query = params.toString();
      const newUrl = `${location.pathname}${query ? `?${query}` : ''}${location.hash}`;
      window.history.replaceState({}, '', newUrl);
    }
    function clearViewedProfile(){
      viewingProfile = null;
      profileOwnedSearch = '';
      friendLookupResults = [];
      friendLookupError = '';
      friendSearchTerm = '';
      setProfileQueryParam(null);
    }

    // --------------------- UI: Landing / Auth ------------------------
    function showLandingPage(){
      document.getElementById('app').innerHTML = `
        <div class="min-h-screen py-12 px-6">
          <div class="max-w-6xl mx-auto">
            <div class="text-center mb-16">
              <div class="flex justify-center mb-6">
                <div class="w-32 h-32 bg-gradient-to-br from-pink-500 via-purple-500 to-cyan-500 rounded-full flex items-center justify-center text-6xl vinyl-spin">üéß</div>
              </div>
              <h1 class="text-5xl md:text-6xl font-bold text-white graffiti-text mb-4">${BRAND.APP_NAME.toUpperCase()}</h1>
              <p class="text-xl md:text-2xl text-cyan-300 mb-6">Create Epic Mashups & DJ Like a Pro on the Jam Stage!</p>
              <div class="mt-6">
                <button onclick="hideLanding()" class="px-8 py-4 bg-gradient-to-r from-pink-500 via-purple-500 to-cyan-500 rounded-xl font-bold text-white text-xl md:text-2xl bounce-icon shadow-lg">üéµ START MIXING NOW</button>
              </div>
            </div>
            <div class="bg-black/60 backdrop-blur-xl border border-pink-500/30 rounded-2xl p-6 md:p-8 mb-12">
              <div class="flex flex-col lg:flex-row items-center gap-8">
                <div class="flex-shrink-0">
                  <div class="w-28 h-28 camelot-wheel rounded-full" style="background: conic-gradient(from 0deg,#FF6B9D 0deg 30deg,#FFA07A 30deg 60deg,#FFD700 60deg 90deg,#98D8C8 90deg 120deg,#6BCB77 120deg 150deg,#4D96FF 150deg 180deg,#9D4EDD 180deg 210deg,#E84A5F 210deg 240deg,#00D9FF 240deg 270deg,#FFA400 270deg 300deg,#FE6D73 300deg 330deg,#A8E6CF 330deg 360deg); width:140px;height:140px;border-radius:50%;box-shadow:0 0 40px rgba(0,217,255,0.2)"></div>
                  <p class="text-center text-xs text-cyan-300 mt-4">The Camelot Wheel in Action</p>
                </div>
                <div class="flex-1">
                  <h2 class="text-2xl md:text-3xl font-bold text-white mb-4 graffiti-text">üéõÔ∏è The Secret: The Camelot Wheel</h2>
                  <p class="text-gray-300 mb-4 text-base md:text-lg">Professional DJs use the Camelot Wheel to create seamless mashups. It's a color-coded system that shows which songs are harmonically compatible.</p>
                  <div class="space-y-3 text-gray-300 text-sm md:text-base">
                    <div class="flex items-start gap-3"><span class="text-2xl">‚úÖ</span><div><strong class="text-cyan-300">Same Number = Perfect Match!</strong><br/><span class="text-sm">Example: 8B ‚Üí 8B</span></div></div>
                    <div class="flex items-start gap-3"><span class="text-2xl">‚úÖ</span><div><strong class="text-cyan-300">A/B Switch = Energy Shift</strong><br/><span class="text-sm">Example: 8B ‚Üí 8A</span></div></div>
                    <div class="flex items-start gap-3"><span class="text-2xl">‚úÖ</span><div><strong class="text-cyan-300">¬±1 Number = Smooth Blend</strong><br/><span class="text-sm">Example: 8B ‚Üí 9B or 7B</span></div></div>
                  </div>
                </div>
              </div>
            </div>

            <div class="text-center">
              <button onclick="hideLanding()" class="px-8 md:px-12 py-4 md:py-5 bg-gradient-to-r from-pink-500 via-purple-500 to-cyan-500 rounded-xl font-bold text-white text-2xl md:text-3xl shadow-2xl">üéµ LET'S MIX!</button>
            </div>
          </div>
        </div>
      `;
    }
    window.hideLanding = () => { localStorage.setItem('hasSeenLanding','true'); checkAuth(); };

    // -------------------- Login / Profile handlers ---------------------
    function showLoginScreen(){
      // default auth mode
      setTimeout(()=>{ try{ if(window.setAuthMode) window.setAuthMode('signin'); }catch(e){} }, 50);

      document.getElementById('app').innerHTML = `
        <div class="min-h-screen flex items-center justify-center p-6">
          <div class="max-w-md w-full">
            <div class="text-center mb-8">
              <div class="w-24 h-24 bg-gradient-to-br from-pink-500 via-purple-500 to-cyan-500 rounded-full flex items-center justify-center text-5xl mx-auto mb-4 vinyl-spin">üéß</div>
              <h1 class="text-4xl font-bold text-white graffiti-text mb-2">${BRAND.APP_NAME.toUpperCase()}</h1>
              <p class="text-cyan-300">Your Personal DJ Profile</p>
            </div>

            <div class="bg-black/60 backdrop-blur-xl border border-cyan-500/30 rounded-2xl p-8 shadow-2xl">
              <h2 class="text-2xl font-bold text-white mb-6 text-center">Sign In / Create Profile</h2>
              ${!firebaseEnabled ? `<div class="mb-4 p-3 rounded-lg bg-yellow-500/20 border border-yellow-500/50 text-yellow-100 text-sm text-center">Firebase not configured ‚Äî using local profiles.</div>` : ''}

              ${firebaseEnabled ? `
                <div class="mb-5">
                  <div class="flex gap-2 bg-black/30 p-1 rounded-xl border border-cyan-500/20">
                    <button type="button" id="tabSignIn" onclick="setAuthMode('signin')" class="flex-1 px-3 py-2 rounded-lg font-bold text-white bg-white/10">Already a member</button>
                    <button type="button" id="tabSignUp" onclick="setAuthMode('signup')" class="flex-1 px-3 py-2 rounded-lg font-bold text-white opacity-80">Sign up</button>
                  </div>
                  <p class="text-xs text-gray-300 mt-3 text-center">
                    Cloud sync works after you create an account once. Sign in to access your profile and owned songs.
                  </p>
                </div>

                <form onsubmit="handleFirebaseAuth(event)" class="space-y-4" autocomplete="on">
                  <input type="hidden" id="authMode" value="signin" />

                  <div>
                    <label class="block text-sm text-gray-300 mb-2">Email</label>
                    <input id="email" type="email" required placeholder="you@example.com"
                      class="w-full px-4 py-3 bg-black/40 border border-gray-600 rounded-lg text-white" />
                  </div>

                  <div>
                    <label class="block text-sm text-gray-300 mb-2">Password</label>
                    <input id="password" type="password" required minlength="6" placeholder="password"
                      class="w-full px-4 py-3 bg-black/40 border border-gray-600 rounded-lg text-white" />
                  </div>

                  <div id="confirmWrap" style="display:none">
                    <label class="block text-sm text-gray-300 mb-2">Confirm Password</label>
                    <input id="passwordConfirm" type="password" placeholder="confirm password"
                      class="w-full px-4 py-3 bg-black/40 border border-gray-600 rounded-lg text-white" />
                    <p class="text-xs text-gray-400 mt-2">Tip: use at least 6 characters.</p>
                  </div>

                  <div>
                    <button type="submit" id="authSubmit"
                      class="w-full px-4 py-3 bg-gradient-to-r from-pink-500 to-purple-500 rounded-lg font-bold text-white">
                      Sign In
                    </button>
                  </div>

                  <div class="text-center">
                    <button type="button" onclick="forgotPassword()" class="text-xs text-cyan-300 hover:underline">Forgot password?</button>
                  </div>
                  <div id="authError" class="mt-3 text-sm text-red-200 bg-red-900/50 border border-red-500/60 rounded-lg p-3" style="display:none"></div>
                </form>
              ` : `
                <form onsubmit="handleLogin(event)" class="space-y-4">
                  <div><label class="block text-sm text-gray-300 mb-2">Username</label><input id="username" type="text" required minlength="3" placeholder="Enter your username" class="w-full px-4 py-3 bg-black/40 border border-gray-600 rounded-lg text-white" /></div>
                  <div><label class="block text-sm text-gray-300 mb-2">DJ Name (optional)</label><input id="djName" type="text" placeholder="e.g., DJ Spinner" class="w-full px-4 py-3 bg-black/40 border border-gray-600 rounded-lg text-white" /></div>
                  <button type="submit" class="w-full px-6 py-3 bg-gradient-to-r from-pink-500 via-purple-500 to-cyan-500 rounded-lg font-bold text-white text-lg">üéµ Enter the Mix</button>
                </form>
              `}
              <div class="mt-6 pt-6 border-t border-gray-700">
                <p class="text-xs text-gray-400 text-center">‚ö†Ô∏è Epic Games doesn't share inventory; mark songs you own manually.</p>
              </div>
            </div>
          </div>
        </div>
      `;
    }

      // -------------------- Firebase Auth UI helpers ---------------------
    window.setAuthMode = (mode) => {
      const m = (mode === 'signup') ? 'signup' : 'signin';
      const authMode = document.getElementById('authMode');
      if (!authMode) return;
      authMode.value = m;

      const tabIn = document.getElementById('tabSignIn');
      const tabUp = document.getElementById('tabSignUp');
      const confirmWrap = document.getElementById('confirmWrap');
      const submit = document.getElementById('authSubmit');
      const confirmInput = document.getElementById('passwordConfirm');

      if (m === 'signup') {
        if (tabUp) { tabUp.classList.add('bg-white/10'); tabUp.classList.remove('opacity-80'); }
        if (tabIn) { tabIn.classList.remove('bg-white/10'); tabIn.classList.add('opacity-80'); }
        if (confirmWrap) confirmWrap.style.display = 'block';
        if (submit) submit.textContent = 'Create Account';
        if (confirmInput) { confirmInput.required = true; confirmInput.setAttribute('minlength','6'); confirmInput.value = ''; }
      } else {
        if (tabIn) { tabIn.classList.add('bg-white/10'); tabIn.classList.remove('opacity-80'); }
        if (tabUp) { tabUp.classList.remove('bg-white/10'); tabUp.classList.add('opacity-80'); }
        if (confirmWrap) confirmWrap.style.display = 'none';
        if (submit) submit.textContent = 'Sign In';
        if (confirmInput) { confirmInput.required = false; confirmInput.value = ''; }
      }
    };

    function getLocalDeviceId(){
      let localId = localStorage.getItem('localDeviceUserId');
      if(!localId){
        localId = 'local_' + Math.random().toString(36).slice(2,10);
        localStorage.setItem('localDeviceUserId', localId);
      }
      return localId;
    }

    window.continueOffline = async () => {
      if(firebaseEnabled){
        alert('Sign in is required while cloud sync is enabled.');
        return;
      }
      const username = getLocalDeviceId();
      currentUser = { username, djName: username, ownedTracks: ownedTracks || [], setlists: [], bandMembers: bandMembers || [], genreOverrides: genreOverrides || {} };
      localStorage.setItem('currentUser', currentUser.username);
      refreshDraftProfileFromCurrentUser();
      try { await persistCurrentUserProfile(); } catch(err){ console.warn('offline profile save failed', err); }
      loadSongs();
    };

    window.forgotPassword = async () => {
      if (!firebaseAuth) return alert('Firebase not ready yet.');
      const email = (document.getElementById('email')?.value || '').trim();
      if (!email) return alert('Type your email first, then click "Forgot password?"');
      try {
        await firebaseAuth.sendPasswordResetEmail(email);
        alert('Password reset email sent (check inbox/spam).');
      } catch (e) {
        alert('Could not send reset email: ' + (e.message || e));
      }
    };

    function getOAuthCallbackUrl(provider){
      if(provider === 'epic') return `${window.location.origin}/oauth-callback.html?oauth=epic`;
      return window.location.origin;
    }

    function cacheEpicLink(linkData){
      if(!firebaseAuth?.currentUser) return;
      try{
        const profiles = JSON.parse(localStorage.getItem('userProfiles') || '{}');
        const uid = firebaseAuth.currentUser.uid;
        const existing = profiles[uid] || {};
        if(linkData){
          profiles[uid] = { ...existing, oauth: { ...(existing.oauth || {}), epic: linkData } };
        } else if(existing.oauth && existing.oauth.epic){
          delete existing.oauth.epic;
          profiles[uid] = { ...existing, oauth: { ...(existing.oauth || {}) } };
        }
        localStorage.setItem('userProfiles', JSON.stringify(profiles));
      }catch(e){ /* non-fatal cache failure */ }
    }

    async function fetchEpicLinkStatus(){
      if(!firebaseAuth?.currentUser) return null;
      let idToken;
      try{ idToken = await firebaseAuth.currentUser.getIdToken(); } catch(e){ return null; }
      try{
        const resp = await fetch('/api/oauth/epic/status', {
          headers: { 'Authorization': `Bearer ${idToken}` },
          credentials: 'include'
        });
        if(resp.status === 401){
          currentUser = currentUser || {};
          if(currentUser.oauth?.epic){ delete currentUser.oauth.epic; cacheEpicLink(null); }
          return { linked: false, error: 'Authentication required' };
        }
        if(!resp.ok) return null;
        const data = await resp.json();
        currentUser = currentUser || {};
        currentUser.oauth = currentUser.oauth || {};
        if(data.linked){
          const epicData = {
            linked: true,
            epicAccountId: data.epicAccountId || null,
            displayName: data.displayName || null,
            linkedAt: data.linkedAt || Date.now(),
            lastValidatedAt: data.lastValidatedAt || Date.now()
          };
          currentUser.oauth.epic = epicData;
          cacheEpicLink(epicData);
        } else if(currentUser.oauth.epic){
          delete currentUser.oauth.epic;
          cacheEpicLink(null);
        }
        return data;
      }catch(e){ console.warn('Epic status fetch failed', e); return null; }
    }

    window.startOAuth = (provider) => {
      if(!firebaseAuth?.currentUser){ alert('Sign in first to link accounts.'); return; }
      if(provider === 'epic'){
        const redirect = encodeURIComponent(getOAuthCallbackUrl(provider));
        window.location.href = `/api/oauth/epic/start?redirect_uri=${redirect}`;
        return;
      }
      alert('Unsupported OAuth provider.');
    };

    window.unlinkOAuth = async (provider) => {
      if(provider !== 'epic') return alert('Unsupported OAuth provider.');
      if(!firebaseAuth?.currentUser){ alert('Sign in first to unlink.'); return; }
      try{
        const token = await firebaseAuth.currentUser.getIdToken();
        const resp = await fetch('/api/oauth/epic/unlink', {
          method:'POST',
          headers:{ 'Authorization': `Bearer ${token}` },
          credentials: 'include'
        });
        if(!resp.ok){
          alert('Could not unlink Epic right now.');
          return;
        }
        await fetchEpicLinkStatus();
        await persistCurrentUserProfile();
        alert('Epic account unlinked.');
        renderProfile(); setupEventListeners();
      }catch(err){
        console.warn('Unlink epic failed', err);
        alert('Could not unlink Epic right now.');
      }
    };

    function hasMeaningfulData(profile){
      if(!profile) return false;
      return (profile.ownedTracks && profile.ownedTracks.length) ||
        (profile.setlist && profile.setlist.length) ||
        (profile.setlists && profile.setlists.length) ||
        (profile.genreOverrides && Object.keys(profile.genreOverrides).length) ||
        (profile.bandMembers && profile.bandMembers.length);
    }

    async function promptLocalImport(firebaseUsername){
      const localOwned = JSON.parse(localStorage.getItem('ownedTracks') || '[]');
      const localSet = JSON.parse(localStorage.getItem('setlist') || '[]');
      const localGenre = JSON.parse(localStorage.getItem('genreOverrides') || '{}');
      const profiles = JSON.parse(localStorage.getItem('userProfiles') || '{}');

      const candidateProfiles = Object.entries(profiles)
        .filter(([name, data]) => name && name !== firebaseUsername && hasMeaningfulData(data));
      const deviceDataAvailable = (localOwned && localOwned.length) || (localSet && localSet.length) || (localGenre && Object.keys(localGenre).length);
      if(!candidateProfiles.length && !deviceDataAvailable) return null;

      return await new Promise((resolve)=>{
        const modal = document.createElement('div');
        modal.id = 'importModal';
        modal.style.cssText = 'position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.85);z-index:30000;backdrop-filter:blur(6px);padding:12px;';
        const optionsHtml = candidateProfiles.length ?
          `<label class="block text-sm text-gray-200 mb-2">Import from saved profile</label>
            <select id="importProfileSelect" class="w-full px-3 py-2 rounded-lg bg-black/60 border border-cyan-500/30 text-white mb-3">
              ${candidateProfiles.map(([name])=>`<option value="${name}">${name}</option>`).join('')}
            </select>` : '';
        modal.innerHTML = `
          <div class="w-full max-w-md bg-gradient-to-b from-black/85 to-black/90 border border-cyan-500/30 rounded-2xl p-6 text-white shadow-2xl">
            <h3 class="text-xl font-bold mb-2">Import your local data?</h3>
            <p class="text-sm text-gray-200 mb-4">We found local data on this device. Import into this account?</p>
            ${optionsHtml || ''}
            ${deviceDataAvailable ? '<p class="text-xs text-gray-300 mb-4">Tip: If you used this app offline, choose Import to keep your owned songs and setlists.</p>' : ''}
            <div class="flex gap-2 justify-end">
              <button id="importSkip" class="px-4 py-2 rounded-lg bg-gray-700 text-white">Skip</button>
              <button id="importConfirm" class="px-4 py-2 rounded-lg bg-gradient-to-r from-pink-500 to-cyan-500 text-white font-bold">Import</button>
            </div>
          </div>`;
        document.body.appendChild(modal);
        const cleanup = ()=>{ modal.remove(); };
        modal.querySelector('#importSkip').onclick = ()=>{ cleanup(); resolve(null); };
        modal.querySelector('#importConfirm').onclick = ()=>{
          const choice = modal.querySelector('#importProfileSelect')?.value || null;
          cleanup();
          if(choice && profiles[choice]) return resolve(profiles[choice]);
          if(deviceDataAvailable){
            return resolve({
              ownedTracks: localOwned,
              setlist: localSet,
              setlists: localSet,
              genreOverrides: localGenre
            });
          }
          resolve(null);
        };
      });
    }

    async function resolveAuthSuccess(firebaseUser) {
      if (!firebaseUser?.uid) return;
      if (authSettledUser === firebaseUser.uid) return;
      authSettledUser = firebaseUser.uid;
      if (authProcessing) return;
      authProcessing = true;
      try {
        const defaultUsername = firebaseUser.displayName || (firebaseUser.email ? firebaseUser.email.split('@')[0] : `user_${firebaseUser.uid.slice(0,6)}`);
        const existingProfile = await loadUserProfileFromBackend(firebaseUser.uid);
        const shouldOfferImport = !hasMeaningfulData(existingProfile);
        let importedProfile = null;
        if (shouldOfferImport) {
          importedProfile = await promptLocalImport(defaultUsername);
        }

        const profile = existingProfile || {};
        currentUser = {
          ...profile,
          uid: firebaseUser.uid,
          username: profile.username || defaultUsername,
          djName: profile.djName || defaultUsername,
          ownedTracks: importedProfile?.ownedTracks || profile.ownedTracks || ownedTracks || [],
          setlists: importedProfile?.setlists || profile.setlists || setlist || [],
          setlist: importedProfile?.setlist || profile.setlist || profile.setlists || setlist || [],
          bandMembers: importedProfile?.bandMembers || profile.bandMembers || bandMembers || [],
          genreOverrides: importedProfile?.genreOverrides || profile.genreOverrides || genreOverrides || {},
          oauth: profile.oauth || {}
        };
        applyPreferencesFromProfile(currentUser);
        loadNamespacedState();
        loadOverridesFromStorage();
        await loadUserOverridesFromBackend();
        ownedTracks = currentUser.ownedTracks || [];
        setlist = currentUser.setlist || currentUser.setlists || [];
        bandMembers = currentUser.bandMembers || [];
        genreOverrides = currentUser.genreOverrides || {};
        refreshDraftProfileFromCurrentUser();
        await fetchEpicLinkStatus();
        localStorage.setItem('currentUser', firebaseUser.uid);
        await persistCurrentUserProfile();
        await maybeLoadSharedProfile();
        loadSongs();
        logEvent('auth_success', { uid: firebaseUser.uid });
      } finally {
        authProcessing = false;
      }
    }

    function setupFirebaseAuthListener() {
      if (!firebaseAuth || firebaseAuthUnsub) return;
      firebaseAuthUnsub = firebaseAuth.onAuthStateChanged(async (user) => {
        if (user) {
          await resolveAuthSuccess(user);
        } else {
          authSettledUser = null;
          currentUser = null;
          showLoginScreen();
        }
      });
    }

    async function handleFirebaseAuth(e){
      e.preventDefault();
      const errorBox = document.getElementById('authError');
      if(!firebaseEnabled || !firebaseAuth){
        if(errorBox){ errorBox.textContent = 'Firebase not configured ‚Äî using local profiles.'; errorBox.style.display = 'block'; }
        logEvent('auth_fail', { reason: 'config_missing' });
        return;
      }
      const mode = document.getElementById('authMode')?.value || 'signin';
      const email = (document.getElementById('email')?.value || '').trim();
      const password = (document.getElementById('password')?.value || '').trim();
      const passwordConfirm = document.getElementById('passwordConfirm')?.value || '';

      if(authInFlight) return;
      if(!email || !password){ if(errorBox){ errorBox.textContent = 'Enter email & password.'; errorBox.style.display = 'block'; } return; }
      if(password.length < 6 && mode === 'signup'){ if(errorBox){ errorBox.textContent = 'Password must be at least 6 characters.'; errorBox.style.display = 'block'; } return; }

      const submitBtn = document.getElementById('authSubmit');
      const disableAuthUi = (disabled) => {
        if(submitBtn){ submitBtn.disabled = disabled; submitBtn.classList.toggle('opacity-70', disabled); }
      };
      const mapErrorCode = (code, message)=>{
        if(code === 'auth/invalid-credential' || code === 'auth/wrong-password') return 'Email/password incorrect';
        if(code === 'auth/user-not-found') return 'No account found ‚Äî click Register';
        if(code === 'auth/network-request-failed') return 'Network blocked/unstable. Try again or disable VPN.';
        if(code === 'auth/too-many-requests') return 'Too many attempts ‚Äî wait a moment';
        return message || 'Sign-in failed';
      };
      authInFlight = true;
      disableAuthUi(true);
      if(errorBox){ errorBox.textContent = ''; errorBox.style.display = 'none'; }
      logEvent('auth_attempt', { mode, email });
      try{
        if(mode === 'signup'){
          if(password !== passwordConfirm){ if(errorBox){ errorBox.textContent = 'Passwords do not match.'; errorBox.style.display = 'block'; } return; }
          await firebaseAuth.createUserWithEmailAndPassword(email,password);
        } else {
          await firebaseAuth.signInWithEmailAndPassword(email,password);
        }

        setupFirebaseAuthListener();
        await resolveAuthSuccess(firebaseAuth.currentUser);

      } catch(err){
        console.error(err);
        const message = mapErrorCode(err?.code || '', err?.message);
        if(errorBox){ errorBox.textContent = message; errorBox.style.display = 'block'; }
        logEvent('auth_fail', { code: err?.code, message: err?.message });
      } finally {
        authInFlight = false;
        disableAuthUi(false);
      }
    }
    window.handleFirebaseAuth = handleFirebaseAuth;

window.handleLogin = async (event) => {
      event.preventDefault();
      const username = document.getElementById('username').value.trim();
      const djName = (document.getElementById('djName').value || username).trim() || username;
      if(username.length<3){ alert('Username must be at least 3 characters'); return; }
      const profile = await loadUserProfile(username);
      if(profile){ currentUser = profile; applyPreferencesFromProfile(currentUser); }
      else { currentUser = { username, djName, ownedTracks: [], setlists: [], bandMembers: [], genreOverrides: {} }; }
      refreshDraftProfileFromCurrentUser();
      loadNamespacedState();
      loadOverridesFromStorage();
      localStorage.setItem('currentUser', username);
      await persistCurrentUserProfile();
      loadSongs();
    };

    async function logoutUser(){
      try { await persistCurrentUserProfile(); } catch(err){ console.warn('save before logout failed', err); }
      if(firebaseAuth){ try{ await firebaseAuth.signOut(); } catch(e){ console.warn('signout',e); } }
      authSettledUser = null; authProcessing = false;
      currentUser = null; draftProfile = null; ownedTracks = []; setlist = []; bandMembers = []; viewingProfile = null; genreOverrides = {};
      localStorage.removeItem('currentUser');
      showLoginScreen();
    }

    // -------------------- Songs loading -----------------------
    async function loadSongs(){
      if(songsLoaded){
        return;
      }
      console.log('Loading tracks...');
      logEvent('songs_fetch_start', { online: navigator.onLine });
      const cachedTracks = await readCachedTracks();
      const endpoints=[ 'https://api.allorigins.win/raw?url=https://fortnitecontent-website-prod07.ol.epicgames.com/content/api/pages/fortnite-game/spark-tracks', 'https://corsproxy.io/?https://fortnitecontent-website-prod07.ol.epicgames.com/content/api/pages/fortnite-game/spark-tracks' ];
      const canFetch = navigator.onLine;
      if(canFetch){
        for(let i=0;i<endpoints.length;i++){
          try{
            const res = await fetch(endpoints[i]);
            if(!res.ok) continue;
            const data = await res.json();
            songs = Object.entries(data).filter(([k])=>!k.startsWith('_')).map(([id,item])=>{
              const track = item?.track || {};
              if(!track?.tt) return null;
              const detectedGenre = detectGenre(track.an||'', track.tt);
              const finalGenre = genreOverrides[id] || detectedGenre;
              const rawBpm = Number(track.mt) || 0;
              const camelotData = deriveCamelotForTrack({ ...track, id });
              const camelotApplied = applyCamelotOverride({ ...track, id, title: track.tt, artist: track.an }, camelotData.camelot);
              const bpmApplied = applyBpmOverride({ ...track, id, title: track.tt, artist: track.an }, rawBpm);
              const keyInfo = parseKey(track.mk || camelotData.keyLabel || track.key || '', track.mm || camelotData.mode || track.mode || '');
              const enriched = { id, title: track.tt, artist: track.an || 'Unknown', bpm: bpmApplied.bpm, rawBpm, key: keyInfo.label || camelotData.keyLabel || (track.mk || '?'), rawKey: track.mk || '', rawMode: track.mm || '', mode: camelotData.mode || (track.mm||''), camelot: camelotApplied.camelot, derivedCamelot: camelotData.camelot, duration: Number(track.dn)||0, albumArt: track.au||'', genre: finalGenre, camelotOverridden: camelotApplied.overridden, bpmOverridden: bpmApplied.overridden, keyInfo };
              enriched.flags = computeTrackFlags(enriched);
              return enriched;
            }).filter(s=>s && s.bpm>0);
            songs.sort((a,b)=>a.title.localeCompare(b.title));
            regressionWarnings = knownCorrections.filter(kc=>{
              const track = songs.find(s=>s.id===kc.id);
              return track && track.camelot !== kc.expectedCamelot;
            });
            if(regressionWarnings.length) console.warn('Regression warnings', regressionWarnings);
            if(songs.length>0){
              trackSource = 'network';
              songsLoaded = true;
              logEvent('songs_fetch_success', { source: trackSource, count: songs.length });
              cacheTracks(songs);
              render(); setupEventListeners();
              return;
            }
          }catch(e){ console.warn('endpoint err',e); logEvent('songs_fetch_fail', { message: e?.message, step: 'network' }); }
        }
      }
      if(cachedTracks.length){
        console.warn('Using cached track data');
        songs = cachedTracks;
        songs.forEach(hydrateKeyInfo);
        trackSource = 'cache';
        songsLoaded = true;
        logEvent('songs_fetch_success', { source: trackSource, count: songs.length });
        render(); setupEventListeners();
        return;
      }
      console.warn('endpoints failed, using fallback sample');
      songs = SAMPLE_TRACKS;
      songs.forEach(hydrateKeyInfo);
      trackSource = 'fallback';
      songsLoaded = true;
      logEvent('songs_fetch_fail', { message: 'network+cache miss; using fallback' });
      render(); setupEventListeners();
    }

    function refreshRegressionWarnings(){
      regressionWarnings = knownCorrections.filter(kc=>{
        const track = songs.find(s=>s.id===kc.id);
        return track && track.camelot !== kc.expectedCamelot;
      });
    }

    function resetPagination(){
      currentPage = 1;
      persistPaginationState();
    }

    const setCamelotOverride = async (trackId,value)=>{
      if(!isAdmin()) return alert('Admin only');
      camelotOverridesStore.ids[trackId] = value;
      await persistOverrides();
      const track = songs.find(s=>s.id===trackId);
      if(track){ refreshSongOverrides(track); }
      refreshRegressionWarnings();
      renderAuditView();
      renderSongList();
    };
    const setBpmOverride = async (trackId,value)=>{
      if(!isAdmin()) return alert('Admin only');
      bpmOverridesStore.ids[trackId] = Number(value);
      await persistOverrides();
      const track = songs.find(s=>s.id===trackId);
      if(track){ refreshSongOverrides(track); }
      renderAuditView();
      renderSongList();
    };
    const clearOverrides = async (trackId)=>{
      if(!isAdmin()) return alert('Admin only');
      delete camelotOverridesStore.ids[trackId];
      delete bpmOverridesStore.ids[trackId];
      await persistOverrides();
      const track = songs.find(s=>s.id===trackId);
      if(track){ refreshSongOverrides(track); }
      refreshRegressionWarnings();
      renderAuditView();
      renderSongList();
    };

    // ---------------------- Render list & setlist -----------------------
    function formatDuration(sec){ const m=Math.floor(sec/60); const s=sec%60; return `${m}:${s.toString().padStart(2,'0')}`; }
    function updateOwnedCount(){ const el=document.getElementById('ownedCount'); if(el){ const displayTracks = viewingProfile ? viewingProfile.ownedTracks || [] : ownedTracks; const ownerLabel = viewingProfile ? (viewingProfile.djName || viewingProfile.username || 'Profile') : 'You'; el.textContent = `${ownerLabel} own ${displayTracks.length}/${songs.length} tracks`; } }

    function renderSongList(){
      const displayTracks = viewingProfile ? viewingProfile.ownedTracks || [] : ownedTracks;
      const filtered = songs.filter(s=>{
        const isSelected = selectedSong && s.id === selectedSong.id;
        const matchesSearch = !searchTerm || s.title.toLowerCase().includes(searchTerm.toLowerCase()) || s.artist.toLowerCase().includes(searchTerm.toLowerCase());
        const matchesOwned = !showOwnedOnly || displayTracks.includes(s.id);
        const matchesMixable = isSelected || !showMixableOnly || !selectedSong || isMixableWithBpm(selectedSong, s);
        const matchesGenre = selectedGenre === 'All' || s.genre === selectedGenre;
        return matchesSearch && matchesOwned && matchesMixable && matchesGenre;
      });

      const scored = filtered.map(song=>{
        if(!selectedSong){
          return { song, comp: null, rank: 0, bpmDiff: null, keyDist: null, sameGenre: false };
        }
        const rankData = priorityRank(selectedSong, song, sortMode);
        return { song, ...rankData };
      });

      if(selectedSong){
        if(keyMatchMode === 'semitone'){
          scored.sort((a,b)=>{
            const aMatch = a.semitoneMatch || {};
            const bMatch = b.semitoneMatch || {};
            const aSame = aMatch.eligibleSameMode ? 1 : 0;
            const bSame = bMatch.eligibleSameMode ? 1 : 0;
            if(aSame !== bSame) return bSame - aSame;
            const aOpp = aMatch.eligibleOppMode ? 1 : 0;
            const bOpp = bMatch.eligibleOppMode ? 1 : 0;
            if(aSame===0 && bSame===0 && aOpp !== bOpp) return bOpp - aOpp;
            const aDist = (aMatch.eligibleSameMode || aMatch.eligibleOppMode) ? aMatch.dist ?? Infinity : Infinity;
            const bDist = (bMatch.eligibleSameMode || bMatch.eligibleOppMode) ? bMatch.dist ?? Infinity : Infinity;
            if(aDist !== bDist) return aDist - bDist;
            const aBpm = a.bpmDiff ?? Infinity;
            const bBpm = b.bpmDiff ?? Infinity;
            if(aBpm !== bBpm) return aBpm - bBpm;
            return a.song.title.localeCompare(b.song.title);
          });
        } else {
          scored.sort((a,b)=>{
            const scoreDiff = (b.rank ?? 0) - (a.rank ?? 0);
            if(scoreDiff !== 0) return scoreDiff;
            return a.song.title.localeCompare(b.song.title);
          });
        }
      } else {
        scored.sort((a,b)=> a.song.title.localeCompare(b.song.title));
      }

      const songListEl = document.getElementById('songList'); if(!songListEl) return;
      const totalPages = Math.max(1, Math.ceil(scored.length / pageSize));
      if(currentPage > totalPages) currentPage = totalPages;
      if(currentPage < 1) currentPage = 1;
      persistPaginationState();
      const startIndex = (currentPage - 1) * pageSize;
      const pageEntries = scored.slice(startIndex, startIndex + pageSize);
      const showingStart = scored.length ? startIndex + 1 : 0;
      const showingEnd = scored.length ? Math.min(scored.length, startIndex + pageEntries.length) : 0;

      const priorityNames = { bpm:'Tempo', camelot:'Camelot', genre:'Genre' };
      const priorityDescriptions = {
        bpm: 'Priority: Tempo ‚Äî closest BPM results are boosted within compatible matches.',
        camelot: 'Priority: Camelot ‚Äî harmonic neighbors rise to the top within the best matches.',
        genre: 'Priority: Genre ‚Äî same-genre blends are boosted while keeping top compatibility first.'
      };
      const priorityHeader = selectedSong ? `
        <div class="mb-3 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-1">
          <div class="text-lg font-bold text-white">Top Matches (Priority: ${priorityNames[sortMode] || 'Tempo'})</div>
          <div class="text-xs text-cyan-200 font-semibold">Strength: ${priorityStrength==='low'?'Low':priorityStrength==='high'?'High':'Medium'}</div>
        </div>
        <div class="text-xs text-gray-300 mb-4">${priorityDescriptions[sortMode] || priorityDescriptions.bpm} Top matches are sorted by compatibility first, then the priority boost (showing strongest ~10 results up top).</div>
      ` : '';

      const adminUser = isAdmin();
      const cardGrid = pageEntries.map(entry=>{
        const song = entry.song;
        const isSelected = selectedSong && song.id === selectedSong.id;
        const isOwned = displayTracks.includes(song.id);
        const comp = entry.comp;
        const pct = comp ? Math.min(100, Math.max(0, Math.round(comp.total))) : null;
        const hasOverride = genreOverrides[song.id];
        const glowClass = pct>=80 ? 'glow-perfect' : pct>=60 ? 'glow-good' : (pct!==null ? 'glow-bad' : '');
        const priorityLabel = selectedSong ? (()=>{
          if(keyMatchMode === 'semitone'){
            const distVal = entry.semitoneMatch?.dist ?? '‚Äî';
            const modeLabel = entry.semitoneMatch?.eligibleSameMode ? 'same mode' : entry.semitoneMatch?.eligibleOppMode ? 'opposite mode' : 'out of range';
            return `üé∂ Semitone priority (Œî${distVal}, ${modeLabel})`;
          }
          if(sortMode === 'bpm'){
            const delta = entry.bpmDiff !== null && entry.bpmDiff !== undefined ? Math.round(entry.bpmDiff) : '‚Äî';
            return `üî• Closest BPM match (Œî${delta})`;
          }
          if(sortMode === 'camelot'){
            const distVal = entry.keyDist !== null && entry.keyDist !== undefined ? (Number.isInteger(entry.keyDist) ? entry.keyDist : entry.keyDist.toFixed(1)) : '‚Äî';
            return `üéº Harmonic neighbor (distance ${distVal})`;
          }
          if(sortMode === 'genre'){
            return entry.sameGenre ? 'üé≠ Same genre boost' : 'üé≠ Genre priority (different genre)';
          }
          return '';
        })() : '';
        const semitoneBadge = (selectedSong && keyMatchMode==='semitone') ? (()=>{
          const match = entry.semitoneMatch;
          if(!match || match.dist===null || match.dist===undefined) return '';
          const deltaLabel = match.signedDelta===null || match.signedDelta===undefined ? `ŒîKey: ${match.dist}` : `ŒîKey: ${match.signedDelta>=0?'+':''}${match.signedDelta}`;
          const modeLabel = match.eligibleSameMode ? 'Same Mode' : (match.eligibleOppMode ? 'Opp Mode' : 'Not in range');
          return `<span class="px-2 py-1 bg-blue-500/20 border border-blue-400/40 rounded text-xs text-blue-100 font-semibold">${deltaLabel} ‚Ä¢ ${modeLabel}</span>`;
        })() : '';
        if(showMixableOnly && selectedSong){ if(!isMixableWithBpm(selectedSong, song)) return ''; }
        const selectedStyles = isSelected ? 'selected-card' : '';
        const genrePill = adminUser
          ? `<button data-genre-tag="${song.id}" data-song-id-genre="${song.id}" class="px-2 py-1 ${hasOverride ? 'bg-green-500/30 border-green-500/50' : 'bg-orange-500/30 border-orange-500/50'} border rounded text-xs cursor-pointer hover:border-cyan-400/60" title="Click to edit genre">${song.genre}${hasOverride ? ' ‚úì' : ''}</button>`
          : `<span class="px-2 py-1 ${hasOverride ? 'bg-green-500/30 border-green-500/50' : 'bg-orange-500/30 border-orange-500/50'} border rounded text-xs cursor-default">${song.genre}${hasOverride ? ' ‚úì' : ''}</span>`;
        return `
          <div class="song-card panel p-4 relative hover:border-cyan-400 transition-all ${selectedStyles}" data-song-id="${song.id}" draggable="true">
            <div class="star-icon absolute top-2 right-2 text-xl" style="display:${isOwned?'block':'none'}">‚≠ê</div>
            ${isSelected ? `<button class="selected-badge absolute top-2 left-2 flex items-center gap-1" onclick="clearSelection(event)">SELECTED <span class="font-normal text-[10px] opacity-90">(click to clear)</span></button>` : (selectedSong && isMixable(selectedSong,song) ? `<div class="absolute top-2 left-2 text-xl">üéß</div>` : '')}
            <div class="flex gap-4 mb-3">
              ${song.albumArt ? `<img src="${song.albumArt}" class="w-20 h-20 rounded-lg cursor-pointer hover:scale-110 transition-transform" onclick="selectSong('${song.id}')"/>` : `<div class="w-20 h-20 bg-gradient-to-br from-purple-500 to-pink-500 rounded-lg"></div>`}
              <div class="flex-1 cursor-pointer" onclick="selectSong('${song.id}')">
                <div class="font-bold text-lg mb-1 text-white">${song.title}</div>
                <div class="text-gray-300 mb-2 text-sm">${song.artist}</div>
                <div class="flex items-center gap-2 text-sm flex-wrap">
                  ${genrePill}
                  <span class="px-3 py-1 rounded-lg font-mono font-bold text-white" style="background:${camelotColors[song.camelot] || '#666'}">${song.camelot}</span>
                  <span class="px-2 py-1 bg-gray-700 rounded text-xs">${song.key}</span>
                  <span class="font-semibold text-cyan-300">${song.bpm} BPM</span>
                  ${semitoneBadge}
                  ${selectedSong && isMixable(selectedSong,song) ? `<span class="px-2 py-1 bg-purple-600/40 border border-purple-400/40 rounded text-xs text-purple-200 font-bold">¬±${Math.abs(song.bpm - selectedSong.bpm)} BPM</span>` : ''}
                  <span class="text-gray-400">${formatDuration(song.duration)}</span>
                </div>
                ${priorityLabel ? `<div class="text-xs text-cyan-200 mt-1">${priorityLabel}</div>` : ''}
              </div>
            </div>
            <div class="flex flex-wrap gap-2 items-center">
              <button onclick="selectSong('${song.id}')" class="px-3 py-2 rounded-lg text-sm font-semibold border ${isSelected?'border-cyan-400 bg-cyan-500/20 text-cyan-100':'border-white/10 bg-white/5 text-gray-200'}">Select</button>
              <button class="previewBtn px-3 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-sm" data-id="${song.id}">Preview</button>
              <button onclick="toggleOwned('${song.id}')" class="px-3 py-2 ${isOwned ? 'bg-green-500 hover:bg-green-600' : 'bg-gray-700 hover:bg-gray-600'} rounded-lg text-sm font-medium transition" ${viewingProfile ? 'disabled style="opacity:0.5;cursor:not-allowed;"' : ''}>${isOwned ? '‚úì Owned' : 'Mark Owned'}</button>
              <button class="addSetBtn px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 rounded-lg text-sm font-medium transition" data-id="${song.id}" ${viewingProfile ? 'disabled style="opacity:0.5;cursor:not-allowed;"' : ''}>+ Set</button>
              <button onclick="addToSandbox('${song.id}')" class="px-3 py-2 bg-blue-600/30 hover:bg-blue-600/50 border border-blue-400/40 rounded-lg text-sm font-medium transition" ${sandboxTracks.find(t=>t.id===song.id) ? 'disabled style="opacity:0.5;cursor:not-allowed;"' : ''}>+ Sandbox</button>
              ${selectedSong ? `<div class="${pct!==null?glowClass:''} ml-2 px-3 py-2 score-badge">${pct!==null?pct+'%':'‚Äî'}</div>` : ''}
            </div>
          </div>
        `;
      }).join('');

      const buildPaginationControls = ()=>{
        const pageSizeOptions = PAGE_SIZE_OPTIONS.map(size=>`<option value="${size}" ${pageSize===size?'selected':''}>${size} / page</option>`).join('');
        return `
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mt-2 bg-black/30 border border-white/5 rounded-lg px-3 py-3">
          <div class="flex flex-col sm:flex-row sm:items-center gap-2 text-sm text-gray-200">
            <span class="font-semibold text-white">Showing ${showingStart}‚Äì${showingEnd} of ${scored.length} tracks</span>
            <span class="text-xs text-gray-400">Page ${currentPage} of ${totalPages}</span>
          </div>
          <div class="flex flex-wrap items-center gap-3">
            <label class="flex items-center gap-2 text-sm text-gray-200">
              <span>Page size</span>
              <select class="pageSizeSelect bg-white/10 border border-white/10 rounded-lg px-3 py-2 min-h-[44px] text-white" onchange="setPageSize(this.value)">${pageSizeOptions}</select>
            </label>
            <div class="flex items-center gap-2">
              <button class="px-4 min-h-[44px] py-2 rounded-lg bg-white/10 border border-white/10 text-sm font-semibold ${currentPage===1?'opacity-50 cursor-not-allowed':''}" onclick="changePage(-1)" ${currentPage===1?'disabled':''}>Previous</button>
              <div class="text-sm font-semibold text-white px-2">Page ${currentPage} / ${totalPages}</div>
              <button class="px-4 min-h-[44px] py-2 rounded-lg bg-white/10 border border-white/10 text-sm font-semibold ${currentPage===totalPages?'opacity-50 cursor-not-allowed':''}" onclick="changePage(1)" ${currentPage===totalPages?'disabled':''}>Next</button>
            </div>
          </div>
        </div>`;
      };

      const paginationTop = scored.length ? buildPaginationControls() : '';
      const paginationBottom = scored.length ? buildPaginationControls() : '';

      const listContent = scored.length
        ? `${paginationTop}<div class="song-grid grid gap-4">${cardGrid}</div>${paginationBottom}`
        : `<div class="panel p-6 text-center text-gray-300 space-y-3"><div>No songs match your filters yet.</div><button onclick="clearFilters()" class="px-4 py-2 rounded-lg bg-white/10 border border-white/20 text-sm text-white">Clear filters</button></div>`;

      songListEl.innerHTML = priorityHeader + listContent;
      bindGenreEditors(songListEl);
    }

    function renderSetlist(){
      const setlistEl = document.getElementById('setlistContent'); if(!setlistEl) return;
      if(setlist.length===0){
        setlistEl.innerHTML = `<div class="text-center py-12"><div class="text-6xl mb-4">üéµ</div><p class="text-xl mb-4 text-white">Your setlist is empty</p><button onclick="switchView('browser')" class="px-6 py-3 bg-gradient-to-r from-purple-500 to-pink-500 rounded-lg font-bold">Browse Tracks</button></div>`;
      } else {
        setlistEl.innerHTML = `<div class="space-y-4">${setlist.map((song,i)=>`<div class="bg-black/40 backdrop-blur-sm border border-gray-700 rounded-xl p-4 flex items-center gap-4 hover:border-cyan-400 transition"><div class="text-2xl font-bold text-pink-400">${i+1}</div>${song.albumArt?`<img src="${song.albumArt}" class="w-16 h-16 rounded-lg"/>`:''}<div class="flex-1"><div class="font-bold text-lg text-white">${song.title}</div><div class="text-gray-300">${song.artist}</div><div class="text-xs text-orange-300">${song.genre}</div></div><div class="text-xl font-mono font-bold" style="color:${camelotColors[song.camelot]}">${song.camelot}</div><button onclick="removeFromSetlist('${song.id}')" class="p-2 hover:bg-red-500/20 rounded text-red-400 text-xl">‚úï</button></div>`).join('')}</div>`;
      }
    }

    function renderProfile(){
      const profileEl = document.getElementById('profileView'); if(!profileEl) return;
      const viewOnly = !!viewingProfile;
      if(!viewOnly && (!draftProfile || (currentUser?.username && draftProfile.username !== currentUser.username))){
        refreshDraftProfileFromCurrentUser();
      }
      const profileOwner = viewingProfile || currentUser || {};
      const editableProfile = viewOnly ? profileOwner : (draftProfile || profileOwner);
      const email = (firebaseAuth && firebaseAuth.currentUser && firebaseAuth.currentUser.email) ? firebaseAuth.currentUser.email : (viewingProfile ? 'Shared profile view' : 'Offline mode (local storage)');
      const usernameVal = editableProfile?.username || '';
      const djVal = editableProfile?.djName || usernameVal;
      const ownedIds = profileOwner?.ownedTracks || [];
      const epicLink = profileOwner?.oauth?.epic || null;
      const epicLinked = !!epicLink?.linked;
      const epicDisplay = epicLink?.displayName || epicLink?.epicAccountId || '';
      const showConnectedAccounts = !!firebaseAuth?.currentUser && !viewOnly;
      const friendError = friendLookupError ? `<div class="text-sm text-red-200 bg-red-500/10 border border-red-500/40 rounded px-3 py-2">${friendLookupError}</div>` : '';
      const friendList = friendLookupResults.length ? `<div class="space-y-2">
        <div class="text-xs text-gray-300">Multiple matches found. Pick one:</div>
        ${friendLookupResults.map(p=>`<button onclick="selectFriendProfile('${p.username || p.uid || ''}')" class="w-full text-left px-3 py-2 bg-white/5 hover:bg-white/10 border border-white/10 rounded flex items-center justify-between"><span class="font-semibold text-white">${p.djName || p.username || 'DJ'}</span><span class="text-xs text-gray-400">${p.username || 'unknown'}</span></button>`).join('')}
      </div>` : '';
      const ownedFiltered = songs
        .filter(s=>ownedIds.includes(s.id))
        .filter(s=>{
          const term = (profileOwnedSearch||'').toLowerCase();
          return !term || s.title.toLowerCase().includes(term) || s.artist.toLowerCase().includes(term);
        })
        .sort((a,b)=> a.title.localeCompare(b.title));
      const ownedCards = ownedFiltered.map(song=>{
        const camelotColor = camelotColors[song.camelot] || '#4b5563';
        return `<div class="flex gap-3 bg-black/40 border border-white/10 rounded-xl p-3 hover:border-cyan-500/40 transition">
          ${song.albumArt ? `<img src="${song.albumArt}" class="w-16 h-16 rounded-lg object-cover" alt="${song.title} cover"/>` : `<div class="w-16 h-16 rounded-lg bg-white/5 flex items-center justify-center text-xl">üéµ</div>`}
          <div class="flex-1 space-y-1">
            <div class="font-bold text-white">${song.title}</div>
            <div class="text-sm text-gray-300">${song.artist}</div>
            <div class="flex flex-wrap gap-2 items-center text-xs">
              <span class="px-2 py-1 rounded font-mono font-semibold text-white" style="background:${camelotColor};">${song.camelot}</span>
              <span class="px-2 py-1 bg-white/10 border border-white/10 rounded text-white">${song.bpm} BPM</span>
              <span class="px-2 py-1 bg-emerald-500/20 border border-emerald-400/40 rounded text-emerald-100">${song.genre}</span>
            </div>
          </div>
        </div>`;
      }).join('');
      const ownedEmpty = `<div class="text-sm text-gray-400">${profileOwnedSearch ? 'No owned songs match your search.' : 'No owned songs yet.'}</div>`;
      profileEl.innerHTML = `
        <div class="space-y-4 max-w-5xl mx-auto">
          <div class="panel space-y-3">
            <div class="flex items-center justify-between">
              <div>
                <div class="text-2xl font-bold text-white">Profile</div>
                <p class="text-sm text-gray-300">Update your DJ identity without leaving the mixer. Username changes migrate your data safely.</p>
              </div>
              <div class="text-sm px-3 py-1 rounded-full ${viewOnly ? 'bg-purple-500/20 border border-purple-400/40 text-purple-100' : 'bg-cyan-500/20 border border-cyan-400/40 text-cyan-100'}">${viewOnly ? 'View only' : 'Editable'}</div>
            </div>
            ${viewOnly ? `<div class="text-sm text-gray-300 bg-white/5 border border-white/10 rounded-lg px-3 py-2">Viewing ${djVal || usernameVal}'s public profile. Editing is disabled.</div>` : ''}
            <div class="grid gap-4 md:grid-cols-2">
              <div>
                <label class="text-sm text-gray-300">Email</label>
                <div class="px-4 py-3 bg-black/40 border border-gray-700 rounded-lg text-white">${email}</div>
              </div>
              <div>
                <label class="text-sm text-gray-300">Username</label>
                <input id="profileUsername" value="${usernameVal}" ${viewOnly ? 'disabled' : ''} class="w-full px-4 py-3 bg-black/40 border border-cyan-500/30 rounded-lg text-white ${viewOnly?'opacity-60 cursor-not-allowed':''}" />
                <p class="text-xs text-gray-400 mt-1">3‚Äì20 characters, letters/numbers/underscore only. No logout needed.</p>
              </div>
              <div>
                <label class="text-sm text-gray-300">DJ Name</label>
                <input id="profileDjName" value="${djVal}" ${viewOnly ? 'disabled' : ''} class="w-full px-4 py-3 bg-black/40 border border-purple-500/30 rounded-lg text-white ${viewOnly?'opacity-60 cursor-not-allowed':''}" />
                <p class="text-xs text-gray-400 mt-1">Shown in headers and shared views.</p>
              </div>
            </div>
            <div class="flex gap-3 flex-wrap">
              ${viewOnly ? '' : `<button onclick="saveProfileSettings()" class="px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 rounded-lg font-bold">Save Profile</button>`}
              <button onclick="switchView('browser')" class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg">Back to Mixer</button>
              ${viewOnly ? `<button onclick="exitProfileViewMode()" class="px-4 py-2 bg-purple-500/20 hover:bg-purple-500/30 border border-purple-500/40 rounded-lg">Back to My Profile</button>` : ''}
            </div>
            <div id="profileStatus" class="text-sm text-cyan-200"></div>
          </div>

          ${showConnectedAccounts ? `
          <div class="panel space-y-3">
            <div class="flex items-center justify-between flex-wrap gap-2">
              <div>
                <div class="text-lg font-bold text-white">Connected Accounts</div>
                <p class="text-sm text-gray-300">Link Epic to get ready for Epic account login later.</p>
              </div>
            </div>
            <div class="flex items-center justify-between gap-3 flex-wrap bg-white/5 border border-white/10 rounded-lg p-3">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center text-xl">üéÆ</div>
                <div>
                  <div class="font-semibold text-white">Epic Games</div>
                  <div class="text-xs text-gray-300">${epicLinked ? `Linked${epicDisplay ? ` ‚Ä¢ ${epicDisplay}` : ''}` : 'Not linked yet'}</div>
                </div>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-xs font-semibold px-2 py-1 rounded-full ${epicLinked ? 'bg-emerald-500/20 text-emerald-100 border border-emerald-400/40' : 'bg-white/10 text-gray-200 border border-white/20'}">${epicLinked ? 'Linked' : 'Not linked'}</span>
                ${epicLinked ? `<button onclick="unlinkOAuth('epic')" class="px-3 py-2 bg-red-500/20 hover:bg-red-500/30 border border-red-400/50 rounded-lg text-sm">Unlink</button>` : `<button onclick="startOAuth('epic')" class="px-3 py-2 bg-gradient-to-r from-purple-500 to-blue-500 rounded-lg text-sm font-semibold">Link Epic</button>`}
              </div>
            </div>
            <p class="text-xs text-gray-400">Redirects through Epic, then returns here to store a link in your profile. Firebase email/password stays your primary sign-in.</p>
          </div>
          ` : ''}

          <div class="panel space-y-4">
            <div class="flex items-start justify-between gap-3 flex-wrap">
              <div>
                <div class="text-lg font-bold text-white">Owned Songs</div>
                <p class="text-sm text-gray-300">Songs you‚Äôve marked as owned</p>
              </div>
              <div class="text-sm text-cyan-200 font-semibold">${ownedIds.length} / ${songs.length}</div>
            </div>
            <div class="flex flex-col lg:flex-row gap-3 items-stretch lg:items-center">
              <div class="flex-1 flex flex-col gap-2">
                <div class="flex flex-col sm:flex-row gap-2 items-stretch sm:items-center">
                  <input id="friendSearchInput" value="${friendSearchTerm || ''}" placeholder="Search DJ name‚Ä¶" class="flex-1 px-4 py-3 bg-black/40 border border-white/10 rounded-lg text-white" />
                  <button onclick="viewFriendProfile()" class="px-4 py-3 bg-purple-500/40 hover:bg-purple-500/50 border border-purple-400/50 rounded-lg font-semibold">View</button>
                </div>
                <div class="text-xs text-gray-400">Shows their owned songs (read-only)</div>
                ${friendError}
                ${friendList}
              </div>
              <div class="flex-1 flex flex-col gap-2">
                <div class="flex flex-col sm:flex-row gap-2 items-stretch sm:items-center">
                  <input id="ownedSearchInput" value="${profileOwnedSearch || ''}" placeholder="Search owned songs‚Ä¶" class="flex-1 px-4 py-3 bg-black/40 border border-white/10 rounded-lg text-white" />
                  <div class="text-xs text-gray-400 sm:w-40">Live filter by title or artist</div>
                </div>
                ${viewOnly ? `<button onclick="exitProfileViewMode()" class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg">Back to My Profile</button>` : ''}
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              ${ownedCards || ownedEmpty}
            </div>
          </div>
        </div>`;
    }

    function renderAuditView(){
      const auditEl = document.getElementById('auditView');
      if(!auditEl) return;
      if(!isAdmin()){ auditEl.innerHTML = '<div class="panel">Admin only</div>'; return; }
      const total = songs.length;
      const flaggedCount = songs.filter(s=>s.flags && s.flags.length).length;
      const camelotCount = Object.keys(camelotOverridesStore.ids||{}).length;
      const bpmCount = Object.keys(bpmOverridesStore.ids||{}).length;
      const okCount = total - flaggedCount;
      const filterMatches = (track)=>{
        const term = (auditSearch||'').toLowerCase();
        if(term && !(track.title.toLowerCase().includes(term) || track.artist.toLowerCase().includes(term))) return false;
        if(auditFilters.flaggedOnly && !(track.flags&&track.flags.length)) return false;
        if(auditFilters.overriddenOnly && !(track.camelotOverridden||track.bpmOverridden)) return false;
        if(auditFilters.invalidCamelot && !(track.flags||[]).includes('INVALID_CAMELOT')) return false;
        if(auditFilters.modeMismatch && !(track.flags||[]).includes('MODE_MISMATCH')) return false;
        if(auditFilters.bpmOutlier && !(track.flags||[]).includes('BPM_OUTLIER')) return false;
        return true;
      };
        const filtered = songs.filter(filterMatches);
        const rows = filtered.map(t=>{
          const flags = t.flags && t.flags.length ? t.flags.map(f=>`<span class="px-2 py-1 rounded bg-white/10 border border-white/10 text-xs mr-1">${f}</span>`).join('') : '<span class="text-green-300 text-xs">OK</span>';
          const hasOverride = genreOverrides[t.id];
          const genreButton = `<button data-song-id-genre="${t.id}" class="px-2 py-1 ${hasOverride ? 'bg-green-500/30 border-green-500/50' : 'bg-orange-500/30 border-orange-500/50'} border rounded text-xs cursor-pointer hover:border-cyan-400/60" title="Click to edit genre">${t.genre}${hasOverride ? ' ‚úì' : ''}</button>`;
          return `<tr class="border-b border-white/5"><td class="p-2">${t.title}<div class="text-xs text-gray-400">${t.artist}</div></td><td class="p-2">${t.bpm} <div class="text-xs text-gray-400">raw ${t.rawBpm||t.bpm}</div></td><td class="p-2">${t.camelot}<div class="text-xs text-gray-400">derived ${t.derivedCamelot}</div></td><td class="p-2 text-xs text-gray-300">${t.rawKey||'?'} ${t.rawMode||''}</td><td class="p-2">${genreButton}</td><td class="p-2">${flags}</td><td class="p-2 text-xs"><button class="px-2 py-1 bg-purple-500/30 rounded" onclick="openOverrideModal('camelot','${t.id}')">Set Camelot</button><button class="ml-1 px-2 py-1 bg-blue-500/30 rounded" onclick="openOverrideModal('bpm','${t.id}')">Set BPM</button><button class="ml-1 px-2 py-1 bg-red-500/30 rounded" onclick="clearOverrides('${t.id}')">Clear</button></td></tr>`;
        }).join('');

      auditEl.innerHTML = `
        <div class="space-y-4">
          <div class="grid md:grid-cols-5 gap-3">
            <div class="panel p-3"><div class="text-xs text-gray-400">Total tracks</div><div class="text-2xl font-bold">${total}</div></div>
            <div class="panel p-3"><div class="text-xs text-gray-400">OK</div><div class="text-2xl font-bold text-green-300">${okCount}</div></div>
            <div class="panel p-3"><div class="text-xs text-gray-400">Flagged</div><div class="text-2xl font-bold text-amber-300">${flaggedCount}</div></div>
            <div class="panel p-3"><div class="text-xs text-gray-400">Camelot overrides</div><div class="text-2xl font-bold">${camelotCount}</div></div>
            <div class="panel p-3"><div class="text-xs text-gray-400">BPM overrides</div><div class="text-2xl font-bold">${bpmCount}</div></div>
          </div>
          <div class="panel p-3 space-y-3">
            <div class="flex flex-wrap gap-2 items-center">
              <input id="auditSearchInput" value="${auditSearch}" placeholder="Search title or artist" class="flex-1 min-w-[200px] px-3 py-2 bg-black/40 border border-white/10 rounded" />
            </div>
            <div class="flex flex-wrap gap-2 text-xs">
              <button class="px-3 py-1 rounded ${auditFilters.flaggedOnly?'bg-amber-500/40':'bg-white/10'}" onclick="toggleAuditFilter('flaggedOnly')">Show flagged only</button>
              <button class="px-3 py-1 rounded ${auditFilters.overriddenOnly?'bg-amber-500/40':'bg-white/10'}" onclick="toggleAuditFilter('overriddenOnly')">Show overridden only</button>
              <button class="px-3 py-1 rounded ${auditFilters.invalidCamelot?'bg-amber-500/40':'bg-white/10'}" onclick="toggleAuditFilter('invalidCamelot')">Invalid camelot</button>
              <button class="px-3 py-1 rounded ${auditFilters.modeMismatch?'bg-amber-500/40':'bg-white/10'}" onclick="toggleAuditFilter('modeMismatch')">Mode mismatch</button>
              <button class="px-3 py-1 rounded ${auditFilters.bpmOutlier?'bg-amber-500/40':'bg-white/10'}" onclick="toggleAuditFilter('bpmOutlier')">BPM outliers</button>
            </div>
          </div>
          <div class="panel overflow-auto">
            <table class="w-full text-sm">
              <thead class="text-left text-gray-300">
                <tr><th class="p-2">Title</th><th class="p-2">BPM</th><th class="p-2">Camelot</th><th class="p-2">Raw key/mode</th><th class="p-2">Genre</th><th class="p-2">Flags</th><th class="p-2">Actions</th></tr>
              </thead>
              <tbody>${rows}</tbody>
            </table>
          </div>
          <div class="panel text-xs text-gray-300">
            <div class="font-semibold text-white mb-1">Debug</div>
            <div>Firebase enabled: ${firebaseEnabled}</div>
            <div>User key: ${computeUserKey()}</div>
            <div>Songs loaded: ${songs.length}</div>
            <div>Overrides loaded: ${camelotCount} camelot / ${bpmCount} bpm</div>
          </div>
        </div>
      `;
      bindGenreEditors(auditEl);
    }

    function updateBandReferencesLocal(oldUsername,newUsername,newDj){
      const profiles = JSON.parse(localStorage.getItem('userProfiles')||'{}');
      Object.keys(profiles).forEach(key=>{
        const memberList = profiles[key].bandMembers || [];
        const updated = memberList.map(m=> m.username===oldUsername ? { ...m, username:newUsername, djName:newDj } : m);
        profiles[key].bandMembers = updated;
      });
      localStorage.setItem('userProfiles', JSON.stringify(profiles));
      bandMembers = (bandMembers||[]).map(m=> m.username===oldUsername ? { ...m, username:newUsername, djName:newDj } : m);
      currentUser.bandMembers = bandMembers;
    }

    async function migrateUsername(oldUsername,newUsername,newDjName){
      const status = document.getElementById('profileStatus');
      const merged = { ...currentUser, username:newUsername, djName:newDjName, ownedTracks, setlist, setlists:setlist, bandMembers, genreOverrides, preferences: currentUser.preferences || { keyMatchMode, maxSemitoneRange, includeOppositeMode, priorityStrength } };
      if(firestore){
        try{
          const oldRef = firestore.collection('users').doc(oldUsername);
          const newRef = firestore.collection('users').doc(newUsername);
          const snap = await oldRef.get();
          const payload = snap.exists ? { ...snap.data(), username:newUsername, djName:newDjName } : merged;
          await newRef.set(payload, { merge:true });
          try{
            const snapshot = await firestore.collection('users').get();
            const batch = firestore.batch();
            let needsCommit = false;
            snapshot.forEach(doc=>{
              const data = doc.data()||{};
              const members = data.bandMembers || [];
              const updated = members.map(m=> m.username===oldUsername ? { ...m, username:newUsername, djName:newDjName } : m);
              const changed = JSON.stringify(updated)!==JSON.stringify(members);
              if(changed){ batch.set(doc.ref,{ bandMembers: updated },{merge:true}); needsCommit=true; }
            });
            if(needsCommit) await batch.commit();
          }catch(err){ console.warn('band member update failed', err); }
          await oldRef.delete().catch(()=>{});
        }catch(e){ if(status) status.textContent = 'Error migrating in Firestore: ' + (e.message||e); throw e; }
      }

      const profiles = JSON.parse(localStorage.getItem('userProfiles')||'{}');
      if(profiles[oldUsername]){
        profiles[newUsername] = { ...profiles[oldUsername], ...merged, username:newUsername, djName:newDjName };
        delete profiles[oldUsername];
      } else {
        profiles[newUsername] = merged;
      }
      localStorage.setItem('userProfiles', JSON.stringify(profiles));
      updateBandReferencesLocal(oldUsername,newUsername,newDjName);
      currentUser = merged;
      refreshDraftProfileFromCurrentUser();
      localStorage.setItem('currentUser', newUsername);
      await persistCurrentUserProfile();
    }

    async function saveProfileSettings(){
      if(viewingProfile){ const status = document.getElementById('profileStatus'); if(status) status.textContent = 'View-only mode: cannot save this profile.'; return; }
      if(!currentUser) return;
      const status = document.getElementById('profileStatus');
      const newUsername = (document.getElementById('profileUsername')?.value || '').trim();
      const newDjName = (document.getElementById('profileDjName')?.value || '').trim() || newUsername;
      if(!usernamePattern.test(newUsername)){
        if(status) status.textContent = 'Username must be 3-20 chars, letters/numbers/underscore only';
        alert('Username must be 3-20 chars, letters/numbers/underscore only');
        return;
      }
      draftProfile = draftProfile || cloneProfile(currentUser) || {};
      draftProfile.username = newUsername;
      draftProfile.djName = newDjName;
      const usernameChanged = newUsername !== currentUser.username;
      const djChanged = newDjName !== currentUser.djName;
      try{
        if(usernameChanged){
          if(status) status.textContent = 'Migrating profile...';
          await migrateUsername(currentUser.username,newUsername,newDjName);
        } else {
          if(status) status.textContent = 'Saving profile...';
          currentUser = { ...currentUser, ...draftProfile, username:newUsername, djName:newDjName };
          if(djChanged) updateBandReferencesLocal(currentUser.username,currentUser.username,newDjName);
          await persistCurrentUserProfile();
        }
        render(); setupEventListeners();
        const statusEl = document.getElementById('profileStatus');
        if(statusEl) statusEl.textContent = 'Saved ‚úÖ';
      }catch(e){ const statusEl = document.getElementById('profileStatus'); if(statusEl) statusEl.textContent = 'Save failed ‚ùå: ' + (e.message||e); console.error('[profile] save failed', e); }
    }


function renderCommunityStat(id, label, icon, value, caption=''){
  return `<div class="flex items-center justify-between px-3 py-2 rounded-lg border border-white/10 bg-white/5">
    <div class="flex items-center gap-2">
      <span>${icon}</span>
      <div class="flex flex-col leading-tight">
        <span class="text-[10px] uppercase tracking-wide text-gray-300">${label}</span>
        <span class="text-sm font-bold text-white" data-community-stat="${id}">${formatStatValue(value)}</span>
        <span class="text-[11px] text-cyan-100/80" data-community-stat-meta="${id}">${caption || formatCommunityMeta(id)}</span>
      </div>
    </div>
  </div>`;
}

function render(){
  logEvent('ui_render', { view });
  if(view === 'audit' && !isAdmin()){
    alert('Admin only');
    view = 'browser';
  }
  if(!isAdmin() && adminMenuOpen){
    adminMenuOpen = false;
  }
  syncAdminGlobals();
  const displayTracks = viewingProfile ? viewingProfile.ownedTracks || [] : ownedTracks;
  const ownedCount = displayTracks.length;
  const networkBadge = `<span data-network-badge class="${isOffline ? 'inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold bg-red-600/30 border border-red-400/60 text-red-100' : 'inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold bg-emerald-600/30 border border-emerald-400/60 text-emerald-100'}">${isOffline ? 'Offline' : 'Online'}</span>`;
  const trackSourceLabel = trackSource === 'cache' ? 'Cached tracks' : trackSource === 'fallback' ? 'Sample tracks' : 'Live tracks';
  const trackSourceBadge = `<span class="inline-flex items-center gap-1 px-3 py-1 rounded-full text-xs font-semibold bg-white/10 border border-white/20 text-cyan-100">üéµ ${trackSourceLabel}</span>`;
  const adminBadge = isAdmin() ? `<span class="ml-2 px-2 py-1 text-xs rounded border border-cyan-400/40 text-cyan-100 bg-white/5">üõ° Admin</span>` : '';
  const communityStatsRow = `
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 mt-2 text-xs">
      ${renderCommunityStat('totalDjs','TOTAL DJS','üéõÔ∏è', communityStats.totalDjs)}
    </div>`;
  const regressionBanner = (isAdmin() && regressionWarnings.length) ? `<div class="mt-2 p-3 rounded-lg border border-amber-400/40 bg-amber-500/10 text-amber-100 text-sm">Regression alerts: ${regressionWarnings.map(r=>`${r.id}‚Üí${r.expectedCamelot}`).join(', ')}</div>` : '';
  const selectedPanel = `
    <div class="panel ${selectedSong ? 'selected-panel' : ''} space-y-3">
      <div class="flex items-center justify-between">
        <div class="font-bold text-white">Selection</div>
        <span class="text-xs text-cyan-100">${selectedSong ? 'Pinned track' : 'No track selected'}</span>
      </div>
      <div class="flex items-start gap-3">
        <div class="w-12 h-12 rounded-lg flex items-center justify-center text-lg font-bold" style="background:${selectedSong ? (camelotColors[selectedSong.camelot] || '#0ea5e9') : 'rgba(255,255,255,0.08)'};color:#fff;">${selectedSong ? selectedSong.camelot : '‚Äî'}</div>
        <div class="flex-1">
          <div class="font-bold text-white">${selectedSong ? selectedSong.title : 'Select a track to pin it'}</div>
          <div class="text-sm text-gray-300">${selectedSong ? selectedSong.artist : 'Songs stay visible while you filter.'}</div>
          <div class="text-xs text-cyan-100 font-semibold mt-1">${selectedSong ? `BPM: ${selectedSong.bpm} ‚Ä¢ Camelot: ${selectedSong.camelot}` : 'Click any card or Select to choose.'}</div>
        </div>
      </div>
      <div class="flex flex-wrap gap-2">
        <button id="panelClearSelectionBtn" onclick="clearSelection()" class="px-3 py-2 bg-white/10 hover:bg-white/20 border border-cyan-400/60 rounded-lg font-semibold text-cyan-100" ${selectedSong ? '' : 'disabled style="opacity:0.55;cursor:not-allowed;"'}>Clear Selection</button>
        <button id="panelClearSearchBtn" onclick="clearSearch()" class="px-3 py-2 bg-white/10 hover:bg-white/20 border border-white/20 rounded-lg font-semibold text-white" ${searchTerm ? '' : 'disabled style="opacity:0.55;cursor:not-allowed;"'}>Clear Search</button>
        <button id="panelDisableMixableBtn" onclick="disableMixable()" class="px-3 py-2 rounded-lg font-semibold border ${showMixableOnly?'border-cyan-300 bg-cyan-500/20 text-cyan-100':'border-white/20 bg-white/5 text-gray-300'}" ${showMixableOnly ? '' : 'disabled style="opacity:0.55;cursor:not-allowed;"'}>${showMixableOnly ? 'Disable Mixable' : 'Mixable Off'}</button>
      </div>
    </div>`;
  const signedLabel = viewingProfile ? `Viewing ${viewingProfile.djName || viewingProfile.username || 'Profile'}` : `Signed in as ${currentUser ? currentUser.djName : 'Guest'}`;
  const authButtonLabel = firebaseAuth?.currentUser ? 'Logout' : 'Sign In';
  const authButtonAction = firebaseAuth?.currentUser ? 'logoutUser()' : 'showLoginScreen()';
  document.getElementById('app').innerHTML = `
    <div class="min-h-screen">
      <header class="bg-black/70 backdrop-blur-xl border-b border-cyan-500/30 sticky top-0 z-50 shadow-lg">
        <div class="max-w-[1400px] mx-auto px-4 py-4 flex flex-wrap items-center justify-between gap-4">
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 bg-gradient-to-br from-pink-500 via-purple-500 to-cyan-500 rounded-lg flex items-center justify-center text-2xl vinyl-spin">üéµ</div>
            <div>
              <h1 class="text-2xl font-bold text-white graffiti-text">${BRAND.APP_NAME.toUpperCase()}</h1>
              <div class="flex items-center flex-wrap gap-2 mt-1">
                <p id="ownedCount" class="text-xs text-cyan-300 font-semibold">Owned: ${ownedCount}/${songs.length}</p>
                ${networkBadge}
                ${trackSourceBadge}
              </div>
              ${communityStatsRow}
            </div>
          </div>
          <div class="flex items-center gap-3 flex-wrap justify-end">
            <div class="text-sm text-gray-200">${signedLabel}${adminBadge}</div>
            ${viewingProfile?`<button onclick="exitProfileViewMode()" class="px-3 py-2 bg-purple-500/20 hover:bg-purple-500/30 border border-purple-500/40 rounded-lg text-purple-100 text-sm">Back to my profile</button>`:''}
            ${(!viewingProfile && isAdmin())?`<div class="relative"><button id="adminToolsBtn" aria-haspopup="true" aria-expanded="${adminMenuOpen}" class="px-3 py-2 bg-cyan-500/20 hover:bg-cyan-500/30 border border-cyan-400/50 rounded-lg text-cyan-100 text-sm flex items-center gap-2" style="pointer-events:auto;cursor:pointer;">üõ†Ô∏è Admin Tools</button>${adminMenuOpen?`<div id="adminToolsMenu" role="menu" class="admin-tools-menu absolute right-0 mt-2 w-56 bg-black/90 border border-cyan-400/30 rounded-lg shadow-xl ring-1 ring-cyan-400/30 p-2 space-y-2" style="z-index:6000;pointer-events:auto;">
                  <button id="adminMenuAudit" role="menuitem" class="w-full text-left px-3 py-2 rounded-md bg-white/5 hover:bg-cyan-500/20 border border-white/10 text-sm">Data Audit (Key/BPM)</button>
                </div>`:''}</div>`:''}
            <button onclick="openProfileView()" class="px-3 py-2 bg-purple-500/20 hover:bg-purple-500/30 border border-purple-500/50 rounded-lg text-purple-200 text-sm">Profile</button>
            <button onclick="openHelp()" class="px-3 py-2 bg-white/6 hover:bg-white/12 border border-cyan-500/20 rounded-lg text-cyan-200 text-sm">‚ùì Help</button>
            <button onclick="${authButtonAction}" class="px-3 py-2 bg-red-500/20 hover:bg-red-500/30 border border-red-500/50 rounded-lg text-red-300 text-sm">${authButtonLabel}</button>
          </div>
        </div>
      </header>

      <main class="max-w-[1400px] mx-auto px-4 py-6 pb-20 space-y-4">
        <div class="flex items-center justify-between gap-3 flex-wrap">
          <div class="flex gap-2 flex-wrap">
            <button id="browserBtn" class="px-4 py-2 rounded-lg font-medium transition ${view==='browser'?'bg-gradient-to-r from-purple-500 to-pink-500':'bg-white/10 hover:bg-white/20'}">Browse</button>
            <button id="setlistBtn" class="px-4 py-2 rounded-lg font-medium transition ${view==='setlist'?'bg-gradient-to-r from-purple-500 to-pink-500':'bg-white/10 hover:bg-white/20'}">Setlist (<span id="setlistCount">${setlist.length}</span>)</button>
            <button id="profileBtn" class="px-4 py-2 rounded-lg font-medium transition ${view==='profile'?'bg-gradient-to-r from-indigo-500 to-blue-500':'bg-white/10 hover:bg-white/20'}">Profile</button>
          </div>
          ${view==='browser'?`<div class="text-sm text-cyan-200 font-semibold">Selected: ${selectedSong ? selectedSong.title : 'None'}</div>`:''}
        </div>
        <div class="flex items-center gap-2 flex-wrap text-sm text-cyan-100">
          ${networkBadge}
          ${trackSourceBadge}
          <span class="text-xs text-gray-300">Offline browsing pulls your last cached tracks.</span>
        </div>

        ${regressionBanner}
        <div id="browserView" style="display:${view==='browser'?'block':'none'}">
          <div class="grid lg:grid-cols-[350px,1fr] gap-4 items-start">
            <div class="space-y-4">
              <div class="panel space-y-3">
                <div class="flex items-center justify-between">
                  <div class="font-bold text-white">Controls</div>
                  <span class="text-xs text-gray-300">${viewingProfile ? 'Shared profile (view only)' : 'Your library'}</span>
                </div>
                <div class="relative">
                  <input type="text" id="searchInput" value="${searchTerm || ''}" placeholder="üîç Search songs" class="w-full px-4 py-3 pr-12 bg-black/40 backdrop-blur-sm border border-cyan-500/30 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500"/>
                  <button id="clearSearchBtn" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white transition text-xl" style="display:none;">‚úï</button>
                </div>
                <div class="flex flex-wrap gap-2">
                  <button id="mixableFilterBtn" class="px-3 py-2 rounded-lg font-medium transition ${showMixableOnly?'bg-gradient-to-r from-blue-500 to-cyan-500':'bg-white/10 hover:bg-white/20'}">${showMixableOnly? 'üéß Mixable Only' : 'Show Mixable'}</button>
                  <button id="ownedFilterBtn" class="px-3 py-2 rounded-lg font-medium transition ${showOwnedOnly?'bg-gradient-to-r from-green-500 to-emerald-500':'bg-white/10 hover:bg-white/20'}">${showOwnedOnly? '‚úì Owned Only' : 'Show All'}</button>
                  <button id="controlClearSelectionBtn" onclick="clearSelection()" class="px-3 py-2 bg-white/10 hover:bg-white/20 border border-cyan-400/60 rounded-lg font-semibold text-cyan-100" ${selectedSong ? '' : 'disabled style="opacity:0.55;cursor:not-allowed;"'}>Clear Selection</button>
                </div>
                ${!viewingProfile?`<div class="flex flex-wrap gap-2">
                  <button id="markAllBtn" class="px-3 py-2 bg-white/10 hover:bg-white/20 rounded-lg">Mark All Owned</button>
                  <button id="clearAllBtn" class="px-3 py-2 bg-white/10 hover:bg-white/20 rounded-lg">Clear All</button>
                </div>`:''}
                <div class="bg-black/40 border border-white/10 rounded-lg p-3 space-y-3">
                  <div class="flex items-center justify-between flex-wrap gap-2">
                    <div class="text-sm font-semibold text-white">Key Mode</div>
                    <span class="text-[11px] text-gray-400">Harmonic preference</span>
                  </div>
                  <div class="grid sm:grid-cols-2 gap-3">
                    <label class="flex flex-col gap-1 text-xs text-gray-300">
                      <span class="font-semibold text-white">Key Matching</span>
                      <select id="keyMatchModeSelect" class="px-3 py-2 bg-white/5 border border-white/10 rounded-lg text-sm text-white">
                        <option value="camelot">Camelot (DJ Wheel)</option>
                        <option value="semitone">Key (Same Mode ¬±0‚Äì6)</option>
                      </select>
                    </label>
                    <label class="flex flex-col gap-1 text-xs text-gray-300">
                      <span class="font-semibold text-white">¬± Range</span>
                      <input id="semitoneRangeInput" type="range" min="1" max="6" step="1" value="${maxSemitoneRange}" class="accent-cyan-400" />
                      <div id="semitoneRangeValue" class="text-[11px] text-cyan-200 font-semibold">¬±${maxSemitoneRange} semitones</div>
                    </label>
                  </div>
                  <div class="flex items-center justify-between gap-2 flex-wrap text-sm text-gray-200">
                    <div>
                      <div class="font-semibold text-white">Include Opposite Mode</div>
                      <div class="text-[11px] text-gray-400">Opposite mode ranks after all same-mode matches</div>
                    </div>
                    <label class="inline-flex items-center gap-2 text-xs">
                      <input id="includeOppositeModeToggle" type="checkbox" class="w-5 h-5 accent-cyan-400" ${includeOppositeMode ? 'checked' : ''} />
                      <span>Include</span>
                    </label>
                  </div>
                  <p class="text-[11px] text-gray-400">Semitone mode prioritizes the most natural-sounding blends; Camelot is better for DJ-style key transitions.</p>
                </div>
              </div>
              <div class="panel space-y-3">
                <div class="flex items-center justify-between">
                  <div class="font-bold text-white">Mix Logic</div>
                  <span class="text-xs text-gray-300">Priority selector</span>
                </div>
                <div class="flex flex-wrap gap-2">
                  <button onclick="setSortMode('bpm')" class="px-3 py-2 rounded-lg text-sm font-semibold border ${sortMode==='bpm'?'border-cyan-400 bg-cyan-500/20 text-cyan-100':'border-white/10 bg-white/5 text-gray-200'}">Tempo (BPM)</button>
                  <button onclick="setSortMode('camelot')" class="px-3 py-2 rounded-lg text-sm font-semibold border ${sortMode==='camelot'?'border-pink-400 bg-pink-500/20 text-pink-100':'border-white/10 bg-white/5 text-gray-200'}">Camelot</button>
                  <button onclick="setSortMode('genre')" class="px-3 py-2 rounded-lg text-sm font-semibold border ${sortMode==='genre'?'border-emerald-400 bg-emerald-500/20 text-emerald-100':'border-white/10 bg-white/5 text-gray-200'}">Genre</button>
                </div>
                <div class="flex items-center gap-2">
                  <div class="text-xs text-gray-300 font-semibold">Priority Strength</div>
                  <div class="flex items-center gap-2 flex-1">
                    <span class="text-[11px] text-gray-500">Low</span>
                    <input type="range" min="0" max="2" step="1" value="${priorityStrength==='low'?0:priorityStrength==='high'?2:1}" class="flex-1 accent-cyan-400" oninput="setPriorityStrength(this.value)" aria-label="Priority Strength" />
                    <span class="text-[11px] text-gray-500">High</span>
                  </div>
                  <div class="text-[11px] px-2 py-1 rounded bg-white/10 border border-white/10 text-cyan-200 font-semibold">${priorityStrength==='low'?'Low':priorityStrength==='high'?'High':'Medium'}</div>
                </div>
              </div>

              ${selectedPanel}

              <div class="panel space-y-2">
                <div class="flex items-center justify-between">
                  <div class="font-bold text-white">Sandbox (Drag tracks here)</div>
                  <div class="flex items-center gap-2 text-xs text-gray-300">
                    <span>Limit 4</span>
                    <button onclick="clearSandbox()" class="px-2 py-1 bg-white/10 hover:bg-white/20 rounded border border-white/10">Clear</button>
                  </div>
                </div>
                <div id="sandbox" class="sandbox-drop bg-black/40"></div>
                <div id="sandboxInfo" class="small-muted"></div>
              </div>
            </div>

            <div class="space-y-4">
              <div class="flex items-center justify-between flex-wrap gap-3">
                <div class="text-xl font-bold text-white">Song Browser</div>
                <div class="text-sm text-cyan-200 font-semibold">Selected: ${selectedSong ? selectedSong.title : 'None'}</div>
              </div>
              <div id="songList" class="space-y-4"></div>
            </div>
          </div>
        </div>

        <div id="setlistView" style="display:${view==='setlist'?'block':'none'}">
          <div id="setlistContent"></div>
        </div>
        <div id="profileView" style="display:${view==='profile'?'block':'none'}"></div>
        <div id="auditView" style="display:${view==='audit'?'block':'none'}"></div>
      </main>
    </div>
  `;
  if(view==='browser'){ renderSongList(); sandboxInit(); renderSandbox(); } else if(view==='setlist'){ renderSetlist(); } else if(view==='audit'){ renderAuditView(); } else { renderProfile(); }
  syncCommunityStatsUI();
}


    // ------------------ Genre context menu ------------------------
    function showGenreMenu(songId,event){
      if(!isAdmin()) { alert('üîí Admin only'); return; }
      const existing = document.getElementById('genreContextMenu'); if(existing) existing.remove();
      const menu=document.createElement('div'); menu.id='genreContextMenu'; menu.className='context-menu';
      const rect = event.target.getBoundingClientRect();
      let left=rect.left, top=rect.bottom+5;
      if(left+220>window.innerWidth) left=rect.right-220;
      if(top+300>window.innerHeight) top=rect.top-305;
      menu.style.left = left+'px'; menu.style.top = top+'px';
      const genres = Object.keys(genreMap).concat(['Other']);
      menu.innerHTML = `<div style="padding:8px 12px;color:#00d9ff;font-weight:bold;border-bottom:1px solid rgba(0,217,255,0.3);margin-bottom:6px;">Select Genre:</div>`;
      genres.forEach(g=>{
        const btn=document.createElement('button'); btn.textContent=g; btn.style.display='block'; btn.style.width='100%'; btn.style.padding='8px 12px'; btn.style.background='transparent'; btn.style.border='none'; btn.style.textAlign='left'; btn.style.color='#e6f7ff'; btn.style.cursor='pointer';
        btn.addEventListener('click',async()=>{ await setGenreOverride(songId,g); menu.remove(); });
        menu.appendChild(btn);
      });
      document.body.appendChild(menu);
      setTimeout(()=>{ const closeMenu=(e)=>{ if(!menu.contains(e.target)){ menu.remove(); document.removeEventListener('click', closeMenu); } }; document.addEventListener('click', closeMenu); },100);
    }

    function bindGenreEditors(scope=document){
      if(!isAdmin()) return;
      scope.querySelectorAll('[data-song-id-genre]').forEach(btn=>{
        const handler = (e)=>{ e.preventDefault(); e.stopPropagation(); const songId = btn.getAttribute('data-song-id-genre'); showGenreMenu(songId, e); };
        btn.onclick = handler;
        btn.oncontextmenu = handler;
      });
    }

    const setGenreOverride = async (songId,newGenre) => {
      if(!isAdmin()) return alert('Admin only');
      if(!currentUser && firebaseAuth?.currentUser){
        currentUser = normalizeProfileShape({
          username: firebaseAuth.currentUser.email?.split('@')[0] || firebaseAuth.currentUser.uid || 'admin',
          djName: firebaseAuth.currentUser.displayName || firebaseAuth.currentUser.email || 'Admin',
          ownedTracks,
          genreOverrides
        }, firebaseAuth.currentUser.uid || firebaseAuth.currentUser.email);
        refreshDraftProfileFromCurrentUser();
      }
      if(!currentUser) return alert('Sign in required for admin edits');
      genreOverrides[songId] = newGenre;
      const song = songs.find(s=>s.id===songId);
      if(song){
        song.genre = newGenre;
        refreshSongOverrides(song);
      }
      persistNamespacedState();
      await persistCurrentUserProfile();
      refreshRegressionWarnings();
      renderAuditView();
      renderSongList();
      const genreTag = document.querySelector(`[data-genre-tag="${songId}"]`);
      if(genreTag){ genreTag.textContent = newGenre + ' ‚úì'; genreTag.classList.add('animate-pulse'); setTimeout(()=>genreTag.classList.remove('animate-pulse'),1000); }
    };

    function toggleAuditFilter(key){ auditFilters[key] = !auditFilters[key]; renderAuditView(); }
    function closeOverrideModal(){ const m=document.getElementById('overrideModal'); if(m) m.remove(); }
    const openOverrideModal = (type, trackId)=>{
      if(!isAdmin()) return alert('Admin only');
      const track = songs.find(s=>s.id===trackId); if(!track) return;
      closeOverrideModal();
      const modal=document.createElement('div'); modal.id='overrideModal'; modal.className='fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50';
      const options = Array.from({length:12},(_,i)=>`${i+1}A`).concat(Array.from({length:12},(_,i)=>`${i+1}B`));
      const camelotSelect = `<select id="camelotSelect" class="w-full px-3 py-2 bg-black/60 border border-white/20 rounded">${options.map(o=>`<option value="${o}" ${track.camelot===o?'selected':''}>${o}</option>`).join('')}</select>`;
      const bpmInput = `<input id="bpmInput" type="number" value="${Math.round(track.bpm)}" class="w-full px-3 py-2 bg-black/60 border border-white/20 rounded"/>`;
      const actionCall = type==='camelot' ? `setCamelotOverride('${trackId}', document.getElementById('camelotSelect').value)` : `setBpmOverride('${trackId}', document.getElementById('bpmInput').value)`;
      modal.innerHTML = `<div class="panel max-w-md w-full">
        <div class="flex items-center justify-between mb-3"><div class="font-bold">Set ${type==='camelot'?'Camelot':'BPM'} for ${track.title}</div><button onclick="closeOverrideModal()">‚úï</button></div>
        <div class="space-y-3">
          ${type==='camelot'?camelotSelect:bpmInput}
          <div class="flex gap-2 justify-end">
            <button class="px-3 py-2 bg-white/10 rounded" onclick="closeOverrideModal()">Cancel</button>
            <button class="px-3 py-2 bg-blue-500/60 rounded" onclick="${actionCall}; closeOverrideModal();">Save</button>
          </div>
        </div>
      </div>`;
      document.body.appendChild(modal);
    };

    function syncAdminGlobals(){
      const adminActive = isAdmin();
      const adminFunctions = { toggleAdminTools, openOverrideModal, clearOverrides, setCamelotOverride, setBpmOverride, setGenreOverride };
      Object.entries(adminFunctions).forEach(([name, fn])=>{
        if(adminActive){ window[name] = fn; }
        else {
          try { delete window[name]; } catch(_) { window[name] = undefined; }
        }
      });
    }

    // ------------------ Event listeners and interactions --------------
    let appDelegatesBound = false;
    function bindAppDelegates(){
      if(appDelegatesBound) return;
      const app = document.getElementById('app');
      if(!app) return;
      app.addEventListener('click', (e)=>{
        const addSet = e.target.closest('.addSetBtn');
        if(addSet){ e.preventDefault(); addToSetlist(addSet.dataset.id); return; }
        const viewBtn = e.target.closest('#browserBtn, #setlistBtn, #profileBtn, #auditBtn');
        if(viewBtn){
          const viewMap = { browserBtn:'browser', setlistBtn:'setlist', profileBtn:'profile', auditBtn:'audit' };
          const targetView = viewMap[viewBtn.id];
          if(targetView){ switchView(targetView); }
        }
        if(e.target.closest('#mixableFilterBtn')){ toggleMixableFilter(); }
        if(e.target.closest('#ownedFilterBtn')){ toggleOwnedFilter(); }
        if(e.target.closest('#clearSearchBtn') || e.target.closest('#panelClearSearchBtn')){ clearSearch(); }
        if(e.target.closest('#markAllBtn') && !viewingProfile){ markAllOwned(); }
        if(e.target.closest('#clearAllBtn') && !viewingProfile){ clearAllOwned(); }
        const genreBtn = e.target.closest('[data-genre-tag]');
        if(genreBtn && isAdmin()){
          const newGenre = prompt('Set genre override', genreBtn.textContent.replace(' ‚úì','').trim());
          if(newGenre){ setGenreOverride(genreBtn.dataset.genreTag || genreBtn.getAttribute('data-genre-tag'), newGenre); }
        }
      });
      app.addEventListener('input', (e)=>{
        if(e.target.id === 'searchInput'){
          searchTerm = e.target.value;
          const clearSearchBtn = document.getElementById('clearSearchBtn');
          if(clearSearchBtn) clearSearchBtn.style.display = searchTerm ? 'block' : 'none';
          const panelClear = document.getElementById('panelClearSearchBtn');
          if(panelClear){ panelClear.disabled = !searchTerm; panelClear.style.opacity = searchTerm ? '1' : '0.55'; panelClear.style.cursor = searchTerm ? 'pointer' : 'not-allowed'; }
          resetPagination();
          renderSongList();
        }
        if(e.target.id === 'auditSearchInput'){ auditSearch = e.target.value; renderAuditView(); }
        if(e.target.id === 'ownedSearchInput'){ profileOwnedSearch = e.target.value; renderProfile(); }
        if(e.target.id === 'profileUsername' && !viewingProfile){ draftProfile = draftProfile || cloneProfile(currentUser) || {}; draftProfile.username = e.target.value; }
        if(e.target.id === 'profileDjName' && !viewingProfile){ draftProfile = draftProfile || cloneProfile(currentUser) || {}; draftProfile.djName = e.target.value; }
        if(e.target.id === 'semitoneRangeInput'){ setMaxSemitoneRange(e.target.value); }
      });
      app.addEventListener('change', (e)=>{
        if(e.target.id === 'keyMatchModeSelect'){ setKeyMatchMode(e.target.value); }
        if(e.target.id === 'includeOppositeModeToggle'){ toggleIncludeOppositeMode(e.target.checked); }
      });
      app.addEventListener('keydown', (e)=>{
        if(e.target.id === 'friendSearchInput' && e.key === 'Enter'){ e.preventDefault(); viewFriendProfile(); }
      });
      appDelegatesBound = true;
    }

    function setupEventListeners(){
      bindAppDelegates();
      const searchInput = document.getElementById('searchInput');
      if(searchInput){
        const clearSearchBtn = document.getElementById('clearSearchBtn');
        if(clearSearchBtn){ clearSearchBtn.style.display = searchTerm ? 'block' : 'none'; }
      }
      const keyModeSelect = document.getElementById('keyMatchModeSelect'); if(keyModeSelect){ keyModeSelect.value = keyMatchMode; }
      const semitoneRangeInput = document.getElementById('semitoneRangeInput'); if(semitoneRangeInput){ semitoneRangeInput.value = maxSemitoneRange; }
      const includeOppToggle = document.getElementById('includeOppositeModeToggle'); if(includeOppToggle){ includeOppToggle.checked = includeOppositeMode; }
      if(isAdmin()){
        const adminBtn = document.getElementById('adminToolsBtn');
        if(adminBtn){
          adminBtn.onclick = (e)=>{ e.stopPropagation(); console.debug('[admin] Admin Tools clicked'); window.toggleAdminTools(); };
          console.debug('[admin] Admin Tools button bound');
        } else {
          console.debug('[admin] Admin Tools button missing after render');
        }
        const adminMenu = document.getElementById('adminToolsMenu');
        if(adminMenu){
          adminMenu.style.pointerEvents = 'auto';
          const auditBtn = document.getElementById('adminMenuAudit');
          if(auditBtn) auditBtn.onclick = (e)=>{ e.stopPropagation(); openAuditFromMenu(); };
        }
      }
    }

    window.setPriorityStrength = (val) => {
      const map = { '0':'low', '1':'medium', '2':'high', low:'low', medium:'medium', high:'high' };
      priorityStrength = map[val] || 'medium';
      persistKeyMatchSettings();
      render();
      setupEventListeners();
    };

    function persistKeyMatchSettings(){
      localStorage.setItem('jamMixer.keyMatchMode', keyMatchMode);
      localStorage.setItem('jamMixer.maxSemitoneRange', String(maxSemitoneRange));
      localStorage.setItem('jamMixer.includeOppositeMode', includeOppositeMode ? 'true' : 'false');
      localStorage.setItem('jamMixer.priorityStrength', priorityStrength);
      syncPreferencesIntoProfile();
      if(!isPersistingProfile) schedulePreferencePersist();
    }
    window.setKeyMatchMode = (mode) => {
      keyMatchMode = mode === 'semitone' ? 'semitone' : 'camelot';
      persistKeyMatchSettings();
      resetPagination();
      render();
      setupEventListeners();
    };
    window.setMaxSemitoneRange = (val) => {
      const num = Math.min(6, Math.max(1, Number(val) || 6));
      maxSemitoneRange = num;
      persistKeyMatchSettings();
      const rangeDisplay = document.getElementById('semitoneRangeValue');
      if(rangeDisplay){ rangeDisplay.textContent = `¬±${num} semitones`; }
      renderSongList();
    };
    window.toggleIncludeOppositeMode = (checked) => {
      includeOppositeMode = !!checked;
      persistKeyMatchSettings();
      renderSongList();
    };

    window.setSortMode = (mode) => {
      sortMode = mode;
      resetPagination();
      render();
      setupEventListeners();
    };

    window.setPageSize = (val) => {
      const nextSize = Number(val);
      if(!PAGE_SIZE_OPTIONS.includes(nextSize)) return;
      if(nextSize === pageSize) return;
      pageSize = nextSize;
      resetPagination();
      persistPaginationState();
      renderSongList();
    };

    window.selectSong = (id) => {
      selectedSong = songs.find(s=>s.id===id);
      resetPagination();
      render();
      setupEventListeners();
    };

    window.clearSelection = (event) => {
      if(event){ event.preventDefault(); event.stopPropagation(); }
      selectedSong = null;
      showMixableOnly = false;
      render();
      setupEventListeners();
    };

    window.disableMixable = () => {
      if(!showMixableOnly) return;
      showMixableOnly = false;
      render();
      setupEventListeners();
    };

    window.clearSearch = () => {
      searchTerm = '';
      const searchInput = document.getElementById('searchInput');
      const clearSearchBtn = document.getElementById('clearSearchBtn');
      if(searchInput) searchInput.value = '';
      if(clearSearchBtn) clearSearchBtn.style.display = 'none';
      const panelClearBtn = document.getElementById('panelClearSearchBtn');
      if(panelClearBtn){ panelClearBtn.disabled = true; panelClearBtn.style.opacity = '0.55'; panelClearBtn.style.cursor = 'not-allowed'; }
      resetPagination();
      renderSongList();
    };

    window.clearFilters = () => {
      searchTerm = '';
      showOwnedOnly = false;
      showMixableOnly = false;
      selectedGenre = 'All';
      resetPagination();
      render();
      setupEventListeners();
    };

    window.openProfileView = () => {
      view = 'profile';
      render();
      setupEventListeners();
      renderProfile();
    };

    window.toggleOwned = async (id) => {
      if(viewingProfile){ alert("You can't edit other people's collections!"); return; }
      if(ownedTracks.includes(id)) ownedTracks = ownedTracks.filter(t=>t!==id); else ownedTracks.push(id);
      persistNamespacedState();
      try { await persistCurrentUserProfile(); } catch(err){ console.error('[profile] save failed after toggleOwned', err); const status=document.getElementById('profileStatus'); if(status) status.textContent='Save failed ‚ùå: '+(err.message||err); }
      updateOwnedCount();
      renderSongList();
    };

    window.exitProfileViewMode = () => {
      clearViewedProfile();
      refreshDraftProfileFromCurrentUser();
      render();
      setupEventListeners();
    };

    window.addToSetlist = (id) => {
      const song = songs.find(s=>s.id===id); if(!song) return;
      if(!setlist.find(s=>s.id===id)){
        setlist.push(song);
        persistNamespacedState();
        const countEl = document.getElementById('setlistCount'); if(countEl) countEl.textContent = setlist.length;
        if(view==='setlist') renderSetlist(); else { if(countEl){ countEl.classList.add('animate-pulse'); setTimeout(()=>countEl.classList.remove('animate-pulse'),800); } }
      }
    };

    window.removeFromSetlist = (id) => {
      setlist = setlist.filter(s=>s.id!==id);
      persistNamespacedState();
      renderSetlist();
      const countEl = document.getElementById('setlistCount'); if(countEl) countEl.textContent = setlist.length;
    };

    window.switchView = (newView) => {
      if(newView === 'audit' && !isAdmin()){
        alert('Admin only');
        newView = 'browser';
      }
      adminMenuOpen = false;
      logEvent('view_switch', { from: view, to: newView });
      view = newView;
      const browserView = document.getElementById('browserView');
      const setlistView = document.getElementById('setlistView');
      const profileView = document.getElementById('profileView');
      const auditViewEl = document.getElementById('auditView');
      if(browserView) browserView.style.display = view==='browser' ? 'block' : 'none';
      if(setlistView) setlistView.style.display = view==='setlist' ? 'block' : 'none';
      if(profileView) profileView.style.display = view==='profile' ? 'block' : 'none';
      if(auditViewEl) auditViewEl.style.display = view==='audit' ? 'block' : 'none';
      const browserBtn = document.getElementById('browserBtn'); const setlistBtn = document.getElementById('setlistBtn'); const profileBtn = document.getElementById('profileBtn'); const auditBtn = document.getElementById('auditBtn');
      if(browserBtn) browserBtn.className = `px-4 py-2 rounded-lg font-medium transition ${view==='browser'?'bg-gradient-to-r from-purple-500 to-pink-500':'bg-white/10 hover:bg-white/20'}`;
      if(setlistBtn) setlistBtn.className = `px-4 py-2 rounded-lg font-medium transition ${view==='setlist'?'bg-gradient-to-r from-purple-500 to-pink-500':'bg-white/10 hover:bg-white/20'}`;
      if(profileBtn) profileBtn.className = `px-4 py-2 rounded-lg font-medium transition ${view==='profile'?'bg-gradient-to-r from-indigo-500 to-blue-500':'bg-white/10 hover:bg-white/20'}`;
      if(auditBtn) auditBtn.className = `px-4 py-2 rounded-lg font-medium transition ${view==='audit'?'bg-gradient-to-r from-amber-500 to-yellow-500':'bg-white/10 hover:bg-white/20'}`;
      if(view==='browser'){ renderSongList(); setupEventListeners(); sandboxInit(); renderSandbox(); }
      else if(view==='setlist'){ renderSetlist(); setupEventListeners(); }
      else if(view==='audit'){ renderAuditView(); setupEventListeners(); }
      else { renderProfile(); setupEventListeners(); }
    };

    window.toggleMixableFilter = () => {
      if(!selectedSong){ alert('Select a song first to see mixable tracks!'); return; }
      showMixableOnly = !showMixableOnly;
      resetPagination();
      render();
      setupEventListeners();
    };

    window.toggleOwnedFilter = () => {
      showOwnedOnly = !showOwnedOnly;
      resetPagination();
      render();
      setupEventListeners();
    };

    window.markAllOwned = async () => {
      if(viewingProfile) return;
      if(!confirm(`‚ö†Ô∏è Mark ALL ${songs.length} songs as owned?\nThis will override your current selection!`)) return;
      ownedTracks = songs.map(s=>s.id);
      persistNamespacedState();
      try { await persistCurrentUserProfile(); } catch(err){ console.error('[profile] markAllOwned save failed', err); }
      renderSongList(); updateOwnedCount(); alert(`‚úÖ Marked all ${songs.length} songs as owned!`);
    };

    window.clearAllOwned = async () => {
      if(viewingProfile) return;
      if(!confirm(`‚ö†Ô∏è CLEAR ALL owned songs?`)) return;
      const count = ownedTracks.length; ownedTracks = []; persistNamespacedState(); try { await persistCurrentUserProfile(); } catch(err){ console.error('[profile] clearAllOwned save failed', err); } renderSongList(); updateOwnedCount(); alert(`üóëÔ∏è Cleared ${count} owned songs.`);
    };

    async function addBandMember(){
      alert('Band Members is temporarily disabled.');
      return;
    }

    async function viewBandMember(username){
      alert('Band Members is temporarily disabled.');
      return;
    }
    function backToMyProfile(){
      alert('Band Members is temporarily disabled.');
      return;
    }

    // --------------------- Preview & two-track (simple) ---------------
    function onPreviewClick(id){
      const b = songs.find(s => s.id === id); if(!selectedSong){ selectedSong = b; render(); setupEventListeners(); alert('Main track selected. Click Preview on another track to compare.'); return; }
      previewSong = b; displayTwoTrackPreview(selectedSong, previewSong);
    }
    function displayTwoTrackPreview(A,B){
      const comp = mashupCompatibility(A,B); const pct = Math.round(comp.total);
      alert(`${A.title} ‚Üí ${B.title}\nCompatibility: ${pct}%\nBPM diff: ${Math.abs(A.bpm-B.bpm)}\n${bpmShiftSuggestion(A.bpm,B.bpm)}`);
    }

    // -------------------- Sandbox functions --------------------------
    function sandboxInit(){ const el=document.getElementById('sandbox'); if(!el) return; if(!el.dataset.bound){ el.dataset.bound='1'; el.addEventListener('dragover', (e)=>e.preventDefault()); el.addEventListener('drop', (e)=>{ e.preventDefault(); const id=e.dataTransfer.getData('text/plain'); const track = songs.find(s=>s.id===id); if(!track) return; if(sandboxTracks.find(t=>t.id===id)) return; if(sandboxTracks.length>=4){ alert('Sandbox limit: 4 tracks'); return; } sandboxTracks.push(track); renderSandbox(); }); } if(!sandboxTracks.length && sandboxIds.length){ sandboxTracks = sandboxIds.map(id=> songs.find(s=>s.id===id)).filter(Boolean).slice(0,4); } renderSandbox(); }
    function persistSandbox(){ sandboxIds = sandboxTracks.map(t=>t.id); localStorage.setItem(getNamespacedKey('sandboxTrackIds'), JSON.stringify(sandboxIds)); }
    function addToSandbox(id){ const track=songs.find(s=>s.id===id); if(!track) return; if(sandboxTracks.find(t=>t.id===id)){ alert('Track already in sandbox'); return; } if(sandboxTracks.length>=4){ alert('Sandbox limit: 4 tracks'); return; } sandboxTracks.push(track); renderSandbox(); renderSongList(); }
    function renderSandbox(){ const el=document.getElementById('sandbox'); if(!el) return; el.innerHTML = sandboxTracks.map((t,i)=>`<div class="flex items-center gap-3 panel p-2 mb-2"><div class="w-10 h-10 rounded" style="background:${camelotColors[t.camelot]||'#666'};display:flex;align-items:center;justify-content:center">${t.camelot}</div><div style="flex:1"><div class="font-semibold">${t.title}</div><div class="small-muted text-xs">${t.artist} ‚Ä¢ ${t.genre} ‚Ä¢ ${t.bpm} BPM ‚Ä¢ ${t.key}</div></div><button class="ml-2 px-2 py-1 bg-red-600/40" onclick="removeSandbox('${t.id}')">‚úï</button></div>`).join('') || `<div class="small-muted p-2">Drop tracks here</div>`; persistSandbox(); const info=document.getElementById('sandboxInfo'); if(sandboxTracks.length===0){ if(info) info.textContent=''; return; } const bpms=sandboxTracks.map(s=>s.bpm); const keys=sandboxTracks.map(s=>s.camelot); const bpmRange=`${Math.min(...bpms)}‚Äì${Math.max(...bpms)}`; const bpmDiffs=bpms.length>1?Math.max(...bpms)-Math.min(...bpms):0; const genreBlend=getGenreBlendScore(sandboxTracks); if(info) info.innerHTML=`BPM range: ${bpmRange} (Œî ${bpmDiffs}) ‚Ä¢ Key set: ${[...new Set(keys)].join(', ')} ‚Ä¢ Genre-blend: ${Math.round(genreBlend*100)}%`; }
    function removeSandbox(id){ sandboxTracks=sandboxTracks.filter(s=>s.id!==id); renderSandbox(); }
    function clearSandbox(){ sandboxTracks=[]; sandboxIds=[]; renderSandbox(); }
    function getGenreBlendScore(list){ if(!list.length) return 0; const counts={}; list.forEach(s=>counts[s.genre]=(counts[s.genre]||0)+1); const max=Math.max(...Object.values(counts)); return max/list.length; }

    function changePage(delta){
      currentPage += delta;
      if(currentPage < 1) currentPage = 1;
      persistPaginationState();
      renderSongList();
    }

    // NOTE:
    // Import / Export was intentionally removed.
    // Profiles persist automatically via Firebase or localStorage.
    // Do not reintroduce manual JSON import/export without a migration plan.

    // --------------------- Help modal functions -----------------------
    function syncHelpTabsA11y(){
      const tabs = document.querySelectorAll('.helpTabBtn');
      tabs.forEach(btn => {
        const isActive = btn.dataset.tab === helpTab;
        btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
        btn.tabIndex = isActive ? 0 : -1;
        btn.classList.toggle('active', isActive);
      });
    }

    function setHelpTab(tab){
      const helpContent = document.getElementById('helpContent');
      if(!helpContent) return;
      const panes = document.querySelectorAll('[data-help-pane]');
      helpScroll[helpTab] = helpContent.scrollTop;
      helpTab = tab === 'advanced' ? 'advanced' : 'basic';
      panes.forEach(pane => {
        const isActive = pane.dataset.helpPane === helpTab;
        pane.style.display = isActive ? 'block' : 'none';
      });
      helpContent.scrollTop = helpScroll[helpTab] || 0;
      syncHelpTabsA11y();
    }

    function bindHelpTabs(){
      const tabs = document.querySelectorAll('.helpTabBtn');
      tabs.forEach(btn => {
        const tab = btn.dataset.tab;
        btn.addEventListener('click', () => setHelpTab(tab));
        btn.addEventListener('keydown', (e) => {
          if(e.key === 'Enter' || e.key === ' ' || e.key === 'Spacebar'){
            e.preventDefault();
            setHelpTab(tab);
          }
        });
      });
      syncHelpTabsA11y();
    }

    function openHelp(){
      const modal = document.getElementById('helpModal');
      if(!modal) return;
      helpTab = 'basic';
      helpScroll = { basic: 0, advanced: 0 };
      setHelpTab('basic');
      modal.style.display = 'flex';
      modal.setAttribute('aria-hidden','false');
      const activeTab = document.querySelector('.helpTabBtn.active');
      if(activeTab){ activeTab.focus(); } else { modal.focus(); }
    }
    function closeHelp(){
      const modal = document.getElementById('helpModal');
      if(!modal) return;
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden','true');
    }

    async function maybeLoadSharedProfile(){
      if(!profileParam){ viewingProfile = null; return; }
      friendSearchTerm = profileParam;
      if(!firebaseAuth?.currentUser){ friendLookupError = 'Sign in required to view other profiles.'; return; }
      if(currentUser && (currentUser.username === profileParam || currentUser.uid === profileParam)){
        viewingProfile = null; setProfileQueryParam(null); return;
      }
      const matches = await fetchProfilesByField('username', profileParam);
      const profile = matches[0] || await loadProfileForViewing(profileParam);
      if(profile){
        viewingProfile = normalizeProfileShape(profile, profile.username || profile.uid);
        setProfileQueryParam(viewingProfile.username || viewingProfile.uid || '');
        view = 'profile';
      } else {
        friendLookupError = `No profile found for ‚Äò${profileParam}‚Äô`;
      }
    }

    const helpModal = document.getElementById('helpModal');
    if(helpModal){
      helpModal.addEventListener('click',(e)=>{ if(e.target === helpModal) closeHelp(); });
      bindHelpTabs();
    }
    document.addEventListener('keydown',(e)=>{ if(e.key === 'Escape'){ closeHelp(); } });

    // ----------------------- Init / Auth check ------------------------
    loadOverridesFromStorage();
    handleNetworkStatusChange();
    window.addEventListener('online', ()=>{ handleNetworkStatusChange(); if(!songs.length) loadSongs(); });
    window.addEventListener('offline', handleNetworkStatusChange);
    if('serviceWorker' in navigator){
      window.addEventListener('load', ()=>{
        navigator.serviceWorker.register('/sw.js').catch(err=>console.warn('SW registration failed', err));
      });
    }
    initCommunityMetrics();
    async function checkAuth(){
      if (firebaseEnabled && firebaseAuth) {
        setupFirebaseAuthListener();
        const fbUser = firebaseAuth.currentUser;
        if (fbUser) {
          await resolveAuthSuccess(fbUser);
          return;
        }
        const savedUsername = localStorage.getItem('currentUser');
        const localId = localStorage.getItem('localDeviceUserId');
        if(savedUsername && savedUsername === localId){
          const profile = await loadUserProfile(savedUsername);
          if(profile){ currentUser = profile; applyPreferencesFromProfile(currentUser); refreshDraftProfileFromCurrentUser(); loadNamespacedState(); loadOverridesFromStorage(); await maybeLoadSharedProfile(); loadSongs(); return; }
        }
        showLoginScreen();
        return;
      }
      const savedUsername = localStorage.getItem('currentUser');
      if(savedUsername){
        const profile = await loadUserProfile(savedUsername);
        if(profile){ currentUser = profile; applyPreferencesFromProfile(currentUser); refreshDraftProfileFromCurrentUser(); loadNamespacedState(); loadOverridesFromStorage(); await maybeLoadSharedProfile(); loadSongs(); return; }
      }
      showLoginScreen();
    }

    if(!localStorage.getItem('hasSeenLanding')) showLandingPage(); else checkAuth();

    // ------------------ Drag/drop support ---------------------------
    document.addEventListener('dragstart', (e)=>{ const card = e.target.closest('.song-card'); if(card) e.dataTransfer.setData('text/plain', card.getAttribute('data-song-id')); });
    document.addEventListener('click', (e)=>{ const preview = e.target.closest('.previewBtn'); if(preview){ e.preventDefault(); onPreviewClick(preview.dataset.id); } const addSet = e.target.closest('.addSetBtn'); if(addSet){ e.preventDefault(); addToSetlist(addSet.dataset.id); } });

    // ---------------- Expose some helpers for debugging ----------------
    window.openHelp = openHelp; window.closeHelp = closeHelp; window.render = render; window.loadSongs = loadSongs; window.renderSongList = renderSongList; window.renderSetlist = renderSetlist; window.viewFriendProfile = viewFriendProfile;
  </script>
</body>
</html>
