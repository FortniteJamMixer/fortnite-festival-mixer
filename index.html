<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fortnite Festival Pro Mixer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    
    .dj-background {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      position: relative;
      overflow: hidden;
    }
    
    .dj-background::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: 
        url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 800"><text x="50" y="100" font-family="Impact" font-size="120" fill="%23ff6b9d" opacity="0.05" transform="rotate(-15 100 100)">FESTIVAL</text><text x="600" y="400" font-family="Impact" font-size="150" fill="%2300d9ff" opacity="0.05" transform="rotate(10 700 400)">DJ</text><text x="200" y="600" font-family="Impact" font-size="100" fill="%23ffd700" opacity="0.05" transform="rotate(-20 300 600)">MIX</text><circle cx="900" cy="150" r="80" fill="none" stroke="%23ff6b9d" stroke-width="3" opacity="0.1"/><circle cx="300" cy="300" r="60" fill="none" stroke="%2300d9ff" stroke-width="3" opacity="0.1"/><line x1="100" y1="700" x2="1100" y2="700" stroke="%23ffd700" stroke-width="2" opacity="0.1"/></svg>');
      background-size: cover;
      pointer-events: none;
      z-index: 0;
    }
    
    .dj-background::after {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 30%, rgba(255, 107, 157, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(0, 217, 255, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 50% 50%, rgba(255, 215, 0, 0.05) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
      animation: pulse 8s ease-in-out infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 0.8; }
    }
    
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    .vinyl-spin {
      animation: spin 4s linear infinite;
    }
    
    .graffiti-text {
      text-shadow: 
        3px 3px 0px #ff6b9d,
        6px 6px 0px rgba(255, 107, 157, 0.3);
      letter-spacing: 2px;
    }
    
    .content-wrapper {
      position: relative;
      z-index: 1;
    }
  </style>
</head>
<body class="dj-background">
  <div id="app" class="content-wrapper">
    <div class="min-h-screen flex items-center justify-center">
      <div class="text-center">
        <div class="text-6xl mb-4 animate-pulse">üéµ</div>
        <div class="text-2xl font-bold text-white">Loading Festival Mixer...</div>
      </div>
    </div>
  </div>
  
  <script>
    const camelotColors = {
      '1A': '#FF6B9D', '1B': '#FF8FAB', '2A': '#FFA07A', '2B': '#FFB699',
      '3A': '#FFD700', '3B': '#FFE55C', '4A': '#98D8C8', '4B': '#7FD8BE',
      '5A': '#6BCB77', '5B': '#8FD89F', '6A': '#4D96FF', '6B': '#6FB1FF',
      '7A': '#9D4EDD', '7B': '#B877FF', '8A': '#E84A5F', '8B': '#FF6B81',
      '9A': '#00D9FF', '9B': '#4DFFFF', '10A': '#FFA400', '10B': '#FFBB5C',
      '11A': '#FE6D73', '11B': '#FF8C94', '12A': '#A8E6CF', '12B': '#C1F0DD'
    };

    const keyToCamelot = {
      'C': '8B', 'Am': '8A', 'A Minor': '8A', 'C Major': '8B',
      'G': '9B', 'Em': '9A', 'E Minor': '9A', 'G Major': '9B',
      'D': '10B', 'Bm': '10A', 'B Minor': '10A', 'D Major': '10B',
      'A': '11B', 'F#m': '11A', 'F# Minor': '11A', 'A Major': '11B',
      'E': '12B', 'C#m': '12A', 'C# Minor': '12A', 'E Major': '12B',
      'B': '1B', 'G#m': '1A', 'G# Minor': '1A', 'B Major': '1B',
      'F#': '2B', 'D#m': '2A', 'D# Minor': '2A', 'F# Major': '2B',
      'Db': '3B', 'Bbm': '3A', 'Bb Minor': '3A', 'Db Major': '3B',
      'Ab': '4B', 'Fm': '4A', 'F Minor': '4A', 'Ab Major': '4B',
      'Eb': '5B', 'Cm': '5A', 'C Minor': '5A', 'Eb Major': '5B',
      'Bb': '6B', 'Gm': '6A', 'G Minor': '6A', 'Bb Major': '6B',
      'F': '7B', 'Dm': '7A', 'D Minor': '7A', 'F Major': '7B'
    };

    // User Profile Management
    let currentUser = null;
    let songs = [];
    let ownedTracks = [];
    let selectedSong = null;
    let setlist = [];
    let searchTerm = '';
    let view = 'browser';
    let showOwnedOnly = false;
    let showMixableOnly = false;

    function saveUserProfile() {
      if (!currentUser) return;
      const profiles = JSON.parse(localStorage.getItem('userProfiles') || '{}');
      profiles[currentUser.username] = {
        username: currentUser.username,
        djName: currentUser.djName,
        ownedTracks: ownedTracks,
        setlists: currentUser.setlists || []
      };
      localStorage.setItem('userProfiles', JSON.stringify(profiles));
    }

    function loadUserProfile(username) {
      const profiles = JSON.parse(localStorage.getItem('userProfiles') || '{}');
      return profiles[username];
    }

    function loginUser(username, djName) {
      const profile = loadUserProfile(username);
      if (profile) {
        currentUser = profile;
        ownedTracks = profile.ownedTracks || [];
      } else {
        currentUser = {
          username: username,
          djName: djName,
          ownedTracks: [],
          setlists: []
        };
        saveUserProfile();
      }
      localStorage.setItem('currentUser', username);
    }

    function logoutUser() {
      saveUserProfile();
      currentUser = null;
      ownedTracks = [];
      setlist = [];
      localStorage.removeItem('currentUser');
      showLoginScreen();
    }

    function showLoginScreen() {
      document.getElementById('app').innerHTML = `
        <div class="min-h-screen flex items-center justify-center p-6">
          <div class="max-w-md w-full">
            <div class="text-center mb-8">
              <div class="w-24 h-24 bg-gradient-to-br from-pink-500 via-purple-500 to-cyan-500 rounded-full flex items-center justify-center text-5xl mx-auto mb-4 vinyl-spin">
                üéß
              </div>
              <h1 class="text-4xl font-bold text-white graffiti-text mb-2">FESTIVAL PRO MIXER</h1>
              <p class="text-cyan-300">Your Personal DJ Profile</p>
            </div>
            
            <div class="bg-black/60 backdrop-blur-xl border border-cyan-500/30 rounded-2xl p-8 shadow-2xl shadow-cyan-500/20">
              <h2 class="text-2xl font-bold text-white mb-6 text-center">Sign In / Create Profile</h2>
              
              <form onsubmit="handleLogin(event)" class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-300 mb-2">Username</label>
                  <input
                    type="text"
                    id="username"
                    required
                    minlength="3"
                    placeholder="Enter your username"
                    class="w-full px-4 py-3 bg-black/40 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500"
                  />
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-300 mb-2">DJ Name (optional)</label>
                  <input
                    type="text"
                    id="djName"
                    placeholder="e.g., DJ Spinner, Beat Master"
                    class="w-full px-4 py-3 bg-black/40 border border-gray-600 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500"
                  />
                </div>
                
                <button
                  type="submit"
                  class="w-full px-6 py-3 bg-gradient-to-r from-pink-500 via-purple-500 to-cyan-500 hover:from-pink-600 hover:via-purple-600 hover:to-cyan-600 rounded-lg font-bold text-white text-lg transition shadow-lg shadow-purple-500/50"
                >
                  üéµ Enter the Mix
                </button>
              </form>
              
              <p class="text-xs text-gray-400 text-center mt-4">
                Your profile is saved locally on this device
              </p>
            </div>
          </div>
        </div>
      `;
    }

    window.handleLogin = (event) => {
      event.preventDefault();
      const username = document.getElementById('username').value.trim();
      const djName = document.getElementById('djName').value.trim() || username;
      
      if (username.length < 3) {
        alert('Username must be at least 3 characters');
        return;
      }
      
      loginUser(username, djName);
      loadSongs();
    };

    function convertToCamelot(key, mode) {
      if (!key) return '?';
      const fullKey = `${key} ${mode}`;
      return keyToCamelot[fullKey] || keyToCamelot[key] || '?';
    }

    function getCompatibleKeys(camelot) {
      if (!camelot || camelot === '?') return [];
      const matches = camelot.match(/^(\d+)([AB])$/);
      if (!matches) return [];
      const num = parseInt(matches[1]);
      const letter = matches[2];
      const compatible = [camelot, `${num}${letter === 'A' ? 'B' : 'A'}`];
      const nextNum = num === 12 ? 1 : num + 1;
      compatible.push(`${nextNum}${letter}`);
      const prevNum = num === 1 ? 12 : num - 1;
      compatible.push(`${prevNum}${letter}`);
      return compatible;
    }

    function isMixable(song1, song2) {
      if (!song1 || !song2) return false;
      const compatible = getCompatibleKeys(song1.camelot);
      return compatible.includes(song2.camelot);
    }

    async function loadSongs() {
      console.log('üéµ Loading Fortnite Festival tracks...');
      
      const endpoints = [
        'https://api.allorigins.win/raw?url=https://fortnitecontent-website-prod07.ol.epicgames.com/content/api/pages/fortnite-game/spark-tracks',
        'https://corsproxy.io/?https://fortnitecontent-website-prod07.ol.epicgames.com/content/api/pages/fortnite-game/spark-tracks',
      ];
      
      for (let i = 0; i < endpoints.length; i++) {
        try {
          console.log(`üì° Trying endpoint ${i + 1}/${endpoints.length}...`);
          const response = await fetch(endpoints[i]);
          console.log(`üìä Response status: ${response.status}`);
          
          if (!response.ok) {
            console.warn(`‚ö†Ô∏è Endpoint ${i + 1} failed with status ${response.status}`);
            continue;
          }
          
          const data = await response.json();
          console.log('üì¶ Received data, processing...');
          
          songs = Object.entries(data)
            .filter(([key]) => !key.startsWith('_'))
            .map(([id, item]) => {
              const track = item?.track;
              if (!track?.tt) return null;
              
              return {
                id,
                title: track.tt,
                artist: track.an || 'Unknown',
                bpm: track.mt || 0,
                key: track.mk || '?',
                mode: track.mm || '',
                camelot: convertToCamelot(track.mk, track.mm),
                duration: track.dn || 0,
                albumArt: track.au || ''
              };
            })
            .filter(song => song && song.bpm > 0);
          
          if (songs.length > 0) {
            console.log(`‚úÖ Successfully loaded ${songs.length} tracks!`);
            render();
            setupEventListeners();
            return;
          }
        } catch (error) {
          console.error(`‚ùå Endpoint ${i + 1} error:`, error);
        }
      }
      
      console.error('‚ùå All endpoints failed');
      showError('Unable to load tracks. The API may be temporarily unavailable. Try refreshing in a few minutes.');
    }

    function showError(message) {
      document.getElementById('app').innerHTML = `
        <div class="min-h-screen flex items-center justify-center p-6">
          <div class="text-center max-w-2xl">
            <div class="text-6xl mb-4">‚ö†Ô∏è</div>
            <div class="text-2xl font-bold mb-4 text-white">Unable to Load Tracks</div>
            <div class="text-gray-300 mb-6 bg-black/30 p-4 rounded-lg backdrop-blur-sm">
              <p class="mb-2">${message}</p>
            </div>
            <button onclick="location.reload()" class="px-6 py-3 bg-gradient-to-r from-pink-500 to-purple-500 hover:from-pink-600 hover:to-purple-600 rounded-lg font-bold">
              üîÑ Retry Loading
            </button>
          </div>
        </div>
      `;
    }

    function toggleOwned(id) {
      if (ownedTracks.includes(id)) {
        ownedTracks = ownedTracks.filter(t => t !== id);
      } else {
        ownedTracks.push(id);
      }
      saveUserProfile();
      renderSongList();
      updateOwnedCount();
    }

    function formatDuration(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function updateOwnedCount() {
      const countEl = document.getElementById('ownedCount');
      if (countEl) {
        countEl.textContent = `You own ${ownedTracks.length}/${songs.length} tracks`;
      }
    }

    function renderSongList() {
      const filteredSongs = songs.filter(s => {
        const matchesSearch = s.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
                             s.artist.toLowerCase().includes(searchTerm.toLowerCase());
        const matchesOwned = !showOwnedOnly || ownedTracks.includes(s.id);
        const matchesMixable = !showMixableOnly || !selectedSong || isMixable(selectedSong, s);
        return matchesSearch && matchesOwned && matchesMixable;
      });

      const songListEl = document.getElementById('songList');
      if (!songListEl) return;

      const compatibleKeys = selectedSong ? getCompatibleKeys(selectedSong.camelot) : [];

      songListEl.innerHTML = `
        ${selectedSong ? `
          <div class="mb-6 bg-gradient-to-r from-pink-500/20 via-purple-500/20 to-blue-500/20 border border-pink-500/30 rounded-xl p-4 backdrop-blur-sm">
            <div class="flex items-center gap-4 flex-wrap">
              ${selectedSong.albumArt ? `<img src="${selectedSong.albumArt}" class="w-16 h-16 rounded-lg vinyl-spin"/>` : '<div class="w-16 h-16 bg-gradient-to-br from-pink-500 to-purple-500 rounded-full vinyl-spin"></div>'}
              <div class="flex-1">
                <div class="text-sm text-pink-300 font-bold">NOW MIXING FROM:</div>
                <div class="font-bold text-xl text-white graffiti-text">${selectedSong.title}</div>
                <div class="text-purple-200 text-sm">${selectedSong.artist}</div>
              </div>
              <div class="text-right">
                <div class="text-3xl font-mono font-bold" style="color: ${camelotColors[selectedSong.camelot] || '#666'}">${selectedSong.camelot}</div>
                <div class="text-xs text-purple-200">${selectedSong.key} ${selectedSong.mode}</div>
                <div class="text-xs text-cyan-300 mt-1 font-bold">MIX WITH: ${compatibleKeys.join(', ')}</div>
              </div>
              <button onclick="clearSelection()" class="p-2 hover:bg-white/10 rounded text-2xl">‚úï</button>
            </div>
          </div>
        ` : ''}

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          ${filteredSongs.slice(0, 100).map(song => {
            const isOwned = ownedTracks.includes(song.id);
            const isMixableWithSelected = selectedSong && isMixable(selectedSong, song);
            
            return `
              <div class="bg-black/40 backdrop-blur-sm border ${
                selectedSong?.id === song.id ? 'border-pink-400 shadow-lg shadow-pink-500/50' : 
                isMixableWithSelected ? 'border-green-400 shadow-lg shadow-green-500/30' : 
                'border-gray-700'
              } rounded-xl p-4 relative hover:border-cyan-400 transition-all">
                ${isOwned ? '<div class="absolute top-2 right-2 text-xl">‚≠ê</div>' : ''}
                ${isMixableWithSelected ? '<div class="absolute top-2 left-2 text-xl">üéß</div>' : ''}
                <div class="flex gap-4 mb-3">
                  ${song.albumArt ? `<img src="${song.albumArt}" class="w-20 h-20 rounded-lg cursor-pointer hover:scale-110 transition-transform" onclick="selectSong('${song.id}')"/>` : `<div class="w-20 h-20 bg-gradient-to-br from-purple-500 to-pink-500 rounded-lg"></div>`}
                  <div class="flex-1 cursor-pointer" onclick="selectSong('${song.id}')">
                    <div class="font-bold text-lg mb-1 text-white">${song.title}</div>
                    <div class="text-gray-300 mb-2 text-sm">${song.artist}</div>
                    <div class="flex items-center gap-2 text-sm flex-wrap">
                      <span class="px-3 py-1 rounded-lg font-mono font-bold text-white shadow-lg" style="background: ${camelotColors[song.camelot] || '#666'}">${song.camelot}</span>
                      <span class="px-2 py-1 bg-gray-700 rounded text-xs">${song.key} ${song.mode}</span>
                      <span class="font-semibold text-cyan-300">${song.bpm} BPM</span>
                      <span class="text-gray-400">${formatDuration(song.duration)}</span>
                    </div>
                  </div>
                </div>
                <div class="flex gap-2">
                  <button onclick="toggleOwned('${song.id}')" class="flex-1 px-3 py-2 ${isOwned ? 'bg-green-500 hover:bg-green-600' : 'bg-gray-700 hover:bg-gray-600'} rounded-lg text-sm font-medium transition">
                    ${isOwned ? '‚úì Owned' : 'Mark Owned'}
                  </button>
                  <button onclick="addToSetlist('${song.id}')" class="px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 rounded-lg text-sm font-medium transition">
                    + Set
                  </button>
                </div>
              </div>
            `;
          }).join('')}
        </div>
        ${filteredSongs.length > 100 ? `<div class="text-center mt-6 text-cyan-300 font-bold">Showing 100 of ${filteredSongs.length} tracks</div>` : ''}
        ${filteredSongs.length === 0 ? `<div class="text-center py-12 text-gray-400">No tracks found matching your filters</div>` : ''}
      `;
    }

    function renderSetlist() {
      const setlistEl = document.getElementById('setlistContent');
      if (!setlistEl) return;

      if (setlist.length === 0) {
        setlistEl.innerHTML = `
          <div class="text-center py-12">
            <div class="text-6xl mb-4">üéµ</div>
            <p class="text-xl mb-4 text-white">Your setlist is empty</p>
            <button onclick="switchView('browser')" class="px-6 py-3 bg-gradient-to-r from-purple-500 to-pink-500 rounded-lg font-bold">Browse Tracks</button>
          </div>
        `;
      } else {
        setlistEl.innerHTML = `
          <div class="space-y-4">
            ${setlist.map((song, i) => `
              <div class="bg-black/40 backdrop-blur-sm border border-gray-700 rounded-xl p-4 flex items-center gap-4 hover:border-cyan-400 transition">
                <div class="text-2xl font-bold text-pink-400">${i + 1}</div>
                ${song.albumArt ? `<img src="${song.albumArt}" class="w-16 h-16 rounded-lg"/>` : ''}
                <div class="flex-1">
                  <div class="font-bold text-lg text-white">${song.title}</div>
                  <div class="text-gray-300">${song.artist}</div>
                </div>
                <div class="text-xl font-mono font-bold" style="color: ${camelotColors[song.camelot]}">${song.camelot}</div>
                <button onclick="removeFromSetlist('${song.id}')" class="p-2 hover:bg-red-500/20 rounded text-red-400 text-xl">‚úï</button>
              </div>
            `).join('')}
          </div>
        `;
      }
    }

    function render() {
      const ownedCount = ownedTracks.length;

      document.getElementById('app').innerHTML = `
        <div class="min-h-screen">
          <div class="bg-black/60 backdrop-blur-xl border-b border-cyan-500/30 sticky top-0 z-50 shadow-lg shadow-cyan-500/20">
            <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between flex-wrap gap-4">
              <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-gradient-to-br from-pink-500 via-purple-500 to-cyan-500 rounded-lg flex items-center justify-center text-2xl vinyl-spin">
                  üéµ
                </div>
                <div>
                  <h1 class="text-2xl font-bold text-white graffiti-text">FESTIVAL PRO MIXER</h1>
                  <p id="ownedCount" class="text-xs text-cyan-300 font-semibold">You own ${ownedCount}/${songs.length} tracks</p>
                </div>
              </div>
              <div class="flex items-center gap-3">
                <div class="text-right">
                  <div class="text-sm text-pink-300 font-bold">${currentUser.djName}</div>
                  <div class="text-xs text-gray-400">@${currentUser.username}</div>
                </div>
                <button onclick="logoutUser()" class="px-3 py-2 bg-red-500/20 hover:bg-red-500/30 border border-red-500/50 rounded-lg text-red-300 text-sm transition">
                  Logout
                </button>
              </div>
            </div>
            <div class="max-w-7xl mx-auto px-6 pb-4">
              <div class="flex gap-2">
                <button id="browserBtn" class="px-4 py-2 rounded-lg font-medium transition ${view === 'browser' ? 'bg-gradient-to-r from-purple-500 to-pink-500' : 'bg-white/10 hover:bg-white/20'}">
                  Browse
                </button>
                <button id="setlistBtn" class="px-4 py-2 rounded-lg font-medium transition ${view === 'setlist' ? 'bg-gradient-to-r from-purple-500 to-pink-500' : 'bg-white/10 hover:bg-white/20'}">
                  Setlist (<span id="setlistCount">${setlist.length}</span>)
                </button>
              </div>
            </div>
          </div>

          <div class="max-w-7xl mx-auto px-6 py-6">
            <div id="browserView" style="display: ${view === 'browser' ? 'block' : 'none'}">
              <div class="mb-6 space-y-4">
                <input
                  type="text"
                  id="searchInput"
                  placeholder="Search tracks or artists..."
                  class="w-full px-4 py-3 bg-black/40 backdrop-blur-sm border border-cyan-500/30 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500"
                />
                <div class="flex flex-wrap gap-3">
                  <button id="mixableFilterBtn" class="px-4 py-2 rounded-lg font-medium transition ${showMixableOnly ? 'bg-gradient-to-r from-blue-500 to-cyan-500' : 'bg-white/10 hover:bg-white/20'}">
                    ${showMixableOnly ? 'üéß Mixable Only' : 'Show Mixable'}
                  </button>
                  <button id="ownedFilterBtn" class="px-4 py-2 rounded-lg font-medium transition ${showOwnedOnly ? 'bg-gradient-to-r from-green-500 to-emerald-500' : 'bg-white/10 hover:bg-white/20'}">
                    ${showOwnedOnly ? '‚úì Owned Only' : 'Show All'}
                  </button>
                  <button id="markAllBtn" class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg transition">
                    Mark All Owned
                  </button>
                  <button id="clearAllBtn" class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg transition">
                    Clear All
                  </button>
                </div>
              </div>
              <div id="songList"></div>
            </div>

            <div id="setlistView" style="display: ${view === 'setlist' ? 'block' : 'none'}">
              <div id="setlistContent"></div>
            </div>
          </div>
        </div>
      `;

      if (view === 'browser') {
        renderSongList();
      } else {
        renderSetlist();
      }
    }

    function setupEventListeners() {
      const searchInput = document.getElementById('searchInput');
      if (searchInput) {
        searchInput.addEventListener('input', (e) => {
          searchTerm = e.target.value;
          renderSongList();
        });
      }

      document.getElementById('browserBtn')?.addEventListener('click', () => switchView('browser'));
      document.getElementById('setlistBtn')?.addEventListener('click', () => switchView('setlist'));
      document.getElementById('mixableFilterBtn')?.addEventListener('click', toggleMixableFilter);
      document.getElementById('ownedFilterBtn')?.addEventListener('click', toggleOwnedFilter);
      document.getElementById('markAllBtn')?.addEventListener('click', markAllOwned);
      document.getElementById('clearAllBtn')?.addEventListener('click', clearAllOwned);
    }

    window.selectSong = (id) => { 
      selectedSong = songs.find(s => s.id === id);
      showMixableOnly = true;
      const btn = document.getElementById('mixableFilterBtn');
      if (btn) {
        btn.className = 'px-4 py-2 rounded-lg font-medium transition bg-gradient-to-r from-blue-500 to-cyan-500';
        btn.textContent = 'üéß Mixable Only';
      }
      renderSongList();
    };
    
    window.clearSelection = () => { 
      selectedSong = null;
      showMixableOnly = false;
      const btn = document.getElementById('mixableFilterBtn');
      if (btn) {
        btn.className = 'px-4 py-2 rounded-lg font-medium transition bg-white/10 hover:bg-white/20';
        btn.textContent = 'Show Mixable';
      }
      renderSongList();
    };
    
    window.toggleOwned = toggleOwned;
    
    window.markAllOwned = () => { 
      ownedTracks = songs.map(s => s.id); 
      saveUserProfile(); 
      renderSongList();
      updateOwnedCount();
    };
    
    window.clearAllOwned = () => { 
      ownedTracks = []; 
      saveUserProfile(); 
      renderSongList();
      updateOwnedCount();
    };
    
    window.toggleMixableFilter = () => {
      if (!selectedSong) {
        alert('Select a song first to see mixable tracks!');
        return;
      }
      showMixableOnly = !showMixableOnly;
      const btn = document.getElementById('mixableFilterBtn');
      if (btn) {
        btn.className = `px-4 py-2 rounded-lg font-medium transition ${showMixableOnly ? 'bg-gradient-to-r from-blue-500 to-cyan-500' : 'bg-white/10 hover:bg-white/20'}`;
        btn.textContent = showMixableOnly ? 'üéß Mixable Only' : 'Show Mixable';
      }
      renderSongList();
    };
    
    window.toggleOwnedFilter = () => { 
      showOwnedOnly = !showOwnedOnly;
      const btn = document.getElementById('ownedFilterBtn');
      if (btn) {
        btn.className = `px-4 py-2 rounded-lg font-medium transition ${showOwnedOnly ? 'bg-gradient-to-r from-green-500 to-emerald-500' : 'bg-white/10 hover:bg-white/20'}`;
        btn.textContent = showOwnedOnly ? '‚úì Owned Only' : 'Show All';
      }
      renderSongList();
    };
    
    window.addToSetlist = (id) => { 
      const song = songs.find(s => s.id === id); 
      if (!setlist.find(s => s.id === id)) { 
        setlist.push(song);
        const countEl = document.getElementById('setlistCount');
        if (countEl) countEl.textContent = setlist.length;
      }
    };
    
    window.removeFromSetlist = (id) => { 
      setlist = setlist.filter(s => s.id !== id); 
      renderSetlist();
      const countEl = document.getElementById('setlistCount');
      if (countEl) countEl.textContent = setlist.length;
    };
    
    window.switchView = (newView) => { 
      view = newView;
      document.getElementById('browserView').style.display = view === 'browser' ? 'block' : 'none';
      document.getElementById('setlistView').style.display = view === 'setlist' ? 'block' : 'none';
      
      const browserBtn = document.getElementById('browserBtn');
      const setlistBtn = document.getElementById('setlistBtn');
      if (browserBtn) browserBtn.className = `px-4 py-2 rounded-lg font-medium transition ${view === 'browser' ? 'bg-gradient-to-r from-purple-500 to-pink-500' : 'bg-white/10 hover:bg-white/20'}`;
      if (setlistBtn) setlistBtn.className = `px-4 py-2 rounded-lg font-medium transition ${view === 'setlist' ? 'bg-gradient-to-r from-purple-500 to-pink-500' : 'bg-white/10 hover:bg-white/20'}`;
      
      if (view === 'browser') {
        renderSongList();
        setupEventListeners();
      } else {
        renderSetlist();
      }
    };

    // Check if user is already logged in
    const savedUsername = localStorage.getItem('currentUser');
    if (savedUsername) {
      const profile = loadUserProfile(savedUsername);
      if (profile) {
        currentUser = profile;
        ownedTracks = profile.ownedTracks || [];
        loadSongs();
      } else {
        showLoginScreen();
      }
    } else {
      showLoginScreen();
    }
  </script>
</body>
</html>
