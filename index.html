<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Festival Jam Mixer — Cloud Sync</title>
  <style>
    /* Minimal styles to keep UI usable in one file */
    body{background:#0b0b0c;color:#e6eef6;font-family:Inter,Segoe UI,Arial;margin:0;padding:0}
    .wrap{max-width:1100px;margin:24px auto;padding:20px}
    .card{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.04);padding:14px;border-radius:10px;margin-bottom:12px}
    input,button,select{font-size:14px;padding:8px;border-radius:6px;border:1px solid #333;background:#071018;color:#fff}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:16px}
    .song{display:flex;gap:10px;align-items:center;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);margin-bottom:8px}
    .btn{cursor:pointer}
    .badge{background:#6b4cff;padding:4px 8px;border-radius:999px;color:#fff;font-weight:700;margin-left:8px}
    .star{color:#ffd166;margin-left:8px}
    .small{font-size:12px;color:#bcd}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Festival Jam Mixer — Cloud Sync (Firebase)</h1>
    <div class="card" id="loginCard">
      <h3>Sign In / Create Profile</h3>
      <form id="loginForm">
        <label>Username (case-sensitive)</label><br/>
        <input id="username" minlength="3" required placeholder="username (case-sensitive)"/><br/><br/>
        <label>DJ Name (optional)</label><br/>
        <input id="djName" placeholder="DJ Name (optional)"/><br/><br/>
        <button type="submit" class="btn">Enter the Mix</button>
        <div class="small" style="margin-top:8px">Profiles are synced across devices using your Firebase project.</div>
      </form>
      <div id="loginStatus" class="small"></div>
    </div>

    <div id="appArea" style="display:none">
      <div class="grid">
        <div>
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div id="djLabel" style="font-weight:700">—</div>
                <div id="userMeta" class="small">—</div>
              </div>
              <div>
                <button id="logoutBtn" class="btn">Log out</button>
              </div>
            </div>
            <hr style="margin:10px 0 12px 0"/>
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">
              <button id="showAllBtn" class="btn">Show All</button>
              <button id="showOwnedBtn" class="btn">Owned Only</button>
              <button id="markAllBtn" class="btn">Mark All Owned</button>
              <button id="clearAllBtn" class="btn">Clear All Owned</button>
              <button id="exportBtn" class="btn">Export JSON</button>
              <button id="importBtn" class="btn">Import JSON</button>
            </div>

            <div style="margin-top:12px">
              <input id="searchInput" placeholder="search title or artist" style="width:100%"/>
            </div>
            <div id="songList" style="margin-top:12px;max-height:560px;overflow:auto"></div>
          </div>
        </div>

        <div>
          <div class="card">
            <h3>Setlist <span id="setlistCount">0</span></h3>
            <div id="setlistArea"></div>
            <hr/>
            <h4>Band Members (case-sensitive)</h4>
            <div id="bandArea"></div>
            <div style="margin-top:8px">
              <button id="addBandBtn" class="btn">Add Band Member</button>
            </div>
          </div>
          <div class="card" style="margin-top:12px">
            <h4>Debug / Status</h4>
            <div id="status"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
  // --------- Firebase config (inserted by user) ---------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAeVHy4RPVwEAfQaEisW82eqCPwBRkG3WQ",
    authDomain: "festival-jam-mixer.firebaseapp.com",
    projectId: "festival-jam-mixer",
    storageBucket: "festival-jam-mixer.firebasestorage.app",
    messagingSenderId: "255348637744",
    appId: "1:255348637744:web:cbd3151011372f0e8fadf5",
    measurementId: "G-G0ZHBW07C3"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // --------- App state ---------
  let currentUser = null; // object {username,djName,...}
  let songs = []; // will be loaded from remote API
  let ownedTracks = [];
  let setlist = [];
  let bandMembers = [];
  let genreOverrides = {};

  // Simple status helper
  function setStatus(msg) { document.getElementById('status').textContent = msg; }
  function setLoginStatus(msg) { document.getElementById('loginStatus').textContent = msg; }

  // --------- Firestore-backed profile functions ---------
  async function loadUserProfileFromCloud(username) {
    try {
      const ref = doc(db, 'profiles', username);
      const snap = await getDoc(ref);
      if (!snap.exists()) return null;
      return snap.data();
    } catch (err) {
      console.error('loadUserProfileFromCloud error', err);
      return null;
    }
  }

  async function saveUserProfileToCloud(profile) {
    try {
      const ref = doc(db, 'profiles', profile.username);
      const payload = {
        username: profile.username,
        djName: profile.djName || profile.username,
        ownedTracks: profile.ownedTracks || [],
        setlist: profile.setlist || [],
        bandMembers: profile.bandMembers || [],
        genreOverrides: profile.genreOverrides || {},
        updatedAt: serverTimestamp()
      };
      await setDoc(ref, payload, { merge: true });
      setStatus('Saved profile to cloud.');
    } catch (err) {
      console.error('saveUserProfileToCloud error', err);
      setStatus('Failed saving profile to cloud.');
    }
  }

  // Local fallback (cache)
  function saveLocal(profilesKey='fm_local_profiles') {
    try {
      const data = { currentUser: currentUser, ownedTracks, setlist, bandMembers, genreOverrides };
      localStorage.setItem(profilesKey, JSON.stringify(data));
      setStatus('Saved local cache.');
    } catch(e){}
  }
  function loadLocal() {
    try {
      const raw = localStorage.getItem('fm_local_profiles');
      if (!raw) return null;
      return JSON.parse(raw);
    } catch(e){ return null; }
  }

  // --------- Login flow ---------
  document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const username = document.getElementById('username').value.trim();
    const djName = document.getElementById('djName').value.trim() || username;
    if (username.length < 3) { alert('Username must be at least 3 characters'); return; }
    setLoginStatus('Signing in...');
    await loginUser(username, djName);
  });

  async function loginUser(username, djName) {
    // Try cloud first
    setStatus('Loading profile from cloud...');
    const cloudProfile = await loadUserProfileFromCloud(username);
    if (cloudProfile) {
      currentUser = cloudProfile;
      ownedTracks = cloudProfile.ownedTracks || [];
      setlist = cloudProfile.setlist || [];
      bandMembers = cloudProfile.bandMembers || [];
      genreOverrides = cloudProfile.genreOverrides || {};
      setStatus('Loaded profile from cloud.');
      // cache locally
      saveLocal();
    } else {
      // No cloud profile, create a new one
      currentUser = { username, djName };
      ownedTracks = [];
      setlist = [];
      bandMembers = [];
      genreOverrides = {};
      // Save to cloud
      await saveUserProfileToCloud({ username, djName, ownedTracks, setlist, bandMembers, genreOverrides });
    }

    // Show app UI
    document.getElementById('loginCard').style.display = 'none';
    document.getElementById('appArea').style.display = 'block';
    document.getElementById('djLabel').textContent = currentUser.djName;
    document.getElementById('userMeta').textContent = '@' + currentUser.username;
    document.getElementById('setlistCount').textContent = setlist.length;
    renderBand();
    renderSetlist();
    renderSongList();
    setupButtons();
    setLoginStatus('');
    // Load songs
    loadSongs();
  }

  document.getElementById('logoutBtn').addEventListener('click', () => {
    // Save and clear
    if (currentUser) saveUserProfileToCloud({ username: currentUser.username, djName: currentUser.djName, ownedTracks, setlist, bandMembers, genreOverrides });
    currentUser = null;
    ownedTracks = [];
    setlist = [];
    bandMembers = [];
    genreOverrides = {};
    document.getElementById('loginCard').style.display = 'block';
    document.getElementById('appArea').style.display = 'none';
  });

  // --------- Band members ---------
  document.getElementById('addBandBtn').addEventListener('click', async () => {
    const username = prompt('Enter bandmate username (case-sensitive):');
    if (!username) return;
    if (bandMembers.find(b=>b.username===username)) { alert('Already added'); return; }
    // Check cloud for profile existence
    const profile = await loadUserProfileFromCloud(username);
    if (!profile) { alert('User not found (ensure they created profile and use exact capitalization)'); return; }
    bandMembers.push({ username: profile.username, djName: profile.djName || profile.username });
    await saveUserProfileToCloud({ username: currentUser.username, djName: currentUser.djName, ownedTracks, setlist, bandMembers, genreOverrides });
    renderBand();
  });

  function renderBand() {
    const el = document.getElementById('bandArea');
    el.innerHTML = '';
    if (!bandMembers.length) { el.textContent = 'No band members added'; return; }
    bandMembers.forEach(m => {
      const d = document.createElement('div');
      d.className = 'small';
      d.textContent = m.djName + ' (@' + m.username + ')';
      const btn = document.createElement('button');
      btn.textContent = 'View';
      btn.className = 'btn';
      btn.style.marginLeft='8px';
      btn.addEventListener('click', async ()=> { await viewBandMember(m.username); });
      d.appendChild(btn);
      el.appendChild(d);
    });
  }

  async function viewBandMember(username) {
    const p = await loadUserProfileFromCloud(username);
    if (!p) { alert('Could not load member profile'); return; }
    // Show their owned tracks in the list by temporarily replacing display context
    const prevOwned = ownedTracks;
    const prevViewing = currentUser;
    document.getElementById('djLabel').textContent = p.djName + ' (viewing)';
    document.getElementById('userMeta').textContent = '@' + p.username;
    // render songs using p.ownedTracks
    renderSongList(p.ownedTracks);
    // add a back button
    const back = document.createElement('button');
    back.textContent = 'Back to My Profile';
    back.className = 'btn';
    back.style.marginTop='8px';
    back.addEventListener('click', ()=>{
      document.getElementById('djLabel').textContent = currentUser.djName;
      document.getElementById('userMeta').textContent = '@' + currentUser.username;
      renderSongList();
      back.remove();
    });
    document.getElementById('bandArea').appendChild(back);
  }

  // --------- Songs loading (same endpoints) ---------
  async function loadSongs() {
    setStatus('Loading songs...');
    const endpoints = [
      'https://api.allorigins.win/raw?url=https://fortnitecontent-website-prod07.ol.epicgames.com/content/api/pages/fortnite-game/spark-tracks',
      'https://corsproxy.io/?https://fortnitecontent-website-prod07.ol.epicgames.com/content/api/pages/fortnite-game/spark-tracks'
    ];
    for (let i=0;i<endpoints.length;i++) {
      try {
        const r = await fetch(endpoints[i]);
        if (!r.ok) continue;
        const data = await r.json();
        songs = Object.entries(data)
          .filter(([k])=>!k.startsWith('_'))
          .map(([id,item])=>{
            const t = item.track;
            if (!t || !t.tt) return null;
            return {
              id,
              title: t.tt,
              artist: t.an||'Unknown',
              bpm: t.mt||0,
              key: t.mk||'?',
              mode: t.mm||'',
              camelot: '?',
              duration: t.dn||0,
              albumArt: t.au||'',
              genre: 'Other'
            };
          }).filter(s=>s && s.bpm>0);
        songs.sort((a,b)=>a.title.localeCompare(b.title));
        setStatus('Loaded '+songs.length+' songs');
        renderSongList();
        return;
      } catch(e){ console.warn('endpoint failed',e); continue; }
    }
    setStatus('Unable to load songs from API');
  }

  // --------- Rendering & UI ---------
  function setupButtons() {
    document.getElementById('showOwnedBtn').onclick = ()=> renderSongList(undefined,true);
    document.getElementById('showAllBtn').onclick = ()=> renderSongList();
    document.getElementById('markAllBtn').onclick = ()=> { ownedTracks = songs.map(s=>s.id); saveAndRerender(); };
    document.getElementById('clearAllBtn').onclick = ()=> { ownedTracks=[]; saveAndRerender(); };
    document.getElementById('exportBtn').onclick = exportCollection;
    document.getElementById('importBtn').onclick = importCollection;
    document.getElementById('searchInput').addEventListener('input', ()=> renderSongList());
  }

  function saveAndRerender() {
    if (currentUser) saveUserProfileToCloud({ username: currentUser.username, djName: currentUser.djName, ownedTracks, setlist, bandMembers, genreOverrides });
    saveLocal();
    renderSongList();
    renderSetlist();
    renderBand();
  }

  function renderSongList(ownedOverride, forceOwnedOnly=false) {
    const songList = document.getElementById('songList');
    const displayOwned = Array.isArray(ownedOverride) ? ownedOverride : ownedTracks;
    const q = document.getElementById('searchInput').value.trim().toLowerCase();
    const onlyOwned = forceOwnedOnly || false;
    songList.innerHTML = '';
    const filtered = songs.filter(s=> {
      const matchesSearch = !q || s.title.toLowerCase().includes(q) || s.artist.toLowerCase().includes(q);
      const matchesOwned = !onlyOwned || displayOwned.includes(s.id);
      return matchesSearch && matchesOwned;
    });
    filtered.forEach(s=>{
      const div = document.createElement('div');
      div.className='song';
      div.innerHTML = `<div style="width:48px;height:48px;background:#111;border-radius:6px"></div>
        <div style="flex:1">
          <div style="font-weight:700">${escapeHtml(s.title)}</div>
          <div class="small">${escapeHtml(s.artist)} • ${s.bpm} BPM</div>
        </div>`;
      const ownedBtn = document.createElement('button');
      ownedBtn.className='btn';
      ownedBtn.textContent = displayOwned.includes(s.id) ? '✓ Owned' : 'Mark Owned';
      ownedBtn.addEventListener('click', ()=> {
        if (displayOwned.includes(s.id)) { ownedTracks = ownedTracks.filter(x=>x!==s.id); } else { ownedTracks.push(s.id); }
        saveAndRerender();
      });
      const setBtn = document.createElement('button');
      setBtn.className='btn';
      setBtn.textContent = '+ Set';
      setBtn.addEventListener('click', ()=> {
        addToSetlist(s.id);
      });
      div.appendChild(ownedBtn);
      div.appendChild(setBtn);
      songList.appendChild(div);
    });
    if (!filtered.length) songList.innerHTML = '<div class="small">No tracks found</div>';
  }

  function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

  // --------- Setlist ---------
  function addToSetlist(songId) {
    const s = songs.find(x=>x.id===songId);
    if (!s) return;
    setlist.push(s);
    saveAndRerender();
  }
  function removeFromSetlist(songId) {
    setlist = setlist.filter(s=>s.id!==songId);
    saveAndRerender();
  }
  function renderSetlist() {
    const el = document.getElementById('setlistArea');
    if (!el) return;
    el.innerHTML='';
    if (!setlist.length) { el.innerHTML='<div class="small">Setlist is empty</div>'; return; }
    setlist.forEach((s,i)=>{
      const d = document.createElement('div');
      d.className='song';
      d.innerHTML = `<div style="font-weight:700">${i+1}. ${escapeHtml(s.title)}</div>`;
      const rm = document.createElement('button'); rm.className='btn'; rm.textContent='✕'; rm.addEventListener('click', ()=> removeFromSetlist(s.id));
      d.appendChild(rm);
      el.appendChild(d);
    });
    document.getElementById('setlistCount').textContent = setlist.length;
  }

  // --------- Import / Export (local file) ---------
  function exportCollection() {
    if (!currentUser) { alert('Sign in first'); return; }
    const data = { username: currentUser.username, djName: currentUser.djName, ownedTracks, setlist: setlist.map(s=>s.id), bandMembers, genreOverrides };
    const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `festival-mixer-${currentUser.username}.json`; a.click(); URL.revokeObjectURL(url);
  }

  function importCollection() {
    const input = document.createElement('input'); input.type='file'; input.accept='.json';
    input.onchange = async (e)=>{
      const f = e.target.files[0]; if (!f) return;
      const text = await f.text();
      try {
        const data = JSON.parse(text);
        if (confirm(`Import ${data.ownedTracks.length || 0} tracks from ${data.djName || data.username}? This will overwrite your owned list.`)) {
          ownedTracks = data.ownedTracks || [];
          setlist = (data.setlist||[]).map(id=> songs.find(s=>s.id===id)).filter(Boolean);
          bandMembers = data.bandMembers || [];
          genreOverrides = data.genreOverrides || {};
          await saveUserProfileToCloud({ username: currentUser.username, djName: currentUser.djName, ownedTracks, setlist, bandMembers, genreOverrides });
          saveLocal();
          renderSongList();
          renderSetlist();
          renderBand();
          alert('Import complete');
        }
      } catch(e){ alert('Invalid file'); }
    };
    input.click();
  }

  // --------- Utilities ---------
  // On load, check local cache; if present, show quick restore option
  window.addEventListener('load', ()=>{
    const cached = loadLocal();
    if (cached && cached.currentUser) {
      // Offer quick-restore
      const b = document.createElement('button');
      b.textContent = 'Restore cached profile (' + cached.currentUser.username + ')';
      b.className='btn';
      b.style.marginTop='8px';
      b.onclick = ()=> {
        currentUser = cached.currentUser;
        ownedTracks = cached.ownedTracks || [];
        setlist = cached.setlist || [];
        bandMembers = cached.bandMembers || [];
        genreOverrides = cached.genreOverrides || {};
        document.getElementById('loginCard').style.display='none';
        document.getElementById('appArea').style.display='block';
        document.getElementById('djLabel').textContent = currentUser.djName;
        document.getElementById('userMeta').textContent = '@' + currentUser.username;
        renderSongList();
        renderSetlist();
        renderBand();
        setupButtons();
      };
      document.getElementById('loginCard').appendChild(b);
    }
  });

  </script>
</body>
</html>
