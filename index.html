<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>FORTNITE JAM MIXER</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{min-height:100%}
    body{
      background:radial-gradient(circle at 10% 0%,#42275a 0,#14122a 40%,#050816 75%,#0b1f3b 100%);
      color:#e9f7ff;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      -webkit-font-smoothing:antialiased;
    }
    body::before{
      content:'';position:fixed;inset:0;z-index:-1;
      background:
        radial-gradient(circle at 8% 20%,rgba(255,107,157,.15),transparent 45%),
        radial-gradient(circle at 82% 80%,rgba(139,92,246,.18),transparent 50%),
        radial-gradient(circle at 50% 50%,rgba(0,217,255,.12),transparent 55%);
      filter:blur(22px);animation:bgShift 22s linear infinite;opacity:.85;pointer-events:none;
    }
    @keyframes bgShift{
      0%{transform:translate3d(0,0,0)}50%{transform:translate3d(0,-18px,0)}100%{transform:translate3d(0,0,0)}
    }
    .wrap{max-width:1300px;margin:0 auto;padding:16px}
    .panel{
      background:radial-gradient(circle at top left,rgba(24,31,68,.97),rgba(5,9,29,.99));
      border-radius:14px;border:1px solid rgba(148,163,184,.28);
      box-shadow:0 16px 40px rgba(0,0,0,.7);padding:14px;
    }
    .vinyl-spin{animation:spin 4s linear infinite}
    @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
    .graffiti-text{text-shadow:3px 3px 0 #ff6b9d,6px 6px 0 rgba(255,107,157,.22);letter-spacing:1px;}
    .btn{
      padding:6px 12px;border-radius:4px;
      background:linear-gradient(135deg,rgba(15,23,42,.98),rgba(30,64,175,.96));
      color:#e6f7ff;border:1px solid rgba(59,130,246,.5);cursor:pointer;
      font-size:11px;display:inline-flex;align-items:center;gap:5px;
      white-space:nowrap;box-shadow:0 4px 12px rgba(15,23,42,.7);transition:all .12s;
    }
    .btn:hover{background:linear-gradient(135deg,rgba(56,189,248,.98),rgba(59,130,246,.98));box-shadow:0 0 14px rgba(56,189,248,.7);}
    .btn.active{background:linear-gradient(135deg,rgba(0,217,255,.85),rgba(139,92,246,.85));border-color:rgba(0,217,255,.7);box-shadow:0 0 12px rgba(0,217,255,.5);}
    .camelot-pill{padding:3px 7px;border-radius:6px;font-weight:800;color:#fff;display:inline-block;font-size:10px;}
    .small-muted{color:rgba(230,247,255,.7);font-size:12px}

    /* Song card */
    .song-card{
      border-radius:10px;overflow:hidden;
      background:radial-gradient(circle at top left,rgba(24,31,68,.97),rgba(5,9,29,.99));
      border:1px solid rgba(148,163,184,.2);
      box-shadow:0 8px 24px rgba(0,0,0,.6);
      display:flex;flex-direction:column;
      transition:transform .12s,box-shadow .12s;
    }
    .song-card:hover{transform:translateY(-3px);box-shadow:0 14px 32px rgba(0,0,0,.8);}
    .song-card.owned-card{border-color:rgba(0,217,255,.45);}
    .song-card.selected-card{border-color:rgba(255,107,157,.7);box-shadow:0 0 18px rgba(255,107,157,.3);}

    .card-art{
      width:100%;aspect-ratio:1/1;background:#060a1f;
      position:relative;overflow:hidden;
      display:flex;align-items:center;justify-content:center;
    }
    .card-art img{width:100%;height:100%;object-fit:cover;display:block;position:absolute;inset:0;}
    .no-art{font-size:40px;opacity:.3;position:relative;z-index:1;}
    .art-badge{position:absolute;top:6px;right:6px;padding:3px 7px;border-radius:6px;font-weight:800;font-size:11px;color:#fff;box-shadow:0 2px 8px rgba(0,0,0,.7);}
    .owned-badge{position:absolute;top:6px;left:6px;background:rgba(0,217,255,.9);color:#020617;font-size:9px;font-weight:900;padding:2px 6px;border-radius:4px;letter-spacing:.05em;}
    .tier-badge{position:absolute;bottom:6px;right:6px;font-size:9px;font-weight:800;padding:2px 6px;border-radius:4px;color:#fff;box-shadow:0 2px 6px rgba(0,0,0,.6);}

    .card-body{padding:8px 8px 5px;flex:1;display:flex;flex-direction:column;gap:3px;}
    .card-title{font-weight:700;font-size:12px;line-height:1.25;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;}
    .card-artist{font-size:11px;color:rgba(230,247,255,.55);overflow:hidden;white-space:nowrap;text-overflow:ellipsis;}
    .card-meta{display:flex;align-items:center;gap:5px;flex-wrap:wrap;margin-top:2px;}
    .card-bpm{font-size:10px;color:rgba(230,247,255,.5);}

    .card-actions{display:grid;grid-template-columns:1fr 1fr;gap:4px;padding:0 8px 8px;}
    .card-btn{
      padding:4px 0;border-radius:3px;font-size:10px;font-weight:600;
      border:1px solid rgba(59,130,246,.35);color:#e6f7ff;cursor:pointer;
      background:rgba(15,23,42,.8);text-align:center;transition:all .1s;
    }
    .card-btn:hover{background:rgba(56,189,248,.25);border-color:rgba(56,189,248,.55);}
    .card-btn.owned-btn{background:rgba(0,217,255,.18);border-color:rgba(0,217,255,.45);color:#a5f3fc;}
    .card-btn.sel-active{background:rgba(255,107,157,.22);border-color:rgba(255,107,157,.55);color:#fda4af;}

    /* 5-column grid */
    .song-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;}
    @media(max-width:1100px){.song-grid{grid-template-columns:repeat(4,1fr);}}
    @media(max-width:820px){.song-grid{grid-template-columns:repeat(3,1fr);}}
    @media(max-width:540px){.song-grid{grid-template-columns:repeat(2,1fr);}}

    /* Pagination */
    .page-btn{padding:6px 14px;border-radius:6px;font-size:12px;font-weight:700;background:rgba(15,23,42,.9);border:1px solid rgba(59,130,246,.4);color:#e6f7ff;cursor:pointer;transition:all .12s;}
    .page-btn:hover{background:rgba(56,189,248,.2);border-color:rgba(56,189,248,.6);}
    .page-btn.cur{background:rgba(0,217,255,.2);border-color:rgba(0,217,255,.6);color:#67e8f9;}
    .page-btn:disabled{opacity:.3;cursor:default;}

    /* Loading */
    #loadingScreen{position:fixed;inset:0;z-index:30000;background:radial-gradient(circle at 10% 0%,#42275a 0,#14122a 40%,#050816 75%,#0b1f3b 100%);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;}

    /* Preview modal */
    #previewModal{display:none;position:fixed;inset:0;z-index:20000;background:rgba(3,6,20,.88);backdrop-filter:blur(6px);align-items:center;justify-content:center;}
    .preview-box{width:92%;max-width:500px;border-radius:18px;border:2px solid rgba(0,217,255,.3);background:radial-gradient(circle at top left,rgba(56,189,248,.12),rgba(10,15,40,.99));box-shadow:0 24px 60px rgba(0,0,0,.85);padding:20px;}

    /* Help modal */
    #helpModal{display:none;position:fixed;inset:0;z-index:19000;background:rgba(3,6,20,.9);backdrop-filter:blur(8px);align-items:center;justify-content:center;}
    .help-box{width:92%;max-width:700px;max-height:84vh;border-radius:18px;border:2px solid rgba(0,217,255,.22);background:radial-gradient(circle at top left,rgba(56,189,248,.1),rgba(10,15,40,.99));box-shadow:0 24px 60px rgba(0,0,0,.85);display:flex;flex-direction:column;overflow:hidden;}
    .help-head{padding:12px 16px;border-bottom:1px solid rgba(148,163,184,.3);background:linear-gradient(120deg,rgba(15,23,42,.98),rgba(30,64,175,.85));display:flex;align-items:center;justify-content:space-between;}
    .help-body{padding:16px 18px;overflow-y:auto;font-size:13px;line-height:1.55;color:#e5f3ff;}
    .help-body h3{font-size:15px;font-weight:800;color:#a5f3fc;margin:14px 0 6px;}
    .help-body p,.help-body li{color:rgba(230,247,255,.75);margin-bottom:4px;}
    .help-body ul,.help-body ol{margin-left:16px;}
    .help-diagram{margin:8px 0;padding:10px 12px;border-radius:8px;background:rgba(15,23,42,.8);border:1px solid rgba(56,189,248,.4);}

    /* Setlist */
    .setlist-row{display:flex;align-items:center;justify-content:space-between;padding:6px 10px;border-radius:8px;margin-bottom:4px;background:rgba(15,23,42,.6);border:1px solid rgba(148,163,184,.15);font-size:12px;}
  </style>
</head>
<body>

<!-- Loading -->
<div id="loadingScreen">
  <div class="vinyl-spin" style="width:64px;height:64px;background:conic-gradient(from 160deg,#22d3ee,#8b5cf6,#f97316,#22d3ee);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:28px;">üéµ</div>
  <div style="font-size:20px;font-weight:800;color:#e9f7ff" class="graffiti-text">FORTNITE JAM MIXER</div>
  <div id="loadStatus" class="small-muted">Fetching tracks from Epic Games...</div>
</div>

<!-- Preview Modal -->
<div id="previewModal">
  <div class="preview-box">
    <div id="previewContent"></div>
    <button class="btn mt-4" style="width:100%;justify-content:center;font-size:13px;margin-top:14px" onclick="closePreview()">‚úï Close</button>
  </div>
</div>

<!-- Help Modal -->
<div id="helpModal">
  <div class="help-box">
    <div class="help-head">
      <div style="display:flex;align-items:center;gap:10px">
        <div style="width:38px;height:38px;border-radius:10px;background:conic-gradient(from 210deg,#22d3ee,#8b5cf6,#f97316,#22d3ee);display:flex;align-items:center;justify-content:center;font-size:18px">üéß</div>
        <div>
          <div style="font-size:15px;font-weight:900" class="graffiti-text">JAM MIXER GUIDE</div>
          <div style="font-size:11px;color:#bfdbfe">Build harmonic Fortnite Festival setlists</div>
        </div>
      </div>
      <button class="btn" onclick="closeHelp()">‚úï Close</button>
    </div>
    <div class="help-body">
      <h3>üéØ What This Does</h3>
      <p>Browse every Fortnite Festival track, mark what you own, and find songs that mix together using the <strong>Camelot Wheel</strong> ‚Äî the same system pro DJs use. Everything saves to your device. No login needed.</p>
      <h3>üé° Camelot Wheel (Key Matching)</h3>
      <div class="help-diagram">
        <div style="color:#a5f3fc;font-size:11px;font-weight:700;margin-bottom:6px">TIER RULES</div>
        <ul>
          <li><strong>Tier 1</strong> ‚Äî Same code (8A ‚Üí 8A). Perfectly smooth blend.</li>
          <li><strong>Tier 2</strong> ‚Äî Same letter ¬±1 number (8A ‚Üí 7A or 9A). Very good.</li>
          <li><strong>Tier 3</strong> ‚Äî Same number, swap letter (8A ‚Üí 8B). Safe key change.</li>
        </ul>
      </div>
      <h3>üÉè Song Cards</h3>
      <ul>
        <li><strong>Select</strong> ‚Äî Sets this as your main track. All cards show how well they match it.</li>
        <li><strong>Preview</strong> ‚Äî Full compatibility breakdown vs your selected track.</li>
        <li><strong>Own?</strong> / <strong>‚úì Owned</strong> ‚Äî Marks that you own this. Saves to your device.</li>
        <li><strong>+ Setlist</strong> ‚Äî Adds to your planned setlist below.</li>
      </ul>
      <p>The <strong>colored pill</strong> top-right = Camelot key. The <strong>T1/T2/T3</strong> badge bottom-right = match tier vs your selected track.</p>
      <h3>üéõ Controls</h3>
      <ul>
        <li><strong>Search</strong> ‚Äî Filter by title, artist, or genre.</li>
        <li><strong>Show Mixable</strong> ‚Äî Only show harmonically compatible tracks.</li>
        <li><strong>Owned Only</strong> ‚Äî Show just tracks you've marked owned.</li>
        <li><strong>Camelot Tier</strong> ‚Äî How strict the key filter is (T1 ‚Üí T1+T2 ‚Üí All).</li>
        <li><strong>Priority</strong> ‚Äî Sort by overall match score (Tempo) or key tier first (Camelot).</li>
      </ul>
      <h3>‚ö° Quick Start</h3>
      <ol>
        <li>Page through the library and click <strong>Own?</strong> on every track you have.</li>
        <li>Pick a favorite ‚Üí click <strong>Select</strong>.</li>
        <li>Hit <strong>Show Mixable</strong> to see what blends with it.</li>
        <li>Click <strong>Preview</strong> on any track for the full mix breakdown.</li>
        <li>Add good picks to your <strong>Setlist</strong>.</li>
      </ol>
    </div>
  </div>
</div>

<!-- App -->
<div id="appWrapper" style="display:none">
<div class="wrap">

  <!-- Header -->
  <div class="panel" style="margin-bottom:14px">
    <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px">
      <div style="display:flex;align-items:center;gap:12px">
        <div class="vinyl-spin" style="width:52px;height:52px;background:conic-gradient(from 160deg,#22d3ee,#8b5cf6,#f97316,#22d3ee);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0">üéµ</div>
        <div>
          <div style="font-size:20px;font-weight:900" class="graffiti-text">FORTNITE JAM MIXER</div>
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:3px">
            <span id="ownedCounter" class="small-muted" style="background:rgba(0,217,255,.08);border:1px solid rgba(0,217,255,.25);border-radius:20px;padding:2px 10px">Owned: 0 / 0</span>
            <span id="songCount" class="small-muted"></span>
          </div>
        </div>
      </div>
      <button class="btn" onclick="openHelp()">‚ùì Help</button>
    </div>
  </div>

  <!-- Controls -->
  <div class="panel" style="margin-bottom:14px">
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <input id="searchInput" placeholder="üîç Search title, artist, genre..." style="flex:1;min-width:180px;padding:7px 12px;border-radius:6px;background:rgba(0,0,0,.4);border:1px solid rgba(0,217,255,.2);color:#e9f7ff;font-size:12px;outline:none"/>
      <button id="mixableBtn" class="btn" onclick="toggleMixable()">Show Mixable</button>
      <button id="ownedFilterBtn" class="btn" onclick="toggleOwnedFilter()">Show All</button>
      <button id="camelotBtn" class="btn" onclick="cycleCamelot()">Camelot: All Tiers</button>
      <button id="priorityBtn" class="btn" onclick="togglePriority()">Priority: Tempo</button>
      <button class="btn" onclick="clearSelection()">Clear Sel.</button>
    </div>
    <div id="selBar" style="display:none;margin-top:8px;font-size:12px;color:#a5f3fc">
      üéµ Selected: <strong id="selInfo"></strong> ‚Äî click Preview on any card to compare
    </div>
  </div>

  <!-- Song Browser -->
  <div class="panel" style="margin-bottom:14px">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:8px">
      <div style="font-size:14px;font-weight:700">üéµ Song Browser</div>
      <div id="pageInfo" class="small-muted"></div>
    </div>
    <div id="songGrid" class="song-grid"></div>
    <div id="noResults" style="display:none;text-align:center;padding:32px;color:rgba(230,247,255,.45);font-size:14px">No tracks match your filters.</div>
    <div id="pagination" style="display:flex;align-items:center;justify-content:center;gap:6px;margin-top:18px;flex-wrap:wrap"></div>
  </div>

  <!-- Setlist -->
  <div class="panel" style="margin-bottom:16px">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
      <div style="font-size:14px;font-weight:700">üìã Setlist (<span id="setlistCount">0</span>)</div>
      <button class="btn" onclick="clearSetlist()">Clear</button>
    </div>
    <div id="setlistContent"><div class="small-muted">Add songs using "+ Setlist" on any card.</div></div>
  </div>

</div>
</div>

<script>
/* ‚îÄ‚îÄ Camelot ‚îÄ‚îÄ */
const CC={
  "1A":"#FF6B9D","1B":"#FF8FAB","2A":"#FFA07A","2B":"#FFB699",
  "3A":"#FFD700","3B":"#FFE55C","4A":"#98D8C8","4B":"#7FD8BE",
  "5A":"#6BCB77","5B":"#8FD89F","6A":"#4D96FF","6B":"#6FB1FF",
  "7A":"#9D4EDD","7B":"#B877FF","8A":"#E84A5F","8B":"#FF6B81",
  "9A":"#00D9FF","9B":"#4DFFFF","10A":"#FFA400","10B":"#FFBB5C",
  "11A":"#FE6D73","11B":"#FF8C94","12A":"#A8E6CF","12B":"#C1F0DD"
};
const K2C={
  "C":"8B","Am":"8A","A Minor":"8A","C Major":"8B",
  "G":"9B","Em":"9A","E Minor":"9A","G Major":"9B",
  "D":"10B","Bm":"10A","B Minor":"10A","D Major":"10B",
  "A":"11B","F#m":"11A","F# Minor":"11A","A Major":"11B",
  "E":"12B","C#m":"12A","C# Minor":"12A","E Major":"12B",
  "B":"1B","G#m":"1A","G# Minor":"1A","B Major":"1B",
  "F#":"2B","D#m":"2A","D# Minor":"2A","F# Major":"2B",
  "Db":"3B","Bbm":"3A","Bb Minor":"3A","Db Major":"3B",
  "Ab":"4B","Fm":"4A","F Minor":"4A","Ab Major":"4B",
  "Eb":"5B","Cm":"5A","C Minor":"5A","Eb Major":"5B",
  "Bb":"6B","Gm":"6A","G Minor":"6A","Bb Major":"6B",
  "F":"7B","Dm":"7A","D Minor":"7A","F Major":"7B"
};
const toCam=k=>K2C[(k||"").trim()]||"?";

function camTier(a,b){
  if(!a||!b||a==="?"||b==="?")return 99;
  const ma=a.match(/^(\d+)([AB])$/),mb=b.match(/^(\d+)([AB])$/);
  if(!ma||!mb)return 99;
  const na=+ma[1],la=ma[2],nb=+mb[1],lb=mb[2];
  if(na===nb&&la===lb)return 1;
  if(la===lb&&(Math.abs(na-nb)===1||Math.abs(na-nb)===11))return 2;
  if(na===nb&&la!==lb)return 3;
  return 99;
}

function compat(a,b){
  const t=camTier(a.camelot,b.camelot);
  const ks=t===1?40:t===2?30:t===3?20:0;
  const d=Math.abs(a.bpm-b.bpm);
  const bs=d<=1?40:d<=3?35:d<=6?25:d<=10?15:0;
  const gs=(a.genre&&a.genre===b.genre)?20:0;
  return{total:ks+bs+gs,tier:t,bpmDiff:d};
}

/* ‚îÄ‚îÄ State ‚îÄ‚îÄ */
const PER_PAGE=15;
let songs=[],filtered=[];
let owned=JSON.parse(localStorage.getItem("fjm_owned")||"[]");
let setlist=JSON.parse(localStorage.getItem("fjm_setlist")||"[]");
let selected=null,showMixable=false,showOwnedOnly=false;
let camLevel=3,priority="tempo",page=1;

/* ‚îÄ‚îÄ Filter ‚îÄ‚îÄ */
function applyFilters(){
  const q=(document.getElementById("searchInput")?.value||"").trim().toLowerCase();
  filtered=songs.filter(s=>{
    if(q&&!(s.title.toLowerCase().includes(q)||s.artist.toLowerCase().includes(q)||(s.genre||"").toLowerCase().includes(q)))return false;
    if(showOwnedOnly&&!owned.includes(s.id))return false;
    if(showMixable&&selected){
      const t=camTier(selected.camelot,s.camelot);
      if(t>camLevel||Math.abs(s.bpm-selected.bpm)>8)return false;
    }
    return true;
  });
  if(selected){
    filtered.sort((a,b)=>{
      const ca=compat(selected,a),cb=compat(selected,b);
      if(priority==="camelot"&&ca.tier!==cb.tier)return ca.tier-cb.tier;
      if(cb.total!==ca.total)return cb.total-ca.total;
      return Math.abs(a.bpm-selected.bpm)-Math.abs(b.bpm-selected.bpm);
    });
  }else{
    filtered.sort((a,b)=>a.title.localeCompare(b.title));
  }
  page=1;renderPage();
}

/* ‚îÄ‚îÄ Render ‚îÄ‚îÄ */
function renderPage(){
  const grid=document.getElementById("songGrid");
  const noEl=document.getElementById("noResults");
  const pagEl=document.getElementById("pagination");
  const info=document.getElementById("pageInfo");
  if(!filtered.length){grid.innerHTML="";noEl.style.display="block";pagEl.innerHTML="";info.textContent="";return;}
  noEl.style.display="none";
  const total=Math.ceil(filtered.length/PER_PAGE);
  const slice=filtered.slice((page-1)*PER_PAGE,page*PER_PAGE);
  info.textContent=`Page ${page} of ${total} ‚Ä¢ ${filtered.length} tracks`;
  grid.innerHTML=slice.map(buildCard).join("");
  pagEl.innerHTML=buildPager(page,total);
  window.scrollTo({top:0,behavior:"smooth"});
}

function buildCard(s){
  const kc=CC[s.camelot]||"#4b5563";
  const isOwned=owned.includes(s.id);
  const isSel=selected&&selected.id===s.id;
  const c=selected&&!isSel?compat(selected,s):null;
  const t=c?c.tier:null;
  const tierBg=t===1?"#22c55e":t===2?"#f59e0b":t===3?"#6366f1":"";
  const tierLbl=t===1?"T1 ‚úì":t===2?"T2":t===3?"T3":"";
  const scoreColor=c?(c.total>=70?"#4ade80":c.total>=45?"#facc15":"#f87171"):null;
  const art=s.albumArt||"";
  const safeArt=art.replace(/"/g,"&quot;");

  return `<div class="song-card${isOwned?" owned-card":""}${isSel?" selected-card":""}">
  <div class="card-art">
    ${art?`<img src="${safeArt}" loading="lazy" alt="" onerror="this.style.display='none'">`:`<div class="no-art">üéµ</div>`}
    <div class="art-badge" style="background:${kc}">${s.camelot||"?"}</div>
    ${isOwned?`<div class="owned-badge">OWNED</div>`:""}
    ${tierLbl?`<div class="tier-badge" style="background:${tierBg}">${tierLbl}</div>`:""}
  </div>
  <div class="card-body">
    <div class="card-title">${s.title}</div>
    <div class="card-artist">${s.artist}</div>
    <div class="card-meta">
      <span class="card-bpm">${s.bpm} BPM</span>
      ${c?`<span style="font-size:10px;font-weight:700;color:${scoreColor}">${Math.round(c.total)}%</span>`:""}
      ${c?`<span style="font-size:10px;color:rgba(230,247,255,.45)">¬±${c.bpmDiff}</span>`:""}
    </div>
  </div>
  <div class="card-actions">
    <button class="card-btn${isSel?" sel-active":""}" onclick="selectSong('${s.id}')">${isSel?"‚úì Sel":"Select"}</button>
    <button class="card-btn" onclick="previewClick('${s.id}')">Preview</button>
    <button class="card-btn${isOwned?" owned-btn":""}" onclick="toggleOwned('${s.id}')">${isOwned?"‚úì Owned":"Own?"}</button>
    <button class="card-btn" onclick="addSetlist('${s.id}')">+ Setlist</button>
  </div>
</div>`;
}

function buildPager(cur,total){
  if(total<=1)return"";
  let h=`<button class="page-btn" onclick="goPage(${cur-1})" ${cur<=1?"disabled":""}>‚Äπ Prev</button>`;
  let ps=[];
  if(total<=7){for(let i=1;i<=total;i++)ps.push(i);}
  else{
    ps=[1];
    if(cur>3)ps.push("‚Ä¶");
    for(let i=Math.max(2,cur-1);i<=Math.min(total-1,cur+1);i++)ps.push(i);
    if(cur<total-2)ps.push("‚Ä¶");
    ps.push(total);
  }
  ps.forEach(p=>{
    if(p==="‚Ä¶")h+=`<span style="color:rgba(230,247,255,.35);padding:0 4px">‚Ä¶</span>`;
    else h+=`<button class="page-btn${p===cur?" cur":""}" onclick="goPage(${p})">${p}</button>`;
  });
  h+=`<button class="page-btn" onclick="goPage(${cur+1})" ${cur>=total?"disabled":""}>Next ‚Ä∫</button>`;
  return h;
}

function goPage(n){
  const total=Math.ceil(filtered.length/PER_PAGE);
  if(n<1||n>total)return;
  page=n;renderPage();
}

/* ‚îÄ‚îÄ Actions ‚îÄ‚îÄ */
function selectSong(id){
  const s=songs.find(x=>x.id===id);
  if(!s)return;
  selected=(selected&&selected.id===id)?null:s;
  const bar=document.getElementById("selBar");
  if(selected){bar.style.display="block";document.getElementById("selInfo").textContent=`${selected.title} ‚Äî ${selected.artist}`;}
  else bar.style.display="none";
  applyFilters();
}

function toggleOwned(id){
  owned=owned.includes(id)?owned.filter(x=>x!==id):[...owned,id];
  localStorage.setItem("fjm_owned",JSON.stringify(owned));
  updateCounter();applyFilters();
}

function previewClick(id){
  const s=songs.find(x=>x.id===id);if(!s)return;
  if(!selected){selectSong(id);openPreview(null,s,null);return;}
  if(selected.id===id){openPreview(null,s,null);return;}
  openPreview(selected,s,compat(selected,s));
}

function openPreview(main,track,c){
  const kc=CC[track.camelot]||"#4b5563";
  const art=track.albumArt||"";
  let h=`<div style="display:flex;gap:14px;margin-bottom:16px;align-items:flex-start">
    <div style="width:80px;height:80px;flex-shrink:0;border:2px solid ${kc};overflow:hidden;display:flex;align-items:center;justify-content:center;background:#060a1f;border-radius:4px">
      ${art?`<img src="${art.replace(/"/g,"&quot;")}" style="width:100%;height:100%;object-fit:cover" onerror="this.style.display='none'" alt="">`:`<div style="font-size:32px;opacity:.3">üéµ</div>`}
    </div>
    <div>
      <div style="font-size:16px;font-weight:800;margin-bottom:4px">${track.title}</div>
      <div class="small-muted">${track.artist}</div>
      <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
        <span class="camelot-pill" style="background:${kc}">${track.camelot}</span>
        <span class="small-muted">${track.bpm} BPM</span>
        <span class="small-muted">${track.genre||"Other"}</span>
      </div>
    </div>
  </div>`;

  if(!main){
    h+=`<div style="text-align:center;padding:12px;color:rgba(230,247,255,.55);font-size:13px">‚úì Now your main track. Click Preview on another song to compare.</div>`;
  }else{
    const bshift=track.bpm-main.bpm;
    const shiftStr=bshift===0?"No shift":(bshift>0?"+":"")+Math.round(bshift)+" BPM";
    const tLbl=c.tier===1?"Perfect (T1)":c.tier===2?"Great (T2)":c.tier===3?"Good (T3)":"Different key";
    const sColor=c.total>=70?"#4ade80":c.total>=45?"#facc15":"#f87171";
    h+=`<div style="border-top:1px solid rgba(148,163,184,.2);padding-top:14px">
      <div class="small-muted" style="margin-bottom:12px">Mixing with: <strong style="color:#67e8f9">${main.title}</strong> &nbsp;${main.camelot} ‚Ä¢ ${main.bpm} BPM</div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;text-align:center;margin-bottom:14px">
        <div style="background:rgba(15,23,42,.8);border:1px solid rgba(56,189,248,.3);border-radius:10px;padding:12px">
          <div style="font-size:22px;font-weight:900;color:${sColor}">${Math.round(c.total)}%</div>
          <div class="small-muted" style="font-size:10px;margin-top:2px">Match Score</div>
        </div>
        <div style="background:rgba(15,23,42,.8);border:1px solid rgba(56,189,248,.3);border-radius:10px;padding:12px">
          <div style="font-size:13px;font-weight:700;color:#a5f3fc">${tLbl}</div>
          <div class="small-muted" style="font-size:10px;margin-top:2px">Key Match</div>
        </div>
        <div style="background:rgba(15,23,42,.8);border:1px solid rgba(56,189,248,.3);border-radius:10px;padding:12px">
          <div style="font-size:14px;font-weight:700">¬±${c.bpmDiff}</div>
          <div class="small-muted" style="font-size:10px;margin-top:2px">${shiftStr}</div>
        </div>
      </div>
      ${c.total>=70
        ?`<div style="background:rgba(74,222,128,.08);border:1px dashed rgba(74,222,128,.5);border-radius:8px;padding:10px;font-size:12px;color:#86efac">üî• <strong>Great mix!</strong> These tracks should blend smoothly.</div>`
        :c.total>=45
        ?`<div style="background:rgba(250,204,21,.08);border:1px dashed rgba(250,204,21,.4);border-radius:8px;padding:10px;font-size:12px;color:#fde68a">‚ö° <strong>Decent match.</strong> May need a transition beat.</div>`
        :`<div style="background:rgba(248,113,113,.08);border:1px dashed rgba(248,113,113,.4);border-radius:8px;padding:10px;font-size:12px;color:#fca5a5">‚ö†Ô∏è <strong>Tough mix.</strong> Very different key/BPM ‚Äî works as a contrast drop.</div>`}
    </div>`;
  }
  document.getElementById("previewContent").innerHTML=h;
  document.getElementById("previewModal").style.display="flex";
}
function closePreview(){document.getElementById("previewModal").style.display="none";}

function addSetlist(id){
  const s=songs.find(x=>x.id===id);
  if(!s||setlist.find(x=>x.id===id))return;
  setlist.push(s);
  localStorage.setItem("fjm_setlist",JSON.stringify(setlist));
  renderSetlist();
}
function removeSetlist(id){
  setlist=setlist.filter(x=>x.id!==id);
  localStorage.setItem("fjm_setlist",JSON.stringify(setlist));
  renderSetlist();
}
function clearSetlist(){
  if(setlist.length&&!confirm("Clear entire setlist?"))return;
  setlist=[];localStorage.setItem("fjm_setlist","[]");renderSetlist();
}
function renderSetlist(){
  const el=document.getElementById("setlistContent");
  document.getElementById("setlistCount").textContent=setlist.length;
  if(!setlist.length){el.innerHTML='<div class="small-muted">Add songs using "+ Setlist" on any card.</div>';return;}
  el.innerHTML=setlist.map((s,i)=>{
    const kc=CC[s.camelot]||"#4b5563";
    return `<div class="setlist-row">
      <div style="display:flex;align-items:center;gap:8px;flex:1;min-width:0">
        <span class="camelot-pill" style="background:${kc};flex-shrink:0">${s.camelot}</span>
        <div style="min-width:0">
          <div style="font-weight:600;font-size:12px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis">${i+1}. ${s.title}</div>
          <div class="small-muted" style="font-size:11px">${s.artist} ‚Ä¢ ${s.bpm} BPM</div>
        </div>
      </div>
      <button class="btn" style="padding:3px 8px;font-size:11px;flex-shrink:0" onclick="removeSetlist('${s.id}')">‚úï</button>
    </div>`;
  }).join("");
}

/* ‚îÄ‚îÄ Controls ‚îÄ‚îÄ */
function toggleMixable(){
  if(!selected){alert("Select a song first.");return;}
  showMixable=!showMixable;
  const b=document.getElementById("mixableBtn");
  b.textContent=showMixable?"üéß Mixable Only":"Show Mixable";
  b.classList.toggle("active",showMixable);
  applyFilters();
}
function toggleOwnedFilter(){
  showOwnedOnly=!showOwnedOnly;
  const b=document.getElementById("ownedFilterBtn");
  b.textContent=showOwnedOnly?"‚úì Owned Only":"Show All";
  b.classList.toggle("active",showOwnedOnly);
  applyFilters();
}
function clearSelection(){
  selected=null;showMixable=false;
  document.getElementById("selBar").style.display="none";
  const mb=document.getElementById("mixableBtn");
  if(mb){mb.textContent="Show Mixable";mb.classList.remove("active");}
  applyFilters();
}
function cycleCamelot(){
  camLevel=camLevel>=3?1:camLevel+1;
  const l={1:"Camelot: Tier 1",2:"Camelot: Tiers 1‚Äì2",3:"Camelot: All Tiers"};
  document.getElementById("camelotBtn").textContent=l[camLevel];
  applyFilters();
}
function togglePriority(){
  priority=priority==="tempo"?"camelot":"tempo";
  document.getElementById("priorityBtn").textContent=priority==="tempo"?"Priority: Tempo":"Priority: Camelot";
  applyFilters();
}
function updateCounter(){
  document.getElementById("ownedCounter").textContent=`Owned: ${owned.length} / ${songs.length}`;
}
function openHelp(){document.getElementById("helpModal").style.display="flex";}
function closeHelp(){document.getElementById("helpModal").style.display="none";}

/* ‚îÄ‚îÄ Genre ‚îÄ‚îÄ */
const GM={"Rock":["foo fighters","nirvana","pearl jam","soundgarden","alice in chains","red hot chili peppers","radiohead","muse"],"Pop":["taylor swift","ariana grande","billie eilish","dua lipa","lady gaga"],"Electronic":["daft punk","deadmau5","skrillex","diplo","zedd","avicii"]};
function detectGenre(a,t){
  const al=(a||"").toLowerCase(),tl=(t||"").toLowerCase();
  for(const[g,l] of Object.entries(GM)){if(l.some(x=>al.includes(x)||tl.includes(x)))return g;}
  if(tl.includes("rock"))return"Rock";if(tl.includes("electr"))return"Electronic";return"Other";
}

/* ‚îÄ‚îÄ Art extraction ‚Äî try every known field ‚îÄ‚îÄ */
function extractArt(t){
  const BASE="https://fortnitecontent-website-prod07.ol.epicgames.com";
  const fix=u=>{
    if(!u||typeof u!=="string")return"";
    u=u.trim();
    if(u.startsWith("//"))u="https:"+u;
    if(u.startsWith("/"))u=BASE+u;
    return u.startsWith("http")?u:"";
  };
  // Check all scalar fields
  for(const k of["au","at","ab","si","ti","im","albumArt","art","cover","thumbnail","image","sq","su","pi"]){
    const v=fix(t[k]);if(v)return v;
  }
  // Nested arrays
  if(Array.isArray(t.images)&&t.images.length){
    const img=t.images[0];
    if(typeof img==="string"){const v=fix(img);if(v)return v;}
    if(img&&img.url){const v=fix(img.url);if(v)return v;}
  }
  return"";
}

/* ‚îÄ‚îÄ Load songs ‚îÄ‚îÄ */
async function loadSongs(){
  const TARGET="https://fortnitecontent-website-prod07.ol.epicgames.com/content/api/pages/fortnite-game/spark-tracks";
  const PROXIES=[
    "https://api.allorigins.win/raw?url="+encodeURIComponent(TARGET),
    "https://corsproxy.io/?"+encodeURIComponent(TARGET)
  ];
  for(const url of PROXIES){
    try{
      document.getElementById("loadStatus").textContent="Connecting... "+url.slice(8,30);
      const controller=new AbortController();
      const timer=setTimeout(()=>controller.abort(),14000);
      const res=await fetch(url,{signal:controller.signal}).finally(()=>clearTimeout(timer));
      if(!res.ok)continue;
      const data=await res.json();
      const parsed=Object.entries(data)
        .filter(([k])=>!k.startsWith("_"))
        .map(([id,item])=>{
          const t=item.track||item||{};
          if(!t.tt)return null;
          return{
            id,title:t.tt,artist:t.an||"Unknown",
            bpm:Number(t.mt)||0,
            camelot:toCam(t.mk||""),
            albumArt:extractArt(t),
            genre:detectGenre(t.an||"",t.tt)
          };
        })
        .filter(s=>s&&s.bpm>0);
      if(parsed.length>0){
        songs=parsed.sort((a,b)=>a.title.localeCompare(b.title));
        document.getElementById("songCount").textContent=`${songs.length} tracks`;
        launch();return;
      }
    }catch(e){console.warn("Proxy failed",url,e);}
  }
  // Demo fallback
  songs=[
    {id:"s1",title:"Bad Guy",artist:"Billie Eilish",bpm:135,camelot:"8B",albumArt:"",genre:"Pop"},
    {id:"s2",title:"Need You Tonight",artist:"INXS",bpm:115,camelot:"8A",albumArt:"",genre:"Rock"},
    {id:"s3",title:"Electric Night",artist:"Daft Sample",bpm:128,camelot:"10B",albumArt:"",genre:"Electronic"},
    {id:"s4",title:"Slow Burn",artist:"Indie Star",bpm:95,camelot:"9A",albumArt:"",genre:"Other"},
    {id:"s5",title:"Drop The Bass",artist:"SkrillSample",bpm:142,camelot:"11A",albumArt:"",genre:"Electronic"}
  ];
  document.getElementById("songCount").textContent="5 demo tracks (API unavailable)";
  launch();
}

function launch(){
  document.getElementById("loadingScreen").style.display="none";
  document.getElementById("appWrapper").style.display="block";
  updateCounter();applyFilters();renderSetlist();
  document.getElementById("searchInput").addEventListener("input",()=>{page=1;applyFilters();});
}

loadSongs();
</script>
</body>
</html>
