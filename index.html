<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FESTIVAL JAM MIXER</title>

  <!-- Tailwind (utility classes mostly for layout) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase config injected from Vercel env vars -->
  <script src="/api/firebase-config.js"></script>

  <!-- Firebase Compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics-compat.js"></script>

  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      background:radial-gradient(circle at 10% 0%,#42275a 0,#14122a 40%,#050816 75%,#0b1f3b 100%);
      color:#e9f7ff;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    body:before{
      content:'';
      position:fixed;
      inset:0;
      z-index:-1;
      background:
        radial-gradient(circle at 8% 20%,rgba(255,107,157,.15),transparent 45%),
        radial-gradient(circle at 82% 80%,rgba(139,92,246,.18),transparent 50%),
        radial-gradient(circle at 50% 50%,rgba(0,217,255,.12),transparent 55%);
      filter:blur(22px);
      animation:bgShift 22s linear infinite;
      opacity:.85;
      pointer-events:none;
    }
    @keyframes bgShift{
      0%{transform:translate3d(0,0,0)}
      50%{transform:translate3d(0,-18px,0)}
      100%{transform:translate3d(0,0,0)}
    }
    .content-wrapper{max-width:1200px;margin:18px auto;padding:12px}
    .panel{
      background:radial-gradient(circle at top left,rgba(24,31,68,.97),rgba(5,9,29,.99));
      border-radius:16px;
      border:1px solid rgba(148,163,184,0.28);
      box-shadow:0 20px 50px rgba(0,0,0,.75);
      padding:14px;
    }
    .vinyl-spin{animation:spin 4s linear infinite}
    @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
    .graffiti-text{
      text-shadow:3px 3px 0 #ff6b9d,6px 6px 0 rgba(255,107,157,.22);
      letter-spacing:1px;
    }
    .camelot-pill{
      padding:4px 8px;
      border-radius:8px;
      font-weight:700;
      color:#fff;
      display:inline-block;
      font-size:10px;
    }
    .small-muted{color:rgba(230,247,255,.75);font-size:13px}
    .energy-bar{height:12px;border-radius:8px;background:rgba(255,255,255,0.06);overflow:hidden}
    .sandbox-drop{min-height:110px;border-radius:12px;padding:10px;border:2px dashed rgba(255,255,255,0.08)}
    .song-card{
      transition:box-shadow .12s,transform .12s;
      overflow:hidden;
      border-radius:0; /* sharp edges for song card */
      min-height:300px; /* H2-ish */
    }
    .song-card:hover{
      transform:translateY(-4px);
      box-shadow:0 16px 32px rgba(0,0,0,.75);
    }
    .btn{
      padding:7px 13px;
      border-radius:4px; /* square-ish DJ style */
      background:linear-gradient(135deg,rgba(15,23,42,0.98),rgba(30,64,175,0.96));
      color:#e6f7ff;
      border:1px solid rgba(59,130,246,0.5);
      cursor:pointer;
      font-size:12px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
      box-shadow:0 8px 18px rgba(15,23,42,0.7);
    }
    .btn:hover{
      background:linear-gradient(135deg,rgba(56,189,248,0.98),rgba(59,130,246,0.98));
      box-shadow:0 0 14px rgba(56,189,248,0.7);
    }
    .art-tile{
      width:96px;
      height:96px;
      border-radius:0; /* square art */
      position:relative;
      overflow:hidden;
      flex:0 0 96px;
      background:#050816;
      border:2px solid #3b82f6;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .art-tile img{width:100%;height:100%;object-fit:cover;display:block}

    /* Help modal */
    #helpModal{
      display:none;
      position:fixed;
      inset:0;
      z-index:20000;
      background:radial-gradient(circle at top,rgba(15,23,42,.96),rgba(3,6,20,.98));
      backdrop-filter:blur(8px);
      align-items:center;
      justify-content:center;
    }
    .helpBox{
      width:92%;
      max-width:880px;
      height:82vh;
      border-radius:18px;
      border:2px solid rgba(0,217,255,.22);
      background:radial-gradient(circle at top left,rgba(56,189,248,.2),rgba(15,23,42,.98));
      box-shadow:0 24px 60px rgba(0,0,0,.85);
      padding:0;
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .helpHeader{
      padding:12px 16px;
      border-bottom:1px solid rgba(148,163,184,.4);
      background:linear-gradient(120deg,rgba(15,23,42,.98),rgba(30,64,175,.85));
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .helpTitle{display:flex;gap:10px;align-items:center}
    .helpContent{padding:14px 18px;overflow-y:auto;color:#e5f3ff;font-size:14px;line-height:1.45}
    .helpTag{font-size:11px;border-radius:999px;padding:3px 10px;border:1px solid rgba(148,163,184,.7);color:#bfdbfe}

    /* Fun tutorial blocks for HG3 + D2 style */
    .help-section{margin-bottom:16px;}
    .help-section h2{font-weight:800;font-size:18px;margin-bottom:4px;}
    .help-section p{margin-top:4px;}
    .help-diagram{
      margin-top:8px;
      margin-bottom:6px;
      padding:8px 10px;
      border-radius:10px;
      background:linear-gradient(135deg,rgba(15,23,42,.95),rgba(30,64,175,.9));
      border:1px solid rgba(56,189,248,.5);
      font-size:13px;
    }
    .help-diagram-title{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:#a5f3fc;
      margin-bottom:4px;
    }
    .help-try{
      margin-top:6px;
      padding:8px 10px;
      border-radius:10px;
      background:linear-gradient(135deg,rgba(22,163,74,.15),rgba(16,185,129,.18));
      border:1px dashed rgba(52,211,153,.6);
      font-size:13px;
    }
    .help-badge{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 7px;
      border-radius:999px;
      font-size:11px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.6);
    }
    @keyframes wheelSpin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="content-wrapper">
    <div id="app"></div>
  </div>

  <!-- Help Modal -->
  <div id="helpModal" aria-hidden="true">
    <div class="helpBox" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
      <div class="helpHeader">
        <div class="helpTitle" id="helpTitle">
          <div style="width:46px;height:46px;border-radius:14px;background:conic-gradient(from 210deg at 30% 30%,#22d3ee,#8b5cf6,#f97316,#22d3ee);display:flex;align-items:center;justify-content:center;box-shadow:0 10px 30px rgba(15,23,42,.8);font-size:22px;">üéß</div>
          <div>
            <div style="font-size:18px;font-weight:900;letter-spacing:.06em" class="graffiti-text">FESTIVAL JAM MIXER ‚Äì GUIDE</div>
            <div style="font-size:12px;color:#bfdbfe">Learn how to build clean Fortnite Festival mixes step-by-step.</div>
          </div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <span class="helpTag">Camelot ‚Ä¢ BPM ‚Ä¢ Energy ‚Ä¢ Sandbox ‚Ä¢ Band</span>
          <button class="btn" onclick="closeHelp()">Close</button>
        </div>
      </div>

      <div class="helpContent">
        <!-- 1. What this app does -->
        <div class="help-section">
          <h2>1. What Is FESTIVAL JAM MIXER?</h2>
          <p class="small-muted">
            This tool helps you pick Fortnite Festival tracks that sound good together. It:
          </p>
          <ul class="small-muted" style="margin-left:16px;margin-top:4px">
            <li>Shows your tracks with BPM, Camelot key and energy.</li>
            <li>Finds songs that match your main track in key &amp; tempo.</li>
            <li>Lets you test ideas in a <strong>Sandbox</strong>.</li>
            <li>Lets you plan a <strong>Setlist</strong> for your in-game show.</li>
            <li>Lets you see what <strong>your bandmates own</strong> too.</li>
          </ul>

          <div class="help-diagram">
            <div class="help-diagram-title">App Layout</div>
            <div class="small-muted">
              <strong>Top bar:</strong> app name, who you‚Äôre signed in as, owned counter.<br>
              <strong>Left column:</strong> controls + band + sandbox.<br>
              <strong>Right column:</strong> song browser + setlist.
            </div>
          </div>
        </div>

        <!-- 2. Song Cards Explained -->
        <div class="help-section">
          <h2>2. Song Cards ‚Äì What Everything Means</h2>
          <p class="small-muted">
            Each big box in the Song Browser is one track. It looks something like this:
          </p>
          <div class="help-diagram">
            <div class="help-diagram-title">Song Card Example</div>
            <div style="display:flex;gap:8px;align-items:flex-start">
              <div style="width:52px;height:52px;background:#020617;border:2px solid #3b82f6;"></div>
              <div style="flex:1">
                <div class="small-muted"><strong>Song Title</strong></div>
                <div class="small-muted">Artist Name</div>
                <div class="small-muted" style="margin-top:4px">
                  <span class="help-badge">üí® 128 BPM</span>
                  <span class="help-badge">üéµ Genre</span>
                  <span class="help-badge">üé® Camelot: <strong>8A</strong></span>
                </div>
                <div style="margin-top:6px;display:flex;flex-wrap:wrap;gap:4px">
                  <span class="help-badge">Select</span>
                  <span class="help-badge">+ Set</span>
                  <span class="help-badge">‚úì Owned</span>
                  <span class="help-badge">‚ñ∂ Preview</span>
                </div>
              </div>
            </div>
          </div>
          <p class="small-muted">
            <strong>Buttons on a song card:</strong>
          </p>
          <ul class="small-muted" style="margin-left:16px;margin-top:4px">
            <li><strong>Select:</strong> chooses this as your main track. All other songs are compared to it.</li>
            <li><strong>+ Set:</strong> adds the song to your Setlist at the bottom.</li>
            <li><strong>Mark Owned / ‚úì Owned:</strong> toggle that you own this track in Fortnite.</li>
            <li><strong>Preview:</strong> compares this song to the selected one and pops up a compatibility summary.</li>
          </ul>
          <div class="help-try">
            <strong>Try this:</strong> pick any song, click <strong>Select</strong>, then click <strong>Preview</strong> on another song.  
            You‚Äôll see how well they match and how many BPM to shift.
          </div>
        </div>

        <!-- 3. Camelot Wheel & Tiers -->
        <div class="help-section">
          <h2>3. Camelot Wheel &amp; Tiers (Key Matching)</h2>
          <p class="small-muted">
            Camelot turns music keys into codes like <strong>8A</strong> or <strong>10B</strong>.
            You don‚Äôt need music theory ‚Äì just match the codes in a smart way.
          </p>

          <div style="display:flex;flex-wrap:wrap;gap:18px;margin-top:8px;align-items:center">
            <div style="flex:0 0 auto">
              <!-- Spinning Camelot wheel with segment colors -->
              <svg width="150" height="150" viewBox="0 0 120 120" style="transform-origin:center;animation:wheelSpin 18s linear infinite">
                <circle cx="60" cy="60" r="46" fill="#020617" opacity="0.9"></circle>
                <g transform="translate(60,60)" stroke-width="1.6">
                  <line x1="0" y1="-46" x2="0" y2="-36" transform="rotate(0)"   stroke="#FF6B9D"/>  <!-- 1 -->
                  <line x1="0" y1="-46" x2="0" y2="-36" transform="rotate(30)"  stroke="#FFA07A"/>  <!-- 2 -->
                  <line x1="0" y1="-46" x2="0" y2="-36" transform="rotate(60)"  stroke="#FFD700"/>  <!-- 3 -->
                  <line x1="0" y1="-46" x2="0" y2="-36" transform="rotate(90)"  stroke="#98D8C8"/>  <!-- 4 -->
                  <line x1="0" y1="-46" x2="0" y2="-36" transform="rotate(120)" stroke="#6BCB77"/>  <!-- 5 -->
                  <line x1="0" y1="-46" x2="0" y2="-36" transform="rotate(150)" stroke="#4D96FF"/>  <!-- 6 -->
                  <line x1="0" y1="-46" x2="0" y2="-36" transform="rotate(180)" stroke="#9D4EDD"/>  <!-- 7 -->
                  <line x1="0" y1="-46" x2="0" y2="-36" transform="rotate(210)" stroke="#E84A5F"/>  <!-- 8 -->
                  <line x1="0" y1="-46" x2="0" y2="-36" transform="rotate(240)" stroke="#00D9FF"/>  <!-- 9 -->
                  <line x1="0" y1="-46" x2="0" y2="-36" transform="rotate(270)" stroke="#FFA400"/>  <!-- 10 -->
                  <line x1="0" y1="-46" x2="0" y2="-36" transform="rotate(300)" stroke="#FE6D73"/>  <!-- 11 -->
                  <line x1="0" y1="-46" x2="0" y2="-36" transform="rotate(330)" stroke="#A8E6CF"/>  <!-- 12 -->
                </g>
                <circle cx="60" cy="60" r="30" fill="rgba(15,23,42,.96)" stroke="rgba(148,163,184,.6)" stroke-width="1.2"></circle>
                <text x="60" y="55" text-anchor="middle" font-size="11" fill="#e5e7eb" font-weight="600">HARMONIC</text>
                <text x="60" y="70" text-anchor="middle" font-size="13" fill="#f9fafb" font-weight="800">CAMELOT</text>
              </svg>
            </div>
            <div style="flex:1 1 220px">
              <div class="help-diagram">
                <div class="help-diagram-title">Tier Rules (Super Simple)</div>
                <ul class="small-muted" style="margin-left:16px;">
                  <li><strong>Tier 1:</strong> same number &amp; same letter (8A ‚Üí 8A) = smoothest.</li>
                  <li><strong>Tier 2:</strong> same letter, ¬±1 number (8A ‚Üí 7A or 9A) = very good.</li>
                  <li><strong>Tier 3:</strong> same number, swap letter (8A ‚Üí 8B) = color change but safe.</li>
                </ul>
              </div>
              <div class="help-try">
                <strong>Try this:</strong> Select a song in <strong>8A</strong>.  
                Turn <strong>Camelot</strong> to <em>Tiers 1‚Äì2</em> and hit <strong>Show Mixable</strong>.  
                You‚Äôll only see keys that should blend nicely with it.
              </div>
            </div>
          </div>
        </div>

        <!-- 4. Controls Panel -->
        <div class="help-section">
          <h2>4. Controls Panel (Left Side)</h2>
          <p class="small-muted">
            On the left, you control how the song list behaves.
          </p>
          <div class="help-diagram">
            <div class="help-diagram-title">Controls Explained</div>
            <ul class="small-muted" style="margin-left:16px;">
              <li><strong>Search bar:</strong> type part of a title, artist, or genre to filter songs.</li>
              <li><strong>Show Mixable:</strong> only show songs that match your <em>Selected</em> track‚Äôs key &amp; BPM.</li>
              <li><strong>Show All / Owned Only:</strong> switch between everything and just the tracks you own.</li>
              <li><strong>Clear Selection:</strong> unselect your main song so the list goes back to normal.</li>
              <li><strong>Mark All Owned:</strong> quickly mark every loaded song as owned (use if you truly have them all).</li>
              <li><strong>Camelot Tier:</strong> switch between Tier 1 only, Tiers 1‚Äì2, or All tiers.</li>
              <li><strong>Priority:</strong> choose if we sort suggestions mainly by <em>Tempo</em> or by <em>Camelot tier</em>.</li>
            </ul>
          </div>
          <div class="help-try">
            <strong>Try this:</strong>  
            1) Pick a main song and hit <strong>Select</strong>.  
            2) Press <strong>Show Mixable</strong>.  
            3) Flip <strong>Camelot</strong> from Tier 1 ‚Üí All tiers and watch how many options appear.
          </div>
        </div>

        <!-- 5. Priority Mode -->
        <div class="help-section">
          <h2>5. Priority ‚Äì Tempo vs Camelot</h2>
          <p class="small-muted">
            The Priority button changes how we sort songs when you have a <strong>Selected</strong> track.
          </p>
          <div class="help-diagram">
            <div class="help-diagram-title">How Priority Works</div>
            <ul class="small-muted" style="margin-left:16px;">
              <li><strong>Tempo Priority:</strong> best overall matches first (key + BPM). If two songs tie, closer BPM wins.</li>
              <li><strong>Camelot Priority:</strong> best key tiers first (Tier 1 at the very top), then the score, then BPM closeness.</li>
            </ul>
          </div>
          <div class="help-try">
            <strong>Tip:</strong>  
            Use <strong>Tempo</strong> when you care about staying near the same speed.  
            Use <strong>Camelot</strong> when you care more about musical key blending.
          </div>
        </div>

        <!-- 6. Sandbox -->
        <div class="help-section">
          <h2>6. Sandbox ‚Äì Your ‚ÄúTest Stage‚Äù</h2>
          <p class="small-muted">
            The Sandbox is where you drag a few songs you might want to play in a row. It helps you check:
          </p>
          <ul class="small-muted" style="margin-left:16px;margin-top:4px">
            <li>How far the BPM jumps between songs.</li>
            <li>How the <strong>energy level</strong> rises or falls.</li>
            <li>How many different keys you‚Äôre using.</li>
          </ul>

          <div class="help-diagram">
            <div class="help-diagram-title">What You See in Sandbox</div>
            <ul class="small-muted" style="margin-left:16px;">
              <li><strong>BPM range:</strong> lowest ‚Üí highest, plus how big the jump is.</li>
              <li><strong>Avg energy:</strong> a number from 1‚Äì5 showing overall hype level.</li>
              <li><strong>Keys list:</strong> which Camelot keys appear in that cluster.</li>
              <li><strong>Energy graph:</strong> bar for each song, showing its energy rating.</li>
            </ul>
          </div>
          <div class="help-try">
            <strong>Try this:</strong>  
            Drag 3‚Äì5 songs that you think could be a mini-set into the Sandbox.  
            If BPM jumps are huge or keys look chaotic, swap a track for a closer match.
          </div>
        </div>

        <!-- 7. Setlist -->
        <div class="help-section">
          <h2>7. Setlist ‚Äì Planning Your Show</h2>
          <p class="small-muted">
            The Setlist panel is a simple list of songs you want to play, in order.
          </p>
          <div class="help-diagram">
            <div class="help-diagram-title">How to Build a Setlist</div>
            <ul class="small-muted" style="margin-left:16px;">
              <li>Click <strong>+ Set</strong> on any song card to add it to the Setlist.</li>
              <li>Each line shows track number, title, artist, BPM and Camelot.</li>
              <li>Press the <strong>‚úï</strong> button next to a song to remove it from the Setlist.</li>
            </ul>
          </div>
          <div class="help-try">
            <strong>Tip:</strong>  
            Use Setlist to write down your ‚Äúdream‚Äù order. Then in Fortnite Festival, try to follow that flow when you actually queue songs.
          </div>
        </div>

        <!-- 8. Owned Tracks & Profiles -->
        <div class="help-section">
          <h2>8. Owned Tracks, Profiles &amp; Band Members</h2>
          <p class="small-muted">
            The app can remember which tracks you own and save that to your <strong>profile</strong>. You can also look at your <strong>band members‚Äô</strong> libraries.
          </p>

          <div class="help-diagram">
            <div class="help-diagram-title">Owned &amp; Profile</div>
            <ul class="small-muted" style="margin-left:16px;">
              <li>Use <strong>Mark Owned</strong> / <strong>‚úì Owned</strong> on song cards to track what you have.</li>
              <li>The top bar shows <strong>Owned: X / Y</strong> (how many songs are marked vs total songs loaded).</li>
              <li>If you sign in, your owned list can sync between browser and Firebase.</li>
            </ul>
          </div>
          <div class="help-diagram">
            <div class="help-diagram-title">Band Members</div>
            <ul class="small-muted" style="margin-left:16px;">
              <li>Click <strong>+ Add Band Member</strong> and enter their username.</li>
              <li>Click <strong>View</strong> next to a band member to see only their owned tracks.</li>
              <li>Use <strong>‚Ü© Back to Me</strong> to return to your own collection.</li>
              <li>You <strong>cannot</strong> change another user‚Äôs owned tracks ‚Äì only your own.</li>
            </ul>
          </div>
        </div>

        <!-- 9. First Time Recipe -->
        <div class="help-section">
          <h2>9. First Time? Do This Step-By-Step</h2>
          <div class="help-diagram">
            <div class="help-diagram-title">Quick Start</div>
            <ol class="small-muted" style="margin-left:16px;">
              <li>Scroll the Song Browser and press <strong>Mark Owned</strong> on each track you actually own.</li>
              <li>Pick your favorite track and click <strong>Select</strong>.</li>
              <li>Press <strong>Show Mixable</strong> to see only songs that match it.</li>
              <li>Set <strong>Camelot</strong> to <em>Tiers 1‚Äì2</em> for safe mixes.</li>
              <li>Click <strong>Preview</strong> on a song you like to compare them.</li>
              <li>If it looks good, click <strong>+ Set</strong> to add it to your Setlist.</li>
              <li>Drag a few of those songs into the <strong>Sandbox</strong> and check BPM &amp; energy flow.</li>
              <li>Keep going until you have a small show planned.</li>
            </ol>
          </div>
        </div>

        <!-- 10. Extra Tips -->
        <div class="help-section">
          <h2>10. Extra Tips for Better Mixes</h2>
          <ul class="small-muted" style="margin-left:16px;">
            <li>Keep BPM jumps under ~5 if you want smooth transitions.</li>
            <li>Stay within Tier 1‚Äì2 for ‚Äúsafe‚Äù mixes; use Tier 3 when you want a bigger change in mood.</li>
            <li>Watch the energy graph in the Sandbox ‚Äì let the show build, then cool down, then build again.</li>
            <li>Use <strong>Priority: Camelot</strong> when you care more about musical key than speed.</li>
            <li>Use <strong>Priority: Tempo</strong> when you want to stay near the same speed and just slightly bend key.</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

<script>
  /************ Firebase compat init ************/
  let firebaseConfig = window.firebaseConfig || null;
  const firebaseEnabled = true;

  let firebaseApp=null,firebaseAuth=null,firestore=null;

  async function fetchFirebaseConfig(){
    if(firebaseConfig) return firebaseConfig;
    try{
      const resp=await fetch("/api/firebase-config.js?format=json",{cache:"no-store"});
      if(!resp.ok) throw new Error(`Config fetch failed (${resp.status})`);
      const json=await resp.json();
      firebaseConfig=window.firebaseConfig=json;
      return firebaseConfig;
    }catch(err){
      console.error("Firebase config fetch failed.", err);
      return null;
    }
  }

  function initializeFirebase(config){
    if(!firebaseEnabled || !config) return;
    try{
      firebaseApp = firebase.initializeApp(config);
      firebaseAuth = firebase.auth();
      firestore   = firebase.firestore();
      if(firebase.analytics){ try{ firebase.analytics(); }catch(e){} }
    }catch(e){
      console.warn("Firebase init failed, using local-only mode", e);
    }
  }

  async function ensureFirebaseReady(){
    const config=await fetchFirebaseConfig();
    if(!config){
      console.error("Firebase config missing. Ensure /api/firebase-config.js is serving values.");
      return null;
    }
    initializeFirebase(config);
    return config;
  }

  /************ Camelot + scoring ************/
  const camelotColors={
    "1A":"#FF6B9D","1B":"#FF8FAB","2A":"#FFA07A","2B":"#FFB699","3A":"#FFD700","3B":"#FFE55C",
    "4A":"#98D8C8","4B":"#7FD8BE","5A":"#6BCB77","5B":"#8FD89F","6A":"#4D96FF","6B":"#6FB1FF",
    "7A":"#9D4EDD","7B":"#B877FF","8A":"#E84A5F","8B":"#FF6B81","9A":"#00D9FF","9B":"#4DFFFF",
    "10A":"#FFA400","10B":"#FFBB5C","11A":"#FE6D73","11B":"#FF8C94","12A":"#A8E6CF","12B":"#C1F0DD"
  };
  const keyToCamelot={
    "C":"8B","Am":"8A","A Minor":"8A","C Major":"8B",
    "G":"9B","Em":"9A","E Minor":"9A","G Major":"9B",
    "D":"10B","Bm":"10A","B Minor":"10A","D Major":"10B",
    "A":"11B","F#m":"11A","F# Minor":"11A","A Major":"11B",
    "E":"12B","C#m":"12A","C# Minor":"12A","E Major":"12B",
    "B":"1B","G#m":"1A","G# Minor":"1A","B Major":"1B",
    "F#":"2B","D#m":"2A","D# Minor":"2A","F# Major":"2B",
    "Db":"3B","Bbm":"3A","Bb Minor":"3A","Db Major":"3B",
    "Ab":"4B","Fm":"4A","F Minor":"4A","Ab Major":"4B",
    "Eb":"5B","Cm":"5A","C Minor":"5A","Eb Major":"5B",
    "Bb":"6B","Gm":"6A","G Minor":"6A","Bb Major":"6B",
    "F":"7B","Dm":"7A","D Minor":"7A","F Major":"7B"
  };
  function convertToCamelot(key){
    if(!key)return"?";
    return keyToCamelot[(key||"").trim()]||"?";
  }
  function getCamelotTier(a,b){
    if(!a||!b||a==="?"||b==="?")return 99;
    const ma=a.match(/^(\d+)([AB])$/),mb=b.match(/^(\d+)([AB])$/);
    if(!ma||!mb)return 99;
    const na=parseInt(ma[1]),la=ma[2],nb=parseInt(mb[1]),lb=mb[2];
    if(na===nb && la===lb)return 1;
    if(la===lb && (Math.abs(na-nb)===1 || Math.abs(na-nb)===11))return 2;
    if(na===nb && la!==lb)return 3;
    return 99;
  }
  function scoreKeyMatch(a,b){
    const tier=getCamelotTier(a,b);
    if(tier===1)return 40;
    if(tier===2)return 30;
    if(tier===3)return 20;
    return 0;
  }
  function scoreBpmMatch(a,b){
    const d=Math.abs(a-b);
    if(d<=1)return 40;
    if(d<=3)return 35;
    if(d<=6)return 25;
    if(d<=10)return 15;
    return 0;
  }
  function scoreGenreMatch(a,b){
    if(!a||!b)return 0;
    return a===b?20:0;
  }
  function mashupCompatibility(a,b){
    const key  = scoreKeyMatch(a.camelot,b.camelot);
    const bpm  = scoreBpmMatch(a.bpm,b.bpm);
    const genre= scoreGenreMatch(a.genre,b.genre);
    return { total:key+bpm+genre, breakdown:{key,bpm,genre} };
  }
  function bpmShiftSuggestion(a,b){
    const s=Math.round(b-a);
    if(s===0)return "No change";
    return (s>0?"+":"")+s+" BPM = Perfect Match";
  }
  function computeEnergy(track){
    if(!track||!track.bpm)return 3;
    let e=1, bpm=track.bpm;
    if(bpm<90)e=1; else if(bpm<110)e=2; else if(bpm<125)e=3; else if(bpm<140)e=4; else e=5;
    if(track.genre==="Electronic"||track.genre==="Rock")e=Math.min(5,e+1);
    return e;
  }

  const genreMap={
    "Rock":["foo fighters","nirvana","pearl jam","soundgarden","alice in chains","red hot chili peppers","radiohead","muse"],
    "Pop":["taylor swift","ariana grande","billie eilish","dua lipa","lady gaga"],
    "Electronic":["daft punk","deadmau5","skrillex","diplo","zedd","avicii"]
  };
  function detectGenre(artist,title){
    artist=(artist||"").toLowerCase();
    title =(title ||"").toLowerCase();
    for(const[g,list] of Object.entries(genreMap)){
      if(list.some(a=>artist.includes(a)||title.includes(a)))return g;
    }
    if(title.includes("rock"))return"Rock";
    if(title.includes("electr"))return"Electronic";
    return"Other";
  }

  /************ Global state ************/
  let currentUser=null;
  let songs=[];
  let ownedTracks=JSON.parse(localStorage.getItem("ownedTracks")||"[]");
  let setlist=JSON.parse(localStorage.getItem("setlist")||"[]");
  let bandMembers=JSON.parse(localStorage.getItem("bandMembers")||"[]");
  let genreOverrides=JSON.parse(localStorage.getItem("genreOverrides")||"{}");
  let sandboxTracks=[];
  let selectedSong=null;
  let previewSong=null;
  let viewingMember=null;
  let showOwnedOnly=false;
  let showMixableOnly=false;
  let camelotTier=3;
  let priorityMode="tempo";

  /************ UI builder ************/
  function buildMainUI(){
    const userDisplay=currentUser?(currentUser.djName||currentUser.username):"Not signed in";
    return `
      <div class="panel mb-4">
        <div class="flex justify-between items-center gap-3">
          <div class="flex items-center gap-3">
            <div class="vinyl-spin flex items-center justify-center rounded-2xl" style="width:58px;height:58px;background:conic-gradient(from 160deg,#22d3ee,#8b5cf6,#f97316,#22d3ee);box-shadow:0 12px 30px rgba(15,23,42,.85);">
              <span class="text-2xl">üéµ</span>
            </div>
            <div>
              <div class="text-xl font-extrabold graffiti-text tracking-wide">FESTIVAL JAM MIXER</div>
              <div class="small-muted flex flex-wrap items-center gap-2">
                <span>Signed in as <strong>${userDisplay}</strong></span>
                <span id="ownedCounter" class="small-muted px-2 py-0.5 rounded-full bg-sky-500/10 border border-sky-400/40">Owned: 0/0</span>
              </div>
            </div>
          </div>
          <div class="flex flex-wrap gap-2 justify-end">
            <button class="btn" onclick="openHelp()">‚ùì Help</button>
            <button class="btn" onclick="exportCollection()">‚¨á Export</button>
            <button class="btn" onclick="importCollection()">‚¨Ü Import</button>
            <button class="btn" onclick="handleLogin()">üîì Sign In</button>
            <button class="btn" onclick="logoutUser()">üö™ Logout</button>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-[340px_minmax(0,1fr)] gap-4 items-start">
        <!-- Left column -->
        <div class="space-y-4">
          <div class="panel">
            <div class="flex items-baseline justify-between mb-2">
              <div class="font-semibold text-sm tracking-wide">Controls</div>
              <div class="small-muted text-[11px]">Search ‚Ä¢ Filters ‚Ä¢ Mix Logic ‚Ä¢ Band</div>
            </div>
            <div class="space-y-2">
              <div class="small-muted text-[11px]">Search your Festival library</div>
              <input id="searchInput" placeholder="Search by title, artist, or genre..." class="w-full px-3 py-2 rounded-lg bg-black/40 border border-cyan-500/25 text-sm focus:outline-none focus:ring-1 focus:ring-cyan-400"/>
              <div class="small-muted text-[11px] mt-1">Quick filters</div>
              <div class="flex flex-wrap gap-2">
                <button id="mixableFilterBtn" class="btn">${showMixableOnly?"üéß Mixable Only":"Show Mixable"}</button>
                <button id="ownedFilterBtn" class="btn">${showOwnedOnly?"‚úì Owned Only":"Show All"}</button>
                <button id="clearSelectionBtn" class="btn">Clear Selection</button>
                <button id="markAllBtn" class="btn">Mark All Owned</button>
              </div>
              <div class="small-muted text-[11px] mt-1">Mix logic</div>
              <div class="flex flex-wrap gap-2 mt-1">
                <button id="camelotTierBtn" class="btn">Camelot: All Tiers</button>
                <button id="priorityBtn" class="btn">Priority: Tempo</button>
              </div>
              <div class="mt-3">
                <div class="font-semibold mb-1">Band Members</div>
                <div id="bandContainer" class="space-y-1 small-muted text-[12px]"></div>
                <div class="flex gap-2 mt-2">
                  <button id="addBandBtn" class="btn">+ Add Band Member</button>
                  ${viewingMember?'<button class="btn" onclick="backToMyProfile()">‚Ü© Back to Me</button>':""}
                </div>
              </div>
            </div>
          </div>

          <div class="panel">
            <div class="flex items-center justify-between mb-2">
              <div class="font-semibold">Sandbox (Drag tracks here)</div>
              <div class="small-muted">Plan transitions &amp; energy flow</div>
            </div>
            <div id="sandbox" class="sandbox-drop mb-2 bg-black/30"></div>
            <div id="sandboxInfo" class="small-muted mb-1"></div>
            <div id="energyGraph"></div>
          </div>
        </div>

        <!-- Right column -->
        <div class="space-y-4">
          <div class="panel">
            <div class="flex items-center justify-between mb-2">
              <div class="font-semibold">Song Browser</div>
              <div class="small-muted">Selected: <span id="selectedInfo">None</span></div>
            </div>
            <div id="songList" class="grid gap-3 sm:grid-cols-2"></div>
          </div>

          <div class="panel">
            <div class="flex items-center justify-between mb-2">
              <div class="font-semibold">Setlist (<span id="setlistCount">${setlist.length}</span>)</div>
              <div class="small-muted text-xs">Sketch your in-game playlist order.</div>
            </div>
            <div id="setlistContent"></div>
          </div>
        </div>
      </div>
    `;
  }

  /************ Render helpers ************/
  function render(){
    if(!firebaseConfig){
      document.getElementById("app").innerHTML = `
        <div class="panel" style="max-width:640px;margin:32px auto;text-align:center;">
          <div class="text-2xl font-bold mb-2">Firebase Setup Needed</div>
          <p class="small-muted mb-2">Add your Firebase environment variables to Vercel so /api/firebase-config.js can return them.</p>
          <p class="small-muted">After redeploying, reload this page to enable email login and syncing.</p>
        </div>
      `;
      return;
    }
    document.getElementById("app").innerHTML = buildMainUI();
    renderBandPanel();
    renderSongList();
    renderSetlist();
    sandboxInit();
    setupEventListeners();
    updateOwnedCounter();
  }

  function renderBandPanel(){
    const container=document.getElementById("bandContainer");
    if(!container)return;
    if(!bandMembers || bandMembers.length===0){
      container.innerHTML='<div class="small-muted">No band members yet.</div>';
      return;
    }
    container.innerHTML=bandMembers.map(m=>{
      const dj=m.djName||m.username;
      return `
        <div class="flex items-center justify-between py-1">
          <div class="flex items-center gap-2">
            <div class="w-7 h-7 rounded-lg flex items-center justify-center text-[11px] font-bold" style="background:${camelotColors["8B"]};box-shadow:0 0 10px rgba(248,113,113,.45);">
              ${dj[0]||"?"}
            </div>
            <div>
              <div class="font-semibold text-[12px]">${dj}</div>
              <div class="small-muted text-[11px]">@${m.username}</div>
            </div>
          </div>
          <div class="flex gap-1">
            <button class="btn" style="padding-inline:8px" onclick="viewBandMember('${m.username}')">View</button>
            <button class="btn" style="padding-inline:8px" onclick="removeBandMember('${m.username}')">Remove</button>
          </div>
        </div>
      `;
    }).join("");
  }

  function renderSongList(){
    const listEl=document.getElementById("songList");
    if(!listEl)return;
    const selected=selectedSong;
    const displayTracks=viewingMember?(viewingMember.ownedTracks||[]):(ownedTracks||[]);

    let filtered=songs.slice();
    const q=(document.getElementById("searchInput")?.value||"").trim().toLowerCase();
    if(q){
      filtered=filtered.filter(s=>
        s.title.toLowerCase().includes(q) ||
        s.artist.toLowerCase().includes(q) ||
        (s.genre||"").toLowerCase().includes(q)
      );
    }
    if(showOwnedOnly){
      filtered=filtered.filter(s=>displayTracks.includes(s.id));
    }
    filtered=filtered.map(s=>Object.assign({},s,{ _isOwned:displayTracks.includes(s.id) }));

    if(showMixableOnly && selected){
      filtered=filtered.filter(s=>{
        const tier=getCamelotTier(selected.camelot,s.camelot);
        const bpmOk=Math.abs(s.bpm-selected.bpm)<=4;
        return tier<=camelotTier && bpmOk;
      });
    }

    if(selected){
      filtered.sort((a,b)=>{
        const compA=mashupCompatibility(selected,a).total;
        const compB=mashupCompatibility(selected,b).total;
        if(priorityMode==="tempo"){
          if(compB!==compA)return compB-compA; // best overall match first
          return Math.abs(a.bpm-selected.bpm)-Math.abs(b.bpm-selected.bpm);
        }else{
          const ta=getCamelotTier(selected.camelot,a.camelot);
          const tb=getCamelotTier(selected.camelot,b.camelot);
          if(ta!==tb)return ta-tb; // better tier first
          if(compB!==compA)return compB-compA;
          return Math.abs(a.bpm-selected.bpm)-Math.abs(b.bpm-selected.bpm);
        }
      });
    }else{
      filtered.sort((a,b)=>a.title.localeCompare(b.title));
    }

    listEl.innerHTML=filtered.map(song=>{
      const isOwned=song._isOwned;
      const keyColor=camelotColors[song.camelot]||"#4b5563";
      const bpmDiff=selected?Math.abs(song.bpm-selected.bpm):null;
      const bpmBadge=bpmDiff!==null && bpmDiff<=10 ? `<span class="small-muted ml-1 text-[11px]">¬±${bpmDiff} BPM</span>` : "";
      const tier=selected?getCamelotTier(selected.camelot,song.camelot):null;
      const mixableMarker=selected && tier<=camelotTier && bpmDiff!==null && bpmDiff<=4 ? "üéß" : "";
      const art=song.albumArt?song.albumArt.replace(/"/g,"&quot;"):"";
      const tierLabel=tier && tier<99 ? `T${tier}` : "";
      const score=selected?mashupCompatibility(selected,song).total:null;

      return `
        <div class="song-card panel p-3 text-xs sm:text-[13px]" data-song-id="${song.id}" draggable="true">
          <div class="flex gap-3">
            <div class="art-tile">
              ${art?`<img src="${art}" alt="${song.title} cover" loading="lazy" onerror="this.style.display='none'">`:""}
            </div>
            <div class="flex-1 flex flex-col gap-1 min-w-0">
              <div class="flex flex-col">
                <div class="font-semibold truncate text-[13px] sm:text-sm">${song.title}</div>
                <div class="small-muted truncate">${song.artist}</div>
              </div>
              <div class="flex flex-wrap items-center gap-2 text-[11px] mt-1">
                <span class="small-muted">${song.bpm} BPM</span>
                <span class="small-muted">‚Ä¢</span>
                <span class="small-muted">${song.genre||"Other"}</span>
                <span class="camelot-pill" style="background:${keyColor};box-shadow:0 0 8px ${keyColor}66;">
                  ${song.camelot||"?"}
                </span>
              </div>
              <div class="flex flex-wrap gap-1 mt-2">
                <button class="btn" onclick="selectSong('${song.id}')">${selected && selected.id===song.id?"Selected":"Select"}</button>
                <button class="btn" onclick="addToSetlist('${song.id}')">+ Set</button>
                <button class="btn" onclick="toggleOwned('${song.id}')" ${viewingMember?"disabled style='opacity:.55;cursor:not-allowed'":""}>${isOwned?"‚úì Owned":"Mark Owned"}</button>
                <button class="btn" onclick="onPreviewClick('${song.id}')">Preview</button>
              </div>
              <div class="flex flex-wrap items-center justify-between mt-2 text-[11px] small-muted">
                <div class="flex flex-wrap items-center gap-1">
                  ${mixableMarker?`<span class="text-lg">${mixableMarker}</span>`:""}
                  ${tierLabel?`<span class="px-1 rounded border border-sky-500/60">${tierLabel}</span>`:""}
                  ${score!==null?`<span>${Math.round(score)}%</span>`:""}
                </div>
                <div>
                  ${bpmBadge}
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }).join("");

    document.getElementById("selectedInfo").textContent = selected ? `${selected.title} ‚Ä¢ ${selected.artist}` : "None";

    document.querySelectorAll(".song-card").forEach(card=>{
      card.addEventListener("dragstart",e=>{
        e.dataTransfer.setData("text/plain",card.getAttribute("data-song-id"));
      });
    });
  }

  function renderSetlist(){
    const el=document.getElementById("setlistContent");
    if(!el)return;
    if(!setlist || setlist.length===0){
      el.innerHTML='<div class="small-muted">Setlist is empty ‚Äì add songs from the browser.</div>';
      document.getElementById("setlistCount").textContent="0";
      return;
    }
    el.innerHTML=setlist.map((s,i)=>`
      <div class="panel mb-1 px-3 py-2 flex items-center justify-between text-xs">
        <div>
          <div class="font-semibold">${i+1}. ${s.title}</div>
          <div class="small-muted">${s.artist} ‚Ä¢ ${s.bpm} BPM ‚Ä¢ ${s.camelot}</div>
        </div>
        <button class="btn" onclick="removeFromSetlist('${s.id}')">‚úï</button>
      </div>
    `).join("");
    document.getElementById("setlistCount").textContent=setlist.length;
  }

  function updateOwnedCounter(){
    const total=songs.length||0;
    const owned=(ownedTracks||[]).length;
    const el=document.getElementById("ownedCounter");
    if(el)el.textContent=`Owned: ${owned}/${total}`;
  }

  /************ Sandbox (S3 hybrid) ************/
  function sandboxInit(){
    const el=document.getElementById("sandbox");
    if(!el)return;
    if(!sandboxTracks || sandboxTracks.length===0){
      el.innerHTML='<div class="small-muted">Drop or drag tracks here to sandbox transitions.</div>';
      document.getElementById("sandboxInfo").textContent="";
      renderEnergyGraph([]);
    }else{
      renderSandbox();
    }
    el.addEventListener("dragover",e=>e.preventDefault());
    el.addEventListener("drop",e=>{
      e.preventDefault();
      const id=e.dataTransfer.getData("text/plain");
      const track=songs.find(s=>s.id===id);
      if(!track)return;
      if(sandboxTracks.find(s=>s.id===id))return;
      if(sandboxTracks.length>=6){alert("Sandbox limit: 6 tracks");return;}
      sandboxTracks.push(track);
      renderSandbox();
    });
  }

  function renderSandbox(){
    const el=document.getElementById("sandbox");
    if(!el)return;
    if(!sandboxTracks || sandboxTracks.length===0){
      sandboxInit();
      return;
    }
    el.innerHTML=sandboxTracks.map((t,i)=>`
      <div class="panel mb-1 px-2 py-1 flex items-center gap-2 text-xs">
        <div class="w-7 h-7 rounded-lg flex items-center justify-center text-[11px]" style="background:${camelotColors[t.camelot]||"#4b5563"}">
          ${t.camelot||"?"}
        </div>
        <div class="flex-1 min-w-0">
          <div class="font-semibold truncate">${i+1}. ${t.title}</div>
          <div class="small-muted truncate">${t.artist} ‚Ä¢ ${t.bpm} BPM ‚Ä¢ ${t.genre||"Other"}</div>
        </div>
        <div class="small-muted mr-1">${computeEnergy(t)}</div>
        <button class="btn" style="padding-inline:8px" onclick="removeSandbox('${t.id}')">‚úï</button>
      </div>
    `).join("");

    const bpms=sandboxTracks.map(s=>s.bpm);
    const keys=sandboxTracks.map(s=>s.camelot);
    const minBpm=Math.min(...bpms);
    const maxBpm=Math.max(...bpms);
    const bpmSpread=maxBpm-minBpm;
    const energyAvg=sandboxTracks.reduce((a,t)=>a+computeEnergy(t),0)/sandboxTracks.length;
    const uniqueKeys=[...new Set(keys)];
    document.getElementById("sandboxInfo").textContent=
      `BPM range: ${minBpm}‚Äì${maxBpm} (Œî ${bpmSpread}) ‚Ä¢ Avg energy: ${energyAvg.toFixed(1)} ‚Ä¢ Keys: ${uniqueKeys.join(", ")}`;
    renderEnergyGraph(sandboxTracks);
  }

  function removeSandbox(id){
    sandboxTracks=sandboxTracks.filter(s=>s.id!==id);
    renderSandbox();
  }

  function renderEnergyGraph(list){
    const container=document.getElementById("energyGraph");
    if(!container)return;
    if(!list || list.length===0){
      container.innerHTML='<div class="small-muted">No sandbox tracks yet.</div>';
      return;
    }
    container.innerHTML=list.map((t,i)=>{
      const e=computeEnergy(t);
      const pct=(e/5)*100;
      const color=e>=4
        ? "linear-gradient(90deg,#f97316,#ef4444)"
        : e>=3
          ? "linear-gradient(90deg,#f59e0b,#f97316)"
          : "linear-gradient(90deg,#34d399,#10b981)";
      return `
        <div class="flex items-center gap-2 mb-1">
          <div class="w-5 text-[11px] small-muted">${i+1}</div>
          <div class="flex-1">
            <div class="small-muted text-[11px] truncate">${t.title} ‚Äî <span style="color:${camelotColors[t.camelot]||"#e5e7eb"}">${t.camelot}</span></div>
            <div class="energy-bar mt-0.5">
              <div style="width:${pct}%;height:100%;border-radius:8px;background:${color};"></div>
            </div>
          </div>
          <div class="w-6 text-center text-[11px] font-bold">${e}</div>
        </div>
      `;
    }).join("");
  }

  /************ Song interactions ************/
  function selectSong(id){
    const s=songs.find(x=>x.id===id);
    if(!s)return;
    if(selectedSong && selectedSong.id===id)selectedSong=null;
    else selectedSong=s;
    renderSongList();
  }

  function onPreviewClick(id){
    const s=songs.find(x=>x.id===id);
    if(!s)return;
    if(!selectedSong){
      selectedSong=s;
      renderSongList();
      alert("Main track selected. Click Preview on another track to compare.");
      return;
    }
    previewSong=s;
    const comp=mashupCompatibility(selectedSong,previewSong);
    alert(`${selectedSong.title} ‚Üí ${previewSong.title}
Compatibility: ${Math.round(comp.total)}%
BPM diff: ${Math.abs(selectedSong.bpm-previewSong.bpm)}
${bpmShiftSuggestion(selectedSong.bpm,previewSong.bpm)}`);
  }

  function toggleOwned(id){
    if(!ensureEmailLogin())return;
    if(viewingMember){
      alert("You can't edit another band member's collection.");
      return;
    }
    if(ownedTracks.includes(id))ownedTracks=ownedTracks.filter(x=>x!==id);
    else ownedTracks.push(id);
    localStorage.setItem("ownedTracks",JSON.stringify(ownedTracks));
    saveUserProfile();
    renderSongList();
    updateOwnedCounter();
  }

  function addToSetlist(id){
    if(!ensureEmailLogin())return;
    const s=songs.find(x=>x.id===id);
    if(!s)return;
    if(!setlist.find(x=>x.id===id)){
      setlist.push(s);
      localStorage.setItem("setlist",JSON.stringify(setlist));
      renderSetlist();
    }
  }

  function removeFromSetlist(id){
    if(!ensureEmailLogin())return;
    setlist=setlist.filter(x=>x.id!==id);
    localStorage.setItem("setlist",JSON.stringify(setlist));
    renderSetlist();
  }

  /************ Band members ************/
  async function addBandMember(){
    if(!ensureEmailLogin())return;
    const username=prompt("Enter bandmate username (exact):");
    if(!username)return;
    if(bandMembers.find(m=>m.username===username)){
      alert("This person is already in your band.");
      return;
    }
    const profile=await loadUserProfile(username) || { username,djName:username,ownedTracks:[],bandMembers:[],genreOverrides:{} };
    const memberProfile={
      username:profile.username,
      djName:profile.djName||profile.username,
      ownedTracks:profile.ownedTracks||[],
      bandMembers:profile.bandMembers||[],
      genreOverrides:profile.genreOverrides||{}
    };
    bandMembers.push(memberProfile);
    localStorage.setItem("bandMembers",JSON.stringify(bandMembers));
    await saveUserProfile();
    renderBandPanel();
    alert(`Added ${memberProfile.djName} (@${memberProfile.username}) to your band.`);
  }

  async function removeBandMember(username){
    if(!ensureEmailLogin())return;
    const member=bandMembers.find(m=>m.username===username);
    if(!member)return;
    const label=member.djName||member.username;
    if(!confirm(`Remove ${label} (@${member.username}) from your band?`))return;
    bandMembers=bandMembers.filter(m=>m.username!==username);
    localStorage.setItem("bandMembers",JSON.stringify(bandMembers));
    if(viewingMember && viewingMember.username===username){
      viewingMember=null;
      showOwnedOnly=false;
    }
    await saveUserProfile();
    render();
  }

  async function viewBandMember(username){
    if(!ensureEmailLogin())return;
    const profile=await loadUserProfile(username) || { username,djName:username,ownedTracks:[],bandMembers:[],genreOverrides:{} };
    profile.ownedTracks=profile.ownedTracks||[];
    viewingMember=profile;
    showOwnedOnly=true;
    render();
    const btn=document.getElementById("ownedFilterBtn");
    if(btn)btn.textContent="‚úì Owned Only";
  }

  function backToMyProfile(){
    viewingMember=null;
    showOwnedOnly=false;
    render();
    const btn=document.getElementById("ownedFilterBtn");
    if(btn)btn.textContent="Show All";
  }

  /************ Export / Import ************/
  async function exportCollection(){
    if(!ensureEmailLogin())return;
    const data={
      username: currentUser?currentUser.username:"guest",
      djName:   currentUser?currentUser.djName:"",
      ownedTracks,
      genreOverrides,
      exportDate:new Date().toISOString()
    };
    if(firestore && currentUser && confirm("Also back up to Firestore? (Cancel = local only)")){
      try{
        await firestore.collection("backups").doc(`${currentUser.username}_${Date.now()}`).set(data);
        alert("Backed up to Firestore.");
      }catch(e){ console.warn("backup failed",e); }
    }
    const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url;
    a.download=`festival-mixer-${data.username||"guest"}.json`;
    a.click();
    URL.revokeObjectURL(url);
  }

  async function importCollection(){
    if(!ensureEmailLogin())return;
    const input=document.createElement("input");
    input.type="file";
    input.accept=".json";
    input.onchange=async e=>{
      const file=e.target.files[0];
      if(!file)return;
      const text=await file.text();
      try{
        const data=JSON.parse(text);
        if(!Array.isArray(data.ownedTracks))throw new Error("bad");
        if(!confirm(`Import ${data.ownedTracks.length} tracks from ${data.djName||data.username||"file"}?`))return;
        ownedTracks=data.ownedTracks;
        genreOverrides=data.genreOverrides||{};
        localStorage.setItem("ownedTracks",JSON.stringify(ownedTracks));
        localStorage.setItem("genreOverrides",JSON.stringify(genreOverrides));
        await saveUserProfile();
        songs.forEach(song=>{ if(genreOverrides[song.id])song.genre=genreOverrides[song.id]; });
        renderSongList();
        updateOwnedCounter();
        alert("Imported collection.");
      }catch(err){
        alert("Invalid file format.");
      }
    };
    input.click();
  }

  /************ Profiles + Firebase merge ************/
  async function saveUserProfileToBackend(profile){
    if(!profile || !firestore || !profile.username)return false;
    try{
      await firestore.collection("users").doc(profile.username).set(profile,{merge:true});
      return true;
    }catch(e){
      console.warn("Firestore save failed",e);
      return false;
    }
  }
  async function saveUserProfile(){
    if(!currentUser)return;
    const profile={
      username:currentUser.username,
      djName:  currentUser.djName||currentUser.username,
      ownedTracks,
      setlist,
      bandMembers,
      genreOverrides
    };
    const profiles=JSON.parse(localStorage.getItem("userProfiles")||"{}");
    profiles[profile.username]=profile;
    localStorage.setItem("userProfiles",JSON.stringify(profiles));
    localStorage.setItem("ownedTracks",JSON.stringify(ownedTracks));
    localStorage.setItem("bandMembers",JSON.stringify(bandMembers));
    localStorage.setItem("genreOverrides",JSON.stringify(genreOverrides));
    await saveUserProfileToBackend(profile);
  }
  async function loadUserProfile(username){
    if(!username)return null;
    if(firestore){
      try{
        const doc=await firestore.collection("users").doc(username).get();
        if(doc.exists)return doc.data();
      }catch(e){ console.warn("Firestore load failed",e); }
    }
    const profiles=JSON.parse(localStorage.getItem("userProfiles")||"{}");
    return profiles[username]||null;
  }

  /************ Auth ************/
  function ensureEmailLogin(){
    if(!firebaseAuth){
      alert("Firebase email login is required. Check your Firebase config before continuing.");
      return false;
    }
    if(!firebaseAuth.currentUser){
      alert("Please sign in with your email to use this feature.");
      return false;
    }
    return true;
  }

  function usernameFromEmail(email,fallback){
    if(email && email.includes("@"))return email.split("@")[0];
    return fallback||"user";
  }

  async function hydrateProfileFromAuth(user){
    const username=usernameFromEmail(user?.email,user?.uid||"dj");
    const profile=await loadUserProfile(username);
    if(profile){
      currentUser=profile;
      ownedTracks=profile.ownedTracks||[];
      setlist=profile.setlist||[];
      bandMembers=profile.bandMembers||[];
      genreOverrides=profile.genreOverrides||{};
    }else{
      currentUser={
        username,
        djName:username,
        ownedTracks:ownedTracks||[],
        setlist:setlist||[],
        bandMembers:bandMembers||[],
        genreOverrides:genreOverrides||{}
      };
      await saveUserProfile();
    }
    localStorage.setItem("currentUser",username);
    render();
  }

  async function handleLogin(e){
    e && e.preventDefault && e.preventDefault();
    if(!firebaseAuth){
      alert("Firebase email login is required. Please configure Firebase before signing in.");
      return;
    }
    const email=prompt("Enter your email for Firebase login/register:");
    if(!email)return;
    const password=prompt("Enter password:");
    if(!password)return;
    try{
      await firebaseAuth.signInWithEmailAndPassword(email,password);
      await hydrateProfileFromAuth(firebaseAuth.currentUser);
      alert("Signed in.");
    }catch(err){
      if(err.code==="auth/user-not-found" && confirm("No account found ‚Äî create one?")){
        try{
          await firebaseAuth.createUserWithEmailAndPassword(email,password);
          await hydrateProfileFromAuth(firebaseAuth.currentUser);
          alert("Account created & signed in.");
        }catch(e2){
          alert("Register failed: "+(e2.message||e2));
        }
      }else{
        alert("Sign in failed: "+(err.message||err));
      }
    }
  }

  async function logoutUser(){
    await saveUserProfile();
    if(firebaseAuth && firebaseAuth.currentUser){
      try{await firebaseAuth.signOut();}catch(e){console.warn("signout error",e);}
    }
    currentUser=null;
    ownedTracks=[];
    setlist=[];
    bandMembers=[];
    viewingMember=null;
    genreOverrides={};
    localStorage.removeItem("currentUser");
    render();
    alert("Logged out.");
  }

  /************ Misc events ************/
  function setupEventListeners(){
    document.getElementById("mixableFilterBtn")?.addEventListener("click",()=>{
      if(!selectedSong){alert("Select a song first to use Mixable Only.");return;}
      showMixableOnly=!showMixableOnly;
      const btn=document.getElementById("mixableFilterBtn");
      if(btn)btn.textContent=showMixableOnly?"üéß Mixable Only":"Show Mixable";
      renderSongList();
    });
    document.getElementById("ownedFilterBtn")?.addEventListener("click",()=>{
      showOwnedOnly=!showOwnedOnly;
      const btn=document.getElementById("ownedFilterBtn");
      if(btn)btn.textContent=showOwnedOnly?"‚úì Owned Only":"Show All";
      renderSongList();
    });
    document.getElementById("clearSelectionBtn")?.addEventListener("click",()=>{
      selectedSong=null;
      previewSong=null;
      showMixableOnly=false;
      const btn=document.getElementById("mixableFilterBtn");
      if(btn)btn.textContent="Show Mixable";
      renderSongList();
    });
    document.getElementById("markAllBtn")?.addEventListener("click",()=>{
      if(!ensureEmailLogin())return;
      if(!confirm("Mark ALL loaded songs as owned?"))return;
      ownedTracks=songs.map(s=>s.id);
      localStorage.setItem("ownedTracks",JSON.stringify(ownedTracks));
      saveUserProfile();
      renderSongList();
      updateOwnedCounter();
    });
    document.getElementById("addBandBtn")?.addEventListener("click",()=>addBandMember());
    document.getElementById("searchInput")?.addEventListener("input",()=>renderSongList());
    document.getElementById("camelotTierBtn")?.addEventListener("click",()=>{
      camelotTier++;
      if(camelotTier>3)camelotTier=1;
      const labels={1:"Camelot: Tier 1",2:"Camelot: Tiers 1‚Äì2",3:"Camelot: All Tiers"};
      const btn=document.getElementById("camelotTierBtn");
      if(btn)btn.textContent=labels[camelotTier];
      renderSongList();
    });
    document.getElementById("priorityBtn")?.addEventListener("click",()=>{
      priorityMode = priorityMode==="tempo" ? "camelot" : "tempo";
      const btn=document.getElementById("priorityBtn");
      if(btn)btn.textContent = priorityMode==="tempo" ? "Priority: Tempo" : "Priority: Camelot";
      renderSongList();
    });
  }

  function openHelp(){const m=document.getElementById("helpModal");if(m){m.style.display="flex";m.setAttribute("aria-hidden","false");}}
  function closeHelp(){const m=document.getElementById("helpModal");if(m){m.style.display="none";m.setAttribute("aria-hidden","true");}}

  /************ Song loading ************/
  async function loadSongs(){
    const endpoints=[
      "https://api.allorigins.win/raw?url=https://fortnitecontent-website-prod07.ol.epicgames.com/content/api/pages/fortnite-game/spark-tracks",
      "https://corsproxy.io/?https://fortnitecontent-website-prod07.ol.epicgames.com/content/api/pages/fortnite-game/spark-tracks"
    ];
    for(const ep of endpoints){
      try{
        const res=await fetch(ep);
        if(!res.ok)continue;
        const data=await res.json();
        songs=Object.entries(data).filter(([k])=>!k.startsWith("_")).map(([id,item])=>{
          const t=item.track||{};
          if(!t.tt)return null;
          const detected=detectGenre(t.an||"",t.tt);
          const finalGenre=genreOverrides[id]||detected;
          let art="";
          if(t.au)art=t.au.trim();
          if(!art && t.at)art=t.at.trim();
          if(!art && t.im)art=t.im.trim();
          if(!art && Array.isArray(t.images) && t.images.length)art=t.images[0];
          if(art && art.startsWith("//"))art=window.location.protocol+art;
          if(art && art.startsWith("/"))art="https://fortnitecontent-website-prod07.ol.epicgames.com"+art;
          return {
            id,
            title:t.tt,
            artist:t.an||"Unknown",
            bpm:Number(t.mt)||0,
            key:t.mk||"?",
            mode:t.mm||"",
            camelot:convertToCamelot(t.mk||""),
            duration:Number(t.dn)||0,
            albumArt:art||"",
            genre:finalGenre
          };
        }).filter(s=>s && s.bpm>0);
        if(songs.length>0){
          songs.sort((a,b)=>a.title.localeCompare(b.title));
          renderSongList();
          updateOwnedCounter();
          return;
        }
      }catch(e){
        console.warn("Song endpoint error",e);
      }
    }
    // fallback demo data if API fails
    songs=[
      {id:"s1",title:"Bad Guy",artist:"Billie Eilish",bpm:135,key:"C",camelot:"8B",duration:180,albumArt:"",genre:"Pop"},
      {id:"s2",title:"Need You Tonight",artist:"INXS",bpm:115,key:"C",camelot:"8A",duration:210,albumArt:"",genre:"Rock"},
      {id:"s3",title:"Electric Night",artist:"Daft Sample",bpm:128,key:"D",camelot:"10B",duration:200,albumArt:"",genre:"Electronic"},
      {id:"s4",title:"Slow Burn",artist:"Indie Star",bpm:95,key:"G",camelot:"9A",duration:190,albumArt:"",genre:"Indie"},
      {id:"s5",title:"Drop The Bass",artist:"SkrillSample",bpm:142,key:"A",camelot:"11A",duration:160,albumArt:"",genre:"Electronic"}
    ];
    renderSongList();
    updateOwnedCounter();
  }

  /************ Init ************/
  (async function init(){
    const ownedLocal=JSON.parse(localStorage.getItem("ownedTracks")||"[]");
    const bandLocal =JSON.parse(localStorage.getItem("bandMembers")||"[]");
    ownedTracks = Array.isArray(ownedLocal)?ownedLocal:[];
    bandMembers= Array.isArray(bandLocal)?bandLocal:[];
    genreOverrides=JSON.parse(localStorage.getItem("genreOverrides")||"{}");
    setlist       =JSON.parse(localStorage.getItem("setlist")||"[]");

    await ensureFirebaseReady();

    if(firebaseAuth){
      firebaseAuth.onAuthStateChanged(async user=>{
        if(user){
          await hydrateProfileFromAuth(user);
        }else{
          currentUser=null;
          localStorage.removeItem("currentUser");
          render();
        }
      });
    }

    render();
    await loadSongs();
  })();
</script>
</body>
</html>
