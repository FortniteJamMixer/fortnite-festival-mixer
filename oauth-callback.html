<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Epic OAuth Callback</title>
  <script>
    window.firebaseConfig = window.firebaseConfig || null;
    window.firebaseConfigPromise = fetch('./api/firebase-config?format=json', { cache: 'no-store' })
      .then((response) => {
        if (!response.ok) {
          throw new Error(`firebase-config fetch failed: ${response.status}`);
        }
        const contentType = response.headers.get('content-type') || '';
        if (!contentType.includes('application/json')) {
          throw new Error(`firebase-config unexpected content-type: ${contentType || 'unknown'}`);
        }
        return response.json();
      })
      .then((config) => {
        window.firebaseConfig = config;
        return config;
      })
      .catch((error) => {
        console.warn('Firebase config unavailable; continuing without Firebase.', error);
        window.firebaseConfig = null;
        return null;
      });
  </script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-black via-slate-900 to-indigo-950 text-white flex items-center justify-center p-4">
  <div class="w-full max-w-xl bg-white/5 border border-white/10 rounded-2xl p-6 backdrop-blur-md" id="statusBox">
    <div class="text-lg font-bold mb-2" id="statusHeading">Completing Epic link…</div>
    <p class="text-sm text-cyan-100" id="statusMessage">Processing your Epic authorization safely.</p>
    <div class="mt-4 flex items-center gap-2">
      <button id="returnButton" class="hidden px-4 py-2 rounded-lg bg-white/10 border border-white/20 text-sm hover:bg-white/20 transition-colors" type="button">Return to app</button>
    </div>
  </div>

  <script>
    const statusHeading = document.getElementById('statusHeading');
    const statusMessage = document.getElementById('statusMessage');
    const statusBox = document.getElementById('statusBox');
    const returnButton = document.getElementById('returnButton');
    const redirectTarget = '/';

    let firebaseApp = null;
    let firebaseAuth = null;

    function scrubUrl() {
      const cleanPath = `${window.location.pathname}${window.location.hash || ''}`;
      history.replaceState({}, '', cleanPath);
    }

    function updateStatus(heading, message, isError = false) {
      if (statusHeading) statusHeading.textContent = heading;
      if (statusMessage) statusMessage.textContent = message;
      if (isError && statusBox) {
        statusBox.classList.add('border-red-500/50', 'bg-red-500/10');
      }
    }

    function showReturnButton() {
      if (!returnButton) return;
      returnButton.classList.remove('hidden');
      returnButton.addEventListener('click', () => {
        window.location.href = redirectTarget;
      }, { once: true });
    }

    function initFirebase() {
      const config = (window.firebaseConfig && window.firebaseConfig.apiKey)
        ? window.firebaseConfig
        : null;
      if (!config || !window.firebase?.initializeApp) return false;
      try {
        firebaseApp = firebase.initializeApp(config);
        firebaseAuth = firebase.auth();
        return true;
      } catch (e) {
        console.warn('Firebase init failed in callback', e);
        firebaseApp = null;
        firebaseAuth = null;
        return false;
      }
    }

    function waitForAuthReady(timeoutMs = 5000) {
      return new Promise((resolve) => {
        if (!firebaseAuth) return resolve(null);
        let settled = false;
        const timer = setTimeout(() => {
          if (!settled) resolve(firebaseAuth.currentUser || null);
          settled = true;
        }, timeoutMs);
        const unsub = firebaseAuth.onAuthStateChanged((user) => {
          if (settled) return;
          settled = true;
          clearTimeout(timer);
          unsub?.();
          resolve(user || null);
        });
      });
    }

    async function getIdToken() {
      if (!firebaseAuth) return null;
      const user = firebaseAuth.currentUser || (await waitForAuthReady());
      if (!user) return null;
      try {
        return await user.getIdToken(false);
      } catch (e) {
        console.warn('Failed to get ID token', e);
        return null;
      }
    }

    function deriveClientMessage(payload) {
      const code = payload?.errorCode;
      const messageMap = {
        OAUTH_ACCESS_DENIED: 'Epic sign-in was cancelled. Restart linking from your profile when ready.',
        OAUTH_SESSION_MISSING: 'Epic sign-in timed out. Restart linking from your profile.',
        OAUTH_EXPIRED: 'Epic sign-in expired. Restart linking from your profile.',
        OAUTH_STATE_MISMATCH: 'Epic sign-in could not be verified. Restart linking from your profile.',
        OAUTH_REDIRECT_MISMATCH: 'Epic redirect URI mismatch. Confirm the configured callback matches exactly.',
        OAUTH_AUTH_REQUIRED: 'Please sign in to your account, then restart the Epic link.',
        OAUTH_CODE_REPLAY: 'That Epic sign-in link was already used or expired. Restart the link from your profile.',
        TOKEN_EXCHANGE_FAILED: 'Epic rejected the request. Verify your account is signed in and try again.'
      };
      if (code && messageMap[code]) return messageMap[code];
      return payload?.error || 'Epic account could not be linked. Try again from your profile settings.';
    }

    async function sendCallbackRequest(body, idToken) {
      let response;
      let payload = null;
      try {
        response = await fetch('/api/oauth/epic/callback', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...(idToken ? { Authorization: `Bearer ${idToken}` } : {})
          },
          credentials: 'same-origin',
          body: JSON.stringify(body)
        });
        payload = await response.json().catch(() => null);
      } catch (_) {
        return { response: null, payload: null };
      }
      return { response, payload };
    }

    function handleResult({ response, payload }) {
      if (!response?.ok || !payload?.ok) {
        const friendlyMessage = deriveClientMessage(payload);
        updateStatus('Linking failed', friendlyMessage, true);
        showReturnButton();
        if (payload?.redirect) {
          setTimeout(() => { window.location.href = payload.redirect; }, 1200);
        }
        return false;
      }

      try {
        sessionStorage.setItem('epicLinkedHint', '1');
      } catch (_) {
        // Cosmetic hint only; ignore failures.
      }

      updateStatus('Epic account linked!', 'You will be returned to the app shortly. Update your profile anytime from the Profile button.');
      setTimeout(() => { window.location.href = redirectTarget; }, 1200);
      return true;
    }

    async function handleOAuthCallback() {
      const params = new URLSearchParams(window.location.search);
      const code = params.get('code');
      const state = params.get('state');
      const error = params.get('error');

      scrubUrl();

      if (window.firebaseConfigPromise) {
        await window.firebaseConfigPromise;
      }
      const firebaseReady = initFirebase();
      const idToken = firebaseReady ? await getIdToken() : null;

      if (!firebaseReady) {
        updateStatus('Firebase missing', 'Firebase is required to complete Epic linking. Return to the app and sign in.', true);
        showReturnButton();
        return;
      }

      if (error) {
        const result = await sendCallbackRequest({ error, state }, idToken);
        handleResult(result);
        return;
      }

      if (!code || !state) {
        updateStatus('Missing details', 'No Epic authorization details were found. Restart the Epic link flow from your profile.', true);
        showReturnButton();
        return;
      }

      if (!idToken) {
        updateStatus('Sign in required', 'Please sign in to your Fortnite Jam Mixer account, then restart the Epic link.', true);
        showReturnButton();
        return;
      }

      updateStatus('Linking Epic account…', 'Finishing secure Epic link. Do not close this tab.');

      const result = await sendCallbackRequest({ code, state }, idToken);
      if (!result.response && !result.payload) {
        updateStatus('Network issue', 'Could not reach Epic link service. Please try again.', true);
        showReturnButton();
        return;
      }

      handleResult(result);
    }

    handleOAuthCallback();
  </script>
</body>
</html>
