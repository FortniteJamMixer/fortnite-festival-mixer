<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Epic OAuth Callback</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-black via-slate-900 to-indigo-950 text-white flex items-center justify-center p-4">
  <div class="w-full max-w-xl bg-white/5 border border-white/10 rounded-2xl p-6 backdrop-blur-md" id="statusBox">
    <div class="text-lg font-bold mb-2" id="statusHeading">Completing Epic link…</div>
    <p class="text-sm text-cyan-100" id="statusMessage">Processing your Epic authorization safely.</p>
    <div class="mt-4 flex items-center gap-2">
      <button id="returnButton" class="hidden px-4 py-2 rounded-lg bg-white/10 border border-white/20 text-sm hover:bg-white/20 transition-colors" type="button">Return to app</button>
    </div>
  </div>

  <script>
    const statusHeading = document.getElementById('statusHeading');
    const statusMessage = document.getElementById('statusMessage');
    const statusBox = document.getElementById('statusBox');
    const returnButton = document.getElementById('returnButton');
    const redirectTarget = '/?view=profile';

    function scrubUrl() {
      const cleanPath = `${window.location.pathname}${window.location.hash || ''}`;
      history.replaceState({}, '', cleanPath);
    }

    function updateStatus(heading, message, isError = false) {
      if (statusHeading) statusHeading.textContent = heading;
      if (statusMessage) statusMessage.textContent = message;
      if (isError && statusBox) {
        statusBox.classList.add('border-red-500/50', 'bg-red-500/10');
      }
    }

    function showReturnButton() {
      if (!returnButton) return;
      returnButton.classList.remove('hidden');
      returnButton.addEventListener('click', () => {
        window.location.href = redirectTarget;
      }, { once: true });
    }

    async function handleOAuthCallback() {
      const params = new URLSearchParams(window.location.search);
      const code = params.get('code');
      const state = params.get('state');
      const error = params.get('error');

      scrubUrl();

      if (error) {
        updateStatus('Authorization failed', 'Epic reported an error. Please try linking again from your profile settings.', true);
        showReturnButton();
        return;
      }

      if (!code || !state) {
        updateStatus('Missing details', 'No Epic authorization details were found. Restart the Epic link flow from your profile.', true);
        showReturnButton();
        return;
      }

      updateStatus('Linking Epic account…', 'Finishing secure Epic link. Do not close this tab.');

      let response;
      let payload = null;
      try {
        response = await fetch('/api/oauth/epic/callback', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify({ code, state })
        });
        payload = await response.json().catch(() => null);
      } catch (_) {
        updateStatus('Network issue', 'Could not reach Epic link service. Please try again.', true);
        showReturnButton();
        return;
      }

      if (!response?.ok || !payload?.ok) {
        updateStatus('Linking failed', 'Epic account could not be linked. Try again from your profile settings.', true);
        showReturnButton();
        return;
      }

      try {
        sessionStorage.setItem('epicLinkedHint', '1');
      } catch (_) {
        // Cosmetic hint only; ignore failures.
      }

      updateStatus('Epic account linked!', 'You will be returned to your profile shortly.');
      setTimeout(() => { window.location.href = redirectTarget; }, 1200);
    }

    handleOAuthCallback();
  </script>
</body>
</html>
